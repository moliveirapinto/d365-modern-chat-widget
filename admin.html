<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Admin - Customization</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600&family=Crimson+Text:wght@400;600&family=DM+Sans:wght@400;500;600&family=Fira+Code:wght@400;500&family=Fira+Sans:wght@400;500;600&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&family=Lato:wght@400;700&family=Lexend:wght@400;500;600&family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;500;600&family=Manrope:wght@400;500;600&family=Merriweather:wght@400;700&family=Montserrat:wght@400;500;600&family=Nunito:wght@400;600;700&family=Open+Sans:wght@400;600&family=Outfit:wght@400;500;600&family=Playfair+Display:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600&family=Poppins:wght@400;500;600&family=Quicksand:wght@400;500;600&family=Raleway:wght@400;500;600&family=Righteous&family=Roboto:wght@400;500&family=Rubik:wght@400;500;600&family=Source+Code+Pro:wght@400;500&family=Source+Sans+Pro:wght@400;600&family=Ubuntu:wght@400;500;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --admin-primary: #6366f1;
            --admin-primary-dark: #4f46e5;
            --admin-bg: #f8fafc;
            --admin-card: #ffffff;
            --admin-text: #1e293b;
            --admin-text-light: #64748b;
            --admin-border: #e2e8f0;
            --admin-success: #10b981;
            --admin-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --admin-shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--admin-bg);
            color: var(--admin-text);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
            border: 2px solid #f1f5f9;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Header */
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            box-shadow: var(--admin-shadow-lg);
        }
        .admin-header h1 { font-size: 24px; font-weight: 600; }
        .admin-header p { opacity: 0.9; margin-top: 4px; font-size: 14px; }

        /* Main Layout */
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
            padding-right: 450px;
            overflow-x: hidden;
            overflow-y: visible;
            width: 100%;
        }

        @media (max-width: 1200px) {
            .admin-container {
                padding-right: 32px;
            }
        }

        /* Settings Panel */
        .settings-panel {
            display: flex;
            flex-direction: column;
            gap: 32px;
            max-width: 100%;
            overflow-x: hidden;
            overflow-y: visible;
        }

        .settings-card {
            background: var(--admin-card);
            border-radius: 12px;
            box-shadow: var(--admin-shadow);
            overflow: hidden;
            max-width: 100%;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--admin-border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .card-header-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-header-icon svg { width: 20px; height: 20px; fill: white; }
        .card-header h2 { font-size: 16px; font-weight: 600; }
        .card-header p { font-size: 13px; color: var(--admin-text-light); margin-top: 2px; }

        .card-body { padding: 24px; overflow-x: auto; max-width: 100%; }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }
        .form-group:last-child { margin-bottom: 0; }
        
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--admin-text);
            margin-bottom: 6px;
        }
        .form-hint {
            font-size: 12px;
            color: var(--admin-text-light);
            margin-top: 4px;
        }

        /* Widget Mode Selector */
        .widget-mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .mode-option {
            cursor: pointer;
        }
        .mode-option input[type="radio"] {
            display: none;
        }
        .mode-card {
            padding: 20px;
            border: 2px solid var(--admin-border);
            border-radius: 12px;
            background: var(--admin-card);
            transition: all 0.3s ease;
            text-align: center;
        }
        .mode-option input[type="radio"]:checked + .mode-card {
            border-color: var(--admin-primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .mode-card:hover {
            border-color: var(--admin-primary);
        }
        .mode-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            background: linear-gradient(135deg, var(--admin-primary), #8b5cf6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mode-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        .mode-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--admin-text);
            margin-bottom: 6px;
        }
        .mode-desc {
            font-size: 13px;
            color: var(--admin-text-light);
            line-height: 1.4;
        }

        /* Font Preview */
        .font-preview {
            margin-top: 16px;
            padding: 16px;
            background: var(--admin-bg);
            border-radius: 8px;
            border: 1px solid var(--admin-border);
        }
        .font-preview-label {
            font-size: 12px;
            color: var(--admin-text-light);
            margin-bottom: 8px;
        }
        .font-preview-text {
            font-size: 16px;
            color: var(--admin-text);
            line-height: 1.5;
        }
        /* Font families */
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-opensans { font-family: 'Open Sans', sans-serif; }
        .font-lato { font-family: 'Lato', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .font-nunito { font-family: 'Nunito', sans-serif; }
        .font-sourcesans { font-family: 'Source Sans Pro', sans-serif; }
        .font-raleway { font-family: 'Raleway', sans-serif; }
        .font-system { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        /* Custom Widget Settings visibility */
        #customWidgetSettings {
            display: flex;
            flex-direction: column;
            gap: 32px;
            transition: opacity 0.3s ease, max-height 0.3s ease;
        }
        #customWidgetSettings.hidden {
            display: none !important;
        }
        #standardWidgetSettings.hidden {
            display: none !important;
        }
        .preview-panel.hidden {
            display: none;
        }
        .hidden {
            display: none !important;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--admin-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* LCW Textarea */
        .lcw-textarea {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.5;
            min-height: 100px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }
        .extracted-values {
            margin-top: 16px;
            padding: 16px;
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 8px;
        }
        .extracted-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #10b981;
            font-size: 13px;
        }
        .extracted-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .extracted-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .extracted-label {
            color: var(--admin-text-light);
            min-width: 60px;
        }
        .extracted-value {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            color: var(--admin-text);
            background: var(--admin-bg);
            padding: 4px 8px;
            border-radius: 4px;
            word-break: break-all;
        }

        /* Color Picker Grid */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .color-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .color-item label {
            font-size: 12px;
            font-weight: 500;
            color: var(--admin-text-light);
        }
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--admin-bg);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--admin-border);
        }
        .color-picker-wrapper input[type="color"] {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 0;
            background: none;
        }
        .color-picker-wrapper input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker-wrapper input[type="color"]::-webkit-color-swatch {
            border: 2px solid white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .color-hex-input {
            flex: 1;
            border: none;
            background: none;
            font-size: 13px;
            font-family: monospace;
            color: var(--admin-text);
            text-transform: uppercase;
        }
        .color-hex-input:focus { outline: none; }

        /* Image Upload */
        .image-upload-area {
            border: 2px dashed var(--admin-border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--admin-bg);
        }
        .image-upload-area:hover {
            border-color: var(--admin-primary);
            background: rgba(99, 102, 241, 0.02);
        }
        .image-upload-area.has-image {
            padding: 12px;
            border-style: solid;
        }
        .image-upload-area.processing {
            opacity: 0.6;
            pointer-events: none;
        }
        .upload-icon {
            width: 48px; height: 48px; margin: 0 auto 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
        }
        .upload-icon svg { width: 24px; height: 24px; fill: white; }
        .upload-text { font-size: 14px; color: var(--admin-text); font-weight: 500; }
        .upload-hint { font-size: 12px; color: var(--admin-text-light); margin-top: 4px; }

        .uploaded-image-preview {
            position: relative;
            display: inline-block;
        }
        .uploaded-image-preview img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 8px;
            object-fit: cover;
        }
        .uploaded-image-preview.avatar img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }
        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 8px;
        }
        .uploaded-image-preview.avatar .image-overlay {
            border-radius: 50%;
        }
        .uploaded-image-preview:hover .image-overlay {
            opacity: 1;
        }
        .change-image-btn, .remove-image-btn {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        .change-image-btn {
            background: var(--admin-primary);
        }
        .change-image-btn:hover {
            background: var(--admin-primary-dark);
        }
        .remove-image-btn {
            background: #ef4444;
        }
        .remove-image-btn:hover {
            background: #dc2626;
        }

        /* Preview Panel */
        .preview-panel {
            position: fixed;
            top: 100px;
            right: 32px;
            width: 400px;
            height: calc(100vh - 130px);
            overflow-y: auto;
            z-index: 100;
        }

        /* Preview Tabs */
        .preview-tabs {
            display: flex;
            gap: 8px;
            padding: 16px 16px 0 16px;
            background: transparent;
            border-radius: 12px 12px 0 0;
        }

        .preview-tab {
            flex: 1;
            padding: 12px 16px;
            background: white;
            border: none;
            border-radius: 8px 8px 0 0;
            color: #6b7280;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-tab:hover {
            background: #f3f4f6;
            color: #4f46e5;
        }

        .preview-tab.active {
            background: #e0e7ff;
            color: #4f46e5;
            font-weight: 700;
            box-shadow: 0 -2px 8px rgba(79, 70, 229, 0.15);
        }

        .preview-content {
            display: none;
        }

        .preview-content.active {
            display: block;
        }

        @media (max-width: 1200px) {
            .preview-panel {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                height: auto;
                overflow-y: visible;
            }
        }

        .preview-card {
            background: var(--admin-card);
            border-radius: 12px;
            box-shadow: var(--admin-shadow-lg);
            overflow: hidden;
        }

        .preview-widget-container {
            padding: 20px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 420px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mini Widget Preview */
        .widget-preview {
            width: 100%;
            max-width: 340px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .preview-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .preview-header-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .preview-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-header-avatar svg { width: 24px; height: 24px; fill: white; }
        .preview-header-info { flex: 1; }
        .preview-header-title { color: white; font-weight: 600; font-size: 15px; }
        .preview-header-status { color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 2px; }

        .preview-messages {
            padding: 16px;
            background: #f8fafc;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preview-message {
            display: flex;
            gap: 8px;
            max-width: 85%;
        }
        .preview-message.agent { align-self: flex-start; }
        .preview-message.user { align-self: flex-end; flex-direction: row-reverse; }

        .preview-msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }
        .preview-msg-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-msg-bubble {
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 13px;
            line-height: 1.4;
        }
        .preview-message.agent .preview-msg-bubble {
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            border-bottom-left-radius: 4px;
        }
        .preview-message.user .preview-msg-bubble {
            color: white;
            border-bottom-right-radius: 4px;
        }

        .preview-input-area {
            padding: 12px 16px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .preview-input {
            flex: 1;
            padding: 10px 14px;
            background: #f1f5f9;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            color: #64748b;
        }
        .preview-send-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .preview-send-btn svg { width: 18px; height: 18px; fill: white; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: var(--admin-bg);
            color: var(--admin-text);
            border: 1px solid var(--admin-border);
        }
        .btn-secondary:hover {
            background: var(--admin-border);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .btn svg { width: 18px; height: 18px; fill: currentColor; }

        .action-buttons {
            display: flex;
            gap: 12px;
            padding: 20px;
            background: var(--admin-bg);
            border-top: 1px solid var(--admin-border);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #10b981;
            color: white;
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .toast svg { width: 20px; height: 20px; fill: white; }

        /* Image upload inputs (hidden) */
        .hidden-input { display: none; }

        /* Path input group for Edge-friendly image selection */
        .path-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .path-input-group .form-input {
            flex: 1;
            padding: 6px 10px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            background: var(--admin-primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-small:hover {
            background: var(--admin-primary-hover);
        }

        /* Avatar thumbnail gallery */
        .avatar-thumbnails {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding: 12px;
            background: var(--admin-bg);
            border-radius: 8px;
            border: 1px solid var(--admin-border);
        }
        .avatar-thumb {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .avatar-thumb:hover {
            border-color: var(--admin-primary);
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }
        .avatar-thumb.selected {
            border-color: var(--admin-primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--admin-bg);
            border-radius: 10px;
            margin-bottom: 16px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--admin-text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: white;
            color: var(--admin-text);
            box-shadow: var(--admin-shadow);
        }
        .tab-btn:hover:not(.active) {
            color: var(--admin-text);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Gradient Picker */
        .gradient-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--admin-border);
            border-radius: 24px;
            transition: 0.3s;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: var(--admin-shadow);
        }
        .toggle-switch input:checked + .toggle-slider {
            background: var(--admin-primary);
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        .toggle-label {
            font-size: 13px;
            color: var(--admin-text-light);
        }

        .gradient-colors {
            display: none;
            gap: 12px;
        }
        .gradient-colors.show {
            display: flex;
        }
        .gradient-colors .color-item {
            flex: 1;
        }

        /* Demo Profiles */
        .profile-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }
        .profile-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--admin-bg);
            border-radius: 8px;
            border: 1px solid var(--admin-border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .profile-item:hover {
            border-color: var(--admin-primary);
            background: rgba(99, 102, 241, 0.02);
        }
        .profile-item.active {
            border-color: var(--admin-primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .profile-info { flex: 1; }
        .profile-name { font-weight: 500; font-size: 14px; color: var(--admin-text); }
        .profile-desc { font-size: 12px; color: var(--admin-text-light); margin-top: 2px; }
        .profile-actions { display: flex; gap: 4px; }
        .profile-btn {
            width: 32px; height: 32px; border: none; background: none;
            border-radius: 6px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            color: var(--admin-text-light); transition: all 0.2s;
        }
        .profile-btn:hover { background: var(--admin-border); color: var(--admin-text); }
        .profile-btn.delete:hover { background: #fee2e2; color: #ef4444; }
        .profile-btn svg { width: 16px; height: 16px; fill: currentColor; }

        .new-profile-row {
            display: flex;
            gap: 8px;
        }
        .new-profile-row input {
            flex: 1;
        }

        /* Config code block */
        .config-code {
            background: #1e293b;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            overflow-x: auto;
        }
        .config-code pre {
            color: #e2e8f0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .config-code .key { color: #7dd3fc; }
        .config-code .string { color: #86efac; }
        .config-code .comment { color: #64748b; }

        .copy-btn {
            position: relative;
            margin-top: 8px;
        }
        .copy-btn.copied::after {
            content: 'Copied!';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            animation: fadeOut 2s forwards;
        }
        @keyframes fadeOut {
            0%, 70% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Import/Export section */
        .import-export-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Status indicator */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--admin-bg);
            border-radius: 8px;
            margin-top: 12px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #94a3b8;
        }
        .status-dot.connected { background: #10b981; }
        .status-dot.error { background: #ef4444; }
        .status-text { font-size: 13px; color: var(--admin-text-light); }

        /* Collapsible sections */
        .section-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px 0;
        }
        .section-toggle svg {
            width: 16px;
            height: 16px;
            fill: var(--admin-text-light);
            transition: transform 0.2s;
        }
        .section-toggle.expanded svg {
            transform: rotate(90deg);
        }
        .collapsible-content {
            display: none;
            padding-top: 12px;
        }
        .collapsible-content.show {
            display: block;
        }

        /* Quick presets */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .preset-btn {
            padding: 12px 8px;
            border: 1px solid var(--admin-border);
            background: var(--admin-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .preset-btn:hover {
            border-color: var(--admin-primary);
        }
        .preset-btn.active {
            border-color: var(--admin-primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .preset-preview {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 auto 6px;
        }
        .preset-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--admin-text);
        }

        /* Launcher Icon Selection */
        .launcher-icon-option:hover {
            border-color: #667eea !important;
            background: #f8f9ff !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        .launcher-icon-option.selected {
            border-color: #667eea !important;
            background: #f0f4ff !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Launcher Preview */
        .launcher-preview-section {
            margin-top: 0;
            padding: 16px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .launcher-preview-label {
            font-size: 13px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 10px;
            display: block;
        }

        .launcher-preview-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 32px 30px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 8px;
            position: relative;
            overflow: visible;
        }

        /* Elegant pulse animation - matching real widget */
        @keyframes elegantPulse {
            0% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4), 
                            0 0 0 0 rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4), 
                            0 0 0 12px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4), 
                            0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        .preview-launcher-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: elegantPulse 2.5s ease-in-out infinite;
        }

        .preview-launcher-btn:hover {
            transform: scale(1.1);
            animation: none;
        }

        .preview-launcher-btn svg {
            width: 26px;
            height: 26px;
            fill: white;
        }

    </style>
</head>
<body>
    <header class="admin-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
            <div>
                <h1>ðŸŽ¨ Chat Widget Customization</h1>
                <p>Personalize your chat widget appearance and branding</p>
            </div>
            <div style="text-align: right; font-size: 12px; color: rgba(255,255,255,0.7); line-height: 1.4;">
                <div style="font-weight: 500;">Version 2.2.0</div>
                <div>Last Updated: Dec 16, 2025</div>
                <div id="lastSavedInfo" style="margin-top: 4px; font-size: 11px;"></div>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <div class="settings-panel">
            <!-- Demo Profiles -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    </div>
                    <div>
                        <h2>Demo Profiles</h2>
                        <p>Save and switch between customer configurations</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="profile-list" id="profileList">
                        <!-- Profiles will be loaded dynamically -->
                    </div>
                    <div class="new-profile-row">
                        <input type="text" class="form-input" id="newProfileName" placeholder="New profile name (e.g., Contoso Demo)">
                        <button class="btn btn-primary btn-sm" onclick="saveAsProfile()">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:white;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            Save
                        </button>
                    </div>
                </div>
            </div>

            <!-- Demo Website Background -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    </div>
                    <div>
                        <h2>Demo Website Background</h2>
                        <p>Set a screenshot as the background behind the widget</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Local Image File Path</label>
                        <input type="text" class="form-input" id="backgroundImageUrl" placeholder="C:\Users\YourName\Pictures\screenshot.png">
                        <p class="form-hint">ðŸ’¡ Right-click your screenshot â†’ "Copy as path" â†’ Paste here. The path will be saved in your profile and persist across sessions.</p>
                    </div>
                </div>
            </div>

            <!-- D365 Configuration -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.64 12 4.18zM4 16.54V9.08l7 3.5v7.46l-7-3.5zm9 3.5v-7.46l7-3.5v7.46l-7 3.5z"/></svg>
                    </div>
                    <div>
                        <h2>D365 Connection</h2>
                        <p>Paste your Live Chat Widget code snippet</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">LCW Embed Code</label>
                        <textarea class="form-input lcw-textarea" id="lcwCode" rows="4" placeholder="Paste your D365 Live Chat Widget script here...&#10;&#10;Example: <script id=&quot;Microsoft_Omnichannel_LCWidget&quot; src=&quot;...&quot; data-app-id=&quot;...&quot; data-org-id=&quot;...&quot; data-org-url=&quot;...&quot;></script>"></textarea>
                        <p class="form-hint">Copy the entire script tag from D365 Omnichannel Administration â†’ Chat Widget â†’ Code Snippet</p>
                    </div>
                    <div class="extracted-values" id="extractedValues" style="display: none;">
                        <div class="extracted-header">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#10b981;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            <span>Values extracted successfully</span>
                        </div>
                        <div class="extracted-grid">
                            <div class="extracted-item">
                                <span class="extracted-label">App ID:</span>
                                <span class="extracted-value" id="extractedAppId">-</span>
                            </div>
                            <div class="extracted-item">
                                <span class="extracted-label">Org ID:</span>
                                <span class="extracted-value" id="extractedOrgId">-</span>
                            </div>
                            <div class="extracted-item">
                                <span class="extracted-label">Org URL:</span>
                                <span class="extracted-value" id="extractedOrgUrl">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="connection-status" id="connectionStatus">
                        <span class="status-dot" id="statusDot"></span>
                        <span class="status-text" id="statusText">Not configured</span>
                    </div>
                </div>
            </div>

            <!-- Widget Mode Selector -->
            <div class="settings-card" id="widgetModeCard">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    </div>
                    <div>
                        <h2>Widget Mode</h2>
                        <p>Choose between standard D365 widget or custom styled widget</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="widget-mode-selector">
                        <label class="mode-option" onclick="console.log('Standard clicked'); document.getElementById('modeStandard').checked = true; toggleWidgetMode('standard');">
                            <input type="radio" name="widgetMode" value="standard" id="modeStandard">
                            <div class="mode-card">
                                <div class="mode-icon">
                                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/></svg>
                                </div>
                                <div class="mode-title">Standard Widget</div>
                                <div class="mode-desc">Use the default D365 Live Chat Widget appearance and behavior</div>
                            </div>
                        </label>
                        <label class="mode-option" onclick="console.log('Custom clicked'); document.getElementById('modeCustom').checked = true; toggleWidgetMode('custom');">
                            <input type="radio" name="widgetMode" value="custom" id="modeCustom" checked>
                            <div class="mode-card">
                                <div class="mode-icon">
                                    <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                                </div>
                                <div class="mode-title">Custom Widget</div>
                                <div class="mode-desc">Use our beautifully styled custom chat widget with full customization</div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Standard Widget Settings Container -->
            <div id="standardWidgetSettings" class="hidden">
                <!-- Contact Authentication for Standard Mode -->
                <div class="settings-card">
                    <div class="card-header">
                        <div class="card-header-icon">
                            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        </div>
                        <div>
                            <h2>Contact Authentication</h2>
                            <p>Automatically authenticate users with D365 contact records</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableStandardAuth">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label">Enable Auto-Authentication</span>
                            </div>
                            <p class="form-help">When enabled, the widget will automatically authenticate users using the contact information below. This links chat sessions to existing D365 contact records without requiring a pre-chat form.</p>
                        </div>
                        <div id="standardAuthFields" class="hidden">
                            <div class="form-group">
                                <label class="form-label">Default Contact Name</label>
                                <input type="text" class="form-input" id="standardAuthName" placeholder="e.g., John Smith">
                                <p class="form-help">The name to authenticate with D365 (maps to 'Name' field in contact record)</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Contact Email</label>
                                <input type="email" class="form-input" id="standardAuthEmail" placeholder="e.g., john@example.com">
                                <p class="form-help">The email to authenticate with D365 (maps to 'emailaddress1' field in contact record)</p>
                            </div>
                            <div class="info-box" style="margin-top: 16px;">
                                <div class="info-icon">ðŸ’¡</div>
                                <div>
                                    <strong>Use Cases:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                        <li>Authenticated portal users (pass their logged-in credentials)</li>
                                        <li>Quick demos without form friction</li>
                                        <li>Skip pre-chat form for known contacts</li>
                                        <li>Single sign-on (SSO) scenarios</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom Widget Settings Container -->
            <div id="customWidgetSettings">

            <!-- Pre-chat Form -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    </div>
                    <div>
                        <h2>Pre-chat Form</h2>
                        <p>Customize the initial greeting and form fields</p>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Enable/Disable Pre-chat Form Toggle -->
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="enablePrechatForm" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Enable Pre-chat Form</span>
                        </div>
                        <p class="form-help">When disabled, the chat will start immediately without collecting user information. You can still authenticate users via Contact Authentication below.</p>
                    </div>
                    
                    <!-- Pre-chat Form Fields -->
                    <div id="prechatFormFields">
                        <div class="form-group">
                            <label class="form-label">Welcome Title</label>
                            <input type="text" class="form-input" id="welcomeTitle" value="Start a conversation" placeholder="e.g., Start a conversation">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Welcome Message</label>
                            <textarea class="form-input" id="welcomeMessage" placeholder="e.g., We're here to help! Please fill out the form below.">We're here to help! Please fill out the form below to start chatting with our team.</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Name Field Label</label>
                            <input type="text" class="form-input" id="nameFieldLabel" value="Your Name" placeholder="e.g., Your Name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Field Label</label>
                            <input type="text" class="form-input" id="emailFieldLabel" value="Email Address" placeholder="e.g., Email Address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Question Field Label</label>
                            <input type="text" class="form-input" id="questionFieldLabel" value="How can we help?" placeholder="e.g., How can we help?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Question Field Placeholder</label>
                            <input type="text" class="form-input" id="questionFieldPlaceholder" value="Describe your question..." placeholder="e.g., Describe your question...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Button Text</label>
                            <input type="text" class="form-input" id="startBtnText" value="Start Chat" placeholder="e.g., Start Chat">
                        </div>
                    </div>
                    
                    <!-- Contact Authentication (shown when pre-chat is disabled) -->
                    <div id="customAuthSection" class="hidden" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableCustomAuth">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label">Enable Contact Authentication</span>
                            </div>
                            <p class="form-help">Automatically authenticate users with D365 contact records. This links chat sessions to existing contacts so agent can see their information.</p>
                        </div>
                        <div id="customAuthFields" class="hidden">
                            <div class="form-group">
                                <label class="form-label">Default Contact Name</label>
                                <input type="text" class="form-input" id="customAuthName" placeholder="e.g., John Smith">
                                <p class="form-help">The name to authenticate with D365 (maps to 'Name' field in contact record)</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Contact Email</label>
                                <input type="email" class="form-input" id="customAuthEmail" placeholder="e.g., john@example.com">
                                <p class="form-help">The email to authenticate with D365 (maps to 'emailaddress1' field in contact record)</p>
                            </div>
                            <div class="info-box" style="margin-top: 16px;">
                                <div class="info-icon">ðŸ’¡</div>
                                <div>
                                    <strong>Use Cases:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                        <li>Authenticated portal users (pass their logged-in credentials)</li>
                                        <li>Quick demos without form friction</li>
                                        <li>Contact record popup for agents</li>
                                        <li>Single sign-on (SSO) scenarios</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Header & Branding -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                    </div>
                    <div>
                        <h2>Header & Branding</h2>
                        <p>Customize the chat header text and logo</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Header Title</label>
                        <input type="text" class="form-input" id="headerTitle" value="Support Chat" placeholder="e.g., Support Chat, Help Desk">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Header Subtitle</label>
                        <input type="text" class="form-input" id="headerSubtitle" value="We're here to help" placeholder="e.g., We're here to help">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company Logo / Header Icon</label>
                        <div class="image-upload-area" id="logoUploadArea">
                            <div class="upload-icon">
                                <svg viewBox="0 0 24 24"><path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"/></svg>
                            </div>
                            <div class="upload-text">Enter image path below</div>
                            <div class="upload-hint">Place images in the img/ folder</div>
                        </div>
                        <div class="path-input-group" style="margin-top: 8px;">
                            <input type="text" class="form-input" id="logoPathInput" placeholder="Enter path: img/logo.png" style="font-size: 12px;">
                            <button type="button" class="btn-small" onclick="applyImagePath('headerLogo', 'logoPathInput', 'logoUploadArea', false)">Apply</button>
                        </div>
                        <p class="form-hint" style="margin-top: 8px;">ðŸ’¡ Right-click your screenshot â†’ "Copy as path" â†’ Paste here. The path will be saved in your profile and persist across sessions.</p>
                    </div>
                </div>
            </div>

            <!-- Fonts -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M9.93 13.5h4.14L12 7.98 9.93 13.5zM20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-4.05 16.5l-1.14-3H9.17l-1.12 3H5.96l5.11-13h1.86l5.11 13h-2.09z"/></svg>
                    </div>
                    <div>
                        <h2>Fonts</h2>
                        <p>Choose the typography for your widget</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Font Family</label>
                        <select class="form-input" id="fontFamily">
                            <optgroup label="System">
                                <option value="system">System Default</option>
                            </optgroup>
                            <optgroup label="Sans-Serif">
                                <option value="inter">Inter</option>
                                <option value="roboto">Roboto</option>
                                <option value="opensans">Open Sans</option>
                                <option value="lato">Lato</option>
                                <option value="poppins">Poppins</option>
                                <option value="montserrat">Montserrat</option>
                                <option value="nunito">Nunito</option>
                                <option value="sourcesans">Source Sans Pro</option>
                                <option value="raleway">Raleway</option>
                                <option value="ubuntu">Ubuntu</option>
                                <option value="rubik">Rubik</option>
                                <option value="worksans">Work Sans</option>
                                <option value="firasans">Fira Sans</option>
                                <option value="dmsans">DM Sans</option>
                                <option value="manrope">Manrope</option>
                                <option value="plusjakarta">Plus Jakarta Sans</option>
                                <option value="outfit">Outfit</option>
                                <option value="lexend">Lexend</option>
                            </optgroup>
                            <optgroup label="Serif">
                                <option value="playfair">Playfair Display</option>
                                <option value="merriweather">Merriweather</option>
                                <option value="lora">Lora</option>
                                <option value="crimson">Crimson Text</option>
                                <option value="libre">Libre Baskerville</option>
                            </optgroup>
                            <optgroup label="Monospace">
                                <option value="jetbrains">JetBrains Mono</option>
                                <option value="firacode">Fira Code</option>
                                <option value="sourcecodepro">Source Code Pro</option>
                            </optgroup>
                            <optgroup label="Display">
                                <option value="quicksand">Quicksand</option>
                                <option value="comfortaa">Comfortaa</option>
                                <option value="righteous">Righteous</option>
                            </optgroup>
                        </select>
                        <p class="form-hint">Select a font style for the chat widget text</p>
                    </div>
                    <div class="font-preview" id="fontPreview">
                        <div class="font-preview-label">Preview:</div>
                        <div class="font-preview-text" id="fontPreviewText">The quick brown fox jumps over the lazy dog</div>
                    </div>
                </div>
            </div>

            <!-- Colors -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                    </div>
                    <div>
                        <h2>Colors</h2>
                        <p>Define your widget color scheme</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="primary">Primary</button>
                        <button class="tab-btn" data-tab="messages">Messages</button>
                        <button class="tab-btn" data-tab="ui">UI Elements</button>
                        <button class="tab-btn" data-tab="launcher">Launcher</button>
                    </div>

                    <!-- Primary Colors Tab -->
                    <div class="tab-content active" id="tab-primary">
                        <div class="gradient-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" id="useGradient" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Use gradient for header & buttons</span>
                        </div>
                        <div class="gradient-colors show" id="gradientColors">
                            <div class="color-item">
                                <label>Gradient Start</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="gradientStart" value="#667eea">
                                    <input type="text" class="color-hex-input" id="gradientStartHex" value="#667eea">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Gradient End</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="gradientEnd" value="#764ba2">
                                    <input type="text" class="color-hex-input" id="gradientEndHex" value="#764ba2">
                                </div>
                            </div>
                        </div>
                        <div class="color-grid" id="solidColorPicker" style="display:none;">
                            <div class="color-item">
                                <label>Primary Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="primaryColor" value="#667eea">
                                    <input type="text" class="color-hex-input" id="primaryColorHex" value="#667eea">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Colors Tab -->
                    <div class="tab-content" id="tab-messages">
                        <div class="color-grid">
                            <div class="color-item">
                                <label>User Bubble</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="userBubbleColor" value="#667eea">
                                    <input type="text" class="color-hex-input" id="userBubbleColorHex" value="#667eea">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>User Text</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="userTextColor" value="#ffffff">
                                    <input type="text" class="color-hex-input" id="userTextColorHex" value="#ffffff">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Agent Bubble</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="agentBubbleColor" value="#ffffff">
                                    <input type="text" class="color-hex-input" id="agentBubbleColorHex" value="#ffffff">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Agent Text</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="agentTextColor" value="#2d3748">
                                    <input type="text" class="color-hex-input" id="agentTextColorHex" value="#2d3748">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>System Message</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="systemMsgColor" value="#e2e8f0">
                                    <input type="text" class="color-hex-input" id="systemMsgColorHex" value="#e2e8f0">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>System Text</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="systemTextColor" value="#64748b">
                                    <input type="text" class="color-hex-input" id="systemTextColorHex" value="#64748b">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- UI Elements Colors Tab -->
                    <div class="tab-content" id="tab-ui">
                        <div class="color-grid">
                            <div class="color-item">
                                <label>Chat Background</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="chatBgColor" value="#f8fafc">
                                    <input type="text" class="color-hex-input" id="chatBgColorHex" value="#f8fafc">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Input Background</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="inputBgColor" value="#ffffff">
                                    <input type="text" class="color-hex-input" id="inputBgColorHex" value="#ffffff">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Input Border</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="inputBorderColor" value="#e2e8f0">
                                    <input type="text" class="color-hex-input" id="inputBorderColorHex" value="#e2e8f0">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Send Button</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="sendBtnColor" value="#667eea">
                                    <input type="text" class="color-hex-input" id="sendBtnColorHex" value="#667eea">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Notification Badge</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="badgeColor" value="#ff4757">
                                    <input type="text" class="color-hex-input" id="badgeColorHex" value="#ff4757">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Launcher Tab -->
                    <div class="tab-content" id="tab-launcher">
                        <div class="color-grid" style="margin-bottom: 24px;">
                            <div class="color-item">
                                <label>Launcher Button Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="launcherColor" value="#667eea">
                                    <input type="text" class="color-hex-input" id="launcherColorHex" value="#667eea">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Launcher Icon</label>
                            <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">Choose the icon for your chat launcher button</p>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                                <button type="button" class="launcher-icon-option selected" data-icon="chat_multiple" onclick="selectLauncherIcon('chat_multiple')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M9.56158 3C5.41944 3 2.06158 6.35786 2.06158 10.5C2.06158 11.6329 2.31325 12.7088 2.76423 13.6734C2.5102 14.6714 2.22638 15.7842 2.03999 16.5147C1.80697 17.428 2.6294 18.2588 3.54374 18.039C4.29396 17.8587 5.44699 17.5819 6.47447 17.337C7.41678 17.7631 8.46241 18 9.56158 18C13.7037 18 17.0616 14.6421 17.0616 10.5C17.0616 6.35786 13.7037 3 9.56158 3ZM3.56158 10.5C3.56158 7.18629 6.24787 4.5 9.56158 4.5C12.8753 4.5 15.5616 7.18629 15.5616 10.5C15.5616 13.8137 12.8753 16.5 9.56158 16.5C8.60084 16.5 7.69487 16.2748 6.89161 15.8749L6.6482 15.7537L6.38368 15.8167C5.46095 16.0363 4.39489 16.2919 3.59592 16.4838C3.79467 15.7047 4.05784 14.6724 4.28601 13.7757L4.35619 13.4998L4.22568 13.2468C3.80145 12.4246 3.56158 11.4914 3.56158 10.5ZM14.5616 21.0001C12.5922 21.0001 10.8001 20.241 9.46191 18.9995C9.49511 18.9999 9.52835 19.0001 9.56163 19.0001C10.2796 19.0001 10.9768 18.911 11.6427 18.7434C12.5067 19.2254 13.5021 19.5001 14.5616 19.5001C15.5223 19.5001 16.4283 19.2748 17.2316 18.8749L17.475 18.7537L17.7395 18.8167C18.6611 19.0361 19.7046 19.2625 20.4787 19.4262C20.3037 18.6757 20.065 17.6711 19.8372 16.7757L19.767 16.4999L19.8975 16.2469C20.3217 15.4247 20.5616 14.4915 20.5616 13.5001C20.5616 11.3853 19.4676 9.52617 17.8146 8.45761C17.6363 7.73435 17.3653 7.04756 17.015 6.41052C19.9523 7.42684 22.0616 10.2171 22.0616 13.5001C22.0616 14.6332 21.8098 15.7094 21.3586 16.6741C21.6117 17.6821 21.8679 18.774 22.0304 19.4773C22.2348 20.3623 21.4554 21.1633 20.563 20.9768C19.8358 20.8248 18.6933 20.581 17.6495 20.3367C16.707 20.763 15.6611 21.0001 14.5616 21.0001Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Multiple</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_multiple_checkmark" onclick="selectLauncherIcon('chat_multiple_checkmark')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M13.0606 8.99827C13.3357 8.68869 13.3079 8.21463 12.9983 7.93944C12.6887 7.66425 12.2146 7.69214 11.9394 8.00173L8.44187 11.9365L7.0029 10.6359C6.69561 10.3582 6.22134 10.3821 5.94359 10.6894C5.66585 10.9967 5.6898 11.471 5.9971 11.7487L7.9971 13.5564C8.14546 13.6905 8.34124 13.7598 8.54094 13.7489C8.74063 13.738 8.92769 13.6477 9.06056 13.4983L13.0606 8.99827ZM2.06158 10.5C2.06158 6.35786 5.41944 3 9.56158 3C13.7037 3 17.0616 6.35786 17.0616 10.5C17.0616 14.6421 13.7037 18 9.56158 18C8.46241 18 7.41678 17.7631 6.47447 17.337C5.44699 17.5819 4.29396 17.8587 3.54374 18.039C2.6294 18.2588 1.80697 17.428 2.03999 16.5147C2.22638 15.7842 2.5102 14.6714 2.76423 13.6734C2.31325 12.7088 2.06158 11.6329 2.06158 10.5ZM9.56158 4.5C6.24787 4.5 3.56158 7.18629 3.56158 10.5C3.56158 11.4914 3.80145 12.4246 4.22568 13.2468L4.35619 13.4998L4.28601 13.7757C4.05784 14.6724 3.79467 15.7047 3.59592 16.4838C4.39489 16.2919 5.46095 16.0363 6.38368 15.8167L6.6482 15.7537L6.89161 15.8749C7.69487 16.2748 8.60084 16.5 9.56158 16.5C12.8753 16.5 15.5616 13.8137 15.5616 10.5C15.5616 7.18629 12.8753 4.5 9.56158 4.5ZM9.46191 18.9995C10.8001 20.241 12.5922 21.0001 14.5616 21.0001C15.6611 21.0001 16.707 20.763 17.6495 20.3367C18.6933 20.581 19.8358 20.8248 20.563 20.9768C21.4554 21.1633 22.2348 20.3623 22.0304 19.4773C21.8679 18.774 21.6117 17.6821 21.3586 16.6741C21.8098 15.7094 22.0616 14.6332 22.0616 13.5001C22.0616 10.2171 19.9523 7.42684 17.015 6.41052C17.3653 7.04756 17.6363 7.73435 17.8146 8.45761C19.4676 9.52617 20.5616 11.3853 20.5616 13.5001C20.5616 14.4915 20.3217 15.4247 19.8975 16.2469L19.767 16.4999L19.8372 16.7757C20.065 17.6711 20.3037 18.6757 20.4787 19.4262C19.7046 19.2625 18.6611 19.0361 17.7395 18.8167L17.475 18.7537L17.2316 18.8749C16.4283 19.2748 15.5223 19.5001 14.5616 19.5001C13.5021 19.5001 12.5067 19.2254 11.6427 18.7434C10.9768 18.911 10.2796 19.0001 9.56163 19.0001C9.52835 19.0001 9.49511 18.9999 9.46191 18.9995Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Multiple Check</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_sparkle" onclick="selectLauncherIcon('chat_sparkle')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M16.0883 6.41228C16.016 6.31886 15.9377 6.2298 15.8539 6.14569C15.5417 5.83255 15.1606 5.59666 14.741 5.45683L13.3632 5.00939C13.257 4.97196 13.165 4.90253 13.1 4.81068C13.0349 4.71883 13 4.60908 13 4.49656C13 4.38404 13.0349 4.27429 13.1 4.18244C13.165 4.09058 13.257 4.02116 13.3632 3.98372L14.741 3.53628C15.1547 3.39352 15.5299 3.15705 15.837 2.84537C16.1357 2.54224 16.3623 2.17595 16.5 1.77372L16.5114 1.73963L16.9592 0.362894C16.9967 0.256782 17.0662 0.164895 17.1581 0.0998993C17.25 0.0349035 17.3598 0 17.4724 0C17.5851 0 17.6949 0.0349035 17.7868 0.0998993C17.8787 0.164895 17.9482 0.256782 17.9857 0.362894L18.4335 1.73963C18.5727 2.15819 18.8077 2.53853 19.1198 2.85041C19.432 3.1623 19.8126 3.39715 20.2315 3.53628L21.6093 3.98372L21.6368 3.99061C21.743 4.02804 21.835 4.09747 21.9 4.18932C21.9651 4.28117 22 4.39092 22 4.50344C22 4.61596 21.9651 4.72571 21.9 4.81756C21.835 4.90942 21.743 4.97884 21.6368 5.01628L20.259 5.46372C19.8402 5.60285 19.4595 5.8377 19.1474 6.14959C18.8353 6.46147 18.6003 6.84181 18.461 7.26037L18.0132 8.63711C18.0092 8.64855 18.0048 8.65983 18 8.67093C17.9605 8.76273 17.8964 8.84212 17.8144 8.9001C17.7224 8.9651 17.6126 9 17.5 9C17.3874 9 17.2776 8.9651 17.1856 8.9001C17.0937 8.8351 17.0242 8.74322 16.9868 8.63711L16.539 7.26037C16.4378 6.95331 16.2851 6.66664 16.0883 6.41228ZM23.7829 10.2132L23.0175 9.9646C22.7848 9.8873 22.5733 9.75683 22.3999 9.58356C22.2265 9.41029 22.0959 9.199 22.0186 8.96646L21.7698 8.20161C21.749 8.14266 21.7104 8.09161 21.6593 8.0555C21.6083 8.01939 21.5473 8 21.4847 8C21.4221 8 21.3611 8.01939 21.31 8.0555C21.259 8.09161 21.2204 8.14266 21.1996 8.20161L20.9508 8.96646C20.875 9.19736 20.7467 9.40761 20.5761 9.58076C20.4055 9.75392 20.1971 9.88529 19.9672 9.9646L19.2018 10.2132C19.1428 10.234 19.0917 10.2725 19.0555 10.3236C19.0194 10.3746 19 10.4356 19 10.4981C19 10.5606 19.0194 10.6216 19.0555 10.6726C19.0917 10.7236 19.1428 10.7622 19.2018 10.783L19.9672 11.0316C20.2003 11.1093 20.412 11.2403 20.5855 11.4143C20.7589 11.5882 20.8893 11.8003 20.9661 12.0335L21.2149 12.7984C21.2357 12.8573 21.2743 12.9084 21.3254 12.9445C21.3764 12.9806 21.4374 13 21.5 13C21.5626 13 21.6236 12.9806 21.6746 12.9445C21.7257 12.9084 21.7643 12.8573 21.7851 12.7984L22.0339 12.0335C22.1113 11.801 22.2418 11.5897 22.4152 11.4164C22.5886 11.2432 22.8001 11.1127 23.0328 11.0354L23.7982 10.7868C23.8572 10.766 23.9083 10.7275 23.9445 10.6764C23.9806 10.6254 24 10.5644 24 10.5019C24 10.4394 23.9806 10.3784 23.9445 10.3274C23.9083 10.2764 23.8572 10.2378 23.7982 10.217L23.7829 10.2132ZM12 2C12.957 2 13.8826 2.13443 14.7589 2.38542C14.6435 2.45713 14.5197 2.51549 14.39 2.55903L13.05 2.99903C12.7677 3.09976 12.5186 3.27531 12.329 3.50625C12.2199 3.5021 12.1102 3.5 12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.1949 20.5 19.68 17.4613 20.3742 13.465C20.4642 13.5981 20.5776 13.7148 20.71 13.809C20.9288 13.9654 21.191 14.0495 21.46 14.0495C21.5752 14.0495 21.6892 14.034 21.7991 14.0041C20.871 18.5665 16.8365 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Sparkle</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_multiple_heart" onclick="selectLauncherIcon('chat_multiple_heart')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M6.3412 8.3412C7.1326 7.5498 8.41849 7.55366 9.21333 8.3485L9.49671 8.63188L9.77626 8.35179C10.5691 7.55898 11.8556 7.56284 12.6518 8.3591C13.4468 9.15408 13.4493 10.4364 12.6597 11.2303L9.73275 14.1556C9.6107 14.2777 9.41283 14.2777 9.29079 14.1556L6.3485 11.2133C5.55366 10.4185 5.5498 9.1326 6.3412 8.3412ZM2.06158 10.5C2.06158 6.35786 5.41944 3 9.56158 3C13.7037 3 17.0616 6.35786 17.0616 10.5C17.0616 14.6421 13.7037 18 9.56158 18C8.46241 18 7.41678 17.7631 6.47447 17.337C5.44699 17.5819 4.29396 17.8587 3.54374 18.039C2.6294 18.2588 1.80697 17.428 2.03999 16.5147C2.22638 15.7842 2.5102 14.6714 2.76423 13.6734C2.31325 12.7088 2.06158 11.6329 2.06158 10.5ZM9.56158 4.5C6.24787 4.5 3.56158 7.18629 3.56158 10.5C3.56158 11.4914 3.80145 12.4246 4.22568 13.2468L4.35619 13.4998L4.28601 13.7757C4.05784 14.6724 3.79467 15.7047 3.59592 16.4838C4.39489 16.2919 5.46095 16.0363 6.38368 15.8167L6.6482 15.7537L6.89161 15.8749C7.69487 16.2748 8.60084 16.5 9.56158 16.5C12.8753 16.5 15.5616 13.8137 15.5616 10.5C15.5616 7.18629 12.8753 4.5 9.56158 4.5ZM9.46191 18.9995C10.8001 20.241 12.5922 21.0001 14.5616 21.0001C15.6611 21.0001 16.707 20.763 17.6495 20.3367C18.6933 20.581 19.8358 20.8248 20.563 20.9768C21.4554 21.1633 22.2348 20.3623 22.0304 19.4773C21.8679 18.774 21.6117 17.6821 21.3586 16.6741C21.8098 15.7094 22.0616 14.6332 22.0616 13.5001C22.0616 10.2171 19.9523 7.42684 17.015 6.41052C17.3653 7.04756 17.6363 7.73435 17.8146 8.45761C19.4676 9.52617 20.5616 11.3853 20.5616 13.5001C20.5616 14.4915 20.3217 15.4247 19.8975 16.2469L19.767 16.4999L19.8372 16.7757C20.065 17.6711 20.3037 18.6757 20.4787 19.4262C19.7046 19.2625 18.6611 19.0361 17.7395 18.8167L17.475 18.7537L17.2316 18.8749C16.4283 19.2748 15.5223 19.5001 14.5616 19.5001C13.5021 19.5001 12.5067 19.2254 11.6427 18.7434C10.9768 18.911 10.2796 19.0001 9.56163 19.0001C9.52835 19.0001 9.49511 18.9999 9.46191 18.9995Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Heart</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_help" onclick="selectLauncherIcon('chat_help')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.6944 20.5 20.5 16.6944 20.5 12C20.5 7.30558 16.6944 3.5 12 3.5ZM12 15.5C12.5523 15.5 13 15.9477 13 16.5C13 17.0523 12.5523 17.5 12 17.5C11.4477 17.5 11 17.0523 11 16.5C11 15.9477 11.4477 15.5 12 15.5ZM12 6.75C13.5188 6.75 14.75 7.98122 14.75 9.5C14.75 10.5108 14.4525 11.074 13.6989 11.8586L13.5303 12.0303C12.9084 12.6522 12.75 12.9163 12.75 13.5C12.75 13.9142 12.4142 14.25 12 14.25C11.5858 14.25 11.25 13.9142 11.25 13.5C11.25 12.4892 11.5475 11.926 12.3011 11.1414L12.4697 10.9697C13.0916 10.3478 13.25 10.0837 13.25 9.5C13.25 8.80964 12.6904 8.25 12 8.25C11.3528 8.25 10.8205 8.74187 10.7565 9.37219L10.75 9.5C10.75 9.91421 10.4142 10.25 10 10.25C9.58579 10.25 9.25 9.91421 9.25 9.5C9.25 7.98122 10.4812 6.75 12 6.75Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Help</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_empty" onclick="selectLauncherIcon('chat_empty')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M5.25 18C3.45507 18 2 16.5449 2 14.75V6.25C2 4.45507 3.45507 3 5.25 3H18.75C20.5449 3 22 4.45507 22 6.25V14.75C22 16.5449 20.5449 18 18.75 18H13.0125L7.99868 21.7507C7.44585 22.1642 6.6625 22.0512 6.24901 21.4984C6.08736 21.2822 6 21.0196 6 20.7499L5.99921 18H5.25ZM12.5135 16.5H18.75C19.7165 16.5 20.5 15.7165 20.5 14.75V6.25C20.5 5.2835 19.7165 4.5 18.75 4.5H5.25C4.2835 4.5 3.5 5.2835 3.5 6.25V14.75C3.5 15.7165 4.2835 16.5 5.25 16.5H7.49879L7.499 17.2498L7.49986 20.2506L12.5135 16.5Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Comment</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_bubbles_question" onclick="selectLauncherIcon('chat_bubbles_question')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M8.14303 6.30723C8.57707 6.07535 9.04414 6.00076 9.49888 6.00073C10.0253 6.0007 10.6367 6.17363 11.1305 6.57829C11.6475 7.00192 11.9989 7.65186 11.9989 8.5C11.9989 9.47459 11.3102 10.0037 10.9219 10.302C10.8918 10.3252 10.8634 10.347 10.8373 10.3675C10.4127 10.7012 10.2489 10.8795 10.2489 11.25C10.2489 11.6642 9.91314 12 9.49892 12C9.08471 12 8.74892 11.6642 8.74892 11.25C8.74892 10.116 9.46017 9.54195 9.91052 9.18806C10.4238 8.78469 10.4989 8.69484 10.4989 8.5C10.4989 8.10296 10.3503 7.87825 10.1798 7.73853C9.98616 7.57985 9.72254 7.50072 9.49896 7.50073C9.20371 7.50075 9.00078 7.54962 8.84982 7.63027C8.70637 7.7069 8.55459 7.84146 8.40826 8.11137C8.21083 8.47551 7.7556 8.61066 7.39146 8.41324C7.02732 8.21582 6.89217 7.76058 7.08959 7.39644C7.35326 6.91012 7.70147 6.54311 8.14303 6.30723ZM9.49909 15.0001C10.0514 15.0001 10.4992 14.5524 10.4992 14.0001C10.4992 13.4477 10.0514 13 9.49909 13C8.94677 13 8.49902 13.4477 8.49902 14.0001C8.49902 14.5524 8.94677 15.0001 9.49909 15.0001ZM9.49908 3C5.35694 3 1.99908 6.35786 1.99908 10.5C1.99908 11.6329 2.25075 12.7088 2.70173 13.6734C2.4477 14.6714 2.16388 15.7842 1.97749 16.5147C1.74447 17.428 2.5669 18.2588 3.48124 18.039C4.23146 17.8587 5.38449 17.5819 6.41197 17.337C7.35428 17.7631 8.39991 18 9.49908 18C13.6412 18 16.9991 14.6421 16.9991 10.5C16.9991 6.35786 13.6412 3 9.49908 3ZM3.49908 10.5C3.49908 7.18629 6.18537 4.5 9.49908 4.5C12.8128 4.5 15.4991 7.18629 15.4991 10.5C15.4991 13.8137 12.8128 16.5 9.49908 16.5C8.53834 16.5 7.63237 16.2748 6.82911 15.8749L6.5857 15.7537L6.32118 15.8167C5.39845 16.0363 4.33239 16.2919 3.53342 16.4838C3.73217 15.7047 3.99534 14.6724 4.22351 13.7757L4.29369 13.4998L4.16318 13.2468C3.73895 12.4246 3.49908 11.4914 3.49908 10.5ZM14.4991 21.0001C12.5297 21.0001 10.7376 20.241 9.39941 18.9995C9.43261 18.9999 9.46585 19.0001 9.49913 19.0001C10.2171 19.0001 10.9143 18.911 11.5802 18.7434C12.4442 19.2254 13.4396 19.5001 14.4991 19.5001C15.4598 19.5001 16.3658 19.2748 17.1691 18.8749L17.4125 18.7537L17.677 18.8167C18.5986 19.0361 19.6421 19.2625 20.4162 19.4262C20.2412 18.6757 20.0025 17.6711 19.7747 16.7757L19.7045 16.4999L19.835 16.2469C20.2592 15.4247 20.4991 14.4915 20.4991 13.5001C20.4991 11.3853 19.4051 9.52617 17.7521 8.45761C17.5738 7.73435 17.3028 7.04756 16.9525 6.41052C19.8898 7.42684 21.9991 10.2171 21.9991 13.5001C21.9991 14.6332 21.7473 15.7094 21.2961 16.6741C21.5492 17.6821 21.8054 18.774 21.9679 19.4773C22.1723 20.3623 21.3929 21.1633 20.5005 20.9768C19.7733 20.8248 18.6308 20.581 17.587 20.3367C16.6445 20.763 15.5986 21.0001 14.4991 21.0001Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Question</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat" onclick="selectLauncherIcon('chat')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.6944 20.5 20.5 16.6944 20.5 12C20.5 7.30558 16.6944 3.5 12 3.5Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="bot" onclick="selectLauncherIcon('bot')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M17.7534 13.9994C18.9961 13.9994 20.0034 15.0068 20.0034 16.2494V17.1545C20.0034 18.2482 19.526 19.2874 18.6961 19.9998C17.1307 21.3437 14.8904 22.0006 12.0004 22.0006C9.11087 22.0006 6.87205 21.344 5.30918 20.0003C4.48056 19.2879 4.00391 18.2495 4.00391 17.1567V16.2494C4.00391 15.0068 5.01127 13.9994 6.25391 13.9994H17.7534ZM17.7534 15.4994H6.25391C5.83969 15.4994 5.50391 15.8352 5.50391 16.2494V17.1567C5.50391 17.8124 5.7899 18.4354 6.28707 18.8629C7.54516 19.9445 9.44117 20.5006 12.0004 20.5006C14.5603 20.5006 16.4582 19.9442 17.7191 18.8617C18.2169 18.4342 18.5034 17.8107 18.5034 17.1545V16.2494C18.5034 15.8352 18.1676 15.4994 17.7534 15.4994ZM11.8989 2.00685L12.0007 2C12.3804 2 12.6942 2.28215 12.7438 2.64823L12.7507 2.75L12.7499 3.499L16.2504 3.49951C17.493 3.49951 18.5004 4.50687 18.5004 5.74951V10.2541C18.5004 11.4967 17.493 12.5041 16.2504 12.5041H7.75036C6.50772 12.5041 5.50036 11.4967 5.50036 10.2541V5.74951C5.50036 4.50687 6.50772 3.49951 7.75036 3.49951L11.2499 3.499L11.2507 2.75C11.2507 2.3703 11.5328 2.05651 11.8989 2.00685L12.0007 2L11.8989 2.00685ZM16.2504 4.99951H7.75036C7.33615 4.99951 7.00036 5.33529 7.00036 5.74951V10.2541C7.00036 10.6683 7.33615 11.0041 7.75036 11.0041H16.2504C16.6646 11.0041 17.0004 10.6683 17.0004 10.2541V5.74951C17.0004 5.33529 16.6646 4.99951 16.2504 4.99951ZM9.74965 6.49951C10.4396 6.49951 10.9989 7.05883 10.9989 7.74879C10.9989 8.43876 10.4396 8.99808 9.74965 8.99808C9.05969 8.99808 8.50036 8.43876 8.50036 7.74879C8.50036 7.05883 9.05969 6.49951 9.74965 6.49951ZM14.2424 6.49951C14.9324 6.49951 15.4917 7.05883 15.4917 7.74879C15.4917 8.43876 14.9324 8.99808 14.2424 8.99808C13.5524 8.99808 12.9931 8.43876 12.9931 7.74879C12.9931 7.05883 13.5524 6.49951 14.2424 6.49951Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Bot</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="bot_sparkle" onclick="selectLauncherIcon('bot_sparkle')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M18.5004 10.2546C18.5004 10.2994 18.4991 10.3438 18.4965 10.3879C18.4546 10.3508 18.4105 10.3159 18.3645 10.2834C18.1037 10.099 17.7921 10 17.4728 10C17.3115 10 17.1522 10.0253 17.0004 10.074V5.74999C17.0004 5.33578 16.6646 4.99999 16.2504 4.99999H7.75036C7.33615 4.99999 7.00036 5.33578 7.00036 5.74999V10.2546C7.00036 10.6688 7.33615 11.0046 7.75036 11.0046H16.0258L16.0166 11.03L16.0125 11.0417L15.5622 12.426L15.5534 12.4524C15.5474 12.4699 15.5411 12.4873 15.5345 12.5046H7.75036C6.50772 12.5046 5.50036 11.4972 5.50036 10.2546V5.74999C5.50036 4.50735 6.50772 3.49999 7.75036 3.49999L11.2499 3.49949L11.2507 2.75049C11.2507 2.37079 11.5328 2.057 11.8989 2.00733L12.0007 2.00049C12.3804 2.00049 12.6942 2.28264 12.7438 2.64872L12.7507 2.75049L12.7499 3.49949L16.2504 3.49999C17.493 3.49999 18.5004 4.50735 18.5004 5.74999V10.2546ZM13.0428 14.0365L13.1554 13.9999H6.25391C5.01127 13.9999 4.00391 15.0073 4.00391 16.2499V17.1572C4.00391 18.25 4.48056 19.2884 5.30918 20.0008C6.87205 21.3445 9.11087 22.0011 12.0004 22.0011C14.0763 22.0011 15.8171 21.6621 17.2132 20.9731C16.9968 20.9321 16.7904 20.8451 16.6087 20.7166C16.3478 20.5322 16.1506 20.2714 16.0442 19.97L16.04 19.9583L16.0096 19.8646C14.9245 20.2865 13.5901 20.5011 12.0004 20.5011C9.44117 20.5011 7.54516 19.945 6.28707 18.8634C5.7899 18.4359 5.50391 17.8129 5.50391 17.1572V16.2499C5.50391 15.8357 5.83969 15.4999 6.25391 15.4999H12.0004L12.0004 15.4966C12.0004 15.1769 12.0996 14.8653 12.2843 14.6045C12.4689 14.3438 12.7299 14.1468 13.0311 14.0406L13.0428 14.0365ZM10.9989 7.74928C10.9989 7.05932 10.4396 6.49999 9.74965 6.49999C9.05969 6.49999 8.50036 7.05932 8.50036 7.74928C8.50036 8.43925 9.05969 8.99857 9.74965 8.99857C10.4396 8.99857 10.9989 8.43925 10.9989 7.74928ZM14.2424 6.49999C14.9324 6.49999 15.4917 7.05932 15.4917 7.74928C15.4917 8.43925 14.9324 8.99857 14.2424 8.99857C13.5524 8.99857 12.9931 8.43925 12.9931 7.74928C12.9931 7.05932 13.5524 6.49999 14.2424 6.49999ZM16.0886 17.4123C16.0163 17.3189 15.9381 17.2298 15.8542 17.1457C15.5421 16.8326 15.161 16.5967 14.7413 16.4568L13.3635 16.0094C13.2573 15.972 13.1654 15.9025 13.1003 15.8107C13.0353 15.7188 13.0004 15.6091 13.0004 15.4966C13.0004 15.384 13.0353 15.2743 13.1003 15.1824C13.1654 15.0906 13.2573 15.0212 13.3635 14.9837L14.7413 14.5363C15.1551 14.3935 15.5302 14.1571 15.8374 13.8454C16.1361 13.5422 16.3626 13.1759 16.5004 12.7737L16.5118 12.7396L16.9596 11.3629C16.997 11.2568 17.0665 11.1649 17.1584 11.0999C17.2504 11.0349 17.3602 11 17.4728 11C17.5854 11 17.6953 11.0349 17.7872 11.0999C17.8791 11.1649 17.9486 11.2568 17.986 11.3629L18.4338 12.7396C18.5731 13.1582 18.8081 13.5385 19.1202 13.8504C19.4323 14.1623 19.813 14.3971 20.2318 14.5363L21.6096 14.9837L21.6372 14.9906C21.7434 15.028 21.8353 15.0975 21.9004 15.1893C21.9654 15.2812 22.0004 15.3909 22.0004 15.5034C22.0004 15.616 21.9654 15.7257 21.9004 15.8176C21.8353 15.9094 21.7434 15.9788 21.6372 16.0163L20.2594 16.4637C19.8405 16.6029 19.4599 16.8377 19.1478 17.1496C18.8356 17.4615 18.6006 17.8418 18.4614 18.2604L18.0136 19.6371C18.0096 19.6486 18.0051 19.6598 18.0004 19.6709C17.9609 19.7627 17.8967 19.8421 17.8147 19.9001C17.7228 19.9651 17.613 20 17.5004 20C17.3878 20 17.2779 19.9651 17.186 19.9001C17.0941 19.8351 17.0246 19.7432 16.9871 19.6371L16.5394 18.2604C16.4382 17.9533 16.2855 17.6666 16.0886 17.4123ZM23.7833 21.2132L23.0179 20.9646C22.7851 20.8873 22.5737 20.7568 22.4003 20.5836C22.2269 20.4103 22.0963 20.199 22.019 19.9665L21.7702 19.2016C21.7494 19.1427 21.7108 19.0916 21.6597 19.0555C21.6086 19.0194 21.5476 19 21.4851 19C21.4225 19 21.3615 19.0194 21.3104 19.0555C21.2593 19.0916 21.2207 19.1427 21.1999 19.2016L20.9512 19.9665C20.8753 20.1974 20.7471 20.4076 20.5765 20.5808C20.4058 20.7539 20.1974 20.8853 19.9676 20.9646L19.2021 21.2132C19.1431 21.234 19.092 21.2725 19.0559 21.3236C19.0198 21.3746 19.0004 21.4356 19.0004 21.4981C19.0004 21.5606 19.0198 21.6216 19.0559 21.6726C19.092 21.7236 19.1431 21.7622 19.2021 21.783L19.9676 22.0316C20.2007 22.1093 20.4124 22.2403 20.5858 22.4143C20.7593 22.5882 20.8896 22.8003 20.9665 23.0335L21.2152 23.7984C21.2361 23.8573 21.2747 23.9084 21.3257 23.9445C21.3768 23.9806 21.4378 24 21.5004 24C21.5629 24 21.6239 23.9806 21.675 23.9445C21.7261 23.9084 21.7647 23.8573 21.7855 23.7984L22.0343 23.0335C22.1116 22.801 22.2422 22.5897 22.4156 22.4164C22.589 22.2432 22.8005 22.1127 23.0332 22.0354L23.7986 21.7868C23.8576 21.766 23.9087 21.7275 23.9448 21.6764C23.981 21.6254 24.0004 21.5644 24.0004 21.5019C24.0004 21.4394 23.981 21.3784 23.9448 21.3274C23.9087 21.2764 23.8576 21.2378 23.7986 21.217L23.7833 21.2132Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Bot Sparkle</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Avatars -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    </div>
                    <div>
                        <h2>Avatars</h2>
                        <p>Upload custom avatars for agents and customers</p>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Default Agent Avatar</label>
                            <div class="image-upload-area" id="agentAvatarArea">
                                <div class="upload-icon">
                                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                </div>
                                <div class="upload-text">Select from gallery or enter path below</div>
                                <div class="upload-hint">Click a thumbnail to select</div>
                            </div>
                            <div class="avatar-thumbnails">
                                <img src="img/headshots/headshot_female1.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'img/headshots/headshot_female1.png', true)" alt="Female 1" title="Female 1">
                                <img src="img/headshots/headshot_female2.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'img/headshots/headshot_female2.png', true)" alt="Female 2" title="Female 2">
                                <img src="img/headshots/headshot_female3.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'img/headshots/headshot_female3.png', true)" alt="Female 3" title="Female 3">
                                <img src="img/headshots/headshot_female4.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'img/headshots/headshot_female4.png', true)" alt="Female 4" title="Female 4">
                                <img src="img/headshots/headshot_male1.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'img/headshots/headshot_male1.png', true)" alt="Male 1" title="Male 1">
                                <img src="img/headshots/headshot_male2.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'img/headshots/headshot_male2.png', true)" alt="Male 2" title="Male 2">
                                <img src="img/headshots/headshot_male3.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'img/headshots/headshot_male3.png', true)" alt="Male 3" title="Male 3">
                                <img src="img/headshots/headshot_male4.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'img/headshots/headshot_male4.png', true)" alt="Male 4" title="Male 4">
                            </div>
                            <div class="path-input-group" style="margin-top: 8px;">
                                <input type="text" class="form-input" id="agentAvatarPathInput" placeholder="Or enter custom path: img/agent.png" style="font-size: 12px;">
                                <button type="button" class="btn-small" onclick="applyImagePath('agentAvatar', 'agentAvatarPathInput', 'agentAvatarArea', true)">Apply</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Customer Avatar</label>
                            <div class="image-upload-area" id="customerAvatarArea">
                                <div class="upload-icon">
                                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                </div>
                                <div class="upload-text">Select from gallery or enter path below</div>
                                <div class="upload-hint">Click a thumbnail to select</div>
                            </div>
                            <div class="avatar-thumbnails">
                                <img src="img/headshots/headshot_female1.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'img/headshots/headshot_female1.png', true)" alt="Female 1" title="Female 1">
                                <img src="img/headshots/headshot_female2.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'img/headshots/headshot_female2.png', true)" alt="Female 2" title="Female 2">
                                <img src="img/headshots/headshot_female3.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'img/headshots/headshot_female3.png', true)" alt="Female 3" title="Female 3">
                                <img src="img/headshots/headshot_female4.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'img/headshots/headshot_female4.png', true)" alt="Female 4" title="Female 4">
                                <img src="img/headshots/headshot_male1.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'img/headshots/headshot_male1.png', true)" alt="Male 1" title="Male 1">
                                <img src="img/headshots/headshot_male2.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'img/headshots/headshot_male2.png', true)" alt="Male 2" title="Male 2">
                                <img src="img/headshots/headshot_male3.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'img/headshots/headshot_male3.png', true)" alt="Male 3" title="Male 3">
                                <img src="img/headshots/headshot_male4.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'img/headshots/headshot_male4.png', true)" alt="Male 4" title="Male 4">
                            </div>
                            <div class="path-input-group" style="margin-top: 8px;">
                                <input type="text" class="form-input" id="customerAvatarPathInput" placeholder="Or enter custom path: img/customer.png" style="font-size: 12px;">
                                <button type="button" class="btn-small" onclick="applyImagePath('customerAvatar', 'customerAvatarPathInput', 'customerAvatarArea', true)">Apply</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Bot Avatar</label>
                            <div class="image-upload-area" id="botAvatarArea">
                                <div class="upload-icon">
                                    <svg viewBox="0 0 24 24"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zM7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5zM16 17H8v-2h8v2zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13z"/></svg>
                                </div>
                                <div class="upload-text">Select from gallery or enter path below</div>
                                <div class="upload-hint">Click a thumbnail to select</div>
                            </div>
                            <div class="avatar-thumbnails">
                                <img src="img/bot/bot1.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'img/bot/bot1.png', true)" alt="Bot 1" title="Bot 1">
                                <img src="img/bot/bot2.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'img/bot/bot2.png', true)" alt="Bot 2" title="Bot 2">
                                <img src="img/bot/bot3.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'img/bot/bot3.png', true)" alt="Bot 3" title="Bot 3">
                                <img src="img/bot/bot4.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'img/bot/bot4.png', true)" alt="Bot 4" title="Bot 4">
                                <img src="img/bot/bot5.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'img/bot/bot5.png', true)" alt="Bot 5" title="Bot 5">
                                <img src="img/bot/bot6.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'img/bot/bot6.png', true)" alt="Bot 6" title="Bot 6">
                                <img src="img/bot/bot7.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'img/bot/bot7.png', true)" alt="Bot 7" title="Bot 7">
                                <img src="img/bot/bot8.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'img/bot/bot8.png', true)" alt="Bot 8" title="Bot 8">
                            </div>
                            <div class="path-input-group" style="margin-top: 8px;">
                                <input type="text" class="form-input" id="botAvatarPathInput" placeholder="Or enter custom path: img/bot.png" style="font-size: 12px;">
                                <button type="button" class="btn-small" onclick="applyImagePath('botAvatar', 'botAvatarPathInput', 'botAvatarArea', true)">Apply</button>
                            </div>
                        </div>
                    </div>
                    <p class="form-hint" style="margin-top: 12px;">These avatars will be used as defaults. Agent's actual photo from D365 will override if available.</p>
                    <p class="form-hint" style="margin-top: 8px;">ðŸ’¡ Right-click your screenshot â†’ "Copy as path" â†’ Paste here. The path will be saved in your profile and persist across sessions.</p>
                </div>
            </div>

            <!-- Import/Export -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>
                    </div>
                    <div>
                        <h2>Import / Export</h2>
                        <p>Share configurations or backup your settings</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="import-export-btns">
                        <button class="btn btn-secondary btn-sm" onclick="exportSettings()">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            Export JSON
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('importFile').click()">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                            Import JSON
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="copyEmbedCode()">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                            Copy Embed Code
                        </button>
                    </div>
                    <input type="file" id="importFile" class="hidden-input" accept=".json" onchange="importSettings(event)">
                    
                    <div class="config-code" id="embedCodeBlock" style="display:none;">
                        <pre id="embedCode"></pre>
                    </div>
                </div>
            </div>

            </div><!-- End customWidgetSettings -->

            <!-- Actions -->
            <div class="settings-card">
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveSettings()">
                        <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                        Save Settings
                    </button>
                    <button class="btn btn-secondary" onclick="resetSettings()" style="background: #dc3545; border-color: #dc3545; color: white;">
                        <svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                        Reset to Default
                    </button>
                    <a href="index.html" target="_blank" class="btn btn-success" id="goToWidgetBtn" style="text-decoration:none;">
                        <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
                        Go to Widget
                    </a>
                </div>
            </div>
        </div>

        <!-- Live Preview -->
        <div class="preview-panel">
            <div class="preview-card">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-header-icon">
                        <svg viewBox="0 0 24 24" style="fill: white;"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                    </div>
                    <div>
                        <h2 style="color: white;">Live Preview</h2>
                        <p style="color: rgba(255,255,255,0.9);">See changes in real-time</p>
                    </div>
                </div>
                
                <!-- Preview Tabs -->
                <div class="preview-tabs">
                    <button class="preview-tab active" onclick="switchPreviewTab('prechat')">Pre-chat Form</button>
                    <button class="preview-tab" onclick="switchPreviewTab('chat')">Chat Preview</button>
                </div>
                
                <!-- Pre-chat Form Preview -->
                <div class="preview-content active" id="prechatPreview">
                <div class="preview-widget-container" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); background-image: none;">
                    <div class="widget-preview" style="background: white; border-radius: 8px;">
                        <div class="preview-header" id="previewPrechatHeader">
                            <div class="preview-header-avatar" id="previewPrechatHeaderAvatar">
                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                            </div>
                            <div class="preview-header-info">
                                <div class="preview-header-title" id="previewPrechatTitle">Support Chat</div>
                                <div class="preview-header-status" id="previewPrechatStatus">We're here to help</div>
                            </div>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px;">
                                <h3 id="previewWelcomeTitle" style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">Start a conversation</h3>
                                <p id="previewWelcomeMessage" style="font-size: 14px; color: #6b7280; line-height: 1.5;">We're here to help! Please fill out the form below to start chatting with our team.</p>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div>
                                    <label id="previewNameLabel" style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 4px;">Your Name</label>
                                    <input type="text" placeholder="Enter your name" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label id="previewEmailLabel" style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 4px;">Email Address</label>
                                    <input type="email" placeholder="your@email.com" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label id="previewQuestionLabel" style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 4px;">How can we help?</label>
                                    <textarea id="previewQuestionPlaceholder" placeholder="Describe your question..." style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; min-height: 70px; resize: vertical;"></textarea>
                                </div>
                                <button id="previewStartBtn" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 14px; cursor: pointer; margin-top: 8px;">Start Chat</button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Chat Preview -->
                <div class="preview-content" id="chatPreview">
                <div class="preview-widget-container">
                    <div class="widget-preview">
                        <div class="preview-header" id="previewHeader">
                            <div class="preview-header-avatar" id="previewHeaderAvatar">
                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                            </div>
                            <div class="preview-header-info">
                                <div class="preview-header-title" id="previewTitle">Support Chat</div>
                                <div class="preview-header-status" id="previewStatus">We're here to help</div>
                            </div>
                        </div>
                        <div class="preview-messages" id="previewMessages">
                            <div class="preview-message agent">
                                <div class="preview-msg-avatar" id="previewBotAvatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">B</div>
                                <div class="preview-msg-bubble" id="previewBotBubble">Hello! How can I help you today?</div>
                            </div>
                            <div class="preview-message user">
                                <div class="preview-msg-avatar" id="previewUserAvatar" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">U</div>
                                <div class="preview-msg-bubble" id="previewUserBubble">Hi, I have a question about my order.</div>
                            </div>
                            <div class="preview-message agent">
                                <div class="preview-msg-avatar" id="previewAgentAvatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">A</div>
                                <div class="preview-msg-bubble" id="previewAgentBubble">I'd be happy to help with that!</div>
                            </div>
                        </div>
                        <div class="preview-input-area" id="previewInputArea">
                            <div class="preview-input">Type your message...</div>
                            <button class="preview-send-btn" id="previewSendBtn">
                                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Launcher Preview -->
                <div class="launcher-preview-section">
                    <label class="launcher-preview-label">Launcher Button Preview</label>
                    <div class="launcher-preview-container">
                        <button class="preview-launcher-btn" id="previewLauncherBtn">
                            <svg viewBox="0 0 24 24" id="previewLauncherIcon">
                                <path d="M9.56158 3C5.41944 3 2.06158 6.35786 2.06158 10.5C2.06158 11.6329 2.31325 12.7088 2.76423 13.6734C2.5102 14.6714 2.22638 15.7842 2.03999 16.5147C1.80697 17.428 2.6294 18.2588 3.54374 18.039C4.29396 17.8587 5.44699 17.5819 6.47447 17.337C7.41678 17.7631 8.46241 18 9.56158 18C13.7037 18 17.0616 14.6421 17.0616 10.5C17.0616 6.35786 13.7037 3 9.56158 3ZM3.56158 10.5C3.56158 7.18629 6.24787 4.5 9.56158 4.5C12.8753 4.5 15.5616 7.18629 15.5616 10.5C15.5616 13.8137 12.8753 16.5 9.56158 16.5C8.60084 16.5 7.69487 16.2748 6.89161 15.8749L6.6482 15.7537L6.38368 15.8167C5.46095 16.0363 4.39489 16.2919 3.59592 16.4838C3.79467 15.7047 4.05784 14.6724 4.28601 13.7757L4.35619 13.4998L4.22568 13.2468C3.80145 12.4246 3.56158 11.4914 3.56158 10.5ZM14.5616 21.0001C12.5922 21.0001 10.8001 20.241 9.46191 18.9995C9.49511 18.9999 9.52835 19.0001 9.56163 19.0001C10.2796 19.0001 10.9768 18.911 11.6427 18.7434C12.5067 19.2254 13.5021 19.5001 14.5616 19.5001C15.5223 19.5001 16.4283 19.2748 17.2316 18.8749L17.475 18.7537L17.7395 18.8167C18.6611 19.0361 19.7046 19.2625 20.4787 19.4262C20.3037 18.6757 20.065 17.6711 19.8372 16.7757L19.767 16.4999L19.8975 16.2469C20.3217 15.4247 20.5616 14.4915 20.5616 13.5001C20.5616 11.3853 19.4676 9.52617 17.8146 8.45761C17.6363 7.73435 17.3653 7.04756 17.015 6.41052C19.9523 7.42684 22.0616 10.2171 22.0616 13.5001C22.0616 14.6332 21.8098 15.7094 21.3586 16.6741C21.6117 17.6821 21.8679 18.774 22.0304 19.4773C22.2348 20.3623 21.4554 21.1633 20.563 20.9768C19.8358 20.8248 18.6933 20.581 17.6495 20.3367C16.707 20.763 15.6611 21.0001 14.5616 21.0001Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        <span id="toastMessage">Settings saved successfully!</span>
    </div>

    <script>
        // Default settings - comprehensive for demos
        const defaultSettings = {
            // D365 Connection
            lcwCode: '',
            orgId: '',
            orgUrl: '',
            widgetId: '',
            // Widget Mode
            widgetMode: 'custom',
            // Standard Widget Authentication
            enableStandardAuth: false,
            standardAuthName: '',
            standardAuthEmail: '',
            enableCustomAuth: false,
            customAuthName: '',
            customAuthEmail: '',
            // Demo Settings
            backgroundImageUrl: '',
            // Header & Branding
            headerTitle: 'Support Chat',
            headerSubtitle: "We're here to help",
            headerLogo: null,
            // Fonts
            fontFamily: 'system',
            // Colors
            useGradient: true,
            gradientStart: '#667eea',
            gradientEnd: '#764ba2',
            primaryColor: '#667eea',
            userBubbleColor: '#667eea',
            userTextColor: '#ffffff',
            agentBubbleColor: '#ffffff',
            agentTextColor: '#2d3748',
            systemMsgColor: '#e2e8f0',
            systemTextColor: '#64748b',
            chatBgColor: '#f8fafc',
            inputBgColor: '#ffffff',
            inputBorderColor: '#e2e8f0',
            sendBtnColor: '#667eea',
            launcherColor: '#667eea',
            launcherIcon: 'chat_multiple',
            badgeColor: '#ff4757',
            // Avatars
            agentAvatar: null,
            customerAvatar: null,
            botAvatar: null,
            // Pre-chat Form
            enablePrechatForm: true,
            enableCustomAuth: false,
            customAuthName: '',
            customAuthEmail: '',
            defaultContactName: '',
            defaultContactEmail: '',
            welcomeTitle: 'Start a conversation',
            welcomeMessage: "We're here to help! Please fill out the form below to start chatting with our team.",
            nameFieldLabel: 'Your Name',
            emailFieldLabel: 'Email Address',
            questionFieldLabel: 'How can we help?',
            questionFieldPlaceholder: 'Describe your question...',
            startBtnText: 'Start Chat'
        };

        let settings = { ...defaultSettings };
        let profiles = [];
        let activeProfileId = null;
        let isInitializing = true; // Flag to prevent auto-save during form population

        // Tab switching
        function switchPreviewTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.preview-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.preview-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tab + 'Preview').classList.add('active');
        }

        const MAX_IMAGE_DATA_LENGTH = 120 * 1024; // ~120KB limit for stored image data URLs

        function isSafeImageData(value) {
            if (typeof value !== 'string' || value.length === 0) return false;
            
            // Accept file paths (like img/logo.png)
            if (value.startsWith('img/') && /\.(png|jpg|jpeg|gif|webp|svg)$/i.test(value)) {
                return true;
            }
            
            // Accept data URLs (legacy support)
            return value.startsWith('data:image') && value.length <= MAX_IMAGE_DATA_LENGTH;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadProfiles();
            loadSettings();
            setupEventListeners();
            updatePreview();
            updateConnectionStatus();
            // Allow auto-save after initial load is complete
            setTimeout(() => {
                isInitializing = false;
                console.log('âœ… Initialization complete - auto-save enabled');
            }, 100);
        });

        // ============ PROFILES MANAGEMENT ============
        function loadProfiles() {
            const saved = localStorage.getItem('chatWidgetProfiles');
            console.log('ðŸ“¦ RAW localStorage data:', saved ? saved.substring(0, 200) + '...' : 'EMPTY');
            if (saved) {
                profiles = JSON.parse(saved);
                console.log('ðŸ“¦ Loaded profiles array. First profile gradientStart:', profiles[0]?.settings?.gradientStart);
            }
            activeProfileId = localStorage.getItem('chatWidgetActiveProfile');
            renderProfiles();
        }

        function saveProfiles() {
            console.log('ðŸ’¾ Saving profiles to localStorage. Total profiles:', profiles.length);
            if (activeProfileId) {
                const activeProfile = profiles.find(p => p.id === activeProfileId);
                if (activeProfile) {
                    console.log('ðŸ’¾ Active profile being saved:', {
                        name: activeProfile.name,
                        primaryColor: activeProfile.settings?.primaryColor,
                        gradientStart: activeProfile.settings?.gradientStart,
                        useGradient: activeProfile.settings?.useGradient,
                        demoWebsiteUrl: activeProfile.settings?.demoWebsiteUrl
                    });
                }
            }
            localStorage.setItem('chatWidgetProfiles', JSON.stringify(profiles));
            
            // Verify the save actually worked
            const verification = localStorage.getItem('chatWidgetProfiles');
            const parsed = JSON.parse(verification);
            if (activeProfileId) {
                const verifiedProfile = parsed.find(p => p.id === activeProfileId);
                console.log('âœ… VERIFIED in localStorage:', {
                    name: verifiedProfile?.name,
                    gradientStart: verifiedProfile?.settings?.gradientStart,
                    primaryColor: verifiedProfile?.settings?.primaryColor
                });
            }
            
            if (activeProfileId) {
                localStorage.setItem('chatWidgetActiveProfile', activeProfileId);
            }
        }

        function renderProfiles() {
            const container = document.getElementById('profileList');
            if (profiles.length === 0) {
                container.innerHTML = '<p style="color: var(--admin-text-light); font-size: 13px; text-align: center; padding: 12px;">No saved profiles. Create one to quickly switch between customer demos.</p>';
                return;
            }

            container.innerHTML = profiles.map(p => {
                let host = 'No D365 configured';
                try {
                    if (p.settings && p.settings.orgUrl) {
                        host = new URL(p.settings.orgUrl).hostname;
                    }
                } catch (e) {
                    host = 'Invalid org URL';
                }

                return `
                <div class="profile-item ${p.id === activeProfileId ? 'active' : ''}" onclick="loadProfile('${p.id}')">
                    <div class="profile-info">
                        <div class="profile-name">${escapeHtml(p.name)}</div>
                        <div class="profile-desc">${host}</div>
                    </div>
                    <div class="profile-actions">
                        <button class="profile-btn" onclick="event.stopPropagation(); updateProfile('${p.id}')" title="Update with current settings">
                            <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                        </button>
                        <button class="profile-btn delete" onclick="event.stopPropagation(); deleteProfile('${p.id}')" title="Delete profile">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function saveAsProfile() {
            const nameInput = document.getElementById('newProfileName');
            const name = nameInput.value.trim();
            if (!name) {
                showToast('Please enter a profile name');
                return;
            }

            updateSettingsFromForm();
            console.log('ðŸ’¾ Saving new profile with backgroundImageUrl:', settings.backgroundImageUrl);
            
            const profile = {
                id: 'profile_' + Date.now(),
                name: name,
                settings: { ...settings },
                createdAt: new Date().toISOString()
            };

            profiles.push(profile);
            activeProfileId = profile.id;
            
            // Also save to chatWidgetSettings so index.html can load it
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
            
            saveProfiles();
            renderProfiles();
            nameInput.value = '';
            showToast(`Profile "${name}" saved!`);
        }

        function loadProfile(id) {
            console.log('ðŸ”„ loadProfile() called with id:', id);
            const profile = profiles.find(p => p.id === id);
            if (!profile) {
                console.log('âŒ Profile not found!');
                return;
            }

            console.log('ðŸ“‚ Loading profile:', profile.name, 'settings:', {
                backgroundImageUrl: profile.settings.backgroundImageUrl,
                gradientStart: profile.settings.gradientStart,
                primaryColor: profile.settings.primaryColor,
                headerTitle: profile.settings.headerTitle
            });
            
            // Temporarily disable auto-save while loading profile
            const wasInitializing = isInitializing;
            isInitializing = true;
            
            // Merge with defaults, ensuring undefined values are replaced with defaults
            settings = { ...defaultSettings, ...profile.settings };
            // Clean up any undefined values (from old profiles created before field existed)
            Object.keys(settings).forEach(key => {
                if (settings[key] === undefined && defaultSettings[key] !== undefined) {
                    settings[key] = defaultSettings[key];
                }
            });
            activeProfileId = id;
            localStorage.setItem('chatWidgetActiveProfile', id);
            
            // Also save to chatWidgetSettings so index.html can load it
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
            
            populateForm();
            updatePreview();
            updateConnectionStatus();
            renderProfiles();
            
            // Re-enable auto-save after a short delay
            setTimeout(() => {
                isInitializing = wasInitializing;
                console.log('âœ… Profile loaded, auto-save re-enabled');
            }, 100);
            
            showToast(`Loaded "${profile.name}"`);
        }

        function updateProfile(id) {
            const profile = profiles.find(p => p.id === id);
            if (!profile) return;

            if (confirm(`Update "${profile.name}" with current settings?`)) {
                updateSettingsFromForm();
                console.log('ðŸ”„ Updating profile:', profile.name, 'backgroundImageUrl:', settings.backgroundImageUrl);
                
                profile.settings = { ...settings };
                profile.updatedAt = new Date().toISOString();
                
                // If this is the active profile, also update chatWidgetSettings
                if (activeProfileId === id) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                }
                
                saveProfiles();
                showToast(`Profile "${profile.name}" updated!`);
            }
        }

        function deleteProfile(id) {
            const profile = profiles.find(p => p.id === id);
            if (!profile) return;

            if (confirm(`Delete profile "${profile.name}"?`)) {
                profiles = profiles.filter(p => p.id !== id);
                if (activeProfileId === id) {
                    activeProfileId = null;
                    localStorage.removeItem('chatWidgetActiveProfile');
                }
                saveProfiles();
                renderProfiles();
                showToast('Profile deleted');
            }
        }

        // ============ SETTINGS MANAGEMENT ============
        // Helper to sanitize image data that's too large
        function sanitizeImageSettings(settingsObj) {
            ['headerLogo', 'agentAvatar', 'customerAvatar'].forEach(key => {
                if (!isSafeImageData(settingsObj[key])) {
                    if (settingsObj[key]) {
                        console.warn(`âš ï¸ Clearing invalid or oversized ${key}`);
                    }
                    settingsObj[key] = null;
                }
            });
            return settingsObj;
        }

        function loadSettings() {
            console.log('ðŸ” loadSettings called - activeProfileId:', activeProfileId);
            // If there's an active profile, load that instead of generic settings
            if (activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    console.log('ðŸ“‚ Loading profile settings:', {
                        name: profile.name,
                        primaryColor: profile.settings?.primaryColor,
                        gradientStart: profile.settings?.gradientStart,
                        useGradient: profile.settings?.useGradient,
                        backgroundImageUrl: profile.settings?.backgroundImageUrl
                    });
                    settings = sanitizeImageSettings({ ...defaultSettings, ...profile.settings });
                    populateForm();
                    return;
                }
            }
            
            // Otherwise, load generic settings (or reset to defaults if no saved settings)
            const saved = localStorage.getItem('chatWidgetSettings');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Only use saved settings that are NOT profile-specific
                // This prevents cross-contamination between profiles
                settings = sanitizeImageSettings({ ...defaultSettings, ...parsed });
                // Update last saved info if available
                if (parsed.lastSaved) {
                    updateLastSavedInfo(parsed.lastSaved);
                }
            } else {
                // No saved settings - start fresh with defaults
                settings = { ...defaultSettings };
            }
            populateForm();
        }

        function populateForm() {
            // D365 Connection - LCW Code
            const lcwTextarea = document.getElementById('lcwCode');
            if (settings.lcwCode) {
                lcwTextarea.value = settings.lcwCode;
                // Parse and display extracted values
                parseLCWCode(settings.lcwCode);
            } else if (settings.orgId && settings.orgUrl && settings.widgetId) {
                // If we have individual values but no lcwCode, reconstruct for display
                showExtractedValues(settings.widgetId, settings.orgId, settings.orgUrl);
            }

            // Widget Mode
            const widgetMode = settings.widgetMode || 'custom';
            document.getElementById('modeStandard').checked = (widgetMode === 'standard');
            document.getElementById('modeCustom').checked = (widgetMode === 'custom');
            toggleWidgetMode(widgetMode);

            // Standard Widget Authentication
            const enableStandardAuth = settings.enableStandardAuth || false;
            const standardAuthCheckbox = document.getElementById('enableStandardAuth');
            if (standardAuthCheckbox) {
                standardAuthCheckbox.checked = enableStandardAuth;
                document.getElementById('standardAuthName').value = settings.standardAuthName || '';
                document.getElementById('standardAuthEmail').value = settings.standardAuthEmail || '';
                toggleStandardAuthFields(enableStandardAuth);
            }

            // Custom Widget Pre-chat Form Toggle
            const enablePrechatForm = settings.enablePrechatForm !== false; // default true
            const prechatFormCheckbox = document.getElementById('enablePrechatForm');
            if (prechatFormCheckbox) {
                prechatFormCheckbox.checked = enablePrechatForm;
                togglePrechatForm(enablePrechatForm);
            }

            // Custom Widget Contact Authentication (when pre-chat is disabled)
            const enableCustomAuth = settings.enableCustomAuth || false;
            const customAuthCheckbox = document.getElementById('enableCustomAuth');
            if (customAuthCheckbox) {
                customAuthCheckbox.checked = enableCustomAuth;
                document.getElementById('customAuthName').value = settings.customAuthName || '';
                document.getElementById('customAuthEmail').value = settings.customAuthEmail || '';
                toggleCustomAuthFields(enableCustomAuth);
            }

            // Text fields
            const bgImageInput = document.getElementById('backgroundImageUrl');
            bgImageInput.value = settings.backgroundImageUrl || '';
            console.log('ðŸ“ Populating form - backgroundImageUrl:', settings.backgroundImageUrl);
            
            document.getElementById('headerTitle').value = settings.headerTitle;
            document.getElementById('headerSubtitle').value = settings.headerSubtitle;
            
            // Font family
            document.getElementById('fontFamily').value = settings.fontFamily || 'system';
            updateFontPreview(settings.fontFamily || 'system');
            
            // Pre-chat form fields
            document.getElementById('welcomeTitle').value = settings.welcomeTitle || defaultSettings.welcomeTitle;
            document.getElementById('welcomeMessage').value = settings.welcomeMessage || defaultSettings.welcomeMessage;
            document.getElementById('nameFieldLabel').value = settings.nameFieldLabel || defaultSettings.nameFieldLabel;
            document.getElementById('emailFieldLabel').value = settings.emailFieldLabel || defaultSettings.emailFieldLabel;
            document.getElementById('questionFieldLabel').value = settings.questionFieldLabel || defaultSettings.questionFieldLabel;
            document.getElementById('startBtnText').value = settings.startBtnText || defaultSettings.startBtnText;

            // Color pickers - MUST be set BEFORE toggleGradient() which calls updateSettingsFromForm()
            const colorFields = [
                'gradientStart', 'gradientEnd', 'primaryColor',
                'userBubbleColor', 'userTextColor', 'agentBubbleColor', 'agentTextColor',
                'systemMsgColor', 'systemTextColor', 'chatBgColor', 'inputBgColor',
                'inputBorderColor', 'sendBtnColor', 'launcherColor', 'badgeColor'
            ];
            
            colorFields.forEach(field => {
                const picker = document.getElementById(field);
                const hex = document.getElementById(field + 'Hex');
                if (picker && settings[field]) {
                    picker.value = settings[field];
                    if (hex) hex.value = settings[field];
                }
            });

            // Gradient toggle - call AFTER colors are populated
            document.getElementById('useGradient').checked = settings.useGradient;
            toggleGradient();

            // Launcher Icon - restore selection
            if (settings.launcherIcon) {
                const iconButtons = document.querySelectorAll('.launcher-icon-option');
                iconButtons.forEach(btn => {
                    if (btn.getAttribute('data-icon') === settings.launcherIcon) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }

            // Images
            [
                { key: 'headerLogo', areaId: 'logoUploadArea', isAvatar: false },
                { key: 'agentAvatar', areaId: 'agentAvatarArea', isAvatar: true },
                { key: 'customerAvatar', areaId: 'customerAvatarArea', isAvatar: true }
            ].forEach(({ key, areaId, isAvatar }) => {
                const area = document.getElementById(areaId);
                if (!area) return;

                if (isSafeImageData(settings[key])) {
                    showUploadedImage(areaId, settings[key], isAvatar);
                } else if (area.classList.contains('has-image')) {
                    removeImage({ stopPropagation: () => {} }, areaId);
                }
            });
        }

        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
                });
            });

            // Widget Mode selector
            document.querySelectorAll('input[name="widgetMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    toggleWidgetMode(e.target.value);
                    updateSettingsFromForm();
                    // Auto-save to active profile
                    if (!isInitializing && activeProfileId) {
                        const profile = profiles.find(p => p.id === activeProfileId);
                        if (profile) {
                            profile.settings = { ...settings };
                            profile.updatedAt = new Date().toISOString();
                            saveProfiles();
                        }
                    }
                    if (!isInitializing) {
                        localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                    }
                });
            });

            // Gradient toggle
            document.getElementById('useGradient').addEventListener('change', toggleGradient);

            // Color pickers sync
            document.querySelectorAll('input[type="color"]').forEach(picker => {
                const hexInput = document.getElementById(picker.id + 'Hex');
                picker.addEventListener('input', () => {
                    if (hexInput) hexInput.value = picker.value;
                    updateSettingsFromForm();
                    updatePreview();
                    // Auto-save to active profile and localStorage (but not during initialization)
                    if (!isInitializing && activeProfileId) {
                        const profile = profiles.find(p => p.id === activeProfileId);
                        if (profile) {
                            profile.settings = { ...settings };
                            profile.updatedAt = new Date().toISOString();
                            saveProfiles();
                        }
                    }
                    if (!isInitializing) {
                        localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                    }
                });
            });

            // Hex inputs sync
            document.querySelectorAll('.color-hex-input').forEach(input => {
                const pickerId = input.id.replace('Hex', '');
                const picker = document.getElementById(pickerId);
                input.addEventListener('input', () => {
                    let val = input.value;
                    if (!val.startsWith('#')) val = '#' + val;
                    if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                        picker.value = val;
                        updateSettingsFromForm();
                        updatePreview();
                        // Auto-save to active profile and localStorage (but not during initialization)
                        if (!isInitializing && activeProfileId) {
                            const profile = profiles.find(p => p.id === activeProfileId);
                            if (profile) {
                                profile.settings = { ...settings };
                                profile.updatedAt = new Date().toISOString();
                                saveProfiles();
                            }
                        }
                        if (!isInitializing) {
                            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                        }
                    }
                });
            });

            // Font family selector
            document.getElementById('fontFamily').addEventListener('change', (e) => {
                updateFontPreview(e.target.value);
                updateSettingsFromForm();
                updatePreview();
                // Auto-save
                if (!isInitializing && activeProfileId) {
                    const profile = profiles.find(p => p.id === activeProfileId);
                    if (profile) {
                        profile.settings = { ...settings };
                        profile.updatedAt = new Date().toISOString();
                        saveProfiles();
                    }
                }
                if (!isInitializing) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                }
            });

            // Text inputs - real-time preview AND auto-save to active profile
            ['backgroundImageUrl', 'headerTitle', 'headerSubtitle', 'welcomeTitle', 'welcomeMessage', 
             'nameFieldLabel', 'emailFieldLabel', 'questionFieldLabel', 'questionFieldPlaceholder', 'startBtnText',
             'standardAuthName', 'standardAuthEmail', 'customAuthName', 'customAuthEmail'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', () => {
                        updateSettingsFromForm();
                        updatePreview();
                        // Auto-save to active profile and localStorage (but not during initialization)
                        if (!isInitializing && activeProfileId) {
                            const profile = profiles.find(p => p.id === activeProfileId);
                            if (profile) {
                                profile.settings = { ...settings };
                                profile.updatedAt = new Date().toISOString();
                                saveProfiles();
                            }
                        }
                        if (!isInitializing) {
                            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                        }
                    });
                }
            });

            // Standard widget authentication toggle
            document.getElementById('enableStandardAuth').addEventListener('change', (e) => {
                toggleStandardAuthFields(e.target.checked);
                updateSettingsFromForm();
                // Auto-save
                if (!isInitializing && activeProfileId) {
                    const profile = profiles.find(p => p.id === activeProfileId);
                    if (profile) {
                        profile.settings = { ...settings };
                        profile.updatedAt = new Date().toISOString();
                        saveProfiles();
                    }
                }
                if (!isInitializing) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                }
            });

            // Custom widget pre-chat form toggle
            document.getElementById('enablePrechatForm').addEventListener('change', (e) => {
                togglePrechatForm(e.target.checked);
                updateSettingsFromForm();
                updatePreview();
                // Auto-save
                if (!isInitializing && activeProfileId) {
                    const profile = profiles.find(p => p.id === activeProfileId);
                    if (profile) {
                        profile.settings = { ...settings };
                        profile.updatedAt = new Date().toISOString();
                        saveProfiles();
                    }
                }
                if (!isInitializing) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                }
            });

            // Custom widget contact authentication toggle
            document.getElementById('enableCustomAuth').addEventListener('change', (e) => {
                toggleCustomAuthFields(e.target.checked);
                updateSettingsFromForm();
                // Auto-save
                if (!isInitializing && activeProfileId) {
                    const profile = profiles.find(p => p.id === activeProfileId);
                    if (profile) {
                        profile.settings = { ...settings };
                        profile.updatedAt = new Date().toISOString();
                        saveProfiles();
                    }
                }
                if (!isInitializing) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                }
            });

            // LCW Code textarea
            document.getElementById('lcwCode').addEventListener('input', (e) => {
                const code = e.target.value;
                settings.lcwCode = code;
                parseLCWCode(code);
                updateConnectionStatus();
            });

            // File uploads removed - using path input instead for Edge compatibility
        }

        // ============ CONNECTION STATUS ============
        function updateConnectionStatus() {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const { orgId, orgUrl, widgetId } = settings;

            if (orgId && orgUrl && widgetId) {
                dot.className = 'status-dot connected';
                text.textContent = 'Configuration complete - ready to connect';
            } else if (orgId || orgUrl || widgetId) {
                dot.className = 'status-dot error';
                const missing = [];
                if (!orgId) missing.push('Org ID');
                if (!orgUrl) missing.push('Org URL');
                if (!widgetId) missing.push('App ID');
                text.textContent = `Missing: ${missing.join(', ')}`;
            } else {
                dot.className = 'status-dot';
                text.textContent = 'Not configured - widget will run in demo mode';
            }
        }

        // ============ LCW CODE PARSING ============
        function parseLCWCode(code) {
            const extractedContainer = document.getElementById('extractedValues');
            
            if (!code || !code.trim()) {
                extractedContainer.style.display = 'none';
                settings.orgId = '';
                settings.orgUrl = '';
                settings.widgetId = '';
                return;
            }

            // Extract data-app-id (widget ID)
            const appIdMatch = code.match(/data-app-id\s*=\s*["']([^"']+)["']/i);
            const appId = appIdMatch ? appIdMatch[1] : '';

            // Extract data-org-id
            const orgIdMatch = code.match(/data-org-id\s*=\s*["']([^"']+)["']/i);
            const orgId = orgIdMatch ? orgIdMatch[1] : '';

            // Extract data-org-url
            const orgUrlMatch = code.match(/data-org-url\s*=\s*["']([^"']+)["']/i);
            const orgUrl = orgUrlMatch ? orgUrlMatch[1] : '';

            // Update settings
            settings.widgetId = appId;
            settings.orgId = orgId;
            settings.orgUrl = orgUrl;

            // Display extracted values
            if (appId || orgId || orgUrl) {
                showExtractedValues(appId, orgId, orgUrl);
            } else {
                extractedContainer.style.display = 'none';
            }
        }

        function showExtractedValues(appId, orgId, orgUrl) {
            const extractedContainer = document.getElementById('extractedValues');
            document.getElementById('extractedAppId').textContent = appId || '-';
            document.getElementById('extractedOrgId').textContent = orgId || '-';
            document.getElementById('extractedOrgUrl').textContent = orgUrl || '-';
            extractedContainer.style.display = 'block';
        }

        function toggleGradient() {
            const useGradient = document.getElementById('useGradient').checked;
            document.getElementById('gradientColors').classList.toggle('show', useGradient);
            document.getElementById('solidColorPicker').style.display = useGradient ? 'none' : 'grid';
            updateSettingsFromForm();
            updatePreview();
            // Auto-save to active profile and localStorage (but not during initialization)
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            if (!isInitializing) {
                localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
            }
        }

        function toggleWidgetMode(mode) {
            console.log('toggleWidgetMode called with:', mode);
            const customSettings = document.getElementById('customWidgetSettings');
            const standardSettings = document.getElementById('standardWidgetSettings');
            const previewPanel = document.querySelector('.preview-panel');
            
            console.log('customSettings:', customSettings);
            console.log('standardSettings:', standardSettings);
            
            if (mode === 'standard') {
                customSettings.classList.add('hidden');
                standardSettings.classList.remove('hidden');
                if (previewPanel) previewPanel.classList.add('hidden');
            } else {
                customSettings.classList.remove('hidden');
                standardSettings.classList.add('hidden');
                if (previewPanel) previewPanel.classList.remove('hidden');
            }
            
            console.log('After toggle - customSettings.classList:', customSettings.classList.toString());
            console.log('After toggle - standardSettings.classList:', standardSettings.classList.toString());
            
            settings.widgetMode = mode;
            console.log('Widget mode changed to:', mode);
        }

        function updateFontPreview(fontFamily) {
            const previewText = document.getElementById('fontPreviewText');
            const widgetPreview = document.querySelector('.widget-preview');
            
            const fontMap = {
                // System
                'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                // Sans-Serif
                'inter': '"Inter", sans-serif',
                'roboto': '"Roboto", sans-serif',
                'opensans': '"Open Sans", sans-serif',
                'lato': '"Lato", sans-serif',
                'poppins': '"Poppins", sans-serif',
                'montserrat': '"Montserrat", sans-serif',
                'nunito': '"Nunito", sans-serif',
                'sourcesans': '"Source Sans Pro", sans-serif',
                'raleway': '"Raleway", sans-serif',
                'ubuntu': '"Ubuntu", sans-serif',
                'rubik': '"Rubik", sans-serif',
                'worksans': '"Work Sans", sans-serif',
                'firasans': '"Fira Sans", sans-serif',
                'dmsans': '"DM Sans", sans-serif',
                'manrope': '"Manrope", sans-serif',
                'plusjakarta': '"Plus Jakarta Sans", sans-serif',
                'outfit': '"Outfit", sans-serif',
                'lexend': '"Lexend", sans-serif',
                // Serif
                'playfair': '"Playfair Display", serif',
                'merriweather': '"Merriweather", serif',
                'lora': '"Lora", serif',
                'crimson': '"Crimson Text", serif',
                'libre': '"Libre Baskerville", serif',
                // Monospace
                'jetbrains': '"JetBrains Mono", monospace',
                'firacode': '"Fira Code", monospace',
                'sourcecodepro': '"Source Code Pro", monospace',
                // Display
                'quicksand': '"Quicksand", sans-serif',
                'comfortaa': '"Comfortaa", cursive',
                'righteous': '"Righteous", cursive'
            };
            
            const fontStack = fontMap[fontFamily] || fontMap['system'];
            
            if (previewText) {
                previewText.style.fontFamily = fontStack;
            }
            if (widgetPreview) {
                widgetPreview.style.fontFamily = fontStack;
            }
        }

        function showUploadedImage(areaId, src, isAvatar) {
            const area = document.getElementById(areaId);
            if (!area) return;
            
            area.classList.add('has-image');
            
            // Show path info below the image
            const pathInfo = `<div class="path-info" style="font-size:10px;color:#666;margin-top:4px;">${src}</div>`;
            
            area.innerHTML = `
                <div class="uploaded-image-preview ${isAvatar ? 'avatar' : ''}">
                    <img src="${src}" alt="Uploaded" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                    <div class="image-error" style="display:none;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#999;">
                        <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:currentColor;"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                        <span style="font-size:10px;margin-top:4px;">Image not found</span>
                    </div>
                    <div class="image-overlay">
                        <button type="button" class="remove-image-btn">Remove</button>
                    </div>
                </div>
                ${pathInfo}
            `;
            
            area.querySelector('.remove-image-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                removeImage(e, areaId);
            });
        }

        function removeImage(event, areaId) {
            event.stopPropagation();
            const area = document.getElementById(areaId);
            area.classList.remove('has-image');
            
            let settingKey, iconSvg, text;
            if (areaId === 'logoUploadArea') {
                settingKey = 'headerLogo';
                iconSvg = '<svg viewBox="0 0 24 24"><path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"/></svg>';
                text = 'Enter image path below';
            } else if (areaId === 'agentAvatarArea') {
                settingKey = 'agentAvatar';
                iconSvg = '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                text = 'Enter image path below';
            } else {
                settingKey = 'customerAvatar';
                iconSvg = '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                text = 'Enter image path below';
            }

            settings[settingKey] = null;
            area.innerHTML = `
                <div class="upload-icon">${iconSvg}</div>
                <div class="upload-text">${text}</div>
                <div class="upload-hint">Place images in the img/ folder</div>
            `;
            updatePreview();
            
            // Save the change
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
        }

        // Select avatar from thumbnail gallery
        function selectAvatar(settingKey, areaId, imagePath, isAvatar) {
            // Store the path
            settings[settingKey] = imagePath;
            console.log('Avatar selected:', settingKey, '=', imagePath);
            
            // Show preview
            showUploadedImage(areaId, imagePath, isAvatar);
            updatePreview();
            
            // Update thumbnail selection visual
            const parentArea = document.getElementById(areaId).parentElement;
            const thumbnails = parentArea.querySelectorAll('.avatar-thumb');
            thumbnails.forEach(thumb => {
                if (thumb.src.includes(imagePath)) {
                    thumb.classList.add('selected');
                } else {
                    thumb.classList.remove('selected');
                }
            });
            
            // Save settings
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
        }

        // Select launcher icon
        function selectLauncherIcon(iconType) {
            // Update settings
            settings.launcherIcon = iconType;
            
            // Update visual selection
            const iconButtons = document.querySelectorAll('.launcher-icon-option');
            iconButtons.forEach(btn => {
                if (btn.getAttribute('data-icon') === iconType) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            // Update launcher preview
            updateLauncherPreview();
            
            // Save settings
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
        }

        // Update launcher preview
        function updateLauncherPreview() {
            const launcherBtn = document.getElementById('previewLauncherBtn');
            const iconSvg = document.getElementById('previewLauncherIcon');
            
            if (!launcherBtn || !iconSvg) return;
            
            // Update color
            launcherBtn.style.background = settings.launcherColor || '#667eea';
            
            // Update icon based on selected type (Fluent 2)
            const iconPaths = {
                chat_multiple: 'M9.56158 3C5.41944 3 2.06158 6.35786 2.06158 10.5C2.06158 11.6329 2.31325 12.7088 2.76423 13.6734C2.5102 14.6714 2.22638 15.7842 2.03999 16.5147C1.80697 17.428 2.6294 18.2588 3.54374 18.039C4.29396 17.8587 5.44699 17.5819 6.47447 17.337C7.41678 17.7631 8.46241 18 9.56158 18C13.7037 18 17.0616 14.6421 17.0616 10.5C17.0616 6.35786 13.7037 3 9.56158 3ZM3.56158 10.5C3.56158 7.18629 6.24787 4.5 9.56158 4.5C12.8753 4.5 15.5616 7.18629 15.5616 10.5C15.5616 13.8137 12.8753 16.5 9.56158 16.5C8.60084 16.5 7.69487 16.2748 6.89161 15.8749L6.6482 15.7537L6.38368 15.8167C5.46095 16.0363 4.39489 16.2919 3.59592 16.4838C3.79467 15.7047 4.05784 14.6724 4.28601 13.7757L4.35619 13.4998L4.22568 13.2468C3.80145 12.4246 3.56158 11.4914 3.56158 10.5ZM14.5616 21.0001C12.5922 21.0001 10.8001 20.241 9.46191 18.9995C9.49511 18.9999 9.52835 19.0001 9.56163 19.0001C10.2796 19.0001 10.9768 18.911 11.6427 18.7434C12.5067 19.2254 13.5021 19.5001 14.5616 19.5001C15.5223 19.5001 16.4283 19.2748 17.2316 18.8749L17.475 18.7537L17.7395 18.8167C18.6611 19.0361 19.7046 19.2625 20.4787 19.4262C20.3037 18.6757 20.065 17.6711 19.8372 16.7757L19.767 16.4999L19.8975 16.2469C20.3217 15.4247 20.5616 14.4915 20.5616 13.5001C20.5616 11.3853 19.4676 9.52617 17.8146 8.45761C17.6363 7.73435 17.3653 7.04756 17.015 6.41052C19.9523 7.42684 22.0616 10.2171 22.0616 13.5001C22.0616 14.6332 21.8098 15.7094 21.3586 16.6741C21.6117 17.6821 21.8679 18.774 22.0304 19.4773C22.2348 20.3623 21.4554 21.1633 20.563 20.9768C19.8358 20.8248 18.6933 20.581 17.6495 20.3367C16.707 20.763 15.6611 21.0001 14.5616 21.0001Z',
                chat_multiple_checkmark: 'M13.0606 8.99827C13.3357 8.68869 13.3079 8.21463 12.9983 7.93944C12.6887 7.66425 12.2146 7.69214 11.9394 8.00173L8.44187 11.9365L7.0029 10.6359C6.69561 10.3582 6.22134 10.3821 5.94359 10.6894C5.66585 10.9967 5.6898 11.471 5.9971 11.7487L7.9971 13.5564C8.14546 13.6905 8.34124 13.7598 8.54094 13.7489C8.74063 13.738 8.92769 13.6477 9.06056 13.4983L13.0606 8.99827ZM2.06158 10.5C2.06158 6.35786 5.41944 3 9.56158 3C13.7037 3 17.0616 6.35786 17.0616 10.5C17.0616 14.6421 13.7037 18 9.56158 18C8.46241 18 7.41678 17.7631 6.47447 17.337C5.44699 17.5819 4.29396 17.8587 3.54374 18.039C2.6294 18.2588 1.80697 17.428 2.03999 16.5147C2.22638 15.7842 2.5102 14.6714 2.76423 13.6734C2.31325 12.7088 2.06158 11.6329 2.06158 10.5ZM9.56158 4.5C6.24787 4.5 3.56158 7.18629 3.56158 10.5C3.56158 11.4914 3.80145 12.4246 4.22568 13.2468L4.35619 13.4998L4.28601 13.7757C4.05784 14.6724 3.79467 15.7047 3.59592 16.4838C4.39489 16.2919 5.46095 16.0363 6.38368 15.8167L6.6482 15.7537L6.89161 15.8749C7.69487 16.2748 8.60084 16.5 9.56158 16.5C12.8753 16.5 15.5616 13.8137 15.5616 10.5C15.5616 7.18629 12.8753 4.5 9.56158 4.5ZM9.46191 18.9995C10.8001 20.241 12.5922 21.0001 14.5616 21.0001C15.6611 21.0001 16.707 20.763 17.6495 20.3367C18.6933 20.581 19.8358 20.8248 20.563 20.9768C21.4554 21.1633 22.2348 20.3623 22.0304 19.4773C21.8679 18.774 21.6117 17.6821 21.3586 16.6741C21.8098 15.7094 22.0616 14.6332 22.0616 13.5001C22.0616 10.2171 19.9523 7.42684 17.015 6.41052C17.3653 7.04756 17.6363 7.73435 17.8146 8.45761C19.4676 9.52617 20.5616 11.3853 20.5616 13.5001C20.5616 14.4915 20.3217 15.4247 19.8975 16.2469L19.767 16.4999L19.8372 16.7757C20.065 17.6711 20.3037 18.6757 20.4787 19.4262C19.7046 19.2625 18.6611 19.0361 17.7395 18.8167L17.475 18.7537L17.2316 18.8749C16.4283 19.2748 15.5223 19.5001 14.5616 19.5001C13.5021 19.5001 12.5067 19.2254 11.6427 18.7434C10.9768 18.911 10.2796 19.0001 9.56163 19.0001C9.52835 19.0001 9.49511 18.9999 9.46191 18.9995Z',
                chat_sparkle: 'M16.0883 6.41228C16.016 6.31886 15.9377 6.2298 15.8539 6.14569C15.5417 5.83255 15.1606 5.59666 14.741 5.45683L13.3632 5.00939C13.257 4.97196 13.165 4.90253 13.1 4.81068C13.0349 4.71883 13 4.60908 13 4.49656C13 4.38404 13.0349 4.27429 13.1 4.18244C13.165 4.09058 13.257 4.02116 13.3632 3.98372L14.741 3.53628C15.1547 3.39352 15.5299 3.15705 15.837 2.84537C16.1357 2.54224 16.3623 2.17595 16.5 1.77372L16.5114 1.73963L16.9592 0.362894C16.9967 0.256782 17.0662 0.164895 17.1581 0.0998993C17.25 0.0349035 17.3598 0 17.4724 0C17.5851 0 17.6949 0.0349035 17.7868 0.0998993C17.8787 0.164895 17.9482 0.256782 17.9857 0.362894L18.4335 1.73963C18.5727 2.15819 18.8077 2.53853 19.1198 2.85041C19.432 3.1623 19.8126 3.39715 20.2315 3.53628L21.6093 3.98372L21.6368 3.99061C21.743 4.02804 21.835 4.09747 21.9 4.18932C21.9651 4.28117 22 4.39092 22 4.50344C22 4.61596 21.9651 4.72571 21.9 4.81756C21.835 4.90942 21.743 4.97884 21.6368 5.01628L20.259 5.46372C19.8402 5.60285 19.4595 5.8377 19.1474 6.14959C18.8353 6.46147 18.6003 6.84181 18.461 7.26037L18.0132 8.63711C18.0092 8.64855 18.0048 8.65983 18 8.67093C17.9605 8.76273 17.8964 8.84212 17.8144 8.9001C17.7224 8.9651 17.6126 9 17.5 9C17.3874 9 17.2776 8.9651 17.1856 8.9001C17.0937 8.8351 17.0242 8.74322 16.9868 8.63711L16.539 7.26037C16.4378 6.95331 16.2851 6.66664 16.0883 6.41228ZM23.7829 10.2132L23.0175 9.9646C22.7848 9.8873 22.5733 9.75683 22.3999 9.58356C22.2265 9.41029 22.0959 9.199 22.0186 8.96646L21.7698 8.20161C21.749 8.14266 21.7104 8.09161 21.6593 8.0555C21.6083 8.01939 21.5473 8 21.4847 8C21.4221 8 21.3611 8.01939 21.31 8.0555C21.259 8.09161 21.2204 8.14266 21.1996 8.20161L20.9508 8.96646C20.875 9.19736 20.7467 9.40761 20.5761 9.58076C20.4055 9.75392 20.1971 9.88529 19.9672 9.9646L19.2018 10.2132C19.1428 10.234 19.0917 10.2725 19.0555 10.3236C19.0194 10.3746 19 10.4356 19 10.4981C19 10.5606 19.0194 10.6216 19.0555 10.6726C19.0917 10.7236 19.1428 10.7622 19.2018 10.783L19.9672 11.0316C20.2003 11.1093 20.412 11.2403 20.5855 11.4143C20.7589 11.5882 20.8893 11.8003 20.9661 12.0335L21.2149 12.7984C21.2357 12.8573 21.2743 12.9084 21.3254 12.9445C21.3764 12.9806 21.4374 13 21.5 13C21.5626 13 21.6236 12.9806 21.6746 12.9445C21.7257 12.9084 21.7643 12.8573 21.7851 12.7984L22.0339 12.0335C22.1113 11.801 22.2418 11.5897 22.4152 11.4164C22.5886 11.2432 22.8001 11.1127 23.0328 11.0354L23.7982 10.7868C23.8572 10.766 23.9083 10.7275 23.9445 10.6764C23.9806 10.6254 24 10.5644 24 10.5019C24 10.4394 23.9806 10.3784 23.9445 10.3274C23.9083 10.2764 23.8572 10.2378 23.7982 10.217L23.7829 10.2132ZM12 2C12.957 2 13.8826 2.13443 14.7589 2.38542C14.6435 2.45713 14.5197 2.51549 14.39 2.55903L13.05 2.99903C12.7677 3.09976 12.5186 3.27531 12.329 3.50625C12.2199 3.5021 12.1102 3.5 12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.1949 20.5 19.68 17.4613 20.3742 13.465C20.4642 13.5981 20.5776 13.7148 20.71 13.809C20.9288 13.9654 21.191 14.0495 21.46 14.0495C21.5752 14.0495 21.6892 14.034 21.7991 14.0041C20.871 18.5665 16.8365 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2Z',
                chat_multiple_heart: 'M6.3412 8.3412C7.1326 7.5498 8.41849 7.55366 9.21333 8.3485L9.49671 8.63188L9.77626 8.35179C10.5691 7.55898 11.8556 7.56284 12.6518 8.3591C13.4468 9.15408 13.4493 10.4364 12.6597 11.2303L9.73275 14.1556C9.6107 14.2777 9.41283 14.2777 9.29079 14.1556L6.3485 11.2133C5.55366 10.4185 5.5498 9.1326 6.3412 8.3412ZM2.06158 10.5C2.06158 6.35786 5.41944 3 9.56158 3C13.7037 3 17.0616 6.35786 17.0616 10.5C17.0616 14.6421 13.7037 18 9.56158 18C8.46241 18 7.41678 17.7631 6.47447 17.337C5.44699 17.5819 4.29396 17.8587 3.54374 18.039C2.6294 18.2588 1.80697 17.428 2.03999 16.5147C2.22638 15.7842 2.5102 14.6714 2.76423 13.6734C2.31325 12.7088 2.06158 11.6329 2.06158 10.5ZM9.56158 4.5C6.24787 4.5 3.56158 7.18629 3.56158 10.5C3.56158 11.4914 3.80145 12.4246 4.22568 13.2468L4.35619 13.4998L4.28601 13.7757C4.05784 14.6724 3.79467 15.7047 3.59592 16.4838C4.39489 16.2919 5.46095 16.0363 6.38368 15.8167L6.6482 15.7537L6.89161 15.8749C7.69487 16.2748 8.60084 16.5 9.56158 16.5C12.8753 16.5 15.5616 13.8137 15.5616 10.5C15.5616 7.18629 12.8753 4.5 9.56158 4.5ZM9.46191 18.9995C10.8001 20.241 12.5922 21.0001 14.5616 21.0001C15.6611 21.0001 16.707 20.763 17.6495 20.3367C18.6933 20.581 19.8358 20.8248 20.563 20.9768C21.4554 21.1633 22.2348 20.3623 22.0304 19.4773C21.8679 18.774 21.6117 17.6821 21.3586 16.6741C21.8098 15.7094 22.0616 14.6332 22.0616 13.5001C22.0616 10.2171 19.9523 7.42684 17.015 6.41052C17.3653 7.04756 17.6363 7.73435 17.8146 8.45761C19.4676 9.52617 20.5616 11.3853 20.5616 13.5001C20.5616 14.4915 20.3217 15.4247 19.8975 16.2469L19.767 16.4999L19.8372 16.7757C20.065 17.6711 20.3037 18.6757 20.4787 19.4262C19.7046 19.2625 18.6611 19.0361 17.7395 18.8167L17.475 18.7537L17.2316 18.8749C16.4283 19.2748 15.5223 19.5001 14.5616 19.5001C13.5021 19.5001 12.5067 19.2254 11.6427 18.7434C10.9768 18.911 10.2796 19.0001 9.56163 19.0001C9.52835 19.0001 9.49511 18.9999 9.46191 18.9995Z',
                chat_help: 'M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.6944 20.5 20.5 16.6944 20.5 12C20.5 7.30558 16.6944 3.5 12 3.5ZM12 15.5C12.5523 15.5 13 15.9477 13 16.5C13 17.0523 12.5523 17.5 12 17.5C11.4477 17.5 11 17.0523 11 16.5C11 15.9477 11.4477 15.5 12 15.5ZM12 6.75C13.5188 6.75 14.75 7.98122 14.75 9.5C14.75 10.5108 14.4525 11.074 13.6989 11.8586L13.5303 12.0303C12.9084 12.6522 12.75 12.9163 12.75 13.5C12.75 13.9142 12.4142 14.25 12 14.25C11.5858 14.25 11.25 13.9142 11.25 13.5C11.25 12.4892 11.5475 11.926 12.3011 11.1414L12.4697 10.9697C13.0916 10.3478 13.25 10.0837 13.25 9.5C13.25 8.80964 12.6904 8.25 12 8.25C11.3528 8.25 10.8205 8.74187 10.7565 9.37219L10.75 9.5C10.75 9.91421 10.4142 10.25 10 10.25C9.58579 10.25 9.25 9.91421 9.25 9.5C9.25 7.98122 10.4812 6.75 12 6.75Z',
                chat_empty: 'M5.25 18C3.45507 18 2 16.5449 2 14.75V6.25C2 4.45507 3.45507 3 5.25 3H18.75C20.5449 3 22 4.45507 22 6.25V14.75C22 16.5449 20.5449 18 18.75 18H13.0125L7.99868 21.7507C7.44585 22.1642 6.6625 22.0512 6.24901 21.4984C6.08736 21.2822 6 21.0196 6 20.7499L5.99921 18H5.25ZM12.5135 16.5H18.75C19.7165 16.5 20.5 15.7165 20.5 14.75V6.25C20.5 5.2835 19.7165 4.5 18.75 4.5H5.25C4.2835 4.5 3.5 5.2835 3.5 6.25V14.75C3.5 15.7165 4.2835 16.5 5.25 16.5H7.49879L7.499 17.2498L7.49986 20.2506L12.5135 16.5Z',
                chat_bubbles_question: 'M8.14303 6.30723C8.57707 6.07535 9.04414 6.00076 9.49888 6.00073C10.0253 6.0007 10.6367 6.17363 11.1305 6.57829C11.6475 7.00192 11.9989 7.65186 11.9989 8.5C11.9989 9.47459 11.3102 10.0037 10.9219 10.302C10.8918 10.3252 10.8634 10.347 10.8373 10.3675C10.4127 10.7012 10.2489 10.8795 10.2489 11.25C10.2489 11.6642 9.91314 12 9.49892 12C9.08471 12 8.74892 11.6642 8.74892 11.25C8.74892 10.116 9.46017 9.54195 9.91052 9.18806C10.4238 8.78469 10.4989 8.69484 10.4989 8.5C10.4989 8.10296 10.3503 7.87825 10.1798 7.73853C9.98616 7.57985 9.72254 7.50072 9.49896 7.50073C9.20371 7.50075 9.00078 7.54962 8.84982 7.63027C8.70637 7.7069 8.55459 7.84146 8.40826 8.11137C8.21083 8.47551 7.7556 8.61066 7.39146 8.41324C7.02732 8.21582 6.89217 7.76058 7.08959 7.39644C7.35326 6.91012 7.70147 6.54311 8.14303 6.30723ZM9.49909 15.0001C10.0514 15.0001 10.4992 14.5524 10.4992 14.0001C10.4992 13.4477 10.0514 13 9.49909 13C8.94677 13 8.49902 13.4477 8.49902 14.0001C8.49902 14.5524 8.94677 15.0001 9.49909 15.0001ZM9.49908 3C5.35694 3 1.99908 6.35786 1.99908 10.5C1.99908 11.6329 2.25075 12.7088 2.70173 13.6734C2.4477 14.6714 2.16388 15.7842 1.97749 16.5147C1.74447 17.428 2.5669 18.2588 3.48124 18.039C4.23146 17.8587 5.38449 17.5819 6.41197 17.337C7.35428 17.7631 8.39991 18 9.49908 18C13.6412 18 16.9991 14.6421 16.9991 10.5C16.9991 6.35786 13.6412 3 9.49908 3ZM3.49908 10.5C3.49908 7.18629 6.18537 4.5 9.49908 4.5C12.8128 4.5 15.4991 7.18629 15.4991 10.5C15.4991 13.8137 12.8128 16.5 9.49908 16.5C8.53834 16.5 7.63237 16.2748 6.82911 15.8749L6.5857 15.7537L6.32118 15.8167C5.39845 16.0363 4.33239 16.2919 3.53342 16.4838C3.73217 15.7047 3.99534 14.6724 4.22351 13.7757L4.29369 13.4998L4.16318 13.2468C3.73895 12.4246 3.49908 11.4914 3.49908 10.5ZM14.4991 21.0001C12.5297 21.0001 10.7376 20.241 9.39941 18.9995C9.43261 18.9999 9.46585 19.0001 9.49913 19.0001C10.2171 19.0001 10.9143 18.911 11.5802 18.7434C12.4442 19.2254 13.4396 19.5001 14.4991 19.5001C15.4598 19.5001 16.3658 19.2748 17.1691 18.8749L17.4125 18.7537L17.677 18.8167C18.5986 19.0361 19.6421 19.2625 20.4162 19.4262C20.2412 18.6757 20.0025 17.6711 19.7747 16.7757L19.7045 16.4999L19.835 16.2469C20.2592 15.4247 20.4991 14.4915 20.4991 13.5001C20.4991 11.3853 19.4051 9.52617 17.7521 8.45761C17.5738 7.73435 17.3028 7.04756 16.9525 6.41052C19.8898 7.42684 21.9991 10.2171 21.9991 13.5001C21.9991 14.6332 21.7473 15.7094 21.2961 16.6741C21.5492 17.6821 21.8054 18.774 21.9679 19.4773C22.1723 20.3623 21.3929 21.1633 20.5005 20.9768C19.7733 20.8248 18.6308 20.581 17.587 20.3367C16.6445 20.763 15.5986 21.0001 14.4991 21.0001Z',
                chat: 'M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.6944 20.5 20.5 16.6944 20.5 12C20.5 7.30558 16.6944 3.5 12 3.5Z',
                bot: 'M17.7534 13.9994C18.9961 13.9994 20.0034 15.0068 20.0034 16.2494V17.1545C20.0034 18.2482 19.526 19.2874 18.6961 19.9998C17.1307 21.3437 14.8904 22.0006 12.0004 22.0006C9.11087 22.0006 6.87205 21.344 5.30918 20.0003C4.48056 19.2879 4.00391 18.2495 4.00391 17.1567V16.2494C4.00391 15.0068 5.01127 13.9994 6.25391 13.9994H17.7534ZM17.7534 15.4994H6.25391C5.83969 15.4994 5.50391 15.8352 5.50391 16.2494V17.1567C5.50391 17.8124 5.7899 18.4354 6.28707 18.8629C7.54516 19.9445 9.44117 20.5006 12.0004 20.5006C14.5603 20.5006 16.4582 19.9442 17.7191 18.8617C18.2169 18.4342 18.5034 17.8107 18.5034 17.1545V16.2494C18.5034 15.8352 18.1676 15.4994 17.7534 15.4994ZM11.8989 2.00685L12.0007 2C12.3804 2 12.6942 2.28215 12.7438 2.64823L12.7507 2.75L12.7499 3.499L16.2504 3.49951C17.493 3.49951 18.5004 4.50687 18.5004 5.74951V10.2541C18.5004 11.4967 17.493 12.5041 16.2504 12.5041H7.75036C6.50772 12.5041 5.50036 11.4967 5.50036 10.2541V5.74951C5.50036 4.50687 6.50772 3.49951 7.75036 3.49951L11.2499 3.499L11.2507 2.75C11.2507 2.3703 11.5328 2.05651 11.8989 2.00685L12.0007 2L11.8989 2.00685ZM16.2504 4.99951H7.75036C7.33615 4.99951 7.00036 5.33529 7.00036 5.74951V10.2541C7.00036 10.6683 7.33615 11.0041 7.75036 11.0041H16.2504C16.6646 11.0041 17.0004 10.6683 17.0004 10.2541V5.74951C17.0004 5.33529 16.6646 4.99951 16.2504 4.99951ZM9.74965 6.49951C10.4396 6.49951 10.9989 7.05883 10.9989 7.74879C10.9989 8.43876 10.4396 8.99808 9.74965 8.99808C9.05969 8.99808 8.50036 8.43876 8.50036 7.74879C8.50036 7.05883 9.05969 6.49951 9.74965 6.49951ZM14.2424 6.49951C14.9324 6.49951 15.4917 7.05883 15.4917 7.74879C15.4917 8.43876 14.9324 8.99808 14.2424 8.99808C13.5524 8.99808 12.9931 8.43876 12.9931 7.74879C12.9931 7.05883 13.5524 6.49951 14.2424 6.49951Z',
                bot_sparkle: 'M18.5004 10.2546C18.5004 10.2994 18.4991 10.3438 18.4965 10.3879C18.4546 10.3508 18.4105 10.3159 18.3645 10.2834C18.1037 10.099 17.7921 10 17.4728 10C17.3115 10 17.1522 10.0253 17.0004 10.074V5.74999C17.0004 5.33578 16.6646 4.99999 16.2504 4.99999H7.75036C7.33615 4.99999 7.00036 5.33578 7.00036 5.74999V10.2546C7.00036 10.6688 7.33615 11.0046 7.75036 11.0046H16.0258L16.0166 11.03L16.0125 11.0417L15.5622 12.426L15.5534 12.4524C15.5474 12.4699 15.5411 12.4873 15.5345 12.5046H7.75036C6.50772 12.5046 5.50036 11.4972 5.50036 10.2546V5.74999C5.50036 4.50735 6.50772 3.49999 7.75036 3.49999L11.2499 3.49949L11.2507 2.75049C11.2507 2.37079 11.5328 2.057 11.8989 2.00733L12.0007 2.00049C12.3804 2.00049 12.6942 2.28264 12.7438 2.64872L12.7507 2.75049L12.7499 3.49949L16.2504 3.49999C17.493 3.49999 18.5004 4.50735 18.5004 5.74999V10.2546ZM13.0428 14.0365L13.1554 13.9999H6.25391C5.01127 13.9999 4.00391 15.0073 4.00391 16.2499V17.1572C4.00391 18.25 4.48056 19.2884 5.30918 20.0008C6.87205 21.3445 9.11087 22.0011 12.0004 22.0011C14.0763 22.0011 15.8171 21.6621 17.2132 20.9731C16.9968 20.9321 16.7904 20.8451 16.6087 20.7166C16.3478 20.5322 16.1506 20.2714 16.0442 19.97L16.04 19.9583L16.0096 19.8646C14.9245 20.2865 13.5901 20.5011 12.0004 20.5011C9.44117 20.5011 7.54516 19.945 6.28707 18.8634C5.7899 18.4359 5.50391 17.8129 5.50391 17.1572V16.2499C5.50391 15.8357 5.83969 15.4999 6.25391 15.4999H12.0004L12.0004 15.4966C12.0004 15.1769 12.0996 14.8653 12.2843 14.6045C12.4689 14.3438 12.7299 14.1468 13.0311 14.0406L13.0428 14.0365ZM10.9989 7.74928C10.9989 7.05932 10.4396 6.49999 9.74965 6.49999C9.05969 6.49999 8.50036 7.05932 8.50036 7.74928C8.50036 8.43925 9.05969 8.99857 9.74965 8.99857C10.4396 8.99857 10.9989 8.43925 10.9989 7.74928ZM14.2424 6.49999C14.9324 6.49999 15.4917 7.05932 15.4917 7.74928C15.4917 8.43925 14.9324 8.99857 14.2424 8.99857C13.5524 8.99857 12.9931 8.43925 12.9931 7.74928C12.9931 7.05932 13.5524 6.49999 14.2424 6.49999ZM16.0886 17.4123C16.0163 17.3189 15.9381 17.2298 15.8542 17.1457C15.5421 16.8326 15.161 16.5967 14.7413 16.4568L13.3635 16.0094C13.2573 15.972 13.1654 15.9025 13.1003 15.8107C13.0353 15.7188 13.0004 15.6091 13.0004 15.4966C13.0004 15.384 13.0353 15.2743 13.1003 15.1824C13.1654 15.0906 13.2573 15.0212 13.3635 14.9837L14.7413 14.5363C15.1551 14.3935 15.5302 14.1571 15.8374 13.8454C16.1361 13.5422 16.3626 13.1759 16.5004 12.7737L16.5118 12.7396L16.9596 11.3629C16.997 11.2568 17.0665 11.1649 17.1584 11.0999C17.2504 11.0349 17.3602 11 17.4728 11C17.5854 11 17.6953 11.0349 17.7872 11.0999C17.8791 11.1649 17.9486 11.2568 17.986 11.3629L18.4338 12.7396C18.5731 13.1582 18.8081 13.5385 19.1202 13.8504C19.4323 14.1623 19.813 14.3971 20.2318 14.5363L21.6096 14.9837L21.6372 14.9906C21.7434 15.028 21.8353 15.0975 21.9004 15.1893C21.9654 15.2812 22.0004 15.3909 22.0004 15.5034C22.0004 15.616 21.9654 15.7257 21.9004 15.8176C21.8353 15.9094 21.7434 15.9788 21.6372 16.0163L20.2594 16.4637C19.8405 16.6029 19.4599 16.8377 19.1478 17.1496C18.8356 17.4615 18.6006 17.8418 18.4614 18.2604L18.0136 19.6371C18.0096 19.6486 18.0051 19.6598 18.0004 19.6709C17.9609 19.7627 17.8967 19.8421 17.8147 19.9001C17.7228 19.9651 17.613 20 17.5004 20C17.3878 20 17.2779 19.9651 17.186 19.9001C17.0941 19.8351 17.0246 19.7432 16.9871 19.6371L16.5394 18.2604C16.4382 17.9533 16.2855 17.6666 16.0886 17.4123ZM23.7833 21.2132L23.0179 20.9646C22.7851 20.8873 22.5737 20.7568 22.4003 20.5836C22.2269 20.4103 22.0963 20.199 22.019 19.9665L21.7702 19.2016C21.7494 19.1427 21.7108 19.0916 21.6597 19.0555C21.6086 19.0194 21.5476 19 21.4851 19C21.4225 19 21.3615 19.0194 21.3104 19.0555C21.2593 19.0916 21.2207 19.1427 21.1999 19.2016L20.9512 19.9665C20.8753 20.1974 20.7471 20.4076 20.5765 20.5808C20.4058 20.7539 20.1974 20.8853 19.9676 20.9646L19.2021 21.2132C19.1431 21.234 19.092 21.2725 19.0559 21.3236C19.0198 21.3746 19.0004 21.4356 19.0004 21.4981C19.0004 21.5606 19.0198 21.6216 19.0559 21.6726C19.092 21.7236 19.1431 21.7622 19.2021 21.783L19.9676 22.0316C20.2007 22.1093 20.4124 22.2403 20.5858 22.4143C20.7593 22.5882 20.8896 22.8003 20.9665 23.0335L21.2152 23.7984C21.2361 23.8573 21.2747 23.9084 21.3257 23.9445C21.3768 23.9806 21.4378 24 21.5004 24C21.5629 24 21.6239 23.9806 21.675 23.9445C21.7261 23.9084 21.7647 23.8573 21.7855 23.7984L22.0343 23.0335C22.1116 22.801 22.2422 22.5897 22.4156 22.4164C22.589 22.2432 22.8005 22.1127 23.0332 22.0354L23.7986 21.7868C23.8576 21.766 23.9087 21.7275 23.9448 21.6764C23.981 21.6254 24.0004 21.5644 24.0004 21.5019C24.0004 21.4394 23.981 21.3784 23.9448 21.3274C23.9087 21.2764 23.8576 21.2378 23.7986 21.217L23.7833 21.2132Z'
            };
            
            const selectedIcon = settings.launcherIcon || 'chat_multiple';
            iconSvg.innerHTML = `<path d="${iconPaths[selectedIcon]}"/>`;
        }

        // Apply image from path input (Edge-friendly alternative to file upload)
        function applyImagePath(settingKey, inputId, areaId, isAvatar) {
            const input = document.getElementById(inputId);
            let path = input.value.trim();
            
            if (!path) {
                alert('Please enter an image path (e.g., img/logo.png or C:\\Users\\...\\image.png)');
                return;
            }
            
            // Remove surrounding quotes if present
            if ((path.startsWith('"') && path.endsWith('"')) || (path.startsWith("'") && path.endsWith("'"))) {
                path = path.slice(1, -1).trim();
            }
            
            // Validate the path format
            if (!path.match(/\.(png|jpg|jpeg|gif|webp|svg)$/i)) {
                alert('Please enter a valid image path ending with .png, .jpg, .gif, .webp, or .svg');
                return;
            }
            
            // Store the path
            settings[settingKey] = path;
            
            // Show preview
            showUploadedImage(areaId, path, isAvatar);
            updatePreview();
            
            // Clear the input
            input.value = '';
            
            // Save settings
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
        }

        function toggleStandardAuthFields(enabled) {
            const fieldsContainer = document.getElementById('standardAuthFields');
            if (fieldsContainer) {
                if (enabled) {
                    fieldsContainer.classList.remove('hidden');
                } else {
                    fieldsContainer.classList.add('hidden');
                }
            }
        }

        function togglePrechatForm(enabled) {
            const formFields = document.getElementById('prechatFormFields');
            const authSection = document.getElementById('customAuthSection');
            if (formFields) {
                if (enabled) {
                    formFields.classList.remove('hidden');
                } else {
                    formFields.classList.add('hidden');
                }
            }
            if (authSection) {
                if (enabled) {
                    authSection.classList.add('hidden');
                } else {
                    authSection.classList.remove('hidden');
                }
            }
        }

        function toggleCustomAuthFields(enabled) {
            const fieldsContainer = document.getElementById('customAuthFields');
            if (fieldsContainer) {
                if (enabled) {
                    fieldsContainer.classList.remove('hidden');
                } else {
                    fieldsContainer.classList.add('hidden');
                }
            }
        }

        function updateSettingsFromForm() {
            // D365 Connection - lcwCode is updated via its own event listener
            // orgId, orgUrl, widgetId are already set by parseLCWCode()
            settings.lcwCode = document.getElementById('lcwCode').value;
            // Note: orgId, orgUrl, widgetId are already in settings from parseLCWCode

            // Widget Mode
            settings.widgetMode = document.querySelector('input[name="widgetMode"]:checked')?.value || 'custom';

            // Standard Widget Authentication
            const standardAuthCheckbox = document.getElementById('enableStandardAuth');
            if (standardAuthCheckbox) {
                settings.enableStandardAuth = standardAuthCheckbox.checked;
                settings.standardAuthName = document.getElementById('standardAuthName').value;
                settings.standardAuthEmail = document.getElementById('standardAuthEmail').value;
            }

            // Custom Widget Pre-chat Form
            const prechatFormCheckbox = document.getElementById('enablePrechatForm');
            if (prechatFormCheckbox) {
                settings.enablePrechatForm = prechatFormCheckbox.checked;
            }

            // Custom Widget Contact Authentication
            const customAuthCheckbox = document.getElementById('enableCustomAuth');
            if (customAuthCheckbox) {
                settings.enableCustomAuth = customAuthCheckbox.checked;
                settings.customAuthName = document.getElementById('customAuthName').value;
                settings.customAuthEmail = document.getElementById('customAuthEmail').value;
            }

            // Demo Settings
            const bgImageValue = document.getElementById('backgroundImageUrl').value;
            settings.backgroundImageUrl = bgImageValue;
            console.log('âœï¸ updateSettingsFromForm - backgroundImageUrl:', bgImageValue);

            // Header & Branding
            settings.headerTitle = document.getElementById('headerTitle').value;
            settings.headerSubtitle = document.getElementById('headerSubtitle').value;
            // Note: headerLogo is already in settings from handleImageUpload

            // Fonts
            settings.fontFamily = document.getElementById('fontFamily').value;

            // Colors
            settings.useGradient = document.getElementById('useGradient').checked;
            settings.gradientStart = document.getElementById('gradientStart').value;
            settings.gradientEnd = document.getElementById('gradientEnd').value;
            settings.primaryColor = document.getElementById('primaryColor').value;
            settings.userBubbleColor = document.getElementById('userBubbleColor').value;
            settings.userTextColor = document.getElementById('userTextColor').value;
            settings.agentBubbleColor = document.getElementById('agentBubbleColor').value;
            settings.agentTextColor = document.getElementById('agentTextColor').value;
            settings.systemMsgColor = document.getElementById('systemMsgColor').value;
            settings.systemTextColor = document.getElementById('systemTextColor').value;
            settings.chatBgColor = document.getElementById('chatBgColor').value;
            settings.inputBgColor = document.getElementById('inputBgColor').value;
            settings.inputBorderColor = document.getElementById('inputBorderColor').value;
            settings.sendBtnColor = document.getElementById('sendBtnColor').value;
            settings.launcherColor = document.getElementById('launcherColor').value;
            settings.badgeColor = document.getElementById('badgeColor').value;

            // Pre-chat Form
            settings.welcomeTitle = document.getElementById('welcomeTitle').value;
            settings.welcomeMessage = document.getElementById('welcomeMessage').value;
            settings.nameFieldLabel = document.getElementById('nameFieldLabel').value;
            settings.emailFieldLabel = document.getElementById('emailFieldLabel').value;
            settings.questionFieldLabel = document.getElementById('questionFieldLabel').value;
            settings.questionFieldPlaceholder = document.getElementById('questionFieldPlaceholder').value;
            settings.startBtnText = document.getElementById('startBtnText').value;
        }

        function updatePreview() {
            try {
                const gradient = settings.useGradient 
                    ? `linear-gradient(135deg, ${settings.gradientStart} 0%, ${settings.gradientEnd} 100%)`
                    : settings.primaryColor;

                // Apply font to preview
                updateFontPreview(settings.fontFamily || 'system');

                // Preview containers - use simple gradient backgrounds, no demo images
                const prechatContainer = document.querySelector('#prechatPreview .preview-widget-container');
                const chatContainer = document.querySelector('#chatPreview .preview-widget-container');
                
                if (prechatContainer) {
                    prechatContainer.style.backgroundImage = 'none';
                    prechatContainer.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%)';
                }
                
                if (chatContainer) {
                    chatContainer.style.backgroundImage = 'none';
                    chatContainer.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%)';
                }

                // Header
                document.getElementById('previewHeader').style.background = gradient;
                document.getElementById('previewTitle').textContent = settings.headerTitle;
                document.getElementById('previewStatus').textContent = settings.headerSubtitle;

                const headerAvatar = document.getElementById('previewHeaderAvatar');
                if (isSafeImageData(settings.headerLogo)) {
                    headerAvatar.innerHTML = `<img src="${settings.headerLogo}" alt="Logo" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.parentElement.innerHTML='<svg viewBox=\"0 0 24 24\" style=\"fill:white;width:24px;height:24px;\"><path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H5v-2h9v2zm5-4H5v-2h14v2zm0-4H5V7h14v2z\"/></svg>';">`;
                } else {
                    headerAvatar.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:24px;height:24px;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H5v-2h9v2zm5-4H5v-2h14v2zm0-4H5V7h14v2z"/></svg>';
                }

                // Messages area
                document.getElementById('previewMessages').style.background = settings.chatBgColor;

                // Bot bubble (first message)
                const botBubble = document.getElementById('previewBotBubble');
                botBubble.style.background = settings.agentBubbleColor;
                botBubble.style.color = settings.agentTextColor;

                const botAvatar = document.getElementById('previewBotAvatar');
                console.log('Updating bot avatar, settings.botAvatar:', settings.botAvatar, 'isSafe:', isSafeImageData(settings.botAvatar));
                if (isSafeImageData(settings.botAvatar)) {
                    botAvatar.innerHTML = `<img src="${settings.botAvatar}" alt="Bot" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                    botAvatar.style.background = 'none';
                } else {
                    botAvatar.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:18px;height:18px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';
                    botAvatar.style.background = gradient;
                }

                // Agent bubble (second agent message)
                const agentBubble = document.getElementById('previewAgentBubble');
                agentBubble.style.background = settings.agentBubbleColor;
                agentBubble.style.color = settings.agentTextColor;

                const agentAvatar = document.getElementById('previewAgentAvatar');
                if (isSafeImageData(settings.agentAvatar)) {
                    agentAvatar.innerHTML = `<img src="${settings.agentAvatar}" alt="Agent" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                    agentAvatar.style.background = 'none';
                } else {
                    agentAvatar.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:18px;height:18px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                    agentAvatar.style.background = gradient;
                }

                // User bubble
                const userBubble = document.getElementById('previewUserBubble');
                userBubble.style.background = settings.useGradient ? gradient : settings.userBubbleColor;
                userBubble.style.color = settings.userTextColor;

                const userAvatar = document.getElementById('previewUserAvatar');
                if (isSafeImageData(settings.customerAvatar)) {
                    userAvatar.innerHTML = `<img src="${settings.customerAvatar}" alt="User" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                    userAvatar.style.background = 'none';
                } else {
                    userAvatar.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:18px;height:18px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                    userAvatar.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                }

                // Input area & send button
                document.getElementById('previewInputArea').style.background = settings.inputBgColor;
                document.getElementById('previewSendBtn').style.background = settings.useGradient ? gradient : settings.sendBtnColor;

                // Pre-chat Form Preview
                document.getElementById('previewPrechatHeader').style.background = gradient;
                document.getElementById('previewPrechatTitle').textContent = settings.headerTitle;
                document.getElementById('previewPrechatStatus').textContent = settings.headerSubtitle;
                
                const prechatHeaderAvatar = document.getElementById('previewPrechatHeaderAvatar');
                if (isSafeImageData(settings.headerLogo)) {
                    prechatHeaderAvatar.innerHTML = `<img src="${settings.headerLogo}" alt="Logo" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.parentElement.innerHTML='<svg viewBox=\"0 0 24 24\" style=\"fill:white;width:24px;height:24px;\"><path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H5v-2h9v2zm5-4H5v-2h14v2zm0-4H5V7h14v2z\"/></svg>';">`;
                } else {
                    prechatHeaderAvatar.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:24px;height:24px;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H5v-2h9v2zm5-4H5v-2h14v2zm0-4H5V7h14v2z"/></svg>';
                }

                document.getElementById('previewWelcomeTitle').textContent = document.getElementById('welcomeTitle').value || 'Start a conversation';
                document.getElementById('previewWelcomeMessage').textContent = document.getElementById('welcomeMessage').value || 'We\'re here to help! Please fill out the form below.';
                document.getElementById('previewNameLabel').textContent = document.getElementById('nameFieldLabel').value || 'Your Name';
                document.getElementById('previewEmailLabel').textContent = document.getElementById('emailFieldLabel').value || 'Email Address';
                document.getElementById('previewQuestionLabel').textContent = document.getElementById('questionFieldLabel').value || 'How can we help?';
                document.getElementById('previewQuestionPlaceholder').placeholder = document.getElementById('questionFieldPlaceholder').value || 'Describe your question...';
                document.getElementById('previewStartBtn').textContent = document.getElementById('startBtnText').value || 'Start Chat';
                document.getElementById('previewStartBtn').style.background = gradient;
                
                // Update launcher preview
                updateLauncherPreview();
            } catch (err) {
                console.error('Error in updatePreview:', err);
            }
        }

        function saveSettings() {
            updateSettingsFromForm();
            
            // Create a clean copy without blob URLs (they can't be saved)
            const settingsToSave = { ...settings };
            ['headerLogo', 'agentAvatar', 'customerAvatar'].forEach(key => {
                if (!isSafeImageData(settingsToSave[key])) {
                    settingsToSave[key] = null; // Only persist sanitized image data URLs
                }
                delete settingsToSave[key + '_isBlob'];
            });
            
            // Add timestamp
            settingsToSave.lastSaved = new Date().toISOString();
            
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settingsToSave));
            showToast('Settings saved successfully!');
            updateLastSavedInfo(settingsToSave.lastSaved);
        }

        function updateLastSavedInfo(timestamp) {
            const lastSavedEl = document.getElementById('lastSavedInfo');
            if (lastSavedEl && timestamp) {
                const date = new Date(timestamp);
                const formatted = date.toLocaleString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true 
                });
                lastSavedEl.textContent = `Last Saved: ${formatted}`;
            }
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default?')) {
                settings = { ...defaultSettings };
                localStorage.removeItem('chatWidgetSettings');
                activeProfileId = null;
                localStorage.removeItem('chatWidgetActiveProfile');
                
                // Reset D365 LCW code
                document.getElementById('lcwCode').value = '';
                document.getElementById('extractedValues').style.display = 'none';

                // Reset form
                document.getElementById('headerTitle').value = defaultSettings.headerTitle;
                document.getElementById('headerSubtitle').value = defaultSettings.headerSubtitle;
                document.getElementById('useGradient').checked = defaultSettings.useGradient;

                // Reset pre-chat form fields
                document.getElementById('welcomeTitle').value = defaultSettings.welcomeTitle;
                document.getElementById('welcomeMessage').value = defaultSettings.welcomeMessage;
                document.getElementById('nameFieldLabel').value = defaultSettings.nameFieldLabel;
                document.getElementById('emailFieldLabel').value = defaultSettings.emailFieldLabel;
                document.getElementById('questionFieldLabel').value = defaultSettings.questionFieldLabel;
                document.getElementById('startBtnText').value = defaultSettings.startBtnText;
                
                // Reset pre-chat form toggle and custom auth
                document.getElementById('enablePrechatForm').checked = true;
                document.getElementById('enableCustomAuth').checked = false;
                document.getElementById('customAuthName').value = '';
                document.getElementById('customAuthEmail').value = '';
                togglePrechatForm(true);
                toggleCustomAuthFields(false);
                
                // Reset standard auth
                document.getElementById('enableStandardAuth').checked = false;
                document.getElementById('standardAuthName').value = '';
                document.getElementById('standardAuthEmail').value = '';
                toggleStandardAuthFields(false);
                
                // Clear last saved info
                document.getElementById('lastSavedInfo').textContent = '';
                
                // Reset colors
                const colorFields = [
                    'gradientStart', 'gradientEnd', 'primaryColor',
                    'userBubbleColor', 'userTextColor', 'agentBubbleColor', 'agentTextColor',
                    'systemMsgColor', 'systemTextColor', 'chatBgColor', 'inputBgColor',
                    'inputBorderColor', 'sendBtnColor', 'launcherColor', 'badgeColor'
                ];
                colorFields.forEach(field => {
                    const picker = document.getElementById(field);
                    const hex = document.getElementById(field + 'Hex');
                    if (picker) picker.value = defaultSettings[field];
                    if (hex) hex.value = defaultSettings[field];
                });

                // Reset image areas
                ['logoUploadArea', 'agentAvatarArea', 'customerAvatarArea'].forEach(areaId => {
                    const area = document.getElementById(areaId);
                    if (area.classList.contains('has-image')) {
                        // Simulate remove
                        const fakeEvent = { stopPropagation: () => {} };
                        removeImage(fakeEvent, areaId);
                    }
                });

                toggleGradient();
                updatePreview();
                updateConnectionStatus();
                renderProfiles();
                showToast('Settings reset to default!');
            }
        }

        // ============ IMPORT/EXPORT ============
        function exportSettings() {
            updateSettingsFromForm();
            const exportData = {
                version: '1.0',
                exportedAt: new Date().toISOString(),
                settings: settings,
                profiles: profiles
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-widget-config-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Settings exported!');
        }

        function importSettings(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.settings) {
                        settings = { ...defaultSettings, ...data.settings };
                        localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                    }
                    
                    if (data.profiles && Array.isArray(data.profiles)) {
                        // Merge profiles, avoiding duplicates by name
                        const existingNames = profiles.map(p => p.name);
                        data.profiles.forEach(p => {
                            if (!existingNames.includes(p.name)) {
                                p.id = 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                profiles.push(p);
                            }
                        });
                        saveProfiles();
                    }

                    populateForm();
                    updatePreview();
                    updateConnectionStatus();
                    renderProfiles();
                    showToast('Settings imported successfully!');
                } catch (err) {
                    alert('Invalid configuration file');
                    console.error('Import error:', err);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        function copyEmbedCode() {
            updateSettingsFromForm();
            
            const embedCode = `<!-- D365 Modern Chat Widget -->
<script>
  window.chatWidgetConfig = ${JSON.stringify({
    orgId: settings.orgId,
    orgUrl: settings.orgUrl,
    widgetId: settings.widgetId,
    theme: {
      headerTitle: settings.headerTitle,
      headerSubtitle: settings.headerSubtitle,
      useGradient: settings.useGradient,
      gradientStart: settings.gradientStart,
      gradientEnd: settings.gradientEnd,
      primaryColor: settings.primaryColor
    }
  }, null, 2)};
<\/script>
<script src="dist/chat-sdk-bundle.js"><\/script>`;

            // Show the code block
            const codeBlock = document.getElementById('embedCodeBlock');
            const codeEl = document.getElementById('embedCode');
            codeEl.textContent = embedCode;
            codeBlock.style.display = 'block';

            // Copy to clipboard
            navigator.clipboard.writeText(embedCode).then(() => {
                const btn = event.target.closest('.btn');
                btn.classList.add('copied');
                setTimeout(() => btn.classList.remove('copied'), 2000);
            });
        }

        // ============ UTILITY ============
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
