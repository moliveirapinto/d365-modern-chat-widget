<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Studio</title>
    <meta name="description" content="A modern, customizable chat widget for Dynamics 365 Omnichannel and Copilot Studio. Transform your customer engagement with style.">
    
    <!-- Open Graph / Social Media Preview -->
    <meta property="og:title" content="Chat Widget Studio">
    <meta property="og:description" content="A modern, customizable chat widget for Dynamics 365 Omnichannel and Copilot Studio. Transform your customer engagement with style.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://lemon-water-0adbcca0f.1.azurestaticapps.net/">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Chat Widget Studio">
    <meta name="twitter:description" content="A modern, customizable chat widget for Dynamics 365 Omnichannel and Copilot Studio.">
    
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZP59BHHH9F"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-ZP59BHHH9F');
    </script>
    
    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "uopnw0l7a1");
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;500;600&family=Crimson+Text:wght@400;600&family=DM+Sans:wght@400;500;600&family=Fira+Code:wght@400;500&family=Fira+Sans:wght@400;500;600&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&family=Lato:wght@400;700&family=Lexend:wght@400;500;600&family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;500;600&family=Manrope:wght@400;500;600&family=Merriweather:wght@400;700&family=Montserrat:wght@400;500;600&family=Nunito:wght@400;600;700&family=Open+Sans:wght@400;600&family=Outfit:wght@400;500;600&family=Playfair+Display:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600&family=Poppins:wght@400;500;600&family=Quicksand:wght@400;500;600&family=Raleway:wght@400;500;600&family=Righteous&family=Roboto:wght@400;500&family=Rubik:wght@400;500;600&family=Source+Code+Pro:wght@400;500&family=Source+Sans+Pro:wght@400;600&family=Ubuntu:wght@400;500;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --admin-primary: #6366f1;
            --admin-primary-dark: #4f46e5;
            --admin-primary-light: #e0e7ff;
            --admin-bg: #f1f5f9;
            --admin-card: #ffffff;
            --admin-text: #1e293b;
            --admin-text-light: #64748b;
            --admin-text-muted: #94a3b8;
            --admin-border: #e2e8f0;
            --admin-border-light: #f1f5f9;
            --admin-success: #10b981;
            --admin-shadow: 0 1px 2px rgba(0,0,0,0.04);
            --admin-shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
            --admin-shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04);
            --admin-radius: 16px;
            --admin-radius-sm: 10px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--admin-bg);
            color: var(--admin-text);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            font-size: 14px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Header - Cleaner, more minimal */
        .admin-header {
            background: white;
            color: var(--admin-text);
            border-bottom: 1px solid var(--admin-border);
            position: sticky;
            top: 0;
            z-index: 200;
            display: flex;
            flex-direction: column;
        }
        .admin-header-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 32px;
        }
        .admin-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .admin-logo {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .admin-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .admin-header h1 { font-size: 20px; font-weight: 600; letter-spacing: -0.3px; }
        .admin-header p { color: var(--admin-text-light); margin-top: 2px; font-size: 13px; }

        /* Header Actions */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-header-action {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 7px 12px;
            background: white;
            border: 1px solid var(--admin-border);
            border-radius: var(--admin-radius-sm);
            color: var(--admin-text-light);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-header-action:hover {
            background: var(--admin-primary-light);
            border-color: var(--admin-primary);
            color: var(--admin-primary);
        }
        .btn-header-action svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* Main Layout */
        .admin-container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 24px 32px;
            padding-right: 420px;
            overflow-x: hidden;
            overflow-y: visible;
            width: 100%;
        }

        @media (max-width: 1200px) {
            .admin-container {
                padding-right: 32px;
            }
        }

        /* Settings Panel */
        .settings-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 100%;
            overflow-x: hidden;
            overflow-y: visible;
        }

        /* Cards - Cleaner with collapsible sections */
        .settings-card {
            background: var(--admin-card);
            border-radius: var(--admin-radius);
            box-shadow: var(--admin-shadow);
            border: 1px solid var(--admin-border);
            overflow: hidden;
            max-width: 100%;
            transition: box-shadow 0.2s ease;
        }
        .settings-card:hover {
            box-shadow: var(--admin-shadow-md);
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: none;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: background 0.15s ease;
            user-select: none;
        }
        .card-header:hover {
            background: var(--admin-border-light);
        }
        .card-header-icon {
            width: 36px; height: 36px; border-radius: var(--admin-radius-sm);
            display: flex; align-items: center; justify-content: center;
            background: var(--admin-primary-light);
            flex-shrink: 0;
        }
        .card-header-icon svg { width: 18px; height: 18px; fill: var(--admin-primary); }
        .card-header-content { flex: 1; }
        .card-header h2 { font-size: 15px; font-weight: 600; letter-spacing: -0.2px; }
        .card-header p { font-size: 12px; color: var(--admin-text-muted); margin-top: 1px; }
        .card-collapse-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--admin-text-muted);
            transition: transform 0.2s ease;
        }
        .card-collapse-icon svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        .settings-card.collapsed .card-collapse-icon {
            transform: rotate(-90deg);
        }
        .settings-card.collapsed .card-body {
            display: none;
        }
        .settings-card .card-body {
            border-top: 1px solid var(--admin-border);
            animation: slideDown 0.15s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        .card-body { padding: 20px; overflow: visible; }

        /* Form Elements - Lighter styling */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group:last-child { margin-bottom: 0; }
        
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--admin-text-light);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .form-help {
            font-size: 12px;
            color: var(--admin-text-muted);
            margin-top: 6px;
            line-height: 1.5;
        }
        .form-hint {
            font-size: 11px;
            color: var(--admin-text-muted);
            margin-top: 4px;
        }

        /* Widget Mode Selector */
        .widget-mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .mode-option {
            cursor: pointer;
        }
        .mode-option input[type="radio"] {
            display: none;
        }
        .mode-card {
            padding: 20px;
            border: 2px solid var(--admin-border);
            border-radius: 12px;
            background: var(--admin-card);
            transition: all 0.3s ease;
            text-align: center;
        }
        .mode-option input[type="radio"]:checked + .mode-card {
            border-color: #4f46e5;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(6, 182, 212, 0.05));
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .mode-card:hover {
            border-color: #4f46e5;
        }
        .mode-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            background: linear-gradient(135deg, #4f46e5, #06b6d4);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mode-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        .mode-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--admin-text);
            margin-bottom: 6px;
        }
        .mode-desc {
            font-size: 13px;
            color: var(--admin-text-light);
            line-height: 1.4;
        }

        /* Font Preview */
        .font-preview {
            margin-top: 16px;
            padding: 16px;
            background: var(--admin-bg);
            border-radius: 8px;
            border: 1px solid var(--admin-border);
        }
        .font-preview-label {
            font-size: 12px;
            color: var(--admin-text-light);
            margin-bottom: 8px;
        }
        .font-preview-text {
            font-size: 16px;
            color: var(--admin-text);
            line-height: 1.5;
        }
        /* Font families */
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-opensans { font-family: 'Open Sans', sans-serif; }
        .font-lato { font-family: 'Lato', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .font-nunito { font-family: 'Nunito', sans-serif; }
        .font-sourcesans { font-family: 'Source Sans Pro', sans-serif; }
        .font-raleway { font-family: 'Raleway', sans-serif; }
        .font-system { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        /* Custom Widget Settings visibility */
        #customWidgetSettings {
            display: flex;
            flex-direction: column;
            gap: 32px;
            transition: opacity 0.3s ease, max-height 0.3s ease;
        }
        #customWidgetSettings.hidden {
            display: none !important;
        }
        #standardWidgetSettings.hidden {
            display: none !important;
        }
        .preview-panel.hidden {
            display: none;
        }
        .hidden {
            display: none !important;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--admin-border);
            border-radius: var(--admin-radius-sm);
            font-size: 13px;
            transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
            word-wrap: break-word;
            overflow-wrap: break-word;
            background: var(--admin-card);
        }
        .form-input:hover {
            border-color: #cbd5e1;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--admin-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.08);
            background: white;
        }
        .form-input::placeholder {
            color: var(--admin-text-muted);
        }

        select.form-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M2.5 4.5L6 8l3.5-3.5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 70px;
            font-family: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* LCW Textarea */
        .lcw-textarea {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            min-height: 120px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
            background: linear-gradient(to bottom, #f8fafc, #ffffff);
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 14px;
            color: #334155;
            transition: all 0.2s ease;
        }
        .lcw-textarea:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background: #ffffff;
        }
        .lcw-textarea::placeholder {
            color: #94a3b8;
        }
        .extracted-values {
            margin-top: 16px;
            padding: 16px;
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 8px;
        }
        .extracted-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #10b981;
            font-size: 13px;
        }
        .extracted-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .extracted-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .extracted-label {
            color: var(--admin-text-light);
            min-width: 60px;
        }
        .extracted-value {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            color: var(--admin-text);
            background: var(--admin-bg);
            padding: 4px 8px;
            border-radius: 4px;
            word-break: break-all;
        }

        /* Color Palette Gallery */
        .palette-gallery {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--admin-border);
        }
        .palette-gallery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .palette-gallery-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--admin-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .palette-gallery-title svg {
            width: 16px;
            height: 16px;
            fill: var(--admin-primary);
        }
        .palette-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        .palette-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .palette-card:hover {
            border-color: var(--admin-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .palette-card.selected {
            border-color: var(--admin-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        .palette-colors {
            display: flex;
            height: 36px;
        }
        .palette-colors > div {
            flex: 1;
            transition: flex 0.2s ease;
        }
        .palette-card:hover .palette-colors > div:first-child,
        .palette-card:hover .palette-colors > div:last-child {
            flex: 1.2;
        }
        .palette-name {
            padding: 8px 10px;
            font-size: 11px;
            font-weight: 500;
            color: var(--admin-text);
            text-align: center;
            background: #f8fafc;
        }
        .palette-expand-btn {
            background: linear-gradient(135deg, var(--admin-primary) 0%, #764ba2 100%);
            border: none;
            font-size: 12px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            padding: 6px 14px;
            border-radius: 6px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }
        .palette-expand-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Color Picker Grid - Compact layout */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .color-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .color-item label {
            font-size: 11px;
            font-weight: 500;
            color: var(--admin-text-muted);
        }
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 6px 10px;
            border-radius: var(--admin-radius-sm);
            border: 1px solid var(--admin-border);
            transition: border-color 0.15s;
        }
        .color-picker-wrapper:hover {
            border-color: #cbd5e1;
        }
        .color-picker-wrapper input[type="color"] {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            padding: 0;
            background: none;
        }
        .color-picker-wrapper input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker-wrapper input[type="color"]::-webkit-color-swatch {
            border: 2px solid white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .color-hex-input {
            flex: 1;
            border: none;
            background: none;
            font-size: 13px;
            font-family: monospace;
            color: var(--admin-text);
            text-transform: uppercase;
        }
        .color-hex-input:focus { outline: none; }

        /* Image Upload */
        .image-upload-area {
            border: 2px dashed var(--admin-border);
            border-radius: 10px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--admin-bg);
            min-height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .image-upload-area:hover {
            border-color: var(--admin-primary);
            background: rgba(99, 102, 241, 0.02);
        }
        .image-upload-area.has-image {
            padding: 10px;
            border-style: solid;
            min-height: 140px;
        }
        .path-info {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
            height: 32px;
            overflow: hidden;
            word-break: break-all;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .image-upload-area.processing {
            opacity: 0.6;
            pointer-events: none;
        }
        .upload-icon {
            width: 36px; height: 36px; margin: 0 auto 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
        }
        .upload-icon svg { width: 18px; height: 18px; fill: white; }
        .upload-text { font-size: 12px; color: var(--admin-text); font-weight: 500; }
        .upload-hint { font-size: 11px; color: var(--admin-text-light); margin-top: 2px; }

        .uploaded-image-preview {
            position: relative;
            display: inline-block;
        }
        .uploaded-image-preview img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 8px;
            object-fit: cover;
        }
        .uploaded-image-preview.avatar img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }
        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 8px;
        }
        .uploaded-image-preview.avatar .image-overlay {
            border-radius: 50%;
        }
        .uploaded-image-preview:hover .image-overlay {
            opacity: 1;
        }
        .change-image-btn, .remove-image-btn {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        .change-image-btn {
            background: var(--admin-primary);
        }
        .change-image-btn:hover {
            background: var(--admin-primary-dark);
        }
        .remove-image-btn {
            background: #ef4444;
        }
        .remove-image-btn:hover {
            background: #dc2626;
        }

        /* Preview Panel */
        .preview-panel {
            position: fixed;
            top: 180px;
            right: 24px;
            width: 420px;
            height: calc(100vh - 200px);
            overflow-y: auto;
            z-index: 100;
        }
        .preview-panel .card-header {
            padding: 12px 16px;
            border-radius: 12px 12px 0 0;
        }
        .preview-panel .card-header h2 {
            font-size: 15px;
            margin: 0;
        }
        .preview-panel .card-header p {
            font-size: 12px;
            margin: 0;
        }

        /* Preview Tabs */
        .preview-tabs {
            display: flex;
            gap: 0;
            padding: 0;
            background: transparent;
            border-bottom: 2px solid #e5e7eb;
        }

        .preview-tab {
            flex: 1;
            padding: 14px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .preview-tab:hover {
            color: #4f46e5;
            background: #f9fafb;
        }

        .preview-tab.active {
            color: #4f46e5;
            font-weight: 600;
            background: linear-gradient(to bottom, rgba(224, 231, 255, 0.3), transparent);
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, #4f46e5 0%, #06b6d4 100%) 1;
        }

        .preview-content {
            display: none;
        }

        .preview-content.active {
            display: block;
        }

        @media (max-width: 1200px) {
            .preview-panel {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                height: auto;
                overflow-y: visible;
            }
        }

        .preview-card {
            background: var(--admin-card);
            border-radius: 12px;
            box-shadow: var(--admin-shadow-lg);
            overflow: hidden;
        }

        .preview-widget-container {
            padding: 20px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 420px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mini Widget Preview */
        .widget-preview {
            width: 100%;
            max-width: 340px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .preview-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .preview-header-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.5);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 0 0 2px rgba(255,255,255,0.1);
        }
        .preview-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-header-avatar svg { width: 26px; height: 26px; fill: white; }
        .preview-header-info { flex: 1; }
        .preview-header-title { color: white; font-weight: 600; font-size: 15px; }
        .preview-header-status { color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 2px; }

        .preview-messages {
            padding: 16px;
            background: #f8fafc;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preview-message {
            display: flex;
            gap: 8px;
            max-width: 85%;
        }
        .preview-message.agent { align-self: flex-start; }
        .preview-message.user { align-self: flex-end; flex-direction: row-reverse; }

        .preview-msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
            border: 2px solid transparent;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .preview-msg-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
        }
        .preview-msg-avatar.agent { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            border-color: rgba(102, 126, 234, 0.3);
        }
        .preview-msg-avatar.bot { 
            background: linear-gradient(135deg, #00b4d8 0%, #0077b6 100%); 
            border-color: rgba(0, 180, 216, 0.3);
        }
        .preview-msg-avatar.user { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); 
            border-color: rgba(17, 153, 142, 0.3);
        }
        .preview-msg-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .preview-msg-bubble {
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 13px;
            line-height: 1.4;
        }
        .preview-message.agent .preview-msg-bubble {
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            border-bottom-left-radius: 4px;
        }
        .preview-message.user .preview-msg-bubble {
            color: white;
            border-bottom-right-radius: 4px;
        }

        .preview-input-area {
            padding: 12px 16px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .preview-input {
            flex: 1;
            padding: 10px 14px;
            background: #f1f5f9;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            color: #64748b;
        }
        .preview-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #667eea;
        }
        .preview-send-btn:active {
            transform: scale(0.95);
        }
        .preview-send-btn svg { width: 22px; height: 22px; fill: currentColor; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }
        .btn-secondary {
            background: var(--admin-bg);
            color: var(--admin-text);
            border: 1px solid var(--admin-border);
        }
        .btn-secondary:hover {
            background: var(--admin-border);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .btn svg { width: 18px; height: 18px; fill: currentColor; }

        .action-buttons {
            display: flex;
            gap: 12px;
            padding: 20px;
            background: var(--admin-bg);
            border-top: 1px solid var(--admin-border);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #10b981;
            color: white;
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .toast svg { width: 20px; height: 20px; fill: white; }

        /* Image upload inputs (hidden) */
        .hidden-input { display: none; }

        /* Path input group for Edge-friendly image selection */
        .path-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .path-input-group .form-input {
            flex: 1;
            padding: 6px 10px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            background: var(--admin-primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-small:hover {
            background: var(--admin-primary-hover);
        }

        /* Avatar thumbnail gallery */
        .avatar-thumbnails {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-top: 10px;
            padding: 8px;
            background: var(--admin-bg);
            border-radius: 8px;
            border: 1px solid var(--admin-border);
        }
        .avatar-thumb {
            width: 100%;
            max-width: 40px;
            aspect-ratio: 1;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .avatar-thumb:hover {
            border-color: var(--admin-primary);
            transform: scale(1.08);
            box-shadow: 0 3px 6px rgba(99, 102, 241, 0.3);
        }
        .avatar-thumb.selected {
            border-color: var(--admin-primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--admin-bg);
            border-radius: 10px;
            margin-bottom: 16px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        .tab-btn:hover:not(.active) {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #475569;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Gradient Picker */
        .gradient-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: #cbd5e1;
            border-radius: 22px;
            transition: 0.2s ease;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .toggle-switch input:checked + .toggle-slider {
            background: var(--admin-primary);
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }
        .toggle-label {
            font-size: 13px;
            color: var(--admin-text);
            font-weight: 500;
        }

        .gradient-colors {
            display: none;
            gap: 12px;
        }
        .gradient-colors.show {
            display: flex;
        }
        .gradient-colors .color-item {
            flex: 1;
        }

        /* Demo Profiles */
        .profile-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }
        .profile-item {
            display: flex;
            flex-direction: column;
            padding: 0;
            background: var(--admin-bg);
            border-radius: 8px;
            border: 1px solid var(--admin-border);
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }
        .profile-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            width: 100%;
        }
        .profile-item:hover {
            border-color: var(--admin-primary);
            background: rgba(99, 102, 241, 0.02);
        }
        .profile-item.active {
            border-color: var(--admin-primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .profile-info { flex: 1; }
        .profile-name { font-weight: 500; font-size: 14px; color: var(--admin-text); }
        .profile-desc { font-size: 12px; color: var(--admin-text-light); margin-top: 2px; }
        .profile-actions { display: flex; gap: 4px; }
        .profile-btn {
            width: 32px; height: 32px; border: none; background: none;
            border-radius: 6px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            color: var(--admin-text-light); transition: all 0.2s;
        }
        .profile-btn:hover { background: var(--admin-border); color: var(--admin-text); }
        .profile-btn.delete:hover { background: #fee2e2; color: #ef4444; }
        .profile-btn svg { width: 16px; height: 16px; fill: currentColor; }
        
        /* Expandable D365 Connection Section */
        .profile-embed-section {
            display: none;
            padding: 0 16px 16px 16px;
            border-top: 1px solid var(--admin-border);
            background: #f8fafc;
        }
        .profile-item.active .profile-embed-section {
            display: block;
        }
        .profile-embed-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--admin-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 12px 0 8px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .profile-embed-label svg {
            width: 14px;
            height: 14px;
            fill: var(--admin-primary);
        }
        .profile-embed-code {
            width: 100%;
            min-height: 80px;
            padding: 10px 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            line-height: 1.5;
            border: 1px solid var(--admin-border);
            border-radius: 6px;
            background: white;
            color: var(--admin-text);
            resize: vertical;
        }
        .profile-embed-code:focus {
            outline: none;
            border-color: var(--admin-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .profile-embed-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .profile-embed-btn {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }
        .profile-embed-btn.primary {
            background: var(--admin-primary);
            color: white;
            border: none;
        }
        .profile-embed-btn.primary:hover {
            background: #4f46e5;
        }
        .profile-embed-btn.secondary {
            background: white;
            color: var(--admin-text);
            border: 1px solid var(--admin-border);
        }
        .profile-embed-btn.secondary:hover {
            background: var(--admin-bg);
            border-color: var(--admin-text-light);
        }
        .profile-embed-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }
        
        /* Profile Connection Status */
        .profile-connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            background: #fef3c7;
            border: 1px solid #fde68a;
        }
        .profile-connection-status.configured {
            background: #d1fae5;
            border-color: #a7f3d0;
        }
        .profile-connection-status.partial {
            background: #fef3c7;
            border-color: #fde68a;
        }
        .profile-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f59e0b;
            flex-shrink: 0;
        }
        .profile-connection-status.configured .profile-status-dot {
            background: #10b981;
        }
        .profile-status-text {
            font-size: 12px;
            font-weight: 500;
            color: #92400e;
        }
        .profile-connection-status.configured .profile-status-text {
            color: #065f46;
        }
        
        /* Profile Extracted Values */
        .profile-extracted-values {
            background: white;
            border: 1px solid var(--admin-border);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 12px;
        }
        .profile-extracted-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 4px 0;
            font-size: 12px;
        }
        .profile-extracted-item:not(:last-child) {
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 6px;
            margin-bottom: 2px;
        }
        .profile-extracted-label {
            color: var(--admin-text-light);
            font-weight: 500;
            min-width: 55px;
            flex-shrink: 0;
        }
        .profile-extracted-value {
            color: var(--admin-text);
            font-family: 'Consolas', 'Monaco', monospace;
            word-break: break-all;
            line-height: 1.4;
        }

        .new-profile-row {
            display: flex;
            gap: 8px;
        }
        .new-profile-row input {
            flex: 1;
        }

        /* Spinner animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Profile Tabs (Personal/Team toggle) */
        .profile-tabs {
            display: flex;
            gap: 4px;
            background: var(--admin-border);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .profile-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--admin-text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        .profile-tab:hover {
            color: var(--admin-text);
        }
        .profile-tab.active {
            background: var(--admin-bg);
            color: var(--admin-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .profile-tab svg {
            width: 16px;
            height: 16px;
        }
        .profile-tab-count {
            background: var(--admin-primary);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        .profile-tab:not(.active) .profile-tab-count {
            background: var(--admin-text-muted);
        }

        /* Profile sections */
        .profile-section {
            display: none;
        }
        .profile-section.active {
            display: block;
        }

        /* Team empty state */
        .team-empty-state {
            text-align: center;
            padding: 32px 20px;
            background: var(--admin-border);
            border-radius: 12px;
            border: 2px dashed var(--admin-text-muted);
        }
        .team-empty-state svg {
            width: 48px;
            height: 48px;
            fill: var(--admin-text-muted);
            margin-bottom: 12px;
        }
        .team-empty-state h4 {
            margin: 0 0 8px 0;
            color: var(--admin-text);
        }
        .team-empty-state p {
            margin: 0 0 16px 0;
            color: var(--admin-text-muted);
            font-size: 13px;
        }
        .team-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 280px;
            margin: 0 auto;
        }
        .team-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        .team-btn-primary {
            background: var(--admin-primary);
            color: white;
            border: none;
        }
        .team-btn-primary:hover {
            background: #4338ca;
        }
        .team-btn-secondary {
            background: var(--admin-bg);
            color: var(--admin-text);
            border: 1px solid var(--admin-border);
        }
        .team-btn-secondary:hover {
            background: var(--admin-border);
        }
        .team-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Team connected state */
        .team-connected {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .team-connected svg {
            width: 20px;
            height: 20px;
            fill: #059669;
            flex-shrink: 0;
        }
        .team-connected-info {
            flex: 1;
            min-width: 0;
        }
        .team-connected-label {
            font-size: 11px;
            color: #059669;
            font-weight: 600;
            text-transform: uppercase;
        }
        .team-connected-repo {
            font-size: 13px;
            color: #047857;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .team-disconnect-btn {
            background: none;
            border: none;
            padding: 6px;
            cursor: pointer;
            color: #6b7280;
            border-radius: 4px;
        }
        .team-disconnect-btn:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        /* Team badge on profile items */
        .profile-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .profile-badge.personal {
            background: #e0e7ff;
            color: #4f46e5;
        }
        .profile-badge.team {
            background: #d1fae5;
            color: #059669;
        }

        /* Team Modal */
        .team-modal-content {
            max-width: 480px;
        }
        .team-modal-steps {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin: 20px 0;
        }
        .team-step {
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--admin-border);
            border-radius: 8px;
        }
        .team-step-number {
            width: 28px;
            height: 28px;
            background: var(--admin-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }
        .team-step-content h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
        }
        .team-step-content p {
            margin: 0;
            font-size: 13px;
            color: var(--admin-text-muted);
        }
        .team-repo-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            font-size: 14px;
            margin-top: 16px;
        }
        .team-repo-input:focus {
            outline: none;
            border-color: var(--admin-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Save location choice */
        .save-location-choice {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        .save-location-option {
            flex: 1;
            padding: 16px;
            border: 2px solid var(--admin-border);
            border-radius: 12px;
            background: var(--admin-bg);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }
        .save-location-option:hover {
            border-color: var(--admin-primary);
        }
        .save-location-option.selected {
            border-color: var(--admin-primary);
            background: #f5f3ff;
        }
        .save-location-option svg {
            width: 32px;
            height: 32px;
            fill: var(--admin-text-muted);
            margin-bottom: 8px;
        }
        .save-location-option.selected svg {
            fill: var(--admin-primary);
        }
        .save-location-option h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
        }
        .save-location-option p {
            margin: 0;
            font-size: 12px;
            color: var(--admin-text-muted);
        }

        /* Config code block */
        .config-code {
            background: #1e293b;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            overflow-x: auto;
        }
        .config-code pre {
            color: #e2e8f0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .config-code .key { color: #7dd3fc; }
        .config-code .string { color: #86efac; }
        .config-code .comment { color: #64748b; }

        .copy-btn {
            position: relative;
            margin-top: 8px;
        }
        .copy-btn.copied::after {
            content: 'Copied!';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            animation: fadeOut 2s forwards;
        }
        @keyframes fadeOut {
            0%, 70% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Import/Export section */
        .import-export-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Status indicator */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: transparent;
            border-radius: 8px;
            margin-top: 12px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #94a3b8;
        }
        .status-dot.connected { background: #10b981; }
        .status-dot.error { background: #ef4444; }
        .status-text { font-size: 13px; color: var(--admin-text-light); }

        /* Collapsible sections */
        .section-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px 0;
        }
        .section-toggle svg {
            width: 16px;
            height: 16px;
            fill: var(--admin-text-light);
            transition: transform 0.2s;
        }
        .section-toggle.expanded svg {
            transform: rotate(90deg);
        }
        .collapsible-content {
            display: none;
            padding-top: 12px;
        }
        .collapsible-content.show {
            display: block;
        }

        /* Quick presets */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .preset-btn {
            padding: 12px 8px;
            border: 1px solid var(--admin-border);
            background: var(--admin-bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .preset-btn:hover {
            border-color: var(--admin-primary);
        }
        .preset-btn.active {
            border-color: var(--admin-primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .preset-preview {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 auto 6px;
        }
        .preset-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--admin-text);
        }

        /* Launcher Icon Selection */
        .launcher-icon-option:hover {
            border-color: #667eea !important;
            background: #f8f9ff !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        .launcher-icon-option.selected {
            border-color: #667eea !important;
            background: #f0f4ff !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Launcher Preview */
        .launcher-preview-section {
            margin-top: 12px;
            padding: 12px 16px;
            background: transparent;
            border-top: 1px solid rgba(226, 232, 240, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .launcher-preview-label {
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .launcher-preview-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            background: transparent;
            border-radius: 0;
            position: relative;
            background: transparent;
            border-radius: 0;
            position: relative;
            overflow: visible;
        }

        /* Elegant pulse animation - matching real widget */
        @keyframes elegantPulse {
            0% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4), 
                            0 0 0 0 rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4), 
                            0 0 0 12px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4), 
                            0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        .preview-launcher-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: elegantPulse 2.5s ease-in-out infinite;
        }

        .preview-launcher-btn:hover {
            transform: scale(1.1);
            animation: none;
        }

        .preview-launcher-btn svg {
            width: 26px;
            height: 26px;
            fill: white;
        }

        /* Embed Code Section */
        .embed-code-container {
            position: relative;
        }
        .embed-code-textarea {
            width: 100%;
            height: 200px;
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.5;
            padding: 16px;
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            background: #1e293b;
            color: #e2e8f0;
            resize: vertical;
            overflow: auto;
        }
        .embed-code-textarea:focus {
            outline: none;
            border-color: var(--admin-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .embed-code-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .embed-code-actions .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .embed-info {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
            border-radius: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.15);
        }
        .embed-info-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .embed-info-icon svg {
            width: 16px;
            height: 16px;
            fill: white;
        }
        .embed-info-text h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--admin-text);
            margin-bottom: 4px;
        }
        .embed-info-text p {
            font-size: 12px;
            color: white;
            line-height: 1.4;
            font-weight: 500;
            margin: 0;
        }
        .copy-success {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--admin-success);
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .copy-success.show {
            opacity: 1;
        }
        .embed-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .embed-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.04) 0%, rgba(6, 182, 212, 0.04) 100%);
            border: 1px solid rgba(79, 70, 229, 0.12);
            border-radius: 10px;
            transition: all 0.2s ease;
        }
        .embed-option:hover {
            border-color: rgba(79, 70, 229, 0.25);
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.06) 0%, rgba(6, 182, 212, 0.06) 100%);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.08);
        }
        .embed-option.full-width {
            grid-column: 1 / -1;
        }
        .embed-option label {
            font-size: 13.5px;
            font-weight: 500;
            color: var(--admin-text);
            cursor: pointer;
            user-select: none;
        }
        .embed-option select {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid rgba(79, 70, 229, 0.2);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            background: white;
            color: var(--admin-text);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .embed-option select:hover {
            border-color: rgba(79, 70, 229, 0.4);
        }
        .embed-option select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* ============================================
           GitHub Login Overlay & Cloud Sync
           ============================================ */
        
        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .login-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .login-box {
            background: white;
            padding: 48px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            text-align: center;
            max-width: 480px;
            width: 90%;
        }
        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }
        .login-logo svg { width: 40px; height: 40px; fill: white; }
        .login-box h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--admin-text);
            margin-bottom: 8px;
        }
        .login-box > p {
            color: var(--admin-text-light);
            margin-bottom: 32px;
            font-size: 15px;
        }
        .btn-github-login {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 16px 32px;
            background: #24292e;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            justify-content: center;
        }
        .btn-github-login:hover {
            background: #1b1f23;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .btn-github-login svg { width: 24px; height: 24px; fill: currentColor; }
        
        .login-note {
            margin-top: 24px;
            font-size: 13px;
            color: var(--admin-text-light);
        }
        .login-skip {
            margin-top: 16px;
        }
        .login-skip button {
            background: none;
            border: none;
            color: var(--admin-primary);
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
        }
        .login-skip button:hover {
            color: var(--admin-primary-dark);
        }

        /* Token Entry (fallback for non-Azure hosting) */
        .token-entry {
            display: none;
            text-align: left;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--admin-border);
        }
        .token-entry.show { display: block; }
        .token-entry h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--admin-text);
        }
        .token-entry ol {
            font-size: 14px;
            color: var(--admin-text-light);
            margin-left: 20px;
            margin-bottom: 16px;
            line-height: 1.8;
        }
        .token-entry ol a {
            color: var(--admin-primary);
            font-weight: 600;
        }
        .token-input-row {
            display: flex;
            gap: 8px;
        }
        .token-input-row input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--admin-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }
        .token-input-row input:focus {
            outline: none;
            border-color: var(--admin-primary);
        }
        .token-input-row button {
            padding: 12px 20px;
            background: var(--admin-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .token-status {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        .token-status.error {
            display: block;
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .token-status.success {
            display: block;
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid #bbf7d0;
        }

        /* User Bar (shown when logged in) */
        .user-bar {
            background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);
            padding: 10px 32px;
            display: none;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            color: white;
        }
        .user-bar.show { display: flex; }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .user-name { font-weight: 500; color: white; }
        .user-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .saved-widgets-dropdown {
            position: relative;
        }
        .saved-widgets-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .saved-widgets-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        .saved-widgets-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .saved-widgets-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .saved-widgets-menu.show { display: block; }
        .saved-widgets-header {
            padding: 16px;
            border-bottom: 1px solid var(--admin-border);
            font-weight: 600;
            color: var(--admin-text);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .saved-widgets-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .saved-widget-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--admin-border);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .saved-widget-item:hover { background: var(--admin-bg); }
        .saved-widget-item:last-child { border-bottom: none; }
        .saved-widget-name {
            font-weight: 500;
            color: var(--admin-text);
        }
        .saved-widget-date {
            font-size: 12px;
            color: var(--admin-text-light);
        }
        .saved-widget-delete {
            padding: 4px 8px;
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .saved-widget-item:hover .saved-widget-delete { opacity: 1; }
        .saved-widgets-empty {
            padding: 32px 16px;
            text-align: center;
            color: var(--admin-text-light);
        }
        .cloud-sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            transition: all 0.2s;
        }
        .cloud-sync-status:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }
        .cloud-sync-status svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }
        .cloud-sync-status.synced { 
            color: white;
        }
        .cloud-sync-status.synced svg { 
            fill: #4ade80;
        }
        .cloud-sync-status.syncing { color: #fde68a; }
        .cloud-sync-status.pending { color: #fbbf24; }
        .cloud-sync-status.error { color: #f87171; }
        .btn-logout {
            background: #dc2626;
            border: none;
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            padding: 6px 14px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .btn-logout:hover { 
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
        }

        /* Version Badge */
        .version-info {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            transition: all 0.2s;
        }
        .version-info:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }
        .version-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }
        .version-badge svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* Changelog Modal */
        .changelog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .changelog-overlay.show { display: flex; }
        .changelog-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .changelog-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .changelog-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .changelog-header-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .changelog-header-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        .changelog-header-title h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        .changelog-header-title p {
            margin: 4px 0 0;
            font-size: 13px;
            opacity: 0.9;
        }
        .changelog-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .changelog-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        .changelog-close svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        .changelog-content {
            padding: 24px;
            max-height: calc(80vh - 120px);
            overflow-y: auto;
        }
        .changelog-version {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
        }
        .changelog-version:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .changelog-version-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .changelog-version-number {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .changelog-version-number.latest {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .changelog-version-number svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }
        .changelog-version-date {
            font-size: 13px;
            color: #6b7280;
        }
        .changelog-items {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .changelog-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
        }
        .changelog-item-type {
            flex-shrink: 0;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .changelog-item-type.new {
            background: #dcfce7;
            color: #166534;
        }
        .changelog-item-type.fix {
            background: #fef3c7;
            color: #92400e;
        }
        .changelog-item-type.improve {
            background: #dbeafe;
            color: #1e40af;
        }
        .changelog-item-type.remove {
            background: #fee2e2;
            color: #991b1b;
        }
        .changelog-item-text {
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }

        /* Save Modal */
        .save-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }
        .save-modal-overlay.show { display: flex; }
        .save-modal {
            background: white;
            padding: 32px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        .save-modal h3 {
            font-size: 20px;
            margin-bottom: 16px;
            color: var(--admin-text);
        }
        .save-modal input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--admin-border);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }
        .save-modal input:focus {
            outline: none;
            border-color: var(--admin-primary);
        }
        .save-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .save-modal-actions button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .save-modal-cancel {
            background: var(--admin-bg);
            border: 1px solid var(--admin-border);
            color: var(--admin-text);
        }
        .save-modal-save {
            background: var(--admin-primary);
            border: none;
            color: white;
        }

        /* Professional Confirmation Modal */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            animation: confirmFadeIn 0.2s ease;
        }
        .confirm-modal-overlay.show { display: flex; }
        @keyframes confirmFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes confirmSlideIn {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .confirm-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: confirmSlideIn 0.25s ease;
        }
        .confirm-modal-header {
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .confirm-modal-header.danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-bottom: 1px solid #fecaca;
        }
        .confirm-modal-header.warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-bottom: 1px solid #fde68a;
        }
        .confirm-modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .confirm-modal-header.danger .confirm-modal-icon {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .confirm-modal-header.warning .confirm-modal-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .confirm-modal-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        .confirm-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        .confirm-modal-body {
            padding: 24px;
        }
        .confirm-modal-message {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.6;
            margin: 0;
        }
        .confirm-modal-item-name {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .confirm-modal-item-name svg {
            width: 20px;
            height: 20px;
            fill: #6b7280;
            flex-shrink: 0;
        }
        .confirm-modal-item-name span {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            word-break: break-all;
        }
        .confirm-modal-footer {
            padding: 16px 24px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        .confirm-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
        }
        .confirm-modal-btn.cancel {
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        .confirm-modal-btn.cancel:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        .confirm-modal-btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        .confirm-modal-btn.danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            transform: translateY(-1px);
        }
        .confirm-modal-btn.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        .confirm-modal-btn.warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            transform: translateY(-1px);
        }

    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <div class="login-logo">
                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            </div>
            <h1>D365 Widget Studio</h1>
            <p>Create and customize beautiful chat widgets for Dynamics 365</p>
            
            <button id="githubLoginBtn" class="btn-github-login">
                <svg viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
                Sign in with GitHub
            </button>
            
            <p class="login-note">Your widget configurations will be saved to your GitHub account</p>
            
            <!-- Token entry fallback -->
            <div id="tokenEntry" class="token-entry">
                <h3>Connect your GitHub Account</h3>
                <ol>
                    <li><a href="https://github.com/settings/tokens/new?description=D365%20Widget%20Studio&scopes=gist,read:user" target="_blank">Click here to create a token on GitHub</a></li>
                    <li>Select <strong>gist</strong> and <strong>read:user</strong> scopes</li>
                    <li>Click "Generate token" and paste below:</li>
                </ol>
                <div class="token-input-row">
                    <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx">
                    <button id="tokenConnectBtn">Connect</button>
                </div>
                <div id="tokenStatus" class="token-status"></div>
            </div>
            
            <div class="login-skip">
                <button id="skipLoginBtn">Continue without signing in </button>
            </div>
        </div>
    </div>

    <!-- Save Widget Modal -->
    <div id="saveModal" class="save-modal-overlay">
        <div class="save-modal">
            <h3> Save Widget to Cloud</h3>
            <input type="text" id="saveWidgetName" placeholder="Widget name (e.g., Contoso Support Chat)">
            <div class="save-modal-actions">
                <button class="save-modal-cancel" onclick="closeSaveModal()">Cancel</button>
                <button class="save-modal-save" id="saveModalConfirmBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Create Collaboration Room Modal -->
    <div id="createRoomModal" class="save-modal-overlay" onclick="if(event.target === this) closeCreateRoomModal()">
        <div class="save-modal team-modal-content" style="max-width: 480px;">
            <h3 style="display:flex;align-items:center;gap:8px;">
                <img src="https://github.com/microsoft/fluentui-system-icons/raw/main/assets/Breakout%20Room/SVG/ic_fluent_breakout_room_32_regular.svg?raw=true" alt="Room" style="width: 28px; height: 28px;"> Create Collaboration Room
            </h3>
            
            <!-- Friendly intro -->
            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 14px; margin-bottom: 20px;">
                <p style="margin: 0; color: #0369a1; font-size: 13px; line-height: 1.5;">
                     <strong>No accounts needed!</strong> Create a room, get a 6-character code, share it with your team. That's it!
                </p>
            </div>
            
            <!-- Room name input -->
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; color: #475569; font-weight: 500; margin-bottom: 6px;">
                    Room name:
                </label>
                <input type="text" class="form-input" id="createRoomName" placeholder="e.g., Contoso Support Widget" style="font-size: 14px;">
            </div>
            
            <!-- Your name input -->
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; color: #475569; font-weight: 500; margin-bottom: 6px;">
                    Your name (so teammates know who's editing):
                </label>
                <input type="text" class="form-input" id="createRoomUserName" placeholder="e.g., John" style="font-size: 14px;">
            </div>
            
            <!-- Status area -->
            <div id="createRoomStatus" style="display:none; padding: 14px; border-radius: 8px; margin-bottom: 16px;"></div>
            
            <!-- Success state with room code -->
            <div id="createRoomSuccess" style="display:none; text-align: center; padding: 20px; background: #ecfdf5; border-radius: 12px; margin-bottom: 16px;">
                <div style="font-size: 14px; color: #065f46; margin-bottom: 8px;"> Room created! Your room code is:</div>
                <div id="newRoomCode" style="font-size: 36px; font-weight: bold; font-family: monospace; letter-spacing: 4px; color: #059669; margin-bottom: 12px;">------</div>
                <button onclick="copyRoomCode()" style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 14px; cursor: pointer;">
                    Copy Room Code
                </button>
                <p style="margin: 12px 0 0 0; font-size: 12px; color: #065f46;">Share this code with your team.</p>
            </div>
            
            <div class="save-modal-actions">
                <button class="save-modal-cancel" onclick="closeCreateRoomModal()" id="createRoomCancelBtn">Cancel</button>
                <button class="save-modal-save" id="createRoomBtn" onclick="createCollabRoom()">
                    <span id="createRoomBtnText">Create Room</span>
                    <span id="createRoomSpinner" style="display:none;">
                        <svg style="width:16px;height:16px;animation:spin 1s linear infinite;margin-right:6px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="32" stroke-linecap="round"/></svg>
                        Creating...
                    </span>
                </button>
                <button class="save-modal-save" id="createRoomDoneBtn" onclick="closeCreateRoomModal()" style="display:none;">
                    Done
                </button>
            </div>
        </div>
    </div>

    <!-- Join Collaboration Room Modal -->
    <div id="joinRoomModal" class="save-modal-overlay" onclick="if(event.target === this) closeJoinRoomModal()">
        <div class="save-modal team-modal-content" style="max-width: 480px;">
            <h3> Join Collaboration Room</h3>
            
            <!-- Friendly intro -->
            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 14px; margin-bottom: 20px;">
                <p style="margin: 0; color: #0369a1; font-size: 13px; line-height: 1.5;">
                     Enter the 6-character room code your teammate shared with you.
                </p>
            </div>
            
            <!-- Room code input -->
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; color: #475569; font-weight: 500; margin-bottom: 6px;">
                    Room Code:
                </label>
                <input type="text" class="form-input" id="joinRoomCode" placeholder="ABC123" maxlength="6" style="font-size: 24px; text-align: center; letter-spacing: 4px; font-family: monospace; text-transform: uppercase;">
            </div>
            
            <!-- Your name input -->
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 13px; color: #475569; font-weight: 500; margin-bottom: 6px;">
                    Your name:
                </label>
                <input type="text" class="form-input" id="joinRoomUserName" placeholder="e.g., Sarah" style="font-size: 14px;">
            </div>
            
            <!-- Status area -->
            <div id="joinRoomStatus" style="display:none; padding: 14px; border-radius: 8px; margin-bottom: 16px;"></div>
            
            <div class="save-modal-actions">
                <button class="save-modal-cancel" onclick="closeJoinRoomModal()">Cancel</button>
                <button class="save-modal-save" id="joinRoomBtn" onclick="joinCollabRoom()">
                    <span id="joinRoomBtnText">Join Room</span>
                    <span id="joinRoomSpinner" style="display:none;">
                        <svg style="width:16px;height:16px;animation:spin 1s linear infinite;margin-right:6px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="32" stroke-linecap="round"/></svg>
                        Joining...
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Professional Confirmation Modal -->
    <div id="studioConfirmModal" class="confirm-modal-overlay" onclick="if(event.target === this) closeConfirmModal()">
        <div class="confirm-modal">
            <div class="confirm-modal-header" id="confirmModalHeader">
                <div class="confirm-modal-icon" id="confirmModalIcon">
                    <!-- Icon inserted dynamically -->
                </div>
                <h3 class="confirm-modal-title" id="confirmModalTitle">Confirm Action</h3>
            </div>
            <div class="confirm-modal-body">
                <p class="confirm-modal-message" id="confirmModalMessage">Are you sure you want to proceed?</p>
                <div class="confirm-modal-item-name" id="confirmModalItemName" style="display: none;">
                    <!-- Item info inserted dynamically -->
                </div>
            </div>
            <div class="confirm-modal-footer">
                <button class="confirm-modal-btn cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="confirm-modal-btn" id="confirmModalAction">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorialOverlay" class="changelog-overlay" onclick="if(event.target === this) hideTutorial()">
        <div class="changelog-modal" style="max-width: 700px;">
            <div class="changelog-header" style="background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%);">
                <div class="changelog-header-left">
                    <div class="changelog-header-icon" style="background: transparent; display: flex; align-items: center; justify-content: center;">
                        <img src="img/icon/information.png" alt="Guide" style="width: 36px; height: 36px; object-fit: contain;">
                    </div>
                    <div class="changelog-header-title">
                        <h2>Quick Start Guide</h2>
                        <p>Learn how to use Chat Widget Studio</p>
                    </div>
                </div>
                <button class="changelog-close" onclick="hideTutorial()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="changelog-content" style="padding: 30px;">
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; font-size: 18px; margin-bottom: 12px;">What is Chat Widget Studio?</h3>
                    <p style="color: #666; line-height: 1.6;">
                        A customization tool that lets you personalize your D365 Omnichannel chat widget's look and feel. 
                        Design your widget once, then deploy it anywhere using one of three simple methods.
                    </p>
                </div>

                <div style="margin-bottom: 25px;">
                    <h3 style="color: #667eea; font-size: 18px; margin-bottom: 15px;">Three Ways to Use Your Widget</h3>
                    
                    <div style="background: #f8f9ff; border-left: 4px solid #667eea; padding: 20px; margin-bottom: 15px; border-radius: 8px;">
                        <h4 style="color: #333; font-size: 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <img src="img/icon/check-circle.svg" alt="Go To Widget" style="width: 20px; height: 20px; object-fit: contain;">
                            Go To Widget
                        </h4>
                        <p style="color: #666; line-height: 1.6; margin-bottom: 8px;">
                            <strong>Best for:</strong> Quick and professional live chat demos
                        </p>
                        <p style="color: #666; line-height: 1.6;">
                            Click "Go To Widget" to instantly open your customized chat in a new browser tab. 
                            Perfect for presenting live demos or sharing directly with clients and stakeholders.
                        </p>
                    </div>

                    <div style="background: #f8f9ff; border-left: 4px solid #764ba2; padding: 20px; margin-bottom: 15px; border-radius: 8px;">
                        <h4 style="color: #333; font-size: 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <img src="img/Logo/tampermonkey.png" alt="TamperMonkey" style="width: 20px; height: 20px; object-fit: contain;">
                            TamperMonkey <span style="font-size: 12px; font-weight: 400; color: #888;">(Browser Extension)</span>
                        </h4>
                        <p style="color: #667eea; font-size: 13px; margin-bottom: 8px;">
                            <a href="https://microsoftedge.microsoft.com/addons/detail/tampermonkey/iikmkjmpaadaobahmlepeloendndfphd" target="_blank" style="color: #667eea; text-decoration: none; border-bottom: 1px dotted #667eea;">
                                Install TamperMonkey for Edge 
                            </a>
                        </p>
                        <p style="color: #666; line-height: 1.6; margin-bottom: 8px;">
                            <strong>Best for:</strong> Adding the widget to existing websites you visit
                        </p>
                        <p style="color: #666; line-height: 1.6;">
                            Generate a TamperMonkey script that adds your widget to any website automatically. 
                            Perfect for internal portals or sites where you can't edit the code directly.
                        </p>
                    </div>

                    <div style="background: #f8f9ff; border-left: 4px solid #10b981; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #333; font-size: 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <img src="img/icon/upload-cloud.svg" alt="Embed in Custom Pages" style="width: 20px; height: 20px; object-fit: contain;">
                            Embed in Custom Pages
                        </h4>
                        <p style="color: #666; line-height: 1.6; margin-bottom: 8px;">
                            <strong>Best for:</strong> Your own websites, applications, and Power Pages/Portals
                        </p>
                        <p style="color: #666; line-height: 1.6;">
                            Copy the embed code and paste it into your website's HTML. 
                            Choose between iframe or JavaScript methods depending on your needs. 
                            Perfect for Power Pages/Portals when you need to add a connected chat demo to your existing portal.
                        </p>
                    </div>
                </div>

                <div style="background: #fffbeb; border: 1px solid #fbbf24; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <p style="color: #92400e; line-height: 1.6; margin: 0;">
                         <strong>Tip:</strong> Start by customizing your widget's appearance, then click "Go To Widget" to see your changes live. 
                        Once you're happy with the design, choose your preferred deployment method!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelogOverlay" class="changelog-overlay" onclick="if(event.target === this) hideChangelog()">
        <div class="changelog-modal">
            <div class="changelog-header">
                <div class="changelog-header-left">
                    <div class="changelog-header-icon">
                        <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                    </div>
                    <div class="changelog-header-title">
                        <h2>Changelog <span id="changelogVersion" style="font-size: 14px; font-weight: 500; opacity: 0.9;"></span></h2>
                        <p id="changelogLastUpdated">Last updated: Dec 18, 2025, 03:45 PM</p>
                    </div>
                </div>
                <button class="changelog-close" onclick="hideChangelog()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </div>
            <div class="changelog-content" id="changelogContent">
                <!-- Changelog items will be rendered here by JavaScript -->
            </div>
        </div>
    </div>

    <header class="admin-header">
        <!-- User Bar (shown when logged in with GitHub) -->
        <div id="userBar" class="user-bar">
            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="">
                <span id="userName" class="user-name"></span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: rgba(255,255,255,0.6); letter-spacing: 0.3px; margin: 0 auto;">
                <span style="opacity: 0.7;">Created by</span>
                <a href="https://www.linkedin.com/in/mauriciooliveira/" target="_blank" rel="noopener noreferrer" style="font-weight: 600; color: rgba(255,255,255,0.95); text-decoration: none; transition: all 0.2s;" onmouseover="this.style.color='#06b6d4'; this.style.textDecoration='underline'" onmouseout="this.style.color='rgba(255,255,255,0.95)'; this.style.textDecoration='none'">Mauricio Oliveira</a>
                <span style="opacity: 0.5;"></span>
                <a href="mailto:maoliveira@microsoft.com" style="color: rgba(255,255,255,0.75); text-decoration: none; transition: all 0.2s;" onmouseover="this.style.color='#06b6d4'; this.style.textDecoration='underline'" onmouseout="this.style.color='rgba(255,255,255,0.75)'; this.style.textDecoration='none'">maoliveira@microsoft.com</a>
                <span style="opacity: 0.5;"></span>
                <span style="opacity: 0.7;">GBB Contact Center AI</span>
            </div>
            <div class="user-actions">
                <div class="version-info" onclick="showChangelog()" title="View changelog">
                    <div class="version-badge">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        <span id="versionNumber">v1.0.0</span>
                    </div>
                </div>
                <div id="cloudSyncStatus" class="cloud-sync-status synced">
                    <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM10 17l-3.5-3.5 1.41-1.41L10 14.17l4.59-4.58L16 11l-6 6z"/></svg>
                    <span>Cloud synced</span>
                </div>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </div>
        
        <!-- Main Header Content -->
        <div class="admin-header-main">
            <div class="admin-header-left">
                <div class="admin-logo">
                    <img src="img/Logo/logo.png" alt="Chat Widget Studio Logo" style="width: 48px; height: 48px; object-fit: contain;">
                </div>
                <div>
                    <h1>Chat Widget Studio</h1>
                    <p>Customize your D365 chat widget</p>
                </div>
            </div>
        
        <!-- Header Actions -->
        <div class="header-actions">
            <button class="btn-header-action" onclick="showTutorial()" title="Quick start guide" style="background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%); color: white; border: none;">
                <svg viewBox="0 0 24 24" style="fill: white;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                Guide
            </button>
            
            <!-- Simple Share Dropdown -->
            <div class="share-dropdown" style="position: relative; display: inline-block;">
                <button class="btn-header-action" onclick="toggleShareMenu()" title="Share your config" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
                    <svg viewBox="0 0 24 24" style="fill: white;"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                    Share 
                </button>
                <div id="shareMenu" class="share-menu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; overflow: hidden;">
                    <button onclick="copyShareLink(); toggleShareMenu();" style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px 16px; border: none; background: none; cursor: pointer; text-align: left; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                         <span><strong>Copy Share Link</strong><br><small style="color: #666;">One-click import for anyone</small></span>
                    </button>
                    <button onclick="copyConfigToClipboard(); toggleShareMenu();" style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px 16px; border: none; background: none; cursor: pointer; text-align: left; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                         <span><strong>Copy Config JSON</strong><br><small style="color: #666;">Paste in email, Teams, Slack</small></span>
                    </button>
                    <button onclick="showQRCode(); toggleShareMenu();" style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px 16px; border: none; background: none; cursor: pointer; text-align: left; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                         <span><strong>Show QR Code</strong><br><small style="color: #666;">Scan to import on mobile</small></span>
                    </button>
                    <div style="border-top: 1px solid #e5e7eb; margin: 4px 0;"></div>
                    <button onclick="exportSettings(); toggleShareMenu();" style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px 16px; border: none; background: none; cursor: pointer; text-align: left; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                         <span><strong>Download JSON File</strong><br><small style="color: #666;">Full backup with profiles</small></span>
                    </button>
                </div>
            </div>
            
            <button class="btn-header-action" id="loginBtn" onclick="showLoginOverlay()" title="Sign in with GitHub">
                <svg viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
                Sign in
            </button>
            <button class="btn-header-action" onclick="document.getElementById('importFile').click()" title="Import settings from JSON">
                <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                Import
            </button>
            <input type="file" id="importFile" class="hidden-input" accept=".json" onchange="importSettings(event)">
        </div>
        </div><!-- End admin-header-main -->
    </header>

    <div class="admin-container">
        <div class="settings-panel">
            <!-- Demo Profiles -->
            <div class="settings-card">
                <div class="card-header" style="display:flex;align-items:flex-start;gap:12px;">
                    <div class="card-header-icon">
                        <img src="img/icon/office.png" alt="Demo Profiles" style="width: 24px; height: 24px; object-fit: contain;">
                    </div>
                    <div style="flex:1;">
                        <h2>Widget Profiles</h2>
                        <p>Save and share widget configurations</p>
                    </div>
                    <button class="btn btn-sm" style="display:none;background:#667eea;color:white;white-space:nowrap;" onclick="syncAllProfilesToCloud()" id="syncAllBtn" title="Sync all profiles to cloud">
                        <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:white;vertical-align:middle;margin-right:4px;"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
                        Sync All
                    </button>
                    <button class="btn btn-sm" style="display:none;background:#10b981;color:white;white-space:nowrap;margin-left:6px;" onclick="refreshFromCloud()" id="refreshCloudBtn" title="Refresh profiles from cloud">
                        <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:white;vertical-align:middle;margin-right:4px;"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                        Refresh
                    </button>
                </div>
                <div class="card-body">
                    <!-- Profile Tabs -->
                    <div class="profile-tabs" id="profileTabs">
                        <button class="profile-tab active" data-tab="personal" onclick="switchProfileTab('personal')">
                            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            Personal
                            <span class="profile-tab-count" id="personalCount">0</span>
                        </button>
                        <button class="profile-tab" data-tab="team" onclick="switchProfileTab('team')">
                            <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                            Team
                            <span class="profile-tab-count" id="teamCount">0</span>
                        </button>
                    </div>

                    <!-- Personal Profiles Section -->
                    <div class="profile-section active" id="personalSection">
                        <div class="profile-list" id="profileList">
                            <!-- Profiles will be loaded dynamically -->
                        </div>
                        <div class="new-profile-row">
                            <input type="text" class="form-input" id="newProfileName" placeholder="New profile name (e.g., Contoso Demo)">
                            <button class="btn btn-primary btn-sm" onclick="saveAsProfile()">
                                <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:white;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                Save
                            </button>
                        </div>
                    </div>

                    <!-- Collaboration Room Section -->
                    <div class="profile-section" id="teamSection">
                        <!-- Explanation -->
                        <div style="background: linear-gradient(135deg, #eff6ff 0%, #f0fdf4 100%); border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid #e0e7ff;">
                            <div style="font-size: 13px; color: #334155; line-height: 1.5;">
                                <strong style="color: #1e40af;"> What are Rooms?</strong><br>
                                Rooms let you share widget settings with your team instantly. Create a room to get a 6-character code, share it with colleagues, and everyone can sync the same configuration. No accounts needed!
                            </div>
                        </div>
                        
                        <!-- Room Actions (always visible) -->
                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <button class="team-btn team-btn-primary" onclick="showCreateRoomModal()" style="flex: 1;">
                                <svg viewBox="0 0 24 24" style="fill:white; width:16px; height:16px;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                Create Room
                            </button>
                            <button class="team-btn team-btn-secondary" onclick="showJoinRoomModal()" style="flex: 1;">
                                <svg viewBox="0 0 24 24" style="fill:currentColor; width:16px; height:16px;"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                                Join Room
                            </button>
                        </div>
                        
                        <!-- Room List -->
                        <div id="roomList" class="profile-list">
                            <!-- Rooms will be rendered dynamically -->
                        </div>
                        
                        <!-- Empty State (shown when no rooms) -->
                        <div class="team-empty-state" id="roomEmptyState" style="padding: 24px;">
                            <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                            <h4>No rooms yet</h4>
                            <p>Create a room to share with your team, or join an existing room with a code.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Demo Website Background -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <img src="img/icon/world-wide-web.png" alt="Demo Website Background" style="width: 24px; height: 24px; object-fit: contain;">
                    </div>
                    <div>
                        <h2>Demo Website Background</h2>
                        <p>Set a screenshot as the background behind the widget</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Image URL</label>
                        <input type="text" class="form-input" id="backgroundImageUrl" placeholder="https://i.postimg.cc/your-image.png">
                        <p class="form-hint"> Paste any public image URL directly, or upload your own image to <a href="https://postimages.org/" target="_blank" style="color: var(--admin-primary);">postimages.org</a> / <a href="https://imgbb.com/" target="_blank" style="color: var(--admin-primary);">imgbb.com</a> to get a public URL. Copy the direct image link (ends in .png, .jpg, etc.).</p>
                    </div>
                </div>
            </div>

            <!-- Hidden elements for backwards compatibility (not rendered) -->
            <textarea id="lcwCode" style="display: none !important; visibility: hidden; position: absolute; left: -9999px;"></textarea>
            <div id="extractedValues" style="display: none !important; visibility: hidden; position: absolute; left: -9999px;">
                <span id="extractedAppId"></span>
                <span id="extractedOrgId"></span>
                <span id="extractedOrgUrl"></span>
            </div>
            <div id="noProfileSelectedHint" style="display: none !important;"></div>
            <div id="connectionStatus" style="display: none !important; visibility: hidden; position: absolute; left: -9999px;">
                <span id="statusDot"></span>
                <span id="statusText"></span>
            </div>

            <!-- Widget Mode Selector -->
            <div class="settings-card" id="widgetModeCard">
                <div class="card-header">
                    <div class="card-header-icon">
                        <img src="img/icon/review.png" alt="Widget Mode" style="width: 24px; height: 24px; object-fit: contain;">
                    </div>
                    <div>
                        <h2>Widget Mode</h2>
                        <p>Choose between standard D365 widget or custom styled widget</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="widget-mode-selector">
                        <label class="mode-option" onclick="console.log('Standard clicked'); document.getElementById('modeStandard').checked = true; toggleWidgetMode('standard');">
                            <input type="radio" name="widgetMode" value="standard" id="modeStandard">
                            <div class="mode-card">
                                <div class="mode-icon">
                                    <img src="img/icon/git-commit.svg" alt="Standard Widget" style="width: 28px; height: 28px; object-fit: contain;">
                                </div>
                                <div class="mode-title">Standard Widget</div>
                                <div class="mode-desc">Use the default D365 Live Chat Widget appearance and behavior</div>
                            </div>
                        </label>
                        <label class="mode-option" onclick="console.log('Custom clicked'); document.getElementById('modeCustom').checked = true; toggleWidgetMode('custom');">
                            <input type="radio" name="widgetMode" value="custom" id="modeCustom" checked>
                            <div class="mode-card">
                                <div class="mode-icon">
                                    <img src="img/icon/loader.svg" alt="Custom Widget" style="width: 28px; height: 28px; object-fit: contain;">
                                </div>
                                <div class="mode-title">Custom Widget</div>
                                <div class="mode-desc">Use our beautifully styled custom chat widget with full customization</div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Standard Widget Settings Container -->
            <div id="standardWidgetSettings" class="hidden">
                <!-- Contact Authentication for Standard Mode -->
                <div class="settings-card">
                    <div class="card-header">
                        <div class="card-header-icon">
                            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        </div>
                        <div>
                            <h2>Contact Authentication</h2>
                            <p>Automatically authenticate users with D365 contact records</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableStandardAuth">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label">Enable Auto-Authentication</span>
                            </div>
                            <p class="form-help">When enabled, the widget will automatically authenticate users using the contact information below. This links chat sessions to existing D365 contact records without requiring a pre-chat form.</p>
                        </div>
                        <div id="standardAuthFields" class="hidden">
                            <div class="form-group">
                                <label class="form-label">Default Contact Name</label>
                                <input type="text" class="form-input" id="standardAuthName" placeholder="e.g., John Smith">
                                <p class="form-help">The name to authenticate with D365 (maps to 'Name' field in contact record)</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Contact Email</label>
                                <input type="email" class="form-input" id="standardAuthEmail" placeholder="e.g., john@example.com">
                                <p class="form-help">The email to authenticate with D365 (maps to 'emailaddress1' field in contact record)</p>
                            </div>
                            <div class="info-box" style="margin-top: 16px;">
                                <div class="info-icon"></div>
                                <div>
                                    <strong>Use Cases:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                        <li>Authenticated portal users (pass their logged-in credentials)</li>
                                        <li>Quick demos without form friction</li>
                                        <li>Skip pre-chat form for known contacts</li>
                                        <li>Single sign-on (SSO) scenarios</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Custom Widget Settings Container -->
            <div id="customWidgetSettings">

            <!-- Pre-chat Form -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <img src="img/icon/document.png" alt="Pre-chat Form" style="width: 24px; height: 24px; object-fit: contain;">
                    </div>
                    <div>
                        <h2>Pre-chat Form</h2>
                        <p>Customize the initial greeting and form fields</p>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Enable/Disable Pre-chat Form Toggle -->
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="enablePrechatForm" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Enable Pre-chat Form</span>
                        </div>
                        <p class="form-help">When enabled, users fill out Name & Email which automatically authenticates them with D365 contact records. When disabled, you can optionally use Contact Authentication below to provide credentials.</p>
                    </div>
                    
                    <!-- Pre-chat Form Fields -->
                    <div id="prechatFormFields">
                        <div class="form-group">
                            <label class="form-label">Welcome Title</label>
                            <input type="text" class="form-input" id="welcomeTitle" value="Start a conversation" placeholder="e.g., Start a conversation">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Welcome Message</label>
                            <textarea class="form-input" id="welcomeMessage" placeholder="e.g., We're here to help! Please fill out the form below.">We're here to help! Please fill out the form below to start chatting with our team.</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Name Field Label</label>
                            <input type="text" class="form-input" id="nameFieldLabel" value="Your Name" placeholder="e.g., Your Name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Name Field Placeholder</label>
                            <input type="text" class="form-input" id="nameFieldPlaceholder" value="Enter your name" placeholder="e.g., Enter your name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Field Label</label>
                            <input type="text" class="form-input" id="emailFieldLabel" value="Email Address" placeholder="e.g., Email Address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Field Placeholder</label>
                            <input type="text" class="form-input" id="emailFieldPlaceholder" value="Enter your email" placeholder="e.g., Enter your email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Question Field Label</label>
                            <input type="text" class="form-input" id="questionFieldLabel" value="How can we help?" placeholder="e.g., How can we help?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Question Field Placeholder</label>
                            <input type="text" class="form-input" id="questionFieldPlaceholder" value="Describe your question..." placeholder="e.g., Describe your question...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Button Text</label>
                            <input type="text" class="form-input" id="startBtnText" value="Start Chat" placeholder="e.g., Start Chat">
                        </div>
                    </div>
                    
                    <!-- Contact Authentication (shown when pre-chat is disabled) -->
                    <div id="customAuthSection" class="hidden" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="enableCustomAuth">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label">Enable Contact Authentication</span>
                            </div>
                            <p class="form-help">Automatically authenticate users with D365 contact records. This links chat sessions to existing contacts so agent can see their information.</p>
                        </div>
                        <div id="customAuthFields" class="hidden">
                            <div class="form-group">
                                <label class="form-label">Default Contact Name</label>
                                <input type="text" class="form-input" id="customAuthName" placeholder="e.g., John Smith">
                                <p class="form-help">The name to authenticate with D365 (maps to 'Name' field in contact record)</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Default Contact Email</label>
                                <input type="email" class="form-input" id="customAuthEmail" placeholder="e.g., john@example.com">
                                <p class="form-help">The email to authenticate with D365 (maps to 'emailaddress1' field in contact record)</p>
                            </div>
                            <div class="info-box" style="margin-top: 16px;">
                                <div class="info-icon"></div>
                                <div>
                                    <strong>Use Cases:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                        <li>Authenticated portal users (pass their logged-in credentials)</li>
                                        <li>Quick demos without form friction</li>
                                        <li>Contact record popup for agents</li>
                                        <li>Single sign-on (SSO) scenarios</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Header & Branding -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <img src="img/icon/tag.png" alt="Header & Branding" style="width: 24px; height: 24px; object-fit: contain;">
                    </div>
                    <div>
                        <h2>Header & Branding</h2>
                        <p>Customize the chat header text and logo</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Header Title</label>
                        <input type="text" class="form-input" id="headerTitle" value="Support Chat" placeholder="e.g., Support Chat, Help Desk">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Header Subtitle</label>
                        <input type="text" class="form-input" id="headerSubtitle" value="We're here to help" placeholder="e.g., We're here to help">
                    </div>
                    <div class="color-grid" style="margin-top: 16px;">
                        <div class="color-item">
                            <label>Title Text Color</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="headerTitleColor" value="#ffffff">
                                <input type="text" class="color-hex-input" id="headerTitleColorHex" value="#ffffff">
                            </div>
                        </div>
                        <div class="color-item">
                            <label>Subtitle Text Color</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="headerSubtitleColor" value="#e0e7ff">
                                <input type="text" class="color-hex-input" id="headerSubtitleColorHex" value="#e0e7ff">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company Logo / Header Icon</label>
                        <div class="image-upload-area" id="logoUploadArea">
                            <div class="upload-icon">
                                <svg viewBox="0 0 24 24"><path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"/></svg>
                            </div>
                            <div class="upload-text">Enter image path below</div>
                            <div class="upload-hint">Place images in the img/ folder</div>
                        </div>
                        <div class="path-input-group" style="margin-top: 8px;">
                            <input type="text" class="form-input" id="logoPathInput" placeholder="https://i.postimg.cc/your-image.png" style="font-size: 12px;">
                            <button type="button" class="btn-small" onclick="applyImagePath('headerLogo', 'logoPathInput', 'logoUploadArea', false)">Apply</button>
                        </div>
                        <p class="form-hint" style="margin-top: 8px;"> Paste any public image URL directly, or upload your own image to <a href="https://postimages.org" target="_blank" style="color: #6366f1;">postimages.org</a> / <a href="https://imgbb.com" target="_blank" style="color: #6366f1;">imgbb.com</a> to get a public URL. Copy the direct image link (ends in .png, .jpg, etc.).</p>
                    </div>
                </div>
            </div>

            <!-- Fonts -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <img src="img/icon/letter-f.png" alt="Fonts" style="width: 24px; height: 24px; object-fit: contain;">
                    </div>
                    <div>
                        <h2>Fonts</h2>
                        <p>Choose the typography for your widget</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Font Family</label>
                        <select class="form-input" id="fontFamily">
                            <optgroup label="System">
                                <option value="system">System Default</option>
                            </optgroup>
                            <optgroup label="Sans-Serif">
                                <option value="inter">Inter</option>
                                <option value="roboto">Roboto</option>
                                <option value="opensans">Open Sans</option>
                                <option value="lato">Lato</option>
                                <option value="poppins">Poppins</option>
                                <option value="montserrat">Montserrat</option>
                                <option value="nunito">Nunito</option>
                                <option value="sourcesans">Source Sans Pro</option>
                                <option value="raleway">Raleway</option>
                                <option value="ubuntu">Ubuntu</option>
                                <option value="rubik">Rubik</option>
                                <option value="worksans">Work Sans</option>
                                <option value="firasans">Fira Sans</option>
                                <option value="dmsans">DM Sans</option>
                                <option value="manrope">Manrope</option>
                                <option value="plusjakarta">Plus Jakarta Sans</option>
                                <option value="outfit">Outfit</option>
                                <option value="lexend">Lexend</option>
                            </optgroup>
                            <optgroup label="Serif">
                                <option value="playfair">Playfair Display</option>
                                <option value="merriweather">Merriweather</option>
                                <option value="lora">Lora</option>
                                <option value="crimson">Crimson Text</option>
                                <option value="libre">Libre Baskerville</option>
                            </optgroup>
                            <optgroup label="Monospace">
                                <option value="jetbrains">JetBrains Mono</option>
                                <option value="firacode">Fira Code</option>
                                <option value="sourcecodepro">Source Code Pro</option>
                            </optgroup>
                            <optgroup label="Display">
                                <option value="quicksand">Quicksand</option>
                                <option value="comfortaa">Comfortaa</option>
                                <option value="righteous">Righteous</option>
                            </optgroup>
                        </select>
                        <p class="form-hint">Select a font style for the chat widget text</p>
                    </div>
                    <div class="font-preview" id="fontPreview">
                        <div class="font-preview-label">Preview:</div>
                        <div class="font-preview-text" id="fontPreviewText">The quick brown fox jumps over the lazy dog</div>
                    </div>
                </div>
            </div>

            <!-- Colors -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <img src="img/icon/typography.png" alt="Colors" style="width: 24px; height: 24px; object-fit: contain;">
                    </div>
                    <div>
                        <h2>Colors</h2>
                        <p>Define your widget color scheme</p>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Color Palette Gallery -->
                    <div class="palette-gallery">
                        <div class="palette-gallery-header">
                            <div class="palette-gallery-title">
                                <svg viewBox="0 0 24 24"><path d="M12 22C6.49 22 2 17.51 2 12S6.49 2 12 2s10 4.04 10 9c0 3.31-2.69 6-6 6h-1.77c-.28 0-.5.22-.5.5 0 .12.05.23.13.33.41.47.64 1.06.64 1.67A2.5 2.5 0 0 1 12 22zm0-18c-4.41 0-8 3.59-8 8s3.59 8 8 8c.28 0 .5-.22.5-.5a.54.54 0 0 0-.14-.35c-.41-.46-.63-1.05-.63-1.65a2.5 2.5 0 0 1 2.5-2.5H16c2.21 0 4-1.79 4-4 0-3.86-3.59-7-8-7zm-5.5 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm3-4a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm5 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm3 4a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></svg>
                                Quick Palettes
                            </div>
                            <button class="palette-expand-btn" onclick="togglePaletteGallery()" id="paletteExpandBtn">Show All</button>
                        </div>
                        <div class="palette-grid" id="paletteGrid">
                            <!-- Palettes will be inserted by JavaScript -->
                        </div>
                        <p class="form-hint" style="margin-top: 12px; text-align: center;">
                             Need more color ideas? Visit <a href="https://coolors.co" target="_blank" rel="noopener noreferrer" style="color: var(--admin-primary); text-decoration: none; font-weight: 500;">coolors.co</a> for endless palette inspiration!
                        </p>
                    </div>

                    <div class="tabs">
                        <button class="tab-btn active" data-tab="primary">Primary</button>
                        <button class="tab-btn" data-tab="messages">Messages</button>
                        <button class="tab-btn" data-tab="ui">UI Elements</button>
                        <button class="tab-btn" data-tab="launcher">Launcher</button>
                        <button class="tab-btn" data-tab="prechat">Pre-chat</button>
                    </div>

                    <!-- Primary Colors Tab -->
                    <div class="tab-content active" id="tab-primary">
                        <div class="gradient-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" id="useGradient" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Use gradient for header & buttons</span>
                        </div>
                        <div class="gradient-colors show" id="gradientColors">
                            <div class="color-item">
                                <label>Gradient Start</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="gradientStart" value="#667eea">
                                    <input type="text" class="color-hex-input" id="gradientStartHex" value="#667eea">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Gradient End</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="gradientEnd" value="#764ba2">
                                    <input type="text" class="color-hex-input" id="gradientEndHex" value="#764ba2">
                                </div>
                            </div>
                        </div>
                        <div class="color-grid" id="solidColorPicker" style="display:none;">
                            <div class="color-item">
                                <label>Primary Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="primaryColor" value="#667eea">
                                    <input type="text" class="color-hex-input" id="primaryColorHex" value="#667eea">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Colors Tab -->
                    <div class="tab-content" id="tab-messages">
                        <div class="gradient-toggle" style="margin-bottom: 16px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="useBubbleGradient" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Use gradient for user message bubbles</span>
                        </div>
                        <div class="color-grid">
                            <div class="color-item">
                                <label>User Bubble</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="userBubbleColor" value="#667eea">
                                    <input type="text" class="color-hex-input" id="userBubbleColorHex" value="#667eea">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>User Text</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="userTextColor" value="#ffffff">
                                    <input type="text" class="color-hex-input" id="userTextColorHex" value="#ffffff">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Agent Bubble</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="agentBubbleColor" value="#ffffff">
                                    <input type="text" class="color-hex-input" id="agentBubbleColorHex" value="#ffffff">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Agent Text</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="agentTextColor" value="#2d3748">
                                    <input type="text" class="color-hex-input" id="agentTextColorHex" value="#2d3748">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>System Message</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="systemMsgColor" value="#e2e8f0">
                                    <input type="text" class="color-hex-input" id="systemMsgColorHex" value="#e2e8f0">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>System Text</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="systemTextColor" value="#64748b">
                                    <input type="text" class="color-hex-input" id="systemTextColorHex" value="#64748b">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- UI Elements Colors Tab -->
                    <div class="tab-content" id="tab-ui">
                        <div class="color-grid">
                            <div class="color-item">
                                <label>Chat Background</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="chatBgColor" value="#f8fafc">
                                    <input type="text" class="color-hex-input" id="chatBgColorHex" value="#f8fafc">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Input Background</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="inputBgColor" value="#ffffff">
                                    <input type="text" class="color-hex-input" id="inputBgColorHex" value="#ffffff">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Input Border</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="inputBorderColor" value="#e2e8f0">
                                    <input type="text" class="color-hex-input" id="inputBorderColorHex" value="#e2e8f0">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Send Button</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="sendBtnColor" value="#667eea">
                                    <input type="text" class="color-hex-input" id="sendBtnColorHex" value="#667eea">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Notification Badge</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="badgeColor" value="#ff4757">
                                    <input type="text" class="color-hex-input" id="badgeColorHex" value="#ff4757">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Launcher Tab -->
                    <div class="tab-content" id="tab-launcher">
                        <div class="color-grid" style="margin-bottom: 24px;">
                            <div class="color-item">
                                <label>Launcher Button Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="launcherColor" value="#667eea">
                                    <input type="text" class="color-hex-input" id="launcherColorHex" value="#667eea">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Launcher Icon</label>
                            <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">Choose the icon for your chat launcher button</p>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                                <button type="button" class="launcher-icon-option selected" data-icon="chat_multiple" onclick="selectLauncherIcon('chat_multiple')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M9.56158 3C5.41944 3 2.06158 6.35786 2.06158 10.5C2.06158 11.6329 2.31325 12.7088 2.76423 13.6734C2.5102 14.6714 2.22638 15.7842 2.03999 16.5147C1.80697 17.428 2.6294 18.2588 3.54374 18.039C4.29396 17.8587 5.44699 17.5819 6.47447 17.337C7.41678 17.7631 8.46241 18 9.56158 18C13.7037 18 17.0616 14.6421 17.0616 10.5C17.0616 6.35786 13.7037 3 9.56158 3ZM3.56158 10.5C3.56158 7.18629 6.24787 4.5 9.56158 4.5C12.8753 4.5 15.5616 7.18629 15.5616 10.5C15.5616 13.8137 12.8753 16.5 9.56158 16.5C8.60084 16.5 7.69487 16.2748 6.89161 15.8749L6.6482 15.7537L6.38368 15.8167C5.46095 16.0363 4.39489 16.2919 3.59592 16.4838C3.79467 15.7047 4.05784 14.6724 4.28601 13.7757L4.35619 13.4998L4.22568 13.2468C3.80145 12.4246 3.56158 11.4914 3.56158 10.5ZM14.5616 21.0001C12.5922 21.0001 10.8001 20.241 9.46191 18.9995C9.49511 18.9999 9.52835 19.0001 9.56163 19.0001C10.2796 19.0001 10.9768 18.911 11.6427 18.7434C12.5067 19.2254 13.5021 19.5001 14.5616 19.5001C15.5223 19.5001 16.4283 19.2748 17.2316 18.8749L17.475 18.7537L17.7395 18.8167C18.6611 19.0361 19.7046 19.2625 20.4787 19.4262C20.3037 18.6757 20.065 17.6711 19.8372 16.7757L19.767 16.4999L19.8975 16.2469C20.3217 15.4247 20.5616 14.4915 20.5616 13.5001C20.5616 11.3853 19.4676 9.52617 17.8146 8.45761C17.6363 7.73435 17.3653 7.04756 17.015 6.41052C19.9523 7.42684 22.0616 10.2171 22.0616 13.5001C22.0616 14.6332 21.8098 15.7094 21.3586 16.6741C21.6117 17.6821 21.8679 18.774 22.0304 19.4773C22.2348 20.3623 21.4554 21.1633 20.563 20.9768C19.8358 20.8248 18.6933 20.581 17.6495 20.3367C16.707 20.763 15.6611 21.0001 14.5616 21.0001Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Multiple</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_multiple_checkmark" onclick="selectLauncherIcon('chat_multiple_checkmark')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M13.0606 8.99827C13.3357 8.68869 13.3079 8.21463 12.9983 7.93944C12.6887 7.66425 12.2146 7.69214 11.9394 8.00173L8.44187 11.9365L7.0029 10.6359C6.69561 10.3582 6.22134 10.3821 5.94359 10.6894C5.66585 10.9967 5.6898 11.471 5.9971 11.7487L7.9971 13.5564C8.14546 13.6905 8.34124 13.7598 8.54094 13.7489C8.74063 13.738 8.92769 13.6477 9.06056 13.4983L13.0606 8.99827ZM2.06158 10.5C2.06158 6.35786 5.41944 3 9.56158 3C13.7037 3 17.0616 6.35786 17.0616 10.5C17.0616 14.6421 13.7037 18 9.56158 18C8.46241 18 7.41678 17.7631 6.47447 17.337C5.44699 17.5819 4.29396 17.8587 3.54374 18.039C2.6294 18.2588 1.80697 17.428 2.03999 16.5147C2.22638 15.7842 2.5102 14.6714 2.76423 13.6734C2.31325 12.7088 2.06158 11.6329 2.06158 10.5ZM9.56158 4.5C6.24787 4.5 3.56158 7.18629 3.56158 10.5C3.56158 11.4914 3.80145 12.4246 4.22568 13.2468L4.35619 13.4998L4.28601 13.7757C4.05784 14.6724 3.79467 15.7047 3.59592 16.4838C4.39489 16.2919 5.46095 16.0363 6.38368 15.8167L6.6482 15.7537L6.89161 15.8749C7.69487 16.2748 8.60084 16.5 9.56158 16.5C12.8753 16.5 15.5616 13.8137 15.5616 10.5C15.5616 7.18629 12.8753 4.5 9.56158 4.5ZM9.46191 18.9995C10.8001 20.241 12.5922 21.0001 14.5616 21.0001C15.6611 21.0001 16.707 20.763 17.6495 20.3367C18.6933 20.581 19.8358 20.8248 20.563 20.9768C21.4554 21.1633 22.2348 20.3623 22.0304 19.4773C21.8679 18.774 21.6117 17.6821 21.3586 16.6741C21.8098 15.7094 22.0616 14.6332 22.0616 13.5001C22.0616 10.2171 19.9523 7.42684 17.015 6.41052C17.3653 7.04756 17.6363 7.73435 17.8146 8.45761C19.4676 9.52617 20.5616 11.3853 20.5616 13.5001C20.5616 14.4915 20.3217 15.4247 19.8975 16.2469L19.767 16.4999L19.8372 16.7757C20.065 17.6711 20.3037 18.6757 20.4787 19.4262C19.7046 19.2625 18.6611 19.0361 17.7395 18.8167L17.475 18.7537L17.2316 18.8749C16.4283 19.2748 15.5223 19.5001 14.5616 19.5001C13.5021 19.5001 12.5067 19.2254 11.6427 18.7434C10.9768 18.911 10.2796 19.0001 9.56163 19.0001C9.52835 19.0001 9.49511 18.9999 9.46191 18.9995Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Multiple Check</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_sparkle" onclick="selectLauncherIcon('chat_sparkle')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M16.0883 6.41228C16.016 6.31886 15.9377 6.2298 15.8539 6.14569C15.5417 5.83255 15.1606 5.59666 14.741 5.45683L13.3632 5.00939C13.257 4.97196 13.165 4.90253 13.1 4.81068C13.0349 4.71883 13 4.60908 13 4.49656C13 4.38404 13.0349 4.27429 13.1 4.18244C13.165 4.09058 13.257 4.02116 13.3632 3.98372L14.741 3.53628C15.1547 3.39352 15.5299 3.15705 15.837 2.84537C16.1357 2.54224 16.3623 2.17595 16.5 1.77372L16.5114 1.73963L16.9592 0.362894C16.9967 0.256782 17.0662 0.164895 17.1581 0.0998993C17.25 0.0349035 17.3598 0 17.4724 0C17.5851 0 17.6949 0.0349035 17.7868 0.0998993C17.8787 0.164895 17.9482 0.256782 17.9857 0.362894L18.4335 1.73963C18.5727 2.15819 18.8077 2.53853 19.1198 2.85041C19.432 3.1623 19.8126 3.39715 20.2315 3.53628L21.6093 3.98372L21.6368 3.99061C21.743 4.02804 21.835 4.09747 21.9 4.18932C21.9651 4.28117 22 4.39092 22 4.50344C22 4.61596 21.9651 4.72571 21.9 4.81756C21.835 4.90942 21.743 4.97884 21.6368 5.01628L20.259 5.46372C19.8402 5.60285 19.4595 5.8377 19.1474 6.14959C18.8353 6.46147 18.6003 6.84181 18.461 7.26037L18.0132 8.63711C18.0092 8.64855 18.0048 8.65983 18 8.67093C17.9605 8.76273 17.8964 8.84212 17.8144 8.9001C17.7224 8.9651 17.6126 9 17.5 9C17.3874 9 17.2776 8.9651 17.1856 8.9001C17.0937 8.8351 17.0242 8.74322 16.9868 8.63711L16.539 7.26037C16.4378 6.95331 16.2851 6.66664 16.0883 6.41228ZM23.7829 10.2132L23.0175 9.9646C22.7848 9.8873 22.5733 9.75683 22.3999 9.58356C22.2265 9.41029 22.0959 9.199 22.0186 8.96646L21.7698 8.20161C21.749 8.14266 21.7104 8.09161 21.6593 8.0555C21.6083 8.01939 21.5473 8 21.4847 8C21.4221 8 21.3611 8.01939 21.31 8.0555C21.259 8.09161 21.2204 8.14266 21.1996 8.20161L20.9508 8.96646C20.875 9.19736 20.7467 9.40761 20.5761 9.58076C20.4055 9.75392 20.1971 9.88529 19.9672 9.9646L19.2018 10.2132C19.1428 10.234 19.0917 10.2725 19.0555 10.3236C19.0194 10.3746 19 10.4356 19 10.4981C19 10.5606 19.0194 10.6216 19.0555 10.6726C19.0917 10.7236 19.1428 10.7622 19.2018 10.783L19.9672 11.0316C20.2003 11.1093 20.412 11.2403 20.5855 11.4143C20.7589 11.5882 20.8893 11.8003 20.9661 12.0335L21.2149 12.7984C21.2357 12.8573 21.2743 12.9084 21.3254 12.9445C21.3764 12.9806 21.4374 13 21.5 13C21.5626 13 21.6236 12.9806 21.6746 12.9445C21.7257 12.9084 21.7643 12.8573 21.7851 12.7984L22.0339 12.0335C22.1113 11.801 22.2418 11.5897 22.4152 11.4164C22.5886 11.2432 22.8001 11.1127 23.0328 11.0354L23.7982 10.7868C23.8572 10.766 23.9083 10.7275 23.9445 10.6764C23.9806 10.6254 24 10.5644 24 10.5019C24 10.4394 23.9806 10.3784 23.9445 10.3274C23.9083 10.2764 23.8572 10.2378 23.7982 10.217L23.7829 10.2132ZM12 2C12.957 2 13.8826 2.13443 14.7589 2.38542C14.6435 2.45713 14.5197 2.51549 14.39 2.55903L13.05 2.99903C12.7677 3.09976 12.5186 3.27531 12.329 3.50625C12.2199 3.5021 12.1102 3.5 12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.1949 20.5 19.68 17.4613 20.3742 13.465C20.4642 13.5981 20.5776 13.7148 20.71 13.809C20.9288 13.9654 21.191 14.0495 21.46 14.0495C21.5752 14.0495 21.6892 14.034 21.7991 14.0041C20.871 18.5665 16.8365 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Sparkle</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_multiple_heart" onclick="selectLauncherIcon('chat_multiple_heart')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M6.3412 8.3412C7.1326 7.5498 8.41849 7.55366 9.21333 8.3485L9.49671 8.63188L9.77626 8.35179C10.5691 7.55898 11.8556 7.56284 12.6518 8.3591C13.4468 9.15408 13.4493 10.4364 12.6597 11.2303L9.73275 14.1556C9.6107 14.2777 9.41283 14.2777 9.29079 14.1556L6.3485 11.2133C5.55366 10.4185 5.5498 9.1326 6.3412 8.3412ZM2.06158 10.5C2.06158 6.35786 5.41944 3 9.56158 3C13.7037 3 17.0616 6.35786 17.0616 10.5C17.0616 14.6421 13.7037 18 9.56158 18C8.46241 18 7.41678 17.7631 6.47447 17.337C5.44699 17.5819 4.29396 17.8587 3.54374 18.039C2.6294 18.2588 1.80697 17.428 2.03999 16.5147C2.22638 15.7842 2.5102 14.6714 2.76423 13.6734C2.31325 12.7088 2.06158 11.6329 2.06158 10.5ZM9.56158 4.5C6.24787 4.5 3.56158 7.18629 3.56158 10.5C3.56158 11.4914 3.80145 12.4246 4.22568 13.2468L4.35619 13.4998L4.28601 13.7757C4.05784 14.6724 3.79467 15.7047 3.59592 16.4838C4.39489 16.2919 5.46095 16.0363 6.38368 15.8167L6.6482 15.7537L6.89161 15.8749C7.69487 16.2748 8.60084 16.5 9.56158 16.5C12.8753 16.5 15.5616 13.8137 15.5616 10.5C15.5616 7.18629 12.8753 4.5 9.56158 4.5ZM9.46191 18.9995C10.8001 20.241 12.5922 21.0001 14.5616 21.0001C15.6611 21.0001 16.707 20.763 17.6495 20.3367C18.6933 20.581 19.8358 20.8248 20.563 20.9768C21.4554 21.1633 22.2348 20.3623 22.0304 19.4773C21.8679 18.774 21.6117 17.6821 21.3586 16.6741C21.8098 15.7094 22.0616 14.6332 22.0616 13.5001C22.0616 10.2171 19.9523 7.42684 17.015 6.41052C17.3653 7.04756 17.6363 7.73435 17.8146 8.45761C19.4676 9.52617 20.5616 11.3853 20.5616 13.5001C20.5616 14.4915 20.3217 15.4247 19.8975 16.2469L19.767 16.4999L19.8372 16.7757C20.065 17.6711 20.3037 18.6757 20.4787 19.4262C19.7046 19.2625 18.6611 19.0361 17.7395 18.8167L17.475 18.7537L17.2316 18.8749C16.4283 19.2748 15.5223 19.5001 14.5616 19.5001C13.5021 19.5001 12.5067 19.2254 11.6427 18.7434C10.9768 18.911 10.2796 19.0001 9.56163 19.0001C9.52835 19.0001 9.49511 18.9999 9.46191 18.9995Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Heart</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_help" onclick="selectLauncherIcon('chat_help')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.6944 20.5 20.5 16.6944 20.5 12C20.5 7.30558 16.6944 3.5 12 3.5ZM12 15.5C12.5523 15.5 13 15.9477 13 16.5C13 17.0523 12.5523 17.5 12 17.5C11.4477 17.5 11 17.0523 11 16.5C11 15.9477 11.4477 15.5 12 15.5ZM12 6.75C13.5188 6.75 14.75 7.98122 14.75 9.5C14.75 10.5108 14.4525 11.074 13.6989 11.8586L13.5303 12.0303C12.9084 12.6522 12.75 12.9163 12.75 13.5C12.75 13.9142 12.4142 14.25 12 14.25C11.5858 14.25 11.25 13.9142 11.25 13.5C11.25 12.4892 11.5475 11.926 12.3011 11.1414L12.4697 10.9697C13.0916 10.3478 13.25 10.0837 13.25 9.5C13.25 8.80964 12.6904 8.25 12 8.25C11.3528 8.25 10.8205 8.74187 10.7565 9.37219L10.75 9.5C10.75 9.91421 10.4142 10.25 10 10.25C9.58579 10.25 9.25 9.91421 9.25 9.5C9.25 7.98122 10.4812 6.75 12 6.75Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Help</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_empty" onclick="selectLauncherIcon('chat_empty')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M5.25 18C3.45507 18 2 16.5449 2 14.75V6.25C2 4.45507 3.45507 3 5.25 3H18.75C20.5449 3 22 4.45507 22 6.25V14.75C22 16.5449 20.5449 18 18.75 18H13.0125L7.99868 21.7507C7.44585 22.1642 6.6625 22.0512 6.24901 21.4984C6.08736 21.2822 6 21.0196 6 20.7499L5.99921 18H5.25ZM12.5135 16.5H18.75C19.7165 16.5 20.5 15.7165 20.5 14.75V6.25C20.5 5.2835 19.7165 4.5 18.75 4.5H5.25C4.2835 4.5 3.5 5.2835 3.5 6.25V14.75C3.5 15.7165 4.2835 16.5 5.25 16.5H7.49879L7.499 17.2498L7.49986 20.2506L12.5135 16.5Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Comment</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat_bubbles_question" onclick="selectLauncherIcon('chat_bubbles_question')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M8.14303 6.30723C8.57707 6.07535 9.04414 6.00076 9.49888 6.00073C10.0253 6.0007 10.6367 6.17363 11.1305 6.57829C11.6475 7.00192 11.9989 7.65186 11.9989 8.5C11.9989 9.47459 11.3102 10.0037 10.9219 10.302C10.8918 10.3252 10.8634 10.347 10.8373 10.3675C10.4127 10.7012 10.2489 10.8795 10.2489 11.25C10.2489 11.6642 9.91314 12 9.49892 12C9.08471 12 8.74892 11.6642 8.74892 11.25C8.74892 10.116 9.46017 9.54195 9.91052 9.18806C10.4238 8.78469 10.4989 8.69484 10.4989 8.5C10.4989 8.10296 10.3503 7.87825 10.1798 7.73853C9.98616 7.57985 9.72254 7.50072 9.49896 7.50073C9.20371 7.50075 9.00078 7.54962 8.84982 7.63027C8.70637 7.7069 8.55459 7.84146 8.40826 8.11137C8.21083 8.47551 7.7556 8.61066 7.39146 8.41324C7.02732 8.21582 6.89217 7.76058 7.08959 7.39644C7.35326 6.91012 7.70147 6.54311 8.14303 6.30723ZM9.49909 15.0001C10.0514 15.0001 10.4992 14.5524 10.4992 14.0001C10.4992 13.4477 10.0514 13 9.49909 13C8.94677 13 8.49902 13.4477 8.49902 14.0001C8.49902 14.5524 8.94677 15.0001 9.49909 15.0001ZM9.49908 3C5.35694 3 1.99908 6.35786 1.99908 10.5C1.99908 11.6329 2.25075 12.7088 2.70173 13.6734C2.4477 14.6714 2.16388 15.7842 1.97749 16.5147C1.74447 17.428 2.5669 18.2588 3.48124 18.039C4.23146 17.8587 5.38449 17.5819 6.41197 17.337C7.35428 17.7631 8.39991 18 9.49908 18C13.6412 18 16.9991 14.6421 16.9991 10.5C16.9991 6.35786 13.6412 3 9.49908 3ZM3.49908 10.5C3.49908 7.18629 6.18537 4.5 9.49908 4.5C12.8128 4.5 15.4991 7.18629 15.4991 10.5C15.4991 13.8137 12.8128 16.5 9.49908 16.5C8.53834 16.5 7.63237 16.2748 6.82911 15.8749L6.5857 15.7537L6.32118 15.8167C5.39845 16.0363 4.33239 16.2919 3.53342 16.4838C3.73217 15.7047 3.99534 14.6724 4.22351 13.7757L4.29369 13.4998L4.16318 13.2468C3.73895 12.4246 3.49908 11.4914 3.49908 10.5ZM14.4991 21.0001C12.5297 21.0001 10.7376 20.241 9.39941 18.9995C9.43261 18.9999 9.46585 19.0001 9.49913 19.0001C10.2171 19.0001 10.9143 18.911 11.5802 18.7434C12.4442 19.2254 13.4396 19.5001 14.4991 19.5001C15.4598 19.5001 16.3658 19.2748 17.1691 18.8749L17.4125 18.7537L17.677 18.8167C18.5986 19.0361 19.6421 19.2625 20.4162 19.4262C20.2412 18.6757 20.0025 17.6711 19.7747 16.7757L19.7045 16.4999L19.835 16.2469C20.2592 15.4247 20.4991 14.4915 20.4991 13.5001C20.4991 11.3853 19.4051 9.52617 17.7521 8.45761C17.5738 7.73435 17.3028 7.04756 16.9525 6.41052C19.8898 7.42684 21.9991 10.2171 21.9991 13.5001C21.9991 14.6332 21.7473 15.7094 21.2961 16.6741C21.5492 17.6821 21.8054 18.774 21.9679 19.4773C22.1723 20.3623 21.3929 21.1633 20.5005 20.9768C19.7733 20.8248 18.6308 20.581 17.587 20.3367C16.6445 20.763 15.5986 21.0001 14.4991 21.0001Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat Question</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="chat" onclick="selectLauncherIcon('chat')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.6944 20.5 20.5 16.6944 20.5 12C20.5 7.30558 16.6944 3.5 12 3.5Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Chat</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="bot" onclick="selectLauncherIcon('bot')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M17.7534 13.9994C18.9961 13.9994 20.0034 15.0068 20.0034 16.2494V17.1545C20.0034 18.2482 19.526 19.2874 18.6961 19.9998C17.1307 21.3437 14.8904 22.0006 12.0004 22.0006C9.11087 22.0006 6.87205 21.344 5.30918 20.0003C4.48056 19.2879 4.00391 18.2495 4.00391 17.1567V16.2494C4.00391 15.0068 5.01127 13.9994 6.25391 13.9994H17.7534ZM17.7534 15.4994H6.25391C5.83969 15.4994 5.50391 15.8352 5.50391 16.2494V17.1567C5.50391 17.8124 5.7899 18.4354 6.28707 18.8629C7.54516 19.9445 9.44117 20.5006 12.0004 20.5006C14.5603 20.5006 16.4582 19.9442 17.7191 18.8617C18.2169 18.4342 18.5034 17.8107 18.5034 17.1545V16.2494C18.5034 15.8352 18.1676 15.4994 17.7534 15.4994ZM11.8989 2.00685L12.0007 2C12.3804 2 12.6942 2.28215 12.7438 2.64823L12.7507 2.75L12.7499 3.499L16.2504 3.49951C17.493 3.49951 18.5004 4.50687 18.5004 5.74951V10.2541C18.5004 11.4967 17.493 12.5041 16.2504 12.5041H7.75036C6.50772 12.5041 5.50036 11.4967 5.50036 10.2541V5.74951C5.50036 4.50687 6.50772 3.49951 7.75036 3.49951L11.2499 3.499L11.2507 2.75C11.2507 2.3703 11.5328 2.05651 11.8989 2.00685L12.0007 2L11.8989 2.00685ZM16.2504 4.99951H7.75036C7.33615 4.99951 7.00036 5.33529 7.00036 5.74951V10.2541C7.00036 10.6683 7.33615 11.0041 7.75036 11.0041H16.2504C16.6646 11.0041 17.0004 10.6683 17.0004 10.2541V5.74951C17.0004 5.33529 16.6646 4.99951 16.2504 4.99951ZM9.74965 6.49951C10.4396 6.49951 10.9989 7.05883 10.9989 7.74879C10.9989 8.43876 10.4396 8.99808 9.74965 8.99808C9.05969 8.99808 8.50036 8.43876 8.50036 7.74879C8.50036 7.05883 9.05969 6.49951 9.74965 6.49951ZM14.2424 6.49951C14.9324 6.49951 15.4917 7.05883 15.4917 7.74879C15.4917 8.43876 14.9324 8.99808 14.2424 8.99808C13.5524 8.99808 12.9931 8.43876 12.9931 7.74879C12.9931 7.05883 13.5524 6.49951 14.2424 6.49951Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Bot</span>
                                </button>
                                <button type="button" class="launcher-icon-option" data-icon="bot_sparkle" onclick="selectLauncherIcon('bot_sparkle')" style="padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: all 0.2s;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #667eea;"><path d="M18.5004 10.2546C18.5004 10.2994 18.4991 10.3438 18.4965 10.3879C18.4546 10.3508 18.4105 10.3159 18.3645 10.2834C18.1037 10.099 17.7921 10 17.4728 10C17.3115 10 17.1522 10.0253 17.0004 10.074V5.74999C17.0004 5.33578 16.6646 4.99999 16.2504 4.99999H7.75036C7.33615 4.99999 7.00036 5.33578 7.00036 5.74999V10.2546C7.00036 10.6688 7.33615 11.0046 7.75036 11.0046H16.0258L16.0166 11.03L16.0125 11.0417L15.5622 12.426L15.5534 12.4524C15.5474 12.4699 15.5411 12.4873 15.5345 12.5046H7.75036C6.50772 12.5046 5.50036 11.4972 5.50036 10.2546V5.74999C5.50036 4.50735 6.50772 3.49999 7.75036 3.49999L11.2499 3.49949L11.2507 2.75049C11.2507 2.37079 11.5328 2.057 11.8989 2.00733L12.0007 2.00049C12.3804 2.00049 12.6942 2.28264 12.7438 2.64872L12.7507 2.75049L12.7499 3.49949L16.2504 3.49999C17.493 3.49999 18.5004 4.50735 18.5004 5.74999V10.2546ZM13.0428 14.0365L13.1554 13.9999H6.25391C5.01127 13.9999 4.00391 15.0073 4.00391 16.2499V17.1572C4.00391 18.25 4.48056 19.2884 5.30918 20.0008C6.87205 21.3445 9.11087 22.0011 12.0004 22.0011C14.0763 22.0011 15.8171 21.6621 17.2132 20.9731C16.9968 20.9321 16.7904 20.8451 16.6087 20.7166C16.3478 20.5322 16.1506 20.2714 16.0442 19.97L16.04 19.9583L16.0096 19.8646C14.9245 20.2865 13.5901 20.5011 12.0004 20.5011C9.44117 20.5011 7.54516 19.945 6.28707 18.8634C5.7899 18.4359 5.50391 17.8129 5.50391 17.1572V16.2499C5.50391 15.8357 5.83969 15.4999 6.25391 15.4999H12.0004L12.0004 15.4966C12.0004 15.1769 12.0996 14.8653 12.2843 14.6045C12.4689 14.3438 12.7299 14.1468 13.0311 14.0406L13.0428 14.0365ZM10.9989 7.74928C10.9989 7.05932 10.4396 6.49999 9.74965 6.49999C9.05969 6.49999 8.50036 7.05932 8.50036 7.74928C8.50036 8.43925 9.05969 8.99857 9.74965 8.99857C10.4396 8.99857 10.9989 8.43925 10.9989 7.74928ZM14.2424 6.49999C14.9324 6.49999 15.4917 7.05932 15.4917 7.74928C15.4917 8.43925 14.9324 8.99857 14.2424 8.99857C13.5524 8.99857 12.9931 8.43925 12.9931 7.74928C12.9931 7.05932 13.5524 6.49999 14.2424 6.49999ZM16.0886 17.4123C16.0163 17.3189 15.9381 17.2298 15.8542 17.1457C15.5421 16.8326 15.161 16.5967 14.7413 16.4568L13.3635 16.0094C13.2573 15.972 13.1654 15.9025 13.1003 15.8107C13.0353 15.7188 13.0004 15.6091 13.0004 15.4966C13.0004 15.384 13.0353 15.2743 13.1003 15.1824C13.1654 15.0906 13.2573 15.0212 13.3635 14.9837L14.7413 14.5363C15.1551 14.3935 15.5302 14.1571 15.8374 13.8454C16.1361 13.5422 16.3626 13.1759 16.5004 12.7737L16.5118 12.7396L16.9596 11.3629C16.997 11.2568 17.0665 11.1649 17.1584 11.0999C17.2504 11.0349 17.3602 11 17.4728 11C17.5854 11 17.6953 11.0349 17.7872 11.0999C17.8791 11.1649 17.9486 11.2568 17.986 11.3629L18.4338 12.7396C18.5731 13.1582 18.8081 13.5385 19.1202 13.8504C19.4323 14.1623 19.813 14.3971 20.2318 14.5363L21.6096 14.9837L21.6372 14.9906C21.7434 15.028 21.8353 15.0975 21.9004 15.1893C21.9654 15.2812 22.0004 15.3909 22.0004 15.5034C22.0004 15.616 21.9654 15.7257 21.9004 15.8176C21.8353 15.9094 21.7434 15.9788 21.6372 16.0163L20.2594 16.4637C19.8405 16.6029 19.4599 16.8377 19.1478 17.1496C18.8356 17.4615 18.6006 17.8418 18.4614 18.2604L18.0136 19.6371C18.0096 19.6486 18.0051 19.6598 18.0004 19.6709C17.9609 19.7627 17.8967 19.8421 17.8147 19.9001C17.7228 19.9651 17.613 20 17.5004 20C17.3878 20 17.2779 19.9651 17.186 19.9001C17.0941 19.8351 17.0246 19.7432 16.9871 19.6371L16.5394 18.2604C16.4382 17.9533 16.2855 17.6666 16.0886 17.4123ZM23.7833 21.2132L23.0179 20.9646C22.7851 20.8873 22.5737 20.7568 22.4003 20.5836C22.2269 20.4103 22.0963 20.199 22.019 19.9665L21.7702 19.2016C21.7494 19.1427 21.7108 19.0916 21.6597 19.0555C21.6086 19.0194 21.5476 19 21.4851 19C21.4225 19 21.3615 19.0194 21.3104 19.0555C21.2593 19.0916 21.2207 19.1427 21.1999 19.2016L20.9512 19.9665C20.8753 20.1974 20.7471 20.4076 20.5765 20.5808C20.4058 20.7539 20.1974 20.8853 19.9676 20.9646L19.2021 21.2132C19.1431 21.234 19.092 21.2725 19.0559 21.3236C19.0198 21.3746 19.0004 21.4356 19.0004 21.4981C19.0004 21.5606 19.0198 21.6216 19.0559 21.6726C19.092 21.7236 19.1431 21.7622 19.2021 21.783L19.9676 22.0316C20.2007 22.1093 20.4124 22.2403 20.5858 22.4143C20.7593 22.5882 20.8896 22.8003 20.9665 23.0335L21.2152 23.7984C21.2361 23.8573 21.2747 23.9084 21.3257 23.9445C21.3768 23.9806 21.4378 24 21.5004 24C21.5629 24 21.6239 23.9806 21.675 23.9445C21.7261 23.9084 21.7647 23.8573 21.7855 23.7984L22.0343 23.0335C22.1116 22.801 22.2422 22.5897 22.4156 22.4164C22.589 22.2432 22.8005 22.1127 23.0332 22.0354L23.7986 21.7868C23.8576 21.766 23.9087 21.7275 23.9448 21.6764C23.981 21.6254 24.0004 21.5644 24.0004 21.5019C24.0004 21.4394 23.981 21.3784 23.9448 21.3274C23.9087 21.2764 23.8576 21.2378 23.7986 21.217L23.7833 21.2132Z"/></svg>
                                    <span style="font-size: 11px; font-weight: 500; color: #64748b;">Bot Sparkle</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pre-chat Tab -->
                    <div class="tab-content" id="tab-prechat">
                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Customize the colors for the pre-chat hero section with avatars and status indicator</p>
                        
                        <h4 style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px;">Hero Background</h4>
                        <div class="gradient-toggle" style="margin-bottom: 12px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="usePrechatGradient" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Use gradient for pre-chat hero</span>
                        </div>
                        <div class="gradient-colors show" id="prechatGradientColors">
                            <div class="color-item">
                                <label>Gradient Start</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="prechatGradientStart" value="#667eea">
                                    <input type="text" class="color-hex-input" id="prechatGradientStartHex" value="#667eea">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Gradient End</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="prechatGradientEnd" value="#764ba2">
                                    <input type="text" class="color-hex-input" id="prechatGradientEndHex" value="#764ba2">
                                </div>
                            </div>
                        </div>
                        <div class="color-grid" id="prechatSolidColorPicker" style="display:none; margin-bottom: 20px;">
                            <div class="color-item">
                                <label>Hero Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="prechatSolidColor" value="#667eea">
                                    <input type="text" class="color-hex-input" id="prechatSolidColorHex" value="#667eea">
                                </div>
                            </div>
                        </div>
                        
                        <h4 style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px;">Text Colors</h4>
                        <div class="color-grid" style="margin-bottom: 20px;">
                            <div class="color-item">
                                <label>Title Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="prechatTitleColor" value="#ffffff">
                                    <input type="text" class="color-hex-input" id="prechatTitleColorHex" value="#ffffff">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Subtitle Color</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="prechatSubtitleColor" value="#e0e7ff">
                                    <input type="text" class="color-hex-input" id="prechatSubtitleColorHex" value="#e0e7ff">
                                </div>
                            </div>
                        </div>
                        
                        <h4 style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px;">Status Badge</h4>
                        <div class="color-grid" style="margin-bottom: 20px;">
                            <div class="color-item">
                                <label>Badge Background</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="prechatBadgeBg" value="#ffffff">
                                    <input type="text" class="color-hex-input" id="prechatBadgeBgHex" value="#ffffff">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Badge Text</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="prechatBadgeText" value="#059669">
                                    <input type="text" class="color-hex-input" id="prechatBadgeTextHex" value="#059669">
                                </div>
                            </div>
                            <div class="color-item">
                                <label>Status Dot</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="prechatStatusDot" value="#10b981">
                                    <input type="text" class="color-hex-input" id="prechatStatusDotHex" value="#10b981">
                                </div>
                            </div>
                        </div>
                        
                        <h4 style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px;">Avatar Borders</h4>
                        <div class="color-grid">
                            <div class="color-item">
                                <label>Avatar Border</label>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="prechatAvatarBorder" value="#ffffff">
                                    <input type="text" class="color-hex-input" id="prechatAvatarBorderHex" value="#ffffff">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Avatars -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <img src="img/icon/cat.png" alt="Avatars" style="width: 24px; height: 24px; object-fit: contain;">
                    </div>
                    <div>
                        <h2>Avatars</h2>
                        <p>Upload custom avatars for agents and customers</p>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: start;">
                        <div class="form-group">
                            <label class="form-label">Default Agent Avatar</label>
                            <div class="image-upload-area" id="agentAvatarArea">
                                <div class="upload-icon">
                                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                </div>
                                <div class="upload-text">Select from gallery or enter URL below</div>
                                <div class="upload-hint">Click a thumbnail to select</div>
                            </div>
                            <div class="avatar-thumbnails">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female1.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female1.png', true)" alt="Female 1" title="Female 1">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female2.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female2.png', true)" alt="Female 2" title="Female 2">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female3.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female3.png', true)" alt="Female 3" title="Female 3">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female4.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female4.png', true)" alt="Female 4" title="Female 4">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male1.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male1.png', true)" alt="Male 1" title="Male 1">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male2.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male2.png', true)" alt="Male 2" title="Male 2">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male3.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male3.png', true)" alt="Male 3" title="Male 3">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male4.png" class="avatar-thumb" onclick="selectAvatar('agentAvatar', 'agentAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male4.png', true)" alt="Male 4" title="Male 4">
                            </div>
                            <div class="path-input-group" style="margin-top: 8px;">
                                <input type="text" class="form-input" id="agentAvatarPathInput" placeholder="https://i.postimg.cc/your-avatar.png" style="font-size: 12px;">
                                <button type="button" class="btn-small" onclick="applyImagePath('agentAvatar', 'agentAvatarPathInput', 'agentAvatarArea', true)">Apply</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Customer Avatar</label>
                            <div class="image-upload-area" id="customerAvatarArea">
                                <div class="upload-icon">
                                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                </div>
                                <div class="upload-text">Select from gallery or enter URL below</div>
                                <div class="upload-hint">Click a thumbnail to select</div>
                            </div>
                            <div class="avatar-thumbnails">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female1.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female1.png', true)" alt="Female 1" title="Female 1">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female2.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female2.png', true)" alt="Female 2" title="Female 2">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female3.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female3.png', true)" alt="Female 3" title="Female 3">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female4.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female4.png', true)" alt="Female 4" title="Female 4">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male1.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male1.png', true)" alt="Male 1" title="Male 1">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male2.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male2.png', true)" alt="Male 2" title="Male 2">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male3.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male3.png', true)" alt="Male 3" title="Male 3">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male4.png" class="avatar-thumb" onclick="selectAvatar('customerAvatar', 'customerAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male4.png', true)" alt="Male 4" title="Male 4">
                            </div>
                            <div class="path-input-group" style="margin-top: 8px;">
                                <input type="text" class="form-input" id="customerAvatarPathInput" placeholder="https://i.postimg.cc/your-avatar.png" style="font-size: 12px;">
                                <button type="button" class="btn-small" onclick="applyImagePath('customerAvatar', 'customerAvatarPathInput', 'customerAvatarArea', true)">Apply</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Bot Avatar</label>
                            <div class="image-upload-area" id="botAvatarArea">
                                <div class="upload-icon">
                                    <svg viewBox="0 0 24 24"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zM7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5zM16 17H8v-2h8v2zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13z"/></svg>
                                </div>
                                <div class="upload-text">Select from gallery or enter URL below</div>
                                <div class="upload-hint">Click a thumbnail to select</div>
                            </div>
                            <div class="avatar-thumbnails">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot1.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot1.png', true)" alt="Bot 1" title="Bot 1">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot2.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot2.png', true)" alt="Bot 2" title="Bot 2">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot3.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot3.png', true)" alt="Bot 3" title="Bot 3">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot4.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot4.png', true)" alt="Bot 4" title="Bot 4">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot5.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot5.png', true)" alt="Bot 5" title="Bot 5">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot6.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot6.png', true)" alt="Bot 6" title="Bot 6">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot7.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot7.png', true)" alt="Bot 7" title="Bot 7">
                                <img src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot8.png" class="avatar-thumb" onclick="selectAvatar('botAvatar', 'botAvatarArea', 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/bot/bot8.png', true)" alt="Bot 8" title="Bot 8">
                            </div>
                            <div class="path-input-group" style="margin-top: 8px;">
                                <input type="text" class="form-input" id="botAvatarPathInput" placeholder="https://i.postimg.cc/your-avatar.png" style="font-size: 12px;">
                                <button type="button" class="btn-small" onclick="applyImagePath('botAvatar', 'botAvatarPathInput', 'botAvatarArea', true)">Apply</button>
                            </div>
                        </div>
                    </div>
                    <p class="form-hint" style="margin-top: 12px;">These avatars will be used as defaults. Agent's actual photo from D365 will override if available.</p>
                    <p class="form-hint" style="margin-top: 8px;"> Paste any public image URL directly, or upload your own image to <a href="https://postimages.org" target="_blank" style="color: #6366f1;">postimages.org</a> / <a href="https://imgbb.com" target="_blank" style="color: #6366f1;">imgbb.com</a> to get a public URL. Copy the direct image link (ends in .png, .jpg, etc.).</p>
                </div>
            </div>

            </div><!-- End customWidgetSettings -->

            <!-- Embed Widget Code Section -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-header-icon">
                        <img src="img/icon/coding.png" alt="Embed Widget Code" style="width: 24px; height: 24px; object-fit: contain;">
                    </div>
                    <div>
                        <h2>Embed Widget Code</h2>
                        <p>Generate script to embed widget on your website</p>
                    </div>
                </div>
                <div class="card-body">
                    <div class="embed-info">
                        <div class="embed-info-text">
                            <p>Paste before <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; font-size: 11px;">&lt;/body&gt;</code></p>
                        </div>
                    </div>
                    
                    <div class="embed-options">
                        <div class="embed-option full-width">
                            <label for="embedCodeMode" style="min-width: fit-content;">Mode:</label>
                            <select id="embedCodeMode">
                                <option value="compact"> Compact (Power Pages) - Under 2KB!</option>
                                <option value="full"> Full (Self-Contained) - ~100KB</option>
                            </select>
                        </div>
                        <div class="embed-option">
                            <input type="checkbox" id="embedIncludeSettings" checked style="width: 18px; height: 18px; cursor: pointer; accent-color: #4f46e5;">
                            <label for="embedIncludeSettings">Include settings</label>
                        </div>
                        <div class="embed-option">
                            <input type="checkbox" id="embedMinified" checked style="width: 18px; height: 18px; cursor: pointer; accent-color: #4f46e5;">
                            <label for="embedMinified">Minified output</label>
                        </div>
                    </div>

                    <!-- Character count indicator -->
                    <div id="embedCharCount" style="margin: 12px 0; padding: 12px 16px; border-radius: 8px; font-size: 13px; display: none;">
                        <span id="charCountText"></span>
                        <div style="margin-top: 8px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                            <div id="charCountBar" style="height: 100%; border-radius: 3px; transition: width 0.3s, background 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div class="info-box" style="margin-bottom: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 14px;">
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #64748b; flex-shrink: 0; margin-top: 1px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                            <div style="flex: 1;">
                                <p style="margin: 0; font-size: 12px; color: #64748b; line-height: 1.5;">
                                    <strong style="color: #475569;">Power Pages users:</strong> Add <code style="padding: 2px 5px; background: #e2e8f0; border-radius: 3px; font-size: 11px; color: #334155;">cdn.jsdelivr.net, unpkg.com, oc-cdn-ocprod.azureedge.net</code> to CSP if SDK fails to load.<br>
                                    <span style="color: #64748b;">Navigate to: <strong style="color: #475569;">Power Pages  Security  Advanced settings  Content Security Providers (CSP)</strong></span>
                                    <a href="https://github.com/moliveirapinto/d365-modern-chat-widget/blob/main/img/extra/image%20374657381.png?raw=true" target="_blank" style="margin-left: 6px; color: #6366f1; text-decoration: none; font-weight: 500;"> See example</a>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="embed-code-container">
                        <textarea id="embedCodeOutput" class="embed-code-textarea" readonly placeholder="Click 'Generate Embed Code' to create your widget script..."></textarea>
                    </div>
                    
                    <div class="embed-code-actions">
                        <button class="btn btn-primary" onclick="generateEmbedCode()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); box-shadow: 0 2px 8px rgba(139, 92, 246, 0.25);">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;"><path d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z"/></svg>
                            Generate Embed Code
                        </button>
                        <button class="btn btn-primary" onclick="generateTamperMonkeyCode()" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-color: #16213e;">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            Generate TamperMonkey Code
                        </button>
                        <button class="btn btn-secondary" onclick="copyGeneratedEmbedCode()">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                            Copy to Clipboard
                        </button>
                        <button class="btn btn-primary" id="downloadHtmlBtn" onclick="downloadEmbedCode()" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-color: #059669; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            Download as HTML
                        </button>
                        <span class="copy-success" id="copySuccess">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            Copied!
                        </span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="settings-card">
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveSettings()">
                        <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                        Save Settings
                    </button>
                    <button class="btn btn-secondary" onclick="resetSettings()" style="background: #dc3545; border-color: #dc3545; color: white;">
                        <svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                        Reset to Default
                    </button>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <a href="live.html" target="_blank" class="btn btn-success" id="goToWidgetBtn" style="text-decoration:none;">
                            <svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
                            Go to Live Widget
                        </a>
                        <span style="font-size: 11px; color: #94a3b8; white-space: nowrap;">(save first!)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Preview -->
        <div class="preview-panel">
            <div class="preview-card">
                <div class="card-header" style="background: linear-gradient(135deg, #4f46e5 0%, #06b6d4 100%); padding: 10px 16px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 6px; background: rgba(239,68,68,0.9); padding: 4px 10px; border-radius: 4px;">
                            <span style="width: 8px; height: 8px; background: white; border-radius: 50%; animation: pulse 1.5s infinite;"></span>
                            <span style="font-size: 11px; font-weight: 600; color: white; text-transform: uppercase; letter-spacing: 0.5px;">REC</span>
                        </div>
                    </div>
                    <div style="flex: 1; margin-left: 10px;">
                        <h2 style="color: white; font-size: 14px; margin: 0;">Live Preview</h2>
                    </div>
                </div>
                
                <!-- Preview Tabs -->
                <div class="preview-tabs" id="customPreviewTabs">
                    <button class="preview-tab active" onclick="switchPreviewTab('prechat')">Pre-chat</button>
                    <button class="preview-tab" onclick="switchPreviewTab('chat')">Chat Preview</button>
                    <button class="preview-tab" onclick="switchPreviewTab('launcher')">Launcher</button>
                </div>
                
                <!-- Standard Widget Preview Tab (shown when standard mode selected) -->
                <div class="preview-tabs hidden" id="standardPreviewTabs">
                    <button class="preview-tab active" onclick="switchPreviewTab('standard')">Standard Widget</button>
                </div>
                
                <!-- Standard Widget Preview -->
                <div class="preview-content" id="standardPreview">
                    <div class="preview-widget-container" style="background: #e2e8f0; padding: 0; overflow: hidden;">
                        <!-- Placeholder when no LCW code -->
                        <div id="standardPreviewPlaceholder" style="height: 450px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; text-align: center;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="#94a3b8" style="margin-bottom: 16px;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/></svg>
                            <div style="font-size: 14px; font-weight: 600; color: #475569; margin-bottom: 8px;">No LCW Code Configured</div>
                            <div style="font-size: 12px; color: #94a3b8; line-height: 1.5; max-width: 260px;">Paste your D365 Live Chat Widget embed code in the "LCW Embed Code" field above to see a live preview.</div>
                        </div>
                        <!-- IFrame for actual preview -->
                        <iframe id="standardPreviewIframe" style="width: 100%; height: 450px; border: none; display: none; background: #e2e8f0;" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe>
                    </div>
                    <!-- Footer with refresh -->
                    <div id="standardPreviewFooter" style="display: none; margin-top: 12px; padding: 12px 16px; text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#16a34a"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            <span style="font-size: 12px; color: #16a34a; font-weight: 500;">Widget loaded from your LCW code</span>
                        </div>
                        <button onclick="refreshStandardPreview()" style="background: #0078d4; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            Refresh Preview
                        </button>
                    </div>
                </div>
                
                <!-- Pre-chat Form Preview -->
                <div class="preview-content active" id="prechatPreview">
                <div class="preview-widget-container" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); background-image: none;">
                    <div class="widget-preview" style="background: white; border-radius: 8px; overflow: hidden;">
                        <div class="preview-header" id="previewPrechatHeader">
                            <div class="preview-header-avatar" id="previewPrechatHeaderAvatar">
                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                            </div>
                            <div class="preview-header-info">
                                <div class="preview-header-title" id="previewPrechatTitle">Support Chat</div>
                                <div class="preview-header-status" id="previewPrechatStatus">We're here to help</div>
                            </div>
                        </div>
                        <!-- Pre-chat Hero Section -->
                        <div class="prechat-hero-preview" id="previewPrechatHero" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 28px 20px 24px; text-align: center; position: relative; overflow: hidden;">
                            <div id="previewPrechatStatusBadge" style="position: absolute; top: 8px; right: 8px; display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); backdrop-filter: blur(8px); padding: 5px 10px 5px 7px; border-radius: 16px; font-size: 11px; color: white; font-weight: 500;">
                                <span id="previewPrechatStatusDot" style="width: 7px; height: 7px; background: #10b981; border-radius: 50%; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);"></span>
                                <span>Online</span>
                            </div>
                            <div style="display: flex; justify-content: center; margin-bottom: 14px;">
                                <div class="prechat-avatar-preview" style="width: 42px; height: 42px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.9); background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; margin: 0 -6px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); overflow: hidden; z-index: 3;">
                                    <img src="img/headshots/headshot_female1.png" style="width: 100%; height: 100%; object-fit: cover;" alt="">
                                </div>
                                <div class="prechat-avatar-preview" style="width: 42px; height: 42px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.9); background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; margin: 0 -6px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); overflow: hidden; z-index: 2;">
                                    <img src="img/headshots/headshot_male1.png" style="width: 100%; height: 100%; object-fit: cover;" alt="">
                                </div>
                                <div class="prechat-avatar-preview" style="width: 42px; height: 42px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.9); background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; margin: 0 -6px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); overflow: hidden; z-index: 1;">
                                    <img src="img/headshots/headshot_female2.png" style="width: 100%; height: 100%; object-fit: cover;" alt="">
                                </div>
                            </div>
                            <div id="previewPrechatHeroTitle" style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 6px; letter-spacing: -0.3px;">Start a conversation</div>
                            <div id="previewPrechatHeroSubtitle" style="font-size: 12px; color: rgba(255,255,255,0.9); line-height: 1.4;">We're here to help!<br>Fill out the form below to chat with our team.</div>
                        </div>
                        <div style="padding: 16px;">
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div>
                                    <label id="previewNameLabel" style="display: flex; align-items: center; gap: 3px; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px;">Your Name <span style="color: #ef4444;">*</span></label>
                                    <div style="position: relative;">
                                        <input type="text" placeholder="Enter your name" style="width: 100%; box-sizing: border-box; padding: 10px 12px 10px 36px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 13px; background: #f9fafb;">
                                        <svg style="position: absolute; left: 11px; top: 50%; transform: translateY(-50%); width: 15px; height: 15px; color: #9ca3af;" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                    </div>
                                </div>
                                <div>
                                    <label id="previewEmailLabel" style="display: flex; align-items: center; gap: 3px; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px;">Email Address <span style="color: #ef4444;">*</span></label>
                                    <div style="position: relative;">
                                        <input type="email" placeholder="your@email.com" style="width: 100%; box-sizing: border-box; padding: 10px 12px 10px 36px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 13px; background: #f9fafb;">
                                        <svg style="position: absolute; left: 11px; top: 50%; transform: translateY(-50%); width: 15px; height: 15px; color: #9ca3af;" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                                    </div>
                                </div>
                                <div>
                                    <label id="previewQuestionLabel" style="display: flex; align-items: center; gap: 3px; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 4px;">How can we help? <span style="font-weight: 400; color: #9ca3af;">(optional)</span></label>
                                    <textarea id="previewQuestionPlaceholder" placeholder="Describe your question or issue..." style="width: 100%; box-sizing: border-box; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 13px; font-family: inherit; min-height: 60px; resize: vertical; background: #f9fafb;"></textarea>
                                </div>
                                <button id="previewStartBtn" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 13px; cursor: pointer; margin-top: 4px; box-shadow: 0 3px 10px rgba(0,0,0,0.15);">Start Chat</button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Chat Preview -->
                <div class="preview-content" id="chatPreview">
                <div class="preview-widget-container">
                    <div class="widget-preview">
                        <div class="preview-header" id="previewHeader">
                            <div class="preview-header-avatar" id="previewHeaderAvatar">
                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                            </div>
                            <div class="preview-header-info">
                                <div class="preview-header-title" id="previewTitle">Support Chat</div>
                                <div class="preview-header-status" id="previewStatus">We're here to help</div>
                            </div>
                        </div>
                        <div class="preview-messages" id="previewMessages">
                            <div class="preview-message agent">
                                <div class="preview-msg-avatar bot" id="previewBotAvatar">B</div>
                                <div class="preview-msg-bubble" id="previewBotBubble">Hello! How can I help you today?</div>
                            </div>
                            <div class="preview-message user">
                                <div class="preview-msg-avatar user" id="previewUserAvatar">U</div>
                                <div class="preview-msg-bubble" id="previewUserBubble">Hi, I have a question about my order.</div>
                            </div>
                            <div class="preview-message agent">
                                <div class="preview-msg-avatar agent" id="previewAgentAvatar">A</div>
                                <div class="preview-msg-bubble" id="previewAgentBubble">I'd be happy to help with that!</div>
                            </div>
                        </div>
                        <div class="preview-input-area" id="previewInputArea">
                            <div class="preview-input">Type your message...</div>
                            <button class="preview-send-btn" id="previewSendBtn">
                                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Launcher Preview -->
                <div class="preview-content" id="launcherPreview">
                    <div class="preview-widget-container" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); min-height: 280px; display: flex; align-items: center; justify-content: center;">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <button class="preview-launcher-btn" id="previewLauncherBtn">
                                <svg viewBox="0 0 24 24" id="previewLauncherIcon">
                                    <path d="M9.56158 3C5.41944 3 2.06158 6.35786 2.06158 10.5C2.06158 11.6329 2.31325 12.7088 2.76423 13.6734C2.5102 14.6714 2.22638 15.7842 2.03999 16.5147C1.80697 17.428 2.6294 18.2588 3.54374 18.039C4.29396 17.8587 5.44699 17.5819 6.47447 17.337C7.41678 17.7631 8.46241 18 9.56158 18C13.7037 18 17.0616 14.6421 17.0616 10.5C17.0616 6.35786 13.7037 3 9.56158 3ZM3.56158 10.5C3.56158 7.18629 6.24787 4.5 9.56158 4.5C12.8753 4.5 15.5616 7.18629 15.5616 10.5C15.5616 13.8137 12.8753 16.5 9.56158 16.5C8.60084 16.5 7.69487 16.2748 6.89161 15.8749L6.6482 15.7537L6.38368 15.8167C5.46095 16.0363 4.39489 16.2919 3.59592 16.4838C3.79467 15.7047 4.05784 14.6724 4.28601 13.7757L4.35619 13.4998L4.22568 13.2468C3.80145 12.4246 3.56158 11.4914 3.56158 10.5ZM14.5616 21.0001C12.5922 21.0001 10.8001 20.241 9.46191 18.9995C9.49511 18.9999 9.52835 19.0001 9.56163 19.0001C10.2796 19.0001 10.9768 18.911 11.6427 18.7434C12.5067 19.2254 13.5021 19.5001 14.5616 19.5001C15.5223 19.5001 16.4283 19.2748 17.2316 18.8749L17.475 18.7537L17.7395 18.8167C18.6611 19.0361 19.7046 19.2625 20.4787 19.4262C20.3037 18.6757 20.065 17.6711 19.8372 16.7757L19.767 16.4999L19.8975 16.2469C20.3217 15.4247 20.5616 14.4915 20.5616 13.5001C20.5616 11.3853 19.4676 9.52617 17.8146 8.45761C17.6363 7.73435 17.3653 7.04756 17.015 6.41052C19.9523 7.42684 22.0616 10.2171 22.0616 13.5001C22.0616 14.6332 21.8098 15.7094 21.3586 16.6741C21.6117 17.6821 21.8679 18.774 22.0304 19.4773C22.2348 20.3623 21.4554 21.1633 20.563 20.9768C19.8358 20.8248 18.6933 20.581 17.6495 20.3367C16.707 20.763 15.6611 21.0001 14.5616 21.0001Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        <span id="toastMessage">Settings saved successfully!</span>
    </div>

    <script>
        // ============================================
        // Version & Changelog
        // ============================================
        const APP_VERSION = 'v2.5.0';
        const APP_LAST_UPDATED = 'Jan 22, 2026';
        
        const CHANGELOG = [
            {
                version: 'v2.5.0',
                date: 'Jan 22, 2026',
                latest: true,
                items: [
                    { type: 'new', text: 'Multiple widgets per room - each room can now hold unlimited widget profiles' },
                    { type: 'new', text: 'Copy Personal  Room - share your personal profiles with teammates in one click' },
                    { type: 'new', text: 'Copy Room  Personal - save room widgets to your personal collection' },
                    { type: 'new', text: 'Cloud profile sync - profiles now sync across browsers/devices via GitHub Gists' },
                    { type: 'new', text: 'Refresh button - manually sync profiles from cloud at any time' },
                    { type: 'new', text: '60-second background sync - keeps your profiles up-to-date automatically' },
                    { type: 'improve', text: 'Expandable room list - click room to see all widgets inside' },
                    { type: 'improve', text: 'Profile deletion syncs across devices - delete on one, removed everywhere' },
                    { type: 'improve', text: 'Better error handling for GitHub token scope issues' },
                    { type: 'fix', text: 'Logout now immediately clears UI (page refresh)' },
                    { type: 'fix', text: 'Profiles no longer disappear after re-login on different devices' },
                    { type: 'fix', text: 'Fixed 403/404 errors when cloudId belongs to different account' }
                ]
            },
            {
                version: 'v2.4.0',
                date: 'Jan 16, 2026',
                latest: false,
                items: [
                    { type: 'new', text: 'Room Collaboration - share widget settings with a 6-character code (no accounts needed!)' },
                    { type: 'new', text: 'Multiple rooms support - create/join unlimited rooms, switch between them instantly' },
                    { type: 'new', text: 'Room sync - push your changes to room or pull latest from teammates' },
                    { type: 'improve', text: 'Replaced GitHub Team Repository with simpler Room Code system' },
                    { type: 'improve', text: 'Room action icons updated to Fluent UI (Cloud Sync, Cloud Upload, Clipboard, Delete)' },
                    { type: 'improve', text: 'Team tab now shows helpful explanation of what Rooms are' },
                    { type: 'fix', text: 'Team count badge now shows correct number of rooms' },
                    { type: 'fix', text: 'Feedback form CSP updated to allow forms.office.com' }
                ]
            },
            {
                version: 'v2.3.0',
                date: 'Jan 16, 2026',
                latest: false,
                items: [
                    { type: 'new', text: 'Session persistence - chat survives page refresh (1 hour expiry)' },
                    { type: 'new', text: 'VoiceVideo keepalive - prevents call failures after 5 minutes' },
                    { type: 'new', text: 'Visibility handler - fixes 480/10077 errors when tab in background' },
                    { type: 'improve', text: 'Message ordering uses messageId (millisecond precision) for correct order' },
                    { type: 'improve', text: 'CSP simplified with broad wildcards for faster connections' },
                    { type: 'improve', text: 'Full markdown rendering with citation/reference support' },
                    { type: 'fix', text: 'TamperMonkey/embedded widget now has feature parity with live.html' },
                    { type: 'fix', text: 'Bot avatar path corrected' }
                ]
            },
            {
                version: 'v2.2.0',
                date: 'Jan 3, 2026',
                items: [
                    { type: 'improve', text: 'User-friendly team repository modals with plain-language explanations' },
                    { type: 'improve', text: 'Step-by-step token creation instructions for non-technical users' },
                    { type: 'improve', text: 'Expandable troubleshooting help section with common issues and solutions' },
                    { type: 'improve', text: 'Detailed error messages for team repository creation/joining' },
                    { type: 'improve', text: 'Support for short format repository URLs (owner/repo)' },
                    { type: 'improve', text: 'Instructions for adding collaborators to team repositories' },
                    { type: 'fix', text: 'Personal profiles count now displays correctly in tab badge' },
                    { type: 'fix', text: 'Cloud widgets no longer overwrite personal profile count' }
                ]
            },
            {
                version: 'v2.1.0',
                date: 'Dec 31, 2025',
                latest: false,
                items: [
                    { type: 'new', text: 'Standard Widget live preview - see your actual D365 widget in the admin panel' },
                    { type: 'new', text: 'In-app feedback modal - send feedback without leaving the page' },
                    { type: 'new', text: 'Power Pages CSP documentation with navigation path and screenshot' },
                    { type: 'improve', text: 'Color palettes now update title and subtitle text colors' },
                    { type: 'improve', text: 'Team repository modal uses Fluent UI People Team Add icon' },
                    { type: 'improve', text: 'Cleaner Standard Widget preview with uniform background' },
                    { type: 'fix', text: 'Standard preview no longer shows split gray/white areas' }
                ]
            },
            {
                version: 'v2.0.0',
                date: 'Dec 31, 2025',
                latest: false,
                items: [
                    { type: 'new', text: ' Team Mode - collaborate with teammates on shared widget configurations' },
                    { type: 'new', text: 'GitHub repository-based team storage for multi-user collaboration' },
                    { type: 'new', text: 'One-click team repository creation with automatic setup' },
                    { type: 'new', text: 'Personal vs Team tabs for organized widget management' },
                    { type: 'new', text: 'Join existing team repository by URL' },
                    { type: 'improve', text: 'Renamed "Demo Profiles" to "Widget Profiles" for clarity' },
                    { type: 'improve', text: 'Profile badge indicators (Personal/Team)' },
                    { type: 'improve', text: 'Token scope detection for seamless team mode setup' }
                ]
            },
            {
                version: 'v1.9.0',
                date: 'Dec 31, 2025',
                latest: false,
                items: [
                    { type: 'new', text: 'Image preview with caption before sending - add context to your images' },
                    { type: 'new', text: 'Drag-and-drop file upload support across all deployment modes' },
                    { type: 'new', text: 'Edge browser compatibility fix for file attachments (Chromium bug workaround)' },
                    { type: 'improve', text: 'Label-based file input for better cross-browser reliability' },
                    { type: 'improve', text: 'Visual drop zone overlay when dragging files' },
                    { type: 'fix', text: 'Fixed Edge 143+ crash when clicking attach button' },
                    { type: 'fix', text: 'Image attachments no longer auto-send without user confirmation' }
                ]
            },
            {
                version: 'v1.8.0',
                date: 'Dec 22, 2025',
                latest: false,
                items: [
                    { type: 'new', text: 'Quick Color Palettes gallery with 24 curated professional combinations' },
                    { type: 'new', text: 'One-click palette application to all widget colors' },
                    { type: 'new', text: 'Show All / Show Less toggle for palette gallery' },
                    { type: 'new', text: 'Link to coolors.co for additional color inspiration' },
                    { type: 'improve', text: 'Styled gradient button for palette visibility' },
                    { type: 'fix', text: 'Reset to Default now auto-refreshes page for clean state' },
                    { type: 'fix', text: 'Character count warning only shows when generating embed code' }
                ]
            },
            {
                version: 'v1.7.0',
                date: 'Dec 21, 2025',
                latest: false,
                items: [
                    { type: 'new', text: 'Pre-chat hero gradient toggle (gradient vs solid color)' },
                    { type: 'new', text: 'Custom gradient start/end colors for pre-chat hero' },
                    { type: 'new', text: 'Customizable title, subtitle, badge, and status dot colors' },
                    { type: 'new', text: 'Name and email field placeholder settings' },
                    { type: 'improve', text: 'Download HTML button only appears after generating embed code' },
                    { type: 'improve', text: 'Green gradient styling on Download HTML button' },
                    { type: 'fix', text: 'Avatar image paths now use GitHub raw URLs' },
                    { type: 'fix', text: 'Download HTML no longer produces broken pages with TamperMonkey code' },
                    { type: 'fix', text: 'Placeholders now work in all output modes (embed, TamperMonkey)' }
                ]
            },
            {
                version: 'v1.6.0',
                date: 'Dec 19, 2025',
                latest: false,
                items: [
                    { type: 'new', text: 'Cloudflare D1 SQL database for analytics (100K writes/day)' },
                    { type: 'new', text: 'Analytics dashboard with real-time tracking' },
                    { type: 'new', text: 'Cross-domain analytics tracking (GitHub Pages, Power Apps Portals)' },
                    { type: 'new', text: 'Session-based domain usage metrics (unique widget loads)' },
                    { type: 'new', text: 'Favicon support across all pages' },
                    { type: 'new', text: 'Custom logo in admin header' },
                    { type: 'improve', text: 'Migrated from KV JSON to D1 SQL for better scalability' },
                    { type: 'improve', text: 'Domain usage now counts sessions instead of total events' },
                    { type: 'improve', text: 'Analytics dashboard renamed to "Chat Widget Studio Analytics"' },
                    { type: 'improve', text: 'Video camera icon for Voice/Video Calls metric' }
                ]
            },
            {
                version: 'v1.4.0',
                date: 'Dec 18, 2025',
                latest: false,
                items: [
                    { type: 'new', text: 'Separate toggle for user message bubble gradient' },
                    { type: 'improve', text: 'Independent control: header gradient vs bubble gradient' }
                ]
            },
            {
                version: 'v1.3.0',
                date: 'Dec 18, 2025',
                latest: false,
                items: [
                    { type: 'new', text: 'Enhanced markdown rendering for bot messages' },
                    { type: 'new', text: 'Professional formatting for headers, lists, code blocks' },
                    { type: 'new', text: 'Collapsible Sources section for citation references' },
                    { type: 'improve', text: 'Styled citation links as modern badges' },
                    { type: 'improve', text: 'Links now subtle with dotted underline on hover' }
                ]
            },
            {
                version: 'v1.2.0',
                date: 'Dec 18, 2025',
                latest: false,
                items: [
                    { type: 'improve', text: 'Updated image upload hints with clearer instructions' },
                    { type: 'improve', text: 'Added guidance for using public URLs or free hosting services' }
                ]
            },
            {
                version: 'v1.1.0',
                date: 'Dec 18, 2025',
                latest: false,
                items: [
                    { type: 'new', text: 'Version control with changelog modal' },
                    { type: 'improve', text: 'Auto-save interval reduced to 5 seconds' },
                    { type: 'improve', text: 'Compact launcher preview section layout' },
                    { type: 'improve', text: 'Live preview panel position optimized' },
                    { type: 'improve', text: 'Cleaner header - removed redundant welcome text' },
                    { type: 'fix', text: 'Live preview logo now matches actual widget appearance' }
                ]
            },
            {
                version: 'v1.0.0',
                date: 'Dec 18, 2025',
                latest: false,
                items: [
                    { type: 'new', text: 'Initial release of Chat Widget Studio' },
                    { type: 'new', text: 'GitHub cloud sync for widget configurations' },
                    { type: 'new', text: 'Auto-save to cloud' },
                    { type: 'new', text: 'Demo profiles with rename functionality' },
                    { type: 'new', text: 'Live preview with real-time updates' },
                    { type: 'new', text: 'Export/Import settings as JSON' },
                    { type: 'new', text: 'Embed code generation for iframe and JavaScript' },
                    { type: 'new', text: 'Prechat form customization' },
                    { type: 'new', text: 'Message styling (alignment, colors, avatars)' }
                ]
            }
        ];

        function showChangelog() {
            const content = document.getElementById('changelogContent');
            let html = '';
            
            // Update header with version and last updated
            const changelogVersionEl = document.getElementById('changelogVersion');
            const changelogLastUpdatedEl = document.getElementById('changelogLastUpdated');
            if (changelogVersionEl) changelogVersionEl.textContent = APP_VERSION;
            if (changelogLastUpdatedEl) changelogLastUpdatedEl.textContent = 'Last updated: ' + APP_LAST_UPDATED;
            
            CHANGELOG.forEach(release => {
                html += `
                    <div class="changelog-version">
                        <div class="changelog-version-header">
                            <span class="changelog-version-number ${release.latest ? 'latest' : ''}">
                                ${release.latest ? '<svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>' : ''}
                                ${release.version}
                            </span>
                            <span class="changelog-version-date">${release.date}</span>
                        </div>
                        <ul class="changelog-items">
                            ${release.items.map(item => `
                                <li class="changelog-item">
                                    <span class="changelog-item-type ${item.type}">${item.type}</span>
                                    <span class="changelog-item-text">${item.text}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            });
            
            content.innerHTML = html;
            document.getElementById('changelogOverlay').classList.add('show');
        }

        function hideChangelog() {
            document.getElementById('changelogOverlay').classList.remove('show');
        }

        function showTutorial() {
            document.getElementById('tutorialOverlay').classList.add('show');
        }

        function hideTutorial() {
            document.getElementById('tutorialOverlay').classList.remove('show');
        }

        // Initialize version display
        document.addEventListener('DOMContentLoaded', function() {
            const versionEl = document.getElementById('versionNumber');
            if (versionEl) versionEl.textContent = APP_VERSION;
        });

        // ============================================
        // GitHub Cloud Sync
        // ============================================
        const GIST_PREFIX = '[D365-Widget] ';
        let cloudUser = null;
        let cloudToken = null;
        let savedWidgets = [];
        let currentLoadedWidgetId = null;
        let tokenInvalidated = false; // Flag to prevent repeated 401 errors

        // Handle 401 errors by invalidating the token
        function handleTokenInvalidation(showMessage = true) {
            if (tokenInvalidated) return; // Prevent multiple invalidations
            tokenInvalidated = true;
            cloudToken = null;
            cloudUser = null;
            localStorage.removeItem('d365_github_token');
            localStorage.removeItem('d365_user');
            updateCloudSyncStatus('offline');
            if (showMessage) {
                showToast(' GitHub token expired or invalid. Please sign in again.', 5000);
            }
            // Update UI to show logged out state
            const userBar = document.getElementById('userBar');
            if (userBar) userBar.classList.remove('show');
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) loginBtn.style.display = '';
            const syncAllBtn = document.getElementById('syncAllBtn');
            if (syncAllBtn) syncAllBtn.style.display = 'none';
        }

        // ============================================
        // Team Mode - Repository-based collaboration
        // ============================================
        const TEAM_REPO_NAME = 'd365-widget-configs';
        const TEAM_CONFIG_FOLDER = 'widgets';
        let teamRepoOwner = null;
        let teamRepoName = null;
        let teamWidgets = [];
        let hasRepoScope = false; // Will be checked on login

        // Check if token has repo scope
        async function checkRepoScope() {
            if (!cloudToken || tokenInvalidated) return false;
            try {
                // Try to access repos endpoint - if it fails with 403, no repo scope
                const response = await fetch('https://api.github.com/user/repos?per_page=1', {
                    headers: { 
                        'Authorization': `token ${cloudToken}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                });
                console.log('Repo scope check response:', response.status, response.headers.get('x-oauth-scopes'));
                if (response.status === 401) {
                    handleTokenInvalidation();
                    return false;
                }
                hasRepoScope = response.ok;
                return hasRepoScope;
            } catch (e) {
                console.error('Repo scope check error:', e);
                hasRepoScope = false;
                return false;
            }
        }

        // Load team repo config from localStorage
        function loadTeamRepoConfig() {
            const saved = localStorage.getItem('d365_team_repo');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    teamRepoOwner = config.owner;
                    teamRepoName = config.repo;
                    return true;
                } catch (e) {
                    localStorage.removeItem('d365_team_repo');
                }
            }
            return false;
        }

        // Save team repo config to localStorage
        function saveTeamRepoConfig(owner, repo) {
            teamRepoOwner = owner;
            teamRepoName = repo;
            localStorage.setItem('d365_team_repo', JSON.stringify({ owner, repo }));
        }

        // Clear team repo config
        function clearTeamRepoConfig() {
            teamRepoOwner = null;
            teamRepoName = null;
            teamWidgets = [];
            localStorage.removeItem('d365_team_repo');
        }

        // Switch between Personal and Team tabs
        function switchProfileTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.profile-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            // Update sections
            document.getElementById('personalSection').classList.toggle('active', tab === 'personal');
            document.getElementById('teamSection').classList.toggle('active', tab === 'team');
            
            // Load team widgets if switching to team tab
            if (tab === 'team' && teamRepoOwner && teamRepoName) {
                loadTeamWidgets();
            }
        }

        // Update team UI - now redirects to room UI
        function updateTeamUI() {
            // Legacy function - now use updateRoomUI
            if (typeof updateRoomUI === 'function') {
                updateRoomUI();
            }
        }

        // Legacy modal functions - redirect to new Room functions
        function showCreateTeamRepoModal() { showCreateRoomModal(); }
        function closeCreateTeamRepoModal() { closeCreateRoomModal(); }
        function showJoinTeamRepoModal() { showJoinRoomModal(); }
        function closeJoinTeamRepoModal() { closeJoinRoomModal(); }

        // Apply widget config (shared function for collaboration)
        function applyWidgetConfig(config) {
            // Merge config into settings
            Object.assign(settings, config);
            
            // Save to localStorage
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
            
            // Apply LCW code if present
            if (config.lcwCode) {
                const lcwEl = document.getElementById('lcwCode');
                if (lcwEl) {
                    lcwEl.value = config.lcwCode;
                    if (typeof parseLCWCode === 'function') {
                        parseLCWCode();
                    }
                }
            }
            
            // Refresh the form from settings
            if (typeof populateForm === 'function') {
                populateForm();
            }
            
            // Update preview
            if (typeof updatePreview === 'function') {
                updatePreview();
            }
        }

        // Collect current config (shared function for collaboration)
        function collectCurrentConfig() {
            // Make sure settings are up to date from form
            if (typeof updateSettingsFromForm === 'function') {
                updateSettingsFromForm();
            }
            // Return the current settings object
            return JSON.parse(JSON.stringify(settings));
        }

        // ============ COLLABORATION ROOMS (No GitHub Required!) ============
        
        const COLLAB_API_URL = 'https://d365-widget-collab.mauricio-o-pinto.workers.dev';
        let savedRooms = JSON.parse(localStorage.getItem('d365_collab_rooms') || '[]'); // Array of {code, name, createdBy, joinedAt, widgets}
        let activeRoomCode = localStorage.getItem('d365_collab_active_room') || null;
        let activeRoomWidgetId = localStorage.getItem('d365_collab_active_widget') || null;
        let currentRoomVersion = null;
        let collabUserName = localStorage.getItem('d365_collab_user') || '';
        let expandedRooms = JSON.parse(localStorage.getItem('d365_expanded_rooms') || '{}'); // Track which rooms are expanded
        
        // Migration from old single-room format
        (function migrateOldRoomFormat() {
            const oldRoom = localStorage.getItem('d365_collab_room');
            if (oldRoom && !savedRooms.find(r => r.code === oldRoom)) {
                savedRooms.push({ code: oldRoom, name: `Room ${oldRoom}`, joinedAt: new Date().toISOString() });
                localStorage.setItem('d365_collab_rooms', JSON.stringify(savedRooms));
                activeRoomCode = oldRoom;
                localStorage.setItem('d365_collab_active_room', oldRoom);
            }
            localStorage.removeItem('d365_collab_room'); // Clean up old key
        })();
        
        // Show Create Room modal
        function showCreateRoomModal() {
            const modal = document.getElementById('createRoomModal');
            document.getElementById('createRoomStatus').style.display = 'none';
            document.getElementById('createRoomSuccess').style.display = 'none';
            document.getElementById('createRoomUserName').value = collabUserName;
            document.getElementById('createRoomBtn').style.display = 'inline-flex';
            document.getElementById('createRoomDoneBtn').style.display = 'none';
            document.getElementById('createRoomCancelBtn').style.display = 'inline-flex';
            modal.classList.add('show');
        }
        
        function closeCreateRoomModal() {
            document.getElementById('createRoomModal').classList.remove('show');
        }
        
        // Show Join Room modal
        function showJoinRoomModal() {
            const modal = document.getElementById('joinRoomModal');
            document.getElementById('joinRoomStatus').style.display = 'none';
            document.getElementById('joinRoomCode').value = '';
            document.getElementById('joinRoomUserName').value = collabUserName;
            modal.classList.add('show');
        }
        
        function closeJoinRoomModal() {
            document.getElementById('joinRoomModal').classList.remove('show');
        }
        
        // Professional Confirmation Modal functions
        let confirmModalCallback = null;
        
        function showConfirmModal(options) {
            const modal = document.getElementById('studioConfirmModal');
            const header = document.getElementById('confirmModalHeader');
            const icon = document.getElementById('confirmModalIcon');
            const title = document.getElementById('confirmModalTitle');
            const message = document.getElementById('confirmModalMessage');
            const itemName = document.getElementById('confirmModalItemName');
            const actionBtn = document.getElementById('confirmModalAction');
            
            // Set type (danger or warning)
            const type = options.type || 'danger';
            header.className = 'confirm-modal-header ' + type;
            actionBtn.className = 'confirm-modal-btn ' + type;
            
            // Set icon based on type
            if (type === 'danger') {
                icon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>';
            } else {
                icon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';
            }
            
            // Set content
            title.textContent = options.title || 'Confirm Action';
            message.textContent = options.message || 'Are you sure you want to proceed?';
            actionBtn.textContent = options.actionText || 'Delete';
            
            // Show item name if provided
            if (options.itemName) {
                const itemIcon = options.itemIcon || '<svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/></svg>';
                itemName.innerHTML = itemIcon + '<span>' + options.itemName + '</span>';
                itemName.style.display = 'flex';
            } else {
                itemName.style.display = 'none';
            }
            
            // Store callback
            confirmModalCallback = options.onConfirm;
            
            // Set up action button
            actionBtn.onclick = function() {
                const callback = confirmModalCallback; // Save reference before closing
                closeConfirmModal();
                if (callback) {
                    callback();
                }
            };
            
            modal.classList.add('show');
        }
        
        function closeConfirmModal() {
            document.getElementById('studioConfirmModal').classList.remove('show');
            confirmModalCallback = null;
        }
        
        // Create a new collaboration room
        async function createCollabRoom() {
            const btn = document.getElementById('createRoomBtn');
            const btnText = document.getElementById('createRoomBtnText');
            const spinner = document.getElementById('createRoomSpinner');
            const status = document.getElementById('createRoomStatus');
            const success = document.getElementById('createRoomSuccess');
            const roomName = document.getElementById('createRoomName').value.trim() || 'My Room';
            const userName = document.getElementById('createRoomUserName').value.trim() || 'Anonymous';
            
            // Save username for future use
            collabUserName = userName;
            localStorage.setItem('d365_collab_user', userName);
            
            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'inline';
            status.style.display = 'none';
            
            try {
                const config = collectCurrentConfig();
                
                const response = await fetch(`${COLLAB_API_URL}/room/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config: config,
                        creatorName: userName,
                        roomName: roomName
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create room');
                }
                
                const data = await response.json();
                
                // Create initial widget entry
                const initialWidget = data.widgetId ? [{
                    id: data.widgetId,
                    name: 'Default Widget',
                    config: config,
                    createdAt: new Date().toISOString(),
                    createdBy: userName,
                    updatedAt: new Date().toISOString(),
                    updatedBy: userName,
                    version: 1
                }] : [];
                
                // Add to saved rooms list with widgets
                const newRoom = {
                    code: data.roomCode,
                    name: data.roomName || roomName,
                    createdBy: userName,
                    joinedAt: new Date().toISOString(),
                    isOwner: true,
                    widgets: initialWidget
                };
                savedRooms.push(newRoom);
                localStorage.setItem('d365_collab_rooms', JSON.stringify(savedRooms));
                
                // Set as active room and widget
                activeRoomCode = data.roomCode;
                activeRoomWidgetId = data.widgetId;
                currentRoomVersion = 1;
                localStorage.setItem('d365_collab_active_room', data.roomCode);
                localStorage.setItem('d365_collab_active_widget', data.widgetId || '');
                
                // Expand this room
                expandedRooms[data.roomCode] = true;
                localStorage.setItem('d365_expanded_rooms', JSON.stringify(expandedRooms));
                
                // Show success
                document.getElementById('newRoomCode').textContent = data.roomCode;
                success.style.display = 'block';
                btn.style.display = 'none';
                
                // Show Done button, hide Cancel
                document.getElementById('createRoomDoneBtn').style.display = 'inline-flex';
                document.getElementById('createRoomCancelBtn').style.display = 'none';
                
                renderRoomList();
                showToast(`Room ${data.roomCode} created! Share this code with your team.`);
                
            } catch (error) {
                console.error('Create room error:', error);
                status.style.display = 'block';
                status.style.background = '#fee2e2';
                status.style.color = '#991b1b';
                status.textContent = error.message;
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }
        
        // Copy room code to clipboard
        function copyRoomCode(code) {
            const roomCode = code || document.getElementById('newRoomCode')?.textContent || activeRoomCode;
            navigator.clipboard.writeText(roomCode).then(() => {
                showToast(' Room code copied!');
            });
        }
        
        // Join an existing room
        async function joinCollabRoom() {
            const btn = document.getElementById('joinRoomBtn');
            const btnText = document.getElementById('joinRoomBtnText');
            const spinner = document.getElementById('joinRoomSpinner');
            const status = document.getElementById('joinRoomStatus');
            const codeInput = document.getElementById('joinRoomCode');
            const userName = document.getElementById('joinRoomUserName').value.trim() || 'Anonymous';
            
            const roomCode = codeInput.value.trim().toUpperCase();
            
            if (!roomCode || roomCode.length !== 6) {
                status.style.display = 'block';
                status.style.background = '#fee2e2';
                status.style.color = '#991b1b';
                status.textContent = 'Please enter a valid 6-character room code';
                return;
            }
            
            // Check if already in this room
            if (savedRooms.find(r => r.code === roomCode)) {
                status.style.display = 'block';
                status.style.background = '#fef3c7';
                status.style.color = '#92400e';
                status.textContent = 'You already have this room saved!';
                return;
            }
            
            // Save username
            collabUserName = userName;
            localStorage.setItem('d365_collab_user', userName);
            
            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'inline';
            status.style.display = 'none';
            
            try {
                const response = await fetch(`${COLLAB_API_URL}/room/${roomCode}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Room not found');
                }
                
                const roomData = await response.json();
                
                // Add to saved rooms with widgets
                const newRoom = {
                    code: roomCode,
                    name: roomData.name || `Room ${roomCode}`,
                    createdBy: roomData.createdBy || 'Unknown',
                    joinedAt: new Date().toISOString(),
                    isOwner: false,
                    widgets: roomData.widgets || []
                };
                savedRooms.push(newRoom);
                localStorage.setItem('d365_collab_rooms', JSON.stringify(savedRooms));
                
                // Set as active room
                activeRoomCode = roomCode;
                currentRoomVersion = roomData.version;
                localStorage.setItem('d365_collab_active_room', roomCode);
                
                // Expand this room to show widgets
                expandedRooms[roomCode] = true;
                localStorage.setItem('d365_expanded_rooms', JSON.stringify(expandedRooms));
                
                // Apply the first widget's config if available, otherwise legacy config
                if (roomData.widgets && roomData.widgets.length > 0) {
                    applyWidgetConfig(roomData.widgets[0].config);
                    activeRoomWidgetId = roomData.widgets[0].id;
                    localStorage.setItem('d365_collab_active_widget', activeRoomWidgetId);
                } else if (roomData.config) {
                    applyWidgetConfig(roomData.config);
                }
                
                closeJoinRoomModal();
                renderRoomList();
                
                const widgetCount = roomData.widgets?.length || 0;
                showToast(`Joined room ${roomCode}! ${widgetCount} widget${widgetCount !== 1 ? 's' : ''} available.`);
                
            } catch (error) {
                console.error('Join room error:', error);
                status.style.display = 'block';
                status.style.background = '#fee2e2';
                status.style.color = '#991b1b';
                status.textContent = error.message;
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }
        
        // Leave/remove a room from saved list
        function leaveCollabRoom(roomCode) {
            const code = roomCode || activeRoomCode;
            if (!code) return;
            
            const room = savedRooms.find(r => r.code === code);
            if (!room) return;
            
            const roomDisplayName = room.name || `Room ${code}`;
            
            showConfirmModal({
                type: 'danger',
                title: 'Remove Room?',
                message: 'This will remove the room from your list. You can always rejoin using the room code.',
                itemName: roomDisplayName,
                itemIcon: '<svg viewBox="0 0 24 24" style="fill: #6b7280;"><path d="M12 3L4 9v12h16V9l-8-6zm0 2.84L18 10v9H6v-9l6-4.16zM11 13h2v4h-2v-4zm0-4h2v2h-2V9z"/></svg>',
                actionText: 'Remove Room',
                onConfirm: function() {
                    savedRooms = savedRooms.filter(r => r.code !== code);
                    localStorage.setItem('d365_collab_rooms', JSON.stringify(savedRooms));
                    
                    // If this was the active room, clear it
                    if (activeRoomCode === code) {
                        activeRoomCode = savedRooms.length > 0 ? savedRooms[0].code : null;
                        activeRoomWidgetId = null;
                        localStorage.setItem('d365_collab_active_room', activeRoomCode || '');
                        localStorage.removeItem('d365_collab_active_widget');
                    }
                    
                    // Clean up expanded state
                    delete expandedRooms[code];
                    localStorage.setItem('d365_expanded_rooms', JSON.stringify(expandedRooms));
                    
                    renderRoomList();
                    showToast(`Removed room ${code}`);
                }
            });
        }
        
        // Switch to a different room (now just toggles expand)
        function switchToRoom(roomCode) {
            toggleRoomExpand(roomCode);
        }
        
        // Sync (pull) latest config from room
        async function syncFromRoom(roomCode) {
            const code = roomCode || activeRoomCode;
            if (!code) return;
            
            try {
                showToast('Syncing from room...');
                
                const response = await fetch(`${COLLAB_API_URL}/room/${code}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to sync');
                }
                
                const roomData = await response.json();
                currentRoomVersion = roomData.version;
                
                // Apply the config
                if (roomData.config) {
                    applyWidgetConfig(roomData.config);
                }
                
                // Update room info display
                updateRoomInfo(roomData);
                
                showToast(` Synced! Latest changes from ${roomData.updatedBy}`);
                
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Failed to sync: ' + error.message, 'error');
            }
        }
        
        // Push changes to room
        async function pushToRoom(roomCode) {
            const code = roomCode || activeRoomCode;
            if (!code) return;
            
            try {
                showToast('Pushing changes...');
                
                const config = collectCurrentConfig();
                
                const response = await fetch(`${COLLAB_API_URL}/room/${code}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config: config,
                        updaterName: collabUserName || 'Anonymous',
                        expectedVersion: currentRoomVersion
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    if (response.status === 409) {
                        // Conflict - someone else updated
                        if (confirm(`${error.updatedBy} updated the room. Do you want to overwrite their changes?`)) {
                            // Retry without version check
                            currentRoomVersion = error.currentVersion;
                            await pushToRoom();
                            return;
                        } else {
                            // Sync instead
                            await syncFromRoom();
                            return;
                        }
                    }
                    throw new Error(error.error || 'Failed to push');
                }
                
                const data = await response.json();
                currentRoomVersion = data.version;
                
                showToast(' Changes pushed to room!');
                
            } catch (error) {
                console.error('Push error:', error);
                showToast('Failed to push: ' + error.message, 'error');
            }
        }
        
        // Update room info display
        function updateRoomInfo(roomData) {
            const infoEl = document.getElementById('roomInfo');
            if (infoEl && roomData) {
                document.getElementById('roomCreatedBy').textContent = roomData.createdBy || '-';
                document.getElementById('roomLastUpdated').textContent = roomData.lastUpdated ? 
                    new Date(roomData.lastUpdated).toLocaleString() : '-';
                document.getElementById('roomUpdatedBy').textContent = roomData.updatedBy || '-';
            }
        }
        
        // Render the room list UI with widgets inside each room
        function renderRoomList() {
            const listEl = document.getElementById('roomList');
            const emptyState = document.getElementById('roomEmptyState');
            const teamCountEl = document.getElementById('teamCount');
            
            if (!listEl) return;
            
            // Count total widgets across all rooms
            let totalWidgets = 0;
            savedRooms.forEach(r => totalWidgets += (r.widgets?.length || 0));
            
            // Update team count badge
            if (teamCountEl) {
                teamCountEl.textContent = savedRooms.length > 0 ? savedRooms.length : '0';
            }
            
            if (savedRooms.length === 0) {
                listEl.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            listEl.innerHTML = savedRooms.map(room => {
                const isExpanded = expandedRooms[room.code] || false;
                const widgets = room.widgets || [];
                const hasWidgets = widgets.length > 0;
                const roomDisplayName = room.name || `Room ${room.code}`;
                
                return `
                    <div class="room-container" style="margin-bottom: 8px;">
                        <!-- Room Header -->
                        <div class="profile-item room-header" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 1px solid #e2e8f0; cursor: pointer;" onclick="toggleRoomExpand('${room.code}')">
                            <div class="profile-item-content" style="flex: 1;">
                                <div class="profile-item-header" style="display: flex; align-items: center; gap: 8px;">
                                    <span style="transition: transform 0.2s; transform: rotate(${isExpanded ? '90deg' : '0deg'}); font-size: 12px;"></span>
                                    <span class="profile-item-name" style="font-weight: 600; color: #1e293b;">
                                        ${roomDisplayName}
                                    </span>
                                    <button onclick="event.stopPropagation(); copyRoomCode('${room.code}')" title="Click to copy room code" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border: none; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-family: monospace; font-size: 12px; font-weight: 600; color: white; display: flex; align-items: center; gap: 6px; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3); transition: all 0.15s;">
                                        <span>${room.code}</span>
                                        <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:white;"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                    </button>
                                    ${room.isOwner ? '<span style="font-size: 10px; background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 4px;">Owner</span>' : ''}
                                    <span style="font-size: 11px; color: #64748b; margin-left: auto;">${widgets.length} widget${widgets.length !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="profile-item-details" style="font-size: 11px; color: #64748b;">
                                    <span>by ${room.createdBy || 'Unknown'}</span>
                                    <span></span>
                                    <span>Joined ${new Date(room.joinedAt).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="profile-item-actions" onclick="event.stopPropagation();" style="display:flex; gap:4px;">
                                <button onclick="refreshRoomWidgets('${room.code}')" title="Refresh widgets from server" style="background:transparent; border:none; padding:6px; cursor:pointer; border-radius:4px;">
                                    <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#64748b;"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                                </button>
                                <button onclick="showAddWidgetToRoomModal('${room.code}')" title="Add widget to room" style="background:transparent; border:none; padding:6px; cursor:pointer; border-radius:4px;">
                                    <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#64748b;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                </button>
                                <button onclick="leaveCollabRoom('${room.code}')" title="Leave room" style="background:transparent; border:none; padding:6px; cursor:pointer; border-radius:4px;">
                                    <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#ef4444;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Widgets List (collapsible) -->
                        <div class="room-widgets" style="display: ${isExpanded ? 'block' : 'none'}; margin-left: 16px; border-left: 2px solid #e2e8f0; padding-left: 12px; margin-top: 4px;">
                            ${hasWidgets ? widgets.map(widget => {
                                const isActiveWidget = activeRoomCode === room.code && activeRoomWidgetId === widget.id;
                                return `
                                    <div class="profile-item widget-item ${isActiveWidget ? 'active' : ''}" style="margin-bottom: 4px; padding: 10px 12px; background: ${isActiveWidget ? '#eff6ff' : 'white'}; border: 1px solid ${isActiveWidget ? '#3b82f6' : '#e2e8f0'};">
                                        <div class="profile-item-content" style="flex: 1; cursor: pointer;" onclick="loadRoomWidget('${room.code}', '${widget.id}')">
                                            <div class="profile-item-header">
                                                <span class="profile-item-name" style="font-weight: 500;">
                                                    ${isActiveWidget ? '' : ''} ${widget.name || 'Unnamed Widget'}
                                                </span>
                                            </div>
                                            <div class="profile-item-details" style="font-size: 11px; color: #64748b;">
                                                <span>by ${widget.updatedBy || widget.createdBy || 'Unknown'}</span>
                                                <span></span>
                                                <span>${widget.updatedAt ? new Date(widget.updatedAt).toLocaleDateString() : 'Unknown date'}</span>
                                            </div>
                                        </div>
                                        <div class="profile-item-actions" onclick="event.stopPropagation();" style="display:flex; gap:2px;">
                                            <button onclick="loadRoomWidget('${room.code}', '${widget.id}')" title="Load widget" style="background:transparent; border:none; padding:5px; cursor:pointer; border-radius:4px;">
                                                <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:#64748b;"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                                            </button>
                                            <button onclick="saveCurrentToRoomWidget('${room.code}', '${widget.id}')" title="Save current settings to this widget" style="background:transparent; border:none; padding:5px; cursor:pointer; border-radius:4px;">
                                                <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:#64748b;"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                                            </button>
                                            <button onclick="copyRoomWidgetToPersonal('${room.code}', '${widget.id}')" title="Copy to Personal" style="background:transparent; border:none; padding:5px; cursor:pointer; border-radius:4px;">
                                                <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:#64748b;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                            </button>
                                            <button onclick="deleteRoomWidget('${room.code}', '${widget.id}')" title="Delete widget" style="background:transparent; border:none; padding:5px; cursor:pointer; border-radius:4px;">
                                                <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:#ef4444;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('') : `
                                <div style="padding: 16px; text-align: center; color: #64748b; font-size: 13px;">
                                    <p style="margin: 0 0 8px 0;">No widgets in this room yet</p>
                                    <button onclick="showAddWidgetToRoomModal('${room.code}')" class="btn btn-sm btn-primary" style="font-size: 12px;">
                                        <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:white;margin-right:4px;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                        Add Widget
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle room expansion
        function toggleRoomExpand(roomCode) {
            expandedRooms[roomCode] = !expandedRooms[roomCode];
            localStorage.setItem('d365_expanded_rooms', JSON.stringify(expandedRooms));
            renderRoomList();
        }
        
        // Refresh widgets from server for a specific room
        async function refreshRoomWidgets(roomCode) {
            try {
                showToast('Refreshing room widgets...');
                
                const response = await fetch(`${COLLAB_API_URL}/room/${roomCode}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch room data');
                }
                
                const roomData = await response.json();
                
                // Update local room data with widgets from server
                const roomIndex = savedRooms.findIndex(r => r.code === roomCode);
                if (roomIndex !== -1) {
                    savedRooms[roomIndex].widgets = roomData.widgets || [];
                    savedRooms[roomIndex].lastUpdated = roomData.lastUpdated;
                    // Also update room name if server has one
                    if (roomData.name) {
                        savedRooms[roomIndex].name = roomData.name;
                    }
                    localStorage.setItem('d365_collab_rooms', JSON.stringify(savedRooms));
                }
                
                renderRoomList();
                showToast(` Refreshed ${roomData.widgets?.length || 0} widgets from room`);
                
            } catch (error) {
                console.error('Error refreshing room:', error);
                showToast('Failed to refresh room: ' + error.message, 'error');
            }
        }
        
        // Load a specific widget from a room
        async function loadRoomWidget(roomCode, widgetId) {
            try {
                showToast('Loading widget...');
                
                const response = await fetch(`${COLLAB_API_URL}/room/${roomCode}/widgets/${widgetId}`);
                if (!response.ok) {
                    throw new Error('Widget not found');
                }
                
                const widget = await response.json();
                
                // Apply the config
                if (widget.config) {
                    applyWidgetConfig(widget.config);
                }
                
                // Set as active room widget
                activeRoomCode = roomCode;
                activeRoomWidgetId = widgetId;
                localStorage.setItem('d365_collab_active_room', roomCode);
                localStorage.setItem('d365_collab_active_widget', widgetId);
                
                renderRoomList();
                showToast(` Loaded "${widget.name}" from room`);
                
            } catch (error) {
                console.error('Error loading widget:', error);
                showToast('Failed to load widget: ' + error.message, 'error');
            }
        }
        
        // Save current settings to a specific room widget
        async function saveCurrentToRoomWidget(roomCode, widgetId) {
            try {
                showToast('Saving to widget...');
                
                const config = collectCurrentConfig();
                
                const response = await fetch(`${COLLAB_API_URL}/room/${roomCode}/widgets/${widgetId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config: config,
                        updaterName: collabUserName || cloudUser?.login || 'Anonymous'
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save');
                }
                
                // Refresh room data
                await refreshRoomWidgets(roomCode);
                
                showToast(' Widget saved to room!');
                
            } catch (error) {
                console.error('Error saving widget:', error);
                showToast('Failed to save widget: ' + error.message, 'error');
            }
        }
        
        // Copy a room widget to personal profiles
        async function copyRoomWidgetToPersonal(roomCode, widgetId) {
            try {
                const response = await fetch(`${COLLAB_API_URL}/room/${roomCode}/widgets/${widgetId}`);
                if (!response.ok) {
                    throw new Error('Widget not found');
                }
                
                const widget = await response.json();
                
                // Create new personal profile
                const newProfile = {
                    id: 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: widget.name + ' (from Room)',
                    settings: widget.config,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                profiles.push(newProfile);
                saveProfiles();
                renderProfiles();
                
                // If logged in, also save to cloud
                if (cloudToken && !tokenInvalidated) {
                    saveProfileToCloud(newProfile);
                }
                
                showToast(` "${widget.name}" copied to Personal profiles!`);
                
            } catch (error) {
                console.error('Error copying widget:', error);
                showToast('Failed to copy widget: ' + error.message, 'error');
            }
        }
        
        // Delete a widget from a room
        async function deleteRoomWidget(roomCode, widgetId) {
            // Find the widget name for the modal
            const room = savedRooms.find(r => r.code === roomCode);
            const widget = room?.widgets?.find(w => w.id === widgetId);
            const widgetName = widget?.name || 'this widget';
            
            showConfirmModal({
                type: 'danger',
                title: 'Delete Widget from Room?',
                message: 'This will permanently remove this widget from the collaboration room. Other team members will no longer be able to access it.',
                itemName: widgetName,
                itemIcon: '<svg viewBox="0 0 24 24" style="fill: #6b7280;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>',
                actionText: 'Delete Widget',
                onConfirm: async function() {
                    try {
                        const response = await fetch(`${COLLAB_API_URL}/room/${roomCode}/widgets/${widgetId}?updaterName=${encodeURIComponent(collabUserName || 'Anonymous')}`, {
                            method: 'DELETE'
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to delete widget');
                        }
                        
                        // Clear active widget if it was the deleted one
                        if (activeRoomWidgetId === widgetId) {
                            activeRoomWidgetId = null;
                            localStorage.removeItem('d365_collab_active_widget');
                        }
                        
                        // Refresh room data
                        await refreshRoomWidgets(roomCode);
                        
                        showToast(' Widget deleted from room');
                        
                    } catch (error) {
                        console.error('Error deleting widget:', error);
                        showToast('Failed to delete widget: ' + error.message, 'error');
                    }
                }
            });
        }
        
        // Show modal to add widget to room
        function showAddWidgetToRoomModal(roomCode) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('addWidgetToRoomModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'addWidgetToRoomModal';
                modal.className = 'save-modal-overlay';
                modal.innerHTML = `
                    <div class="save-modal">
                        <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;"></span> Add Widget to Room
                        </h3>
                        <div class="form-group">
                            <label class="form-label">Widget Name</label>
                            <input type="text" class="form-input" id="newRoomWidgetName" placeholder="e.g., Contoso Demo">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="useCurrentSettings" checked>
                                Use current editor settings
                            </label>
                        </div>
                        <div id="addWidgetToRoomStatus" style="display:none; padding: 12px; border-radius: 8px; margin-bottom: 12px;"></div>
                        <div class="save-modal-buttons">
                            <button class="save-modal-cancel" onclick="closeAddWidgetToRoomModal()">Cancel</button>
                            <button class="save-modal-save" id="addWidgetToRoomBtn">
                                <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:white;margin-right:6px;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                Add Widget
                            </button>
                        </div>
                    </div>
                `;
                modal.onclick = function(e) { if (e.target === modal) closeAddWidgetToRoomModal(); };
                document.body.appendChild(modal);
            }
            
            // Store room code in modal
            modal.dataset.roomCode = roomCode;
            document.getElementById('newRoomWidgetName').value = '';
            document.getElementById('useCurrentSettings').checked = true;
            document.getElementById('addWidgetToRoomStatus').style.display = 'none';
            
            // Set up button handler
            document.getElementById('addWidgetToRoomBtn').onclick = function() {
                addWidgetToRoom(modal.dataset.roomCode);
            };
            
            modal.classList.add('show');
            document.getElementById('newRoomWidgetName').focus();
        }
        
        function closeAddWidgetToRoomModal() {
            const modal = document.getElementById('addWidgetToRoomModal');
            if (modal) modal.classList.remove('show');
        }
        
        // Add widget to room
        async function addWidgetToRoom(roomCode) {
            const name = document.getElementById('newRoomWidgetName').value.trim();
            const useCurrentSettings = document.getElementById('useCurrentSettings').checked;
            const statusEl = document.getElementById('addWidgetToRoomStatus');
            
            if (!name) {
                statusEl.style.display = 'block';
                statusEl.style.background = '#fef2f2';
                statusEl.style.color = '#dc2626';
                statusEl.textContent = 'Please enter a widget name';
                return;
            }
            
            try {
                statusEl.style.display = 'block';
                statusEl.style.background = '#eff6ff';
                statusEl.style.color = '#1e40af';
                statusEl.textContent = 'Adding widget...';
                
                const config = useCurrentSettings ? collectCurrentConfig() : {};
                
                const response = await fetch(`${COLLAB_API_URL}/room/${roomCode}/widgets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        config: config,
                        creatorName: collabUserName || cloudUser?.login || 'Anonymous'
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add widget');
                }
                
                closeAddWidgetToRoomModal();
                
                // Expand the room and refresh
                expandedRooms[roomCode] = true;
                localStorage.setItem('d365_expanded_rooms', JSON.stringify(expandedRooms));
                
                await refreshRoomWidgets(roomCode);
                
                showToast(` Widget "${name}" added to room!`);
                
            } catch (error) {
                console.error('Error adding widget:', error);
                statusEl.style.display = 'block';
                statusEl.style.background = '#fef2f2';
                statusEl.style.color = '#dc2626';
                statusEl.textContent = 'Error: ' + error.message;
            }
        }
        
        // Legacy function for compatibility
        function updateRoomUI() {
            renderRoomList();
        }
        
        // Initialize room UI and refresh widgets from server on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Render saved rooms immediately with cached data
            renderRoomList();
            
            // Then refresh widgets from server for all rooms in background
            if (savedRooms.length > 0) {
                console.log(' Refreshing room widgets from server...');
                for (const room of savedRooms) {
                    try {
                        const response = await fetch(`${COLLAB_API_URL}/room/${room.code}`);
                        if (response.ok) {
                            const roomData = await response.json();
                            room.widgets = roomData.widgets || [];
                            room.lastUpdated = roomData.lastUpdated;
                        }
                    } catch (e) {
                        console.log(`Failed to refresh room ${room.code}:`, e);
                    }
                }
                localStorage.setItem('d365_collab_rooms', JSON.stringify(savedRooms));
                renderRoomList();
                console.log(' Room widgets refreshed');
            }
        });

        // Check for existing login on page load
        function checkExistingLogin() {
            const savedUser = localStorage.getItem('d365_user');
            const savedToken = localStorage.getItem('d365_github_token');
            
            if (savedUser && savedToken) {
                try {
                    cloudUser = JSON.parse(savedUser);
                    cloudToken = savedToken;
                    showLoggedInUI();
                    return true;
                } catch (e) {
                    localStorage.removeItem('d365_user');
                    localStorage.removeItem('d365_github_token');
                }
            }
            return false;
        }

        // Show login overlay
        function showLoginOverlay() {
            document.getElementById('loginOverlay').classList.remove('hidden');
        }

        // GitHub login button - show token entry
        document.addEventListener('DOMContentLoaded', function() {
            const githubLoginBtn = document.getElementById('githubLoginBtn');
            if (githubLoginBtn) {
                githubLoginBtn.addEventListener('click', function() {
                    document.getElementById('tokenEntry').classList.add('show');
                });
            }
        });

        // Token connect button
        document.addEventListener('DOMContentLoaded', function() {
            const tokenConnectBtn = document.getElementById('tokenConnectBtn');
            if (tokenConnectBtn) {
                tokenConnectBtn.addEventListener('click', async function() {
                    const token = document.getElementById('tokenInput').value.trim();
                    const statusEl = document.getElementById('tokenStatus');
                    
                    if (!token) {
                        statusEl.className = 'token-status error';
                        statusEl.textContent = 'Please enter a token';
                        return;
                    }
                    
                    this.disabled = true;
                    this.textContent = 'Connecting...';
                    statusEl.className = 'token-status';
                    statusEl.style.display = 'none';
                    
                    await verifyAndLogin(token);
                    
                    this.disabled = false;
                    this.textContent = 'Connect';
                });
            }
        });

        async function verifyAndLogin(token) {
            const statusEl = document.getElementById('tokenStatus');
            
            try {
                // Verify token
                const userRes = await fetch('https://api.github.com/user', {
                    headers: { 'Authorization': 'token ' + token }
                });
                
                if (!userRes.ok) throw new Error('Invalid token');
                
                const user = await userRes.json();
                
                // Check gist scope
                const gistRes = await fetch('https://api.github.com/gists', {
                    headers: { 'Authorization': 'token ' + token }
                });
                
                if (!gistRes.ok) throw new Error('Token needs "gist" scope');
                
                // Success
                cloudUser = {
                    id: user.id,
                    name: user.name || user.login,
                    login: user.login,
                    avatar: user.avatar_url
                };
                cloudToken = token;
                tokenInvalidated = false; // Reset invalidation flag on successful login
                
                localStorage.setItem('d365_user', JSON.stringify(cloudUser));
                localStorage.setItem('d365_github_token', token);
                
                if (statusEl) {
                    statusEl.className = 'token-status success';
                    statusEl.textContent = ' Connected! Welcome, ' + cloudUser.name;
                }
                
                setTimeout(() => showLoggedInUI(), 500);
                
            } catch (err) {
                if (statusEl) {
                    statusEl.className = 'token-status error';
                    statusEl.textContent = ' ' + (err.message || 'Failed to connect');
                }
            }
        }

        async function showLoggedInUI() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('userBar').classList.add('show');
            document.getElementById('userName').textContent = cloudUser.name || cloudUser.login;
            if (cloudUser.avatar) {
                document.getElementById('userAvatar').src = cloudUser.avatar;
            }
            // Hide login button in header
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) loginBtn.style.display = 'none';
            
            // Show Sync All button
            const syncAllBtn = document.getElementById('syncAllBtn');
            if (syncAllBtn) syncAllBtn.style.display = 'inline-flex';
            
            // Show Refresh from Cloud button
            const refreshCloudBtn = document.getElementById('refreshCloudBtn');
            if (refreshCloudBtn) refreshCloudBtn.style.display = 'inline-flex';
            
            loadSavedWidgets();
            
            // CRITICAL: Sync profiles from cloud after login
            // This restores user's saved widgets when logging in on a new device
            await syncProfilesFromCloud();
            
            // Initialize team mode
            initializeTeamMode();
        }
        
        // Sync profiles from cloud (GitHub Gists) after login
        // This is critical for restoring user's widgets on new devices/browsers
        async function syncProfilesFromCloud() {
            if (!cloudToken || tokenInvalidated || !cloudUser) return;
            
            try {
                console.log(' Syncing profiles from cloud for user:', cloudUser.login);
                
                // Ensure profiles is an array
                if (!Array.isArray(profiles)) {
                    profiles = [];
                }
                
                // Check if the current user is different from the last logged-in user
                // This handles the case where someone logs out and logs in with a different account
                const lastUserId = localStorage.getItem('d365_last_user_id');
                const currentUserId = String(cloudUser.id);
                
                if (lastUserId && lastUserId !== currentUserId) {
                    console.log(' Different user detected! Previous:', lastUserId, 'Current:', currentUserId);
                    // Clear profiles that belong to the previous user (those with cloudId)
                    // Keep any profiles without cloudId (local-only profiles)
                    const localOnlyProfiles = profiles.filter(p => p && !p.cloudId);
                    profiles = localOnlyProfiles;
                    saveProfiles();
                    console.log(' Cleared previous user profiles, kept', localOnlyProfiles.length, 'local-only profiles');
                }
                
                // Save current user ID for future comparison
                localStorage.setItem('d365_last_user_id', currentUserId);
                
                const res = await fetch('https://api.github.com/gists', {
                    headers: { 'Authorization': 'token ' + cloudToken }
                });
                
                if (res.status === 401) {
                    handleTokenInvalidation();
                    return;
                }
                
                if (!res.ok) throw new Error('Failed to fetch gists');
                
                const gists = await res.json();
                const widgetGists = gists.filter(g => g.description && g.description.startsWith(GIST_PREFIX));
                
                if (widgetGists.length === 0) {
                    console.log(' No cloud profiles found');
                    return;
                }
                
                console.log(` Found ${widgetGists.length} cloud profiles`);
                
                // Ensure profiles array exists
                if (!Array.isArray(profiles)) {
                    profiles = [];
                }
                
                let importedCount = 0;
                let updatedCount = 0;
                
                // Build a map of existing profiles by cloudId for quick lookup
                const localProfilesByCloudId = {};
                profiles.forEach(p => {
                    if (p && p.cloudId) {
                        localProfilesByCloudId[p.cloudId] = p;
                    }
                });
                
                // Process each cloud gist
                // Track gists that return 404 (actually deleted but still in list cache)
                const deletedGistIds = new Set();
                
                for (const gist of widgetGists) {
                    try {
                        // Check if we already have this profile linked by cloudId
                        const existingProfile = localProfilesByCloudId[gist.id];
                        
                        if (existingProfile) {
                            // Profile already linked - check if cloud version is newer
                            const cloudUpdatedAt = new Date(gist.updated_at);
                            const localUpdatedAt = existingProfile.updatedAt ? new Date(existingProfile.updatedAt) : new Date(0);
                            
                            if (cloudUpdatedAt > localUpdatedAt) {
                                // Cloud is newer - fetch full config and update local
                                const fetchResult = await fetchGistConfig(gist.id);
                                if (fetchResult === 'deleted') {
                                    // Gist was deleted - mark for removal
                                    deletedGistIds.add(gist.id);
                                    console.log(` Gist ${gist.id} was deleted (404), marking for removal`);
                                } else if (fetchResult) {
                                    existingProfile.settings = fetchResult.config;
                                    existingProfile.updatedAt = gist.updated_at;
                                    updatedCount++;
                                    console.log(` Updated profile "${existingProfile.name}" from cloud`);
                                }
                            }
                        } else {
                            // New profile from cloud - import it
                            const fetchResult = await fetchGistConfig(gist.id);
                            if (fetchResult === 'deleted') {
                                // Gist was deleted - mark for removal (but won't affect anything since no local profile)
                                deletedGistIds.add(gist.id);
                                console.log(` Gist ${gist.id} was deleted (404), skipping import`);
                            } else if (fetchResult) {
                                const profileName = gist.description.replace(GIST_PREFIX, '');
                                
                                // Check if a profile with same name already exists (without cloudId link)
                                const existingByName = profiles.find(p => p.name === profileName && !p.cloudId);
                                
                                if (existingByName) {
                                    // Link existing profile to cloud and update settings
                                    existingByName.cloudId = gist.id;
                                    existingByName.settings = fetchResult.config;
                                    existingByName.updatedAt = gist.updated_at;
                                    updatedCount++;
                                    console.log(` Linked and updated existing profile "${profileName}" to cloud`);
                                } else {
                                    // Create new local profile from cloud
                                    const newProfile = {
                                        id: 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                        name: profileName,
                                        settings: fetchResult.config,
                                        cloudId: gist.id,
                                        createdAt: gist.created_at,
                                        updatedAt: gist.updated_at
                                    };
                                    profiles.push(newProfile);
                                    importedCount++;
                                    console.log(` Imported new profile "${profileName}" from cloud`);
                                }
                            }
                        }
                        
                        // Small delay to avoid rate limiting
                        await new Promise(r => setTimeout(r, 200));
                        
                    } catch (e) {
                        console.error(` Error processing gist ${gist.id}:`, e);
                    }
                }
                
                // Remove local profiles whose cloudId no longer exists in the cloud
                // (they were deleted from another browser/device OR returned 404 when fetched)
                const cloudGistIds = new Set(widgetGists.map(g => g.id));
                // Also remove gists that returned 404 when we tried to fetch them
                deletedGistIds.forEach(id => cloudGistIds.delete(id));
                
                const profilesToRemove = profiles.filter(p => p && p.cloudId && !cloudGistIds.has(p.cloudId));
                let removedCount = 0;
                
                if (profilesToRemove.length > 0) {
                    for (const p of profilesToRemove) {
                        console.log(` Removing locally deleted profile "${p.name}" (cloudId ${p.cloudId} no longer exists)`);
                        // If this was the active profile, deselect it
                        if (activeProfileId === p.id) {
                            activeProfileId = null;
                            localStorage.removeItem('chatWidgetActiveProfile');
                        }
                    }
                    profiles = profiles.filter(p => !p || !p.cloudId || cloudGistIds.has(p.cloudId));
                    removedCount = profilesToRemove.length;
                }
                
                // Save updated profiles to localStorage
                if (importedCount > 0 || updatedCount > 0 || removedCount > 0) {
                    saveProfiles();
                    renderProfiles();
                    
                    // Build toast message
                    const parts = [];
                    if (importedCount > 0) parts.push(`restored ${importedCount}`);
                    if (updatedCount > 0) parts.push(`updated ${updatedCount}`);
                    if (removedCount > 0) parts.push(`removed ${removedCount} deleted`);
                    
                    if (parts.length > 0) {
                        showToast(` Sync: ${parts.join(', ')} profile${(importedCount + updatedCount + removedCount) > 1 ? 's' : ''}`);
                    }
                }
                
                console.log(` Cloud sync complete: ${importedCount} imported, ${updatedCount} updated, ${removedCount} removed`);
                
            } catch (e) {
                console.error(' Cloud sync error:', e);
                // Don't show error toast - this is a background operation
            }
        }
        
        // Manual refresh from cloud button handler
        async function refreshFromCloud() {
            if (!cloudToken || tokenInvalidated) {
                showToast('Please log in to refresh from cloud');
                return;
            }
            
            showToast(' Refreshing from cloud...');
            await syncProfilesFromCloud();
        }
        
        // Helper to fetch full gist config
        // Returns { config } on success, 'deleted' if 404, null on other errors
        async function fetchGistConfig(gistId) {
            try {
                const res = await fetch('https://api.github.com/gists/' + gistId, {
                    headers: { 'Authorization': 'token ' + cloudToken }
                });
                
                if (res.status === 401) {
                    handleTokenInvalidation();
                    return null;
                }
                
                if (res.status === 404) {
                    // Gist was deleted - return special marker
                    console.log(` Gist ${gistId} returned 404 - marked as deleted`);
                    return 'deleted';
                }
                
                if (!res.ok) return null;
                
                const gist = await res.json();
                
                if (gist.files && gist.files['config.json']) {
                    const config = JSON.parse(gist.files['config.json'].content);
                    return { config };
                }
                
                return null;
            } catch (e) {
                console.error('Error fetching gist config:', e);
                return null;
            }
        }
        
        // Initialize team mode after login
        async function initializeTeamMode() {
            // Check if token has repo scope
            await checkRepoScope();
            
            // Load saved team repo config
            if (loadTeamRepoConfig()) {
                await loadTeamWidgets();
            }
            
            // Update team UI
            updateTeamUI();
        }

        // Skip login
        document.addEventListener('DOMContentLoaded', function() {
            const skipLoginBtn = document.getElementById('skipLoginBtn');
            if (skipLoginBtn) {
                skipLoginBtn.addEventListener('click', function() {
                    document.getElementById('loginOverlay').classList.add('hidden');
                });
            }
        });

        // Logout
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    cloudUser = null;
                    cloudToken = null;
                    currentLoadedWidgetId = null;
                    hasRepoScope = false;
                    tokenInvalidated = false; // Reset token invalidation flag
                    localStorage.removeItem('d365_user');
                    localStorage.removeItem('d365_github_token');
                    // Note: We intentionally keep d365_last_user_id so we can detect
                    // if a different user logs in next time and clear their profiles
                    // Clear team data on logout
                    clearTeamRepoConfig();
                    
                    showToast('Logged out successfully');
                    
                    // Reload the page after a short delay to show the toast
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                });
            }
        });

        // Saved Widgets Dropdown
        document.addEventListener('DOMContentLoaded', function() {
            const savedWidgetsBtn = document.getElementById('savedWidgetsBtn');
            if (savedWidgetsBtn) {
                savedWidgetsBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    document.getElementById('savedWidgetsMenu').classList.toggle('show');
                });
            }
            
            document.addEventListener('click', function() {
                const menu = document.getElementById('savedWidgetsMenu');
                if (menu) menu.classList.remove('show');
            });
        });

        async function loadSavedWidgets() {
            if (!cloudToken || tokenInvalidated) return;
            
            try {
                const res = await fetch('https://api.github.com/gists', {
                    headers: { 'Authorization': 'token ' + cloudToken }
                });
                
                if (res.status === 401) {
                    handleTokenInvalidation();
                    return;
                }
                
                if (!res.ok) throw new Error('Failed to load');
                
                const gists = await res.json();
                savedWidgets = gists
                    .filter(g => g.description && g.description.startsWith(GIST_PREFIX))
                    .map(g => ({
                        id: g.id,
                        name: g.description.replace(GIST_PREFIX, ''),
                        updated: g.updated_at,
                        files: g.files
                    }));
                
                renderSavedWidgets();
                
            } catch (e) {
                console.error('Error loading widgets:', e);
            }
        }

        function renderSavedWidgets() {
            const list = document.getElementById('savedWidgetsList');
            const count = document.getElementById('widgetCount');
            
            if (!list || !count) return;
            
            count.textContent = savedWidgets.length;
            
            if (savedWidgets.length === 0) {
                list.innerHTML = '<div class="saved-widgets-empty">No saved widgets yet.<br>Create one and click "Save to Cloud"!</div>';
                return;
            }
            
            list.innerHTML = savedWidgets.map(w => {
                const safeName = escapeHtml(w.name).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <div class="saved-widget-item" onclick="loadWidget('${w.id}')">
                    <div>
                        <div class="saved-widget-name">${escapeHtml(w.name)}</div>
                        <div class="saved-widget-date">Updated ${formatTimeAgo(w.updated)}</div>
                    </div>
                    <button class="saved-widget-delete" onclick="event.stopPropagation(); deleteWidget('${w.id}', '${safeName}')">Delete</button>
                </div>
            `;
            }).join('');
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
            return date.toLocaleDateString();
        }

        async function loadWidget(gistId) {
            try {
                const res = await fetch('https://api.github.com/gists/' + gistId, {
                    headers: { 'Authorization': 'token ' + cloudToken }
                });
                
                if (res.status === 401) {
                    handleTokenInvalidation();
                    return;
                }
                
                if (!res.ok) throw new Error('Failed to load widget');
                
                const gist = await res.json();
                
                if (gist.files['config.json']) {
                    const config = JSON.parse(gist.files['config.json'].content);
                    const widgetName = gist.description.replace(GIST_PREFIX, '');
                    
                    // Load the config into the form
                    applyCloudConfig(config);
                    currentLoadedWidgetId = gistId;
                    
                    // Also ensure this widget is linked to a local profile
                    // Check if profile with this cloudId already exists
                    let linkedProfile = profiles.find(p => p.cloudId === gistId);
                    
                    if (!linkedProfile) {
                        // Check if profile with same name exists (but no cloudId - not linked to another cloud widget)
                        linkedProfile = profiles.find(p => p.name === widgetName && !p.cloudId);
                        
                        if (linkedProfile) {
                            // Link existing profile to this cloud widget
                            linkedProfile.cloudId = gistId;
                            linkedProfile.settings = config;
                            linkedProfile.updatedAt = gist.updated_at;
                        } else {
                            // Create new local profile linked to cloud
                            linkedProfile = {
                                id: 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                name: widgetName,
                                settings: config,
                                cloudId: gistId,
                                createdAt: gist.created_at,
                                updatedAt: gist.updated_at
                            };
                            profiles.push(linkedProfile);
                        }
                        
                        saveProfiles();
                        renderProfiles();
                    }
                    
                    // Set as active profile
                    activeProfileId = linkedProfile.id;
                    localStorage.setItem('chatWidgetActiveProfile', activeProfileId);
                    renderProfiles();
                    
                    showToast('Widget loaded: ' + widgetName);
                }
                
                document.getElementById('savedWidgetsMenu').classList.remove('show');
                
            } catch (e) {
                console.error('Error loading widget:', e);
                showToast('Failed to load widget');
            }
        }

        function applyCloudConfig(config) {
            // Merge cloud config into settings
            Object.assign(settings, config);
            
            // Update form fields
            Object.keys(config).forEach(key => {
                const el = document.getElementById(key);
                if (el) {
                    if (el.type === 'checkbox') {
                        el.checked = config[key];
                    } else if (el.type === 'color') {
                        el.value = config[key];
                    } else {
                        el.value = config[key];
                    }
                    // Trigger change event
                    el.dispatchEvent(new Event('input', { bubbles: true }));
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            
            // Update preview
            if (typeof updatePreview === 'function') {
                updatePreview();
            }
            
            // Restore images
            restoreUploadedImages();
        }

        async function deleteWidget(gistId, name) {
            showConfirmModal({
                type: 'danger',
                title: 'Delete Cloud Widget?',
                message: 'This will permanently delete this widget from your GitHub Gists. Any local profile linked to it will be unlinked but preserved locally.',
                itemName: name,
                itemIcon: '<svg viewBox="0 0 24 24" style="fill: #6b7280;"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>',
                actionText: 'Delete Widget',
                onConfirm: async function() {
                    try {
                        const res = await fetch('https://api.github.com/gists/' + gistId, {
                            method: 'DELETE',
                            headers: { 'Authorization': 'token ' + cloudToken }
                        });
                        
                        if (res.status === 401) {
                            handleTokenInvalidation();
                            return;
                        }
                        
                        if (!res.ok && res.status !== 204) {
                            throw new Error('Delete failed: ' + res.status);
                        }
                        
                        // Also remove cloudId from any local profile that was linked to this gist
                        profiles.forEach(p => {
                            if (p.cloudId === gistId) {
                                delete p.cloudId;
                            }
                        });
                        saveProfiles();
                        
                        showToast('Widget deleted');
                        loadSavedWidgets();
                        
                        if (currentLoadedWidgetId === gistId) {
                            currentLoadedWidgetId = null;
                        }
                        
                    } catch (e) {
                        console.error('Delete error:', e);
                        showToast('Failed to delete widget');
                    }
                }
            });
        }

        // Save to Cloud button
        document.addEventListener('DOMContentLoaded', function() {
            const saveToCloudBtn = document.getElementById('saveToCloudBtn');
            if (saveToCloudBtn) {
                saveToCloudBtn.addEventListener('click', function() {
                    if (!cloudToken) {
                        showToast('Please sign in first');
                        showLoginOverlay();
                        return;
                    }
                    document.getElementById('saveWidgetName').value = currentLoadedWidgetId ? 
                        (savedWidgets.find(w => w.id === currentLoadedWidgetId)?.name || '') : '';
                    document.getElementById('saveModal').classList.add('show');
                });
            }
        });

        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('show');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const saveModalConfirmBtn = document.getElementById('saveModalConfirmBtn');
            if (saveModalConfirmBtn) {
                saveModalConfirmBtn.addEventListener('click', saveWidgetToCloud);
            }
        });

        // Auto-save profile to cloud (called when saving/updating profiles)
        async function saveProfileToCloud(profile) {
            console.log(' saveProfileToCloud called for:', profile?.name);
            console.log(' cloudToken exists:', !!cloudToken);
            console.log(' tokenInvalidated:', tokenInvalidated);
            
            if (!cloudToken || tokenInvalidated) {
                console.log(' Aborting save - no token or token invalidated');
                return;
            }
            
            updateCloudSyncStatus('syncing');
            
            const gistData = {
                description: GIST_PREFIX + profile.name,
                public: false,
                files: {
                    'config.json': {
                        content: JSON.stringify(profile.settings, null, 2)
                    },
                    'README.md': {
                        content: `# ${profile.name}\n\nD365 Chat Widget Configuration\n\nCreated with [D365 Widget Studio](https://moliveirapinto.github.io/d365-modern-chat-widget/)`
                    }
                }
            };
            
            console.log(' Gist data prepared:', gistData.description);
            
            try {
                // Check if this profile already has a cloud ID
                let existingGistId = profile.cloudId || null;
                console.log(' Existing gist ID:', existingGistId);
                
                let res;
                if (existingGistId) {
                    // Try to update existing gist
                    console.log(' Updating existing gist...');
                    res = await fetch('https://api.github.com/gists/' + existingGistId, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'token ' + cloudToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                    
                    // If 403 or 404, the gist belongs to another user/token - create new instead
                    if (res.status === 403 || res.status === 404) {
                        console.log(' Cannot access existing gist (403/404), creating new one...');
                        profile.cloudId = null; // Clear invalid cloudId
                        existingGistId = null;
                        res = await fetch('https://api.github.com/gists', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'token ' + cloudToken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(gistData)
                        });
                    }
                } else {
                    // Create new gist
                    console.log(' Creating new gist...');
                    res = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'token ' + cloudToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                }
                
                console.log(' Response status:', res.status);
                
                if (res.status === 401) {
                    console.log(' 401 Unauthorized - invalidating token');
                    handleTokenInvalidation();
                    return;
                }
                
                // 403 on POST means token lacks gist scope
                if (res.status === 403 && !existingGistId) {
                    const errorText = await res.text();
                    console.error(' Token lacks gist scope:', errorText);
                    showToast(' Your GitHub token needs the "gist" scope. Please create a new token with gist permissions.', 8000);
                    return;
                }
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error(' Save failed:', res.status, errorText);
                    throw new Error('Failed to save: ' + res.status);
                }
                
                const gist = await res.json();
                console.log(' Gist saved successfully! ID:', gist.id);
                
                // Store the cloud ID in the profile for future updates
                profile.cloudId = gist.id;
                isDirty = false; // Reset dirty flag after successful cloud save
                saveProfiles();
                
                updateCloudSyncStatus('synced');
                showToast(`Profile "${profile.name}" saved to cloud! `);
                
            } catch (e) {
                console.error(' Cloud save error:', e);
                updateCloudSyncStatus('error');
                showToast(`Profile saved locally (cloud sync failed)`);
            }
        }

        // Sync all profiles to cloud (for existing profiles without cloudId)
        async function syncAllProfilesToCloud() {
            console.log(' syncAllProfilesToCloud called');
            console.log(' cloudToken exists:', !!cloudToken);
            console.log(' profiles count:', profiles.length);
            
            if (!cloudToken) {
                showToast('Please sign in with GitHub first');
                return;
            }
            
            if (profiles.length === 0) {
                showToast('No profiles to sync');
                return;
            }
            
            showToast(`Syncing ${profiles.length} profiles to cloud...`);
            updateCloudSyncStatus('syncing');
            
            let successCount = 0;
            let errorCount = 0;
            
            // Sync profiles one at a time to avoid rate limits
            for (const profile of profiles) {
                console.log(' Syncing profile:', profile.name);
                try {
                    await saveProfileToCloudSync(profile);
                    console.log(' Successfully synced:', profile.name, 'cloudId:', profile.cloudId);
                    successCount++;
                } catch (e) {
                    console.error(` Failed to sync "${profile.name}":`, e);
                    errorCount++;
                }
                // Small delay to avoid rate limiting
                await new Promise(r => setTimeout(r, 500));
            }
            
            saveProfiles(); // Save cloudIds to localStorage
            loadSavedWidgets(); // Refresh the dropdown
            
            if (errorCount === 0) {
                updateCloudSyncStatus('synced');
                showToast(` All ${successCount} profiles synced to cloud!`);
            } else {
                updateCloudSyncStatus('error');
                showToast(` Synced ${successCount}, failed ${errorCount}`);
            }
        }
        
        // Sync version that returns promise (for syncAll)
        async function saveProfileToCloudSync(profile) {
            console.log(' saveProfileToCloudSync called for:', profile.name);
            if (tokenInvalidated) throw new Error('Token invalidated');
            
            const gistData = {
                description: GIST_PREFIX + profile.name,
                public: false,
                files: {
                    'config.json': {
                        content: JSON.stringify(profile.settings, null, 2)
                    },
                    'README.md': {
                        content: `# ${profile.name}\n\nD365 Chat Widget Configuration\n\nCreated with [D365 Widget Studio](https://moliveirapinto.github.io/d365-modern-chat-widget/)`
                    }
                }
            };
            
            let res;
            let existingGistId = profile.cloudId || null;
            
            if (existingGistId) {
                // Try to update existing gist
                console.log(' Updating existing gist:', existingGistId);
                res = await fetch('https://api.github.com/gists/' + existingGistId, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'token ' + cloudToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gistData)
                });
                
                // If 403 or 404, the gist belongs to another user/token - create new instead
                if (res.status === 403 || res.status === 404) {
                    console.log(' Cannot access existing gist (403/404), creating new one...');
                    profile.cloudId = null; // Clear invalid cloudId
                    existingGistId = null;
                    res = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'token ' + cloudToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                }
            } else {
                // Create new gist
                console.log(' Creating new gist for:', profile.name);
                res = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'token ' + cloudToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gistData)
                });
            }
            
            console.log(' Response status:', res.status);
            
            if (res.status === 401) {
                handleTokenInvalidation();
                throw new Error('Token expired');
            }
            
            // 403 on POST means token lacks gist scope
            if (res.status === 403 && !existingGistId) {
                const errorText = await res.text();
                console.error(' Token lacks gist scope:', errorText);
                showToast(' Your GitHub token needs the "gist" scope. Please create a new token with gist permissions.', 8000);
                throw new Error('Token missing gist scope');
            }
            
            if (!res.ok) {
                const errorText = await res.text();
                console.error(' Sync failed:', res.status, errorText);
                throw new Error('Failed to save: ' + res.status);
            }
            
            const gist = await res.json();
            console.log(' Gist created/updated! ID:', gist.id);
            profile.cloudId = gist.id; // Store cloud ID for future updates
        }

        async function saveWidgetToCloud() {
            const name = document.getElementById('saveWidgetName').value.trim();
            
            if (!name) {
                showToast('Please enter a widget name');
                return;
            }
            
            // Update settings from form before saving
            if (typeof updateSettingsFromForm === 'function') {
                updateSettingsFromForm();
            }
            
            const gistData = {
                description: GIST_PREFIX + name,
                public: false,
                files: {
                    'config.json': {
                        content: JSON.stringify(settings, null, 2)
                    },
                    'README.md': {
                        content: `# ${name}\n\nD365 Chat Widget Configuration\n\nCreated with [D365 Widget Studio](https://moliveirapinto.github.io/d365-modern-chat-widget/)`
                    }
                }
            };
            
            try {
                let res;
                if (currentLoadedWidgetId) {
                    // Update existing
                    res = await fetch('https://api.github.com/gists/' + currentLoadedWidgetId, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'token ' + cloudToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                } else {
                    // Create new
                    res = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'token ' + cloudToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                }
                
                if (res.status === 401) {
                    handleTokenInvalidation();
                    return;
                }
                
                if (!res.ok) throw new Error('Failed to save');
                
                const gist = await res.json();
                currentLoadedWidgetId = gist.id;
                
                closeSaveModal();
                showToast('Widget saved to cloud! ');
                loadSavedWidgets();
                
            } catch (e) {
                console.error('Save error:', e);
                showToast('Failed to save widget');
            }
        }

        // ============================================
        // Admin Settings
        // ============================================

        // Default settings - comprehensive for demos
        const defaultSettings = {
            // D365 Connection
            lcwCode: '',
            orgId: '',
            orgUrl: '',
            widgetId: '',
            // Widget Mode
            widgetMode: 'custom',
            // Standard Widget Authentication
            enableStandardAuth: false,
            standardAuthName: '',
            standardAuthEmail: '',
            enableCustomAuth: false,
            customAuthName: '',
            customAuthEmail: '',
            // Demo Settings
            backgroundImageUrl: '',
            // Header & Branding
            headerTitle: 'Support Chat',
            headerSubtitle: "We're here to help",
            headerTitleColor: '#ffffff',
            headerSubtitleColor: '#e0e7ff',
            headerLogo: null,
            // Fonts
            fontFamily: 'system',
            // Colors
            useGradient: true,
            useBubbleGradient: true,
            gradientStart: '#667eea',
            gradientEnd: '#764ba2',
            primaryColor: '#667eea',
            userBubbleColor: '#667eea',
            userTextColor: '#ffffff',
            agentBubbleColor: '#ffffff',
            agentTextColor: '#2d3748',
            systemMsgColor: '#e2e8f0',
            systemTextColor: '#64748b',
            chatBgColor: '#f8fafc',
            inputBgColor: '#ffffff',
            inputBorderColor: '#e2e8f0',
            sendBtnColor: '#667eea',
            launcherColor: '#667eea',
            launcherIcon: 'chat_multiple',
            badgeColor: '#ff4757',
            // Pre-chat Hero Colors
            usePrechatGradient: true,
            prechatGradientStart: '#667eea',
            prechatGradientEnd: '#764ba2',
            prechatSolidColor: '#667eea',
            prechatTitleColor: '#ffffff',
            prechatSubtitleColor: '#e0e7ff',
            prechatBadgeBg: '#ffffff',
            prechatBadgeText: '#059669',
            prechatStatusDot: '#10b981',
            prechatAvatarBorder: '#ffffff',
            // Avatars
            agentAvatar: null,
            customerAvatar: null,
            botAvatar: null,
            // Pre-chat Form
            enablePrechatForm: true,
            enableCustomAuth: false,
            customAuthName: '',
            customAuthEmail: '',
            defaultContactName: '',
            defaultContactEmail: '',
            welcomeTitle: 'Start a conversation',
            welcomeMessage: "We're here to help! Please fill out the form below to start chatting with our team.",
            nameFieldLabel: 'Your Name',
            nameFieldPlaceholder: 'Enter your name',
            emailFieldLabel: 'Email Address',
            emailFieldPlaceholder: 'Enter your email',
            questionFieldLabel: 'How can we help?',
            questionFieldPlaceholder: 'Describe your question...',
            startBtnText: 'Start Chat'
        };

        let settings = { ...defaultSettings };
        let profiles = [];
        let activeProfileId = null;
        let isInitializing = true; // Flag to prevent auto-save during form population
        let isDirty = false; // Track if settings have changed since last cloud sync
        let lastCloudSync = null; // Timestamp of last cloud sync

        // Debounce utility - prevents function from being called too frequently
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Debounced version of updateSettingsFromForm for input handlers
        const debouncedUpdateSettings = debounce(() => {
            updateSettingsFromForm();
            updatePreview();
            // Auto-save to active profile and localStorage (but not during initialization)
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            if (!isInitializing) {
                localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
            }
        }, 150); // 150ms debounce for smooth preview updates

        // Auto-save to cloud every 30 seconds if there are changes
        setInterval(async function() {
            if (isInitializing) return;
            
            // Always auto-save to localStorage
            updateSettingsFromForm();
            const settingsToSave = { ...settings };
            ['headerLogo', 'agentAvatar', 'customerAvatar', 'botAvatar'].forEach(key => {
                if (!isSafeImageData(settingsToSave[key])) {
                    settingsToSave[key] = null;
                }
                delete settingsToSave[key + '_isBlob'];
            });
            settingsToSave.lastSaved = new Date().toISOString();
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settingsToSave));
            
            // Also sync to cloud if logged in and have changes
            if (!cloudToken || !activeProfileId || !isDirty || tokenInvalidated) return;
            
            const profile = profiles.find(p => p.id === activeProfileId);
            if (!profile) return;
            
            // Update the profile with current settings
            updateSettingsFromForm();
            profile.settings = { ...settings };
            profile.updatedAt = new Date().toISOString();
            saveProfiles();
            
            // Sync to cloud silently (no toast)
            try {
                await saveProfileToCloudSync(profile);
                saveProfiles(); // Save cloudId
                isDirty = false;
                lastCloudSync = new Date();
                updateCloudSyncStatus('synced');
                console.log(' Auto-saved to cloud');
            } catch (e) {
                console.error('Auto-save failed:', e);
                updateCloudSyncStatus('error');
            }
        }, 5000); // Every 5 seconds
        
        // Periodic sync FROM cloud to detect deletions/changes from other browsers
        // Runs every 60 seconds when logged in
        setInterval(async function() {
            if (!cloudToken || tokenInvalidated || !cloudUser) return;
            
            // Don't sync if user is actively editing (has pending changes)
            if (isDirty) return;
            
            console.log(' Background sync from cloud...');
            await syncProfilesFromCloud();
        }, 60000); // Every 60 seconds

        // Mark as dirty when settings change
        function markDirty() {
            if (!isInitializing) {
                isDirty = true;
                updateCloudSyncStatus('pending');
            }
        }
        
        // Update cloud status to show pending changes
        function updateCloudSyncStatus(status) {
            const statusEl = document.getElementById('cloudSyncStatus');
            if (!statusEl) return;
            
            statusEl.className = 'cloud-sync-status ' + status;
            const span = statusEl.querySelector('span');
            const svg = statusEl.querySelector('svg');
            
            if (status === 'syncing') {
                span.textContent = 'Syncing...';
                svg.innerHTML = '<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>';
            } else if (status === 'synced') {
                span.textContent = 'Cloud synced';
                svg.innerHTML = '<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM10 17l-3.5-3.5 1.41-1.41L10 14.17l4.59-4.58L16 11l-6 6z"/>';
            } else if (status === 'pending') {
                span.textContent = 'Unsaved changes';
                svg.innerHTML = '<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM12 10c.55 0 1 .45 1 1v4c0 .55-.45 1-1 1s-1-.45-1-1v-4c0-.55.45-1 1-1zm0 8c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>';
            } else if (status === 'offline') {
                span.textContent = 'Offline - Sign in';
                svg.innerHTML = '<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-1.48 0-2.85.43-4.01 1.17l1.46 1.46C10.21 6.23 11.08 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H19c1.66 0 3 1.34 3 3 0 1.13-.64 2.11-1.56 2.62l1.45 1.45C23.16 18.16 24 16.68 24 15c0-2.64-2.05-4.78-4.65-4.96zM3 5.27l2.75 2.74C2.56 8.15 0 10.77 0 14c0 3.31 2.69 6 6 6h11.73l2 2L21 20.73 4.27 4 3 5.27zM7.73 10l8 8H6c-2.21 0-4-1.79-4-4s1.79-4 4-4h1.73z"/>';
            } else {
                span.textContent = 'Sync error';
                svg.innerHTML = '<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/>';
            }
        }

        // Tab switching
        function switchPreviewTab(tab) {
            // Update tab buttons - only within the visible tab group
            const customTabs = document.getElementById('customPreviewTabs');
            const standardTabs = document.getElementById('standardPreviewTabs');
            const activeTabs = (tab === 'standard') ? standardTabs : customTabs;
            
            if (activeTabs) {
                activeTabs.querySelectorAll('.preview-tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                // Find and activate the correct tab button
                activeTabs.querySelectorAll('.preview-tab').forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(tab) || 
                        (tab === 'prechat' && btn.textContent.includes('Pre-chat')) ||
                        (tab === 'chat' && btn.textContent.includes('Chat Preview')) ||
                        (tab === 'launcher' && btn.textContent.includes('Launcher')) ||
                        (tab === 'standard' && btn.textContent.includes('Standard'))) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Update content
            document.querySelectorAll('.preview-content').forEach(content => {
                content.classList.remove('active');
            });
            const previewEl = document.getElementById(tab + 'Preview');
            if (previewEl) {
                previewEl.classList.add('active');
            }
        }

        const MAX_IMAGE_DATA_LENGTH = 120 * 1024; // ~120KB limit for stored image data URLs

        function isSafeImageData(value) {
            if (typeof value !== 'string' || value.length === 0) return false;
            
            // Accept HTTPS/HTTP URLs (including GitHub raw URLs and any public images)
            if (value.startsWith('https://') || value.startsWith('http://')) {
                return true;
            }
            
            // Accept relative file paths ending with valid image extensions
            if (/\.(png|jpg|jpeg|gif|webp|svg)$/i.test(value)) {
                return true;
            }
            
            // Accept data URLs (legacy support)
            return value.startsWith('data:image') && value.length <= MAX_IMAGE_DATA_LENGTH;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check for existing GitHub login
            if (!checkExistingLogin()) {
                // No existing login - show login overlay
                // (user can skip if they want)
            }
            
            loadCurrentUser();
            loadProfiles();
            loadSettings();
            setupEventListeners();
            updatePreview();
            updateConnectionStatus();
            initCollapsibleCards();
            renderPaletteGallery(); // Initialize color palette gallery
            loadConfigFromUrl(); // Check for shared config in URL
            // Allow auto-save after initial load is complete
            setTimeout(() => {
                isInitializing = false;
                console.log(' Initialization complete - auto-save enabled');
            }, 100);
        });

        // ============ COLLAPSIBLE CARDS ============
        function initCollapsibleCards() {
            document.querySelectorAll('.settings-card .card-header').forEach(header => {
                // Add chevron icon if not already present
                if (!header.querySelector('.card-collapse-icon')) {
                    const chevron = document.createElement('div');
                    chevron.className = 'card-collapse-icon';
                    chevron.innerHTML = '<svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>';
                    header.appendChild(chevron);
                }
                
                header.addEventListener('click', (e) => {
                    // Don't collapse if clicking on an input or button inside header
                    if (e.target.closest('input, button, select, textarea')) return;
                    
                    const card = header.closest('.settings-card');
                    card.classList.toggle('collapsed');
                    
                    // Save collapsed state
                    saveCollapsedStates();
                });
            });
            
            // Restore collapsed states from localStorage
            restoreCollapsedStates();
        }
        
        function saveCollapsedStates() {
            const states = {};
            document.querySelectorAll('.settings-card').forEach((card, index) => {
                const heading = card.querySelector('.card-header h2');
                if (heading) {
                    states[heading.textContent.trim()] = card.classList.contains('collapsed');
                }
            });
            localStorage.setItem('cardCollapsedStates', JSON.stringify(states));
        }
        
        function restoreCollapsedStates() {
            const saved = localStorage.getItem('cardCollapsedStates');
            if (saved) {
                const states = JSON.parse(saved);
                document.querySelectorAll('.settings-card').forEach(card => {
                    const heading = card.querySelector('.card-header h2');
                    if (heading && states[heading.textContent.trim()]) {
                        card.classList.add('collapsed');
                    }
                });
            }
        }

        // ============ PROFILES MANAGEMENT ============
        function loadProfiles() {
            const saved = localStorage.getItem('chatWidgetProfiles');
            console.log(' RAW localStorage data:', saved ? saved.substring(0, 200) + '...' : 'EMPTY');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Ensure profiles is always an array
                    profiles = Array.isArray(parsed) ? parsed : [];
                    console.log(' Loaded profiles array. Count:', profiles.length, 'First profile gradientStart:', profiles[0]?.settings?.gradientStart);
                } catch (e) {
                    console.error(' Error parsing profiles from localStorage:', e);
                    profiles = [];
                }
            } else {
                profiles = [];
            }
            activeProfileId = localStorage.getItem('chatWidgetActiveProfile');
            
            // Verify activeProfileId still exists in profiles
            if (activeProfileId && !profiles.find(p => p.id === activeProfileId)) {
                console.log(' Active profile not found, clearing activeProfileId');
                activeProfileId = null;
                localStorage.removeItem('chatWidgetActiveProfile');
            }
            
            renderProfiles();
        }

        function saveProfiles() {
            console.log(' Saving profiles to localStorage. Total profiles:', profiles.length);
            if (activeProfileId) {
                const activeProfile = profiles.find(p => p.id === activeProfileId);
                if (activeProfile) {
                    console.log(' Active profile being saved:', {
                        name: activeProfile.name,
                        primaryColor: activeProfile.settings?.primaryColor,
                        gradientStart: activeProfile.settings?.gradientStart,
                        useGradient: activeProfile.settings?.useGradient,
                        demoWebsiteUrl: activeProfile.settings?.demoWebsiteUrl
                    });
                }
            }
            localStorage.setItem('chatWidgetProfiles', JSON.stringify(profiles));
            
            // Verify the save actually worked
            const verification = localStorage.getItem('chatWidgetProfiles');
            const parsed = JSON.parse(verification);
            if (activeProfileId) {
                const verifiedProfile = parsed.find(p => p.id === activeProfileId);
                console.log(' VERIFIED in localStorage:', {
                    name: verifiedProfile?.name,
                    gradientStart: verifiedProfile?.settings?.gradientStart,
                    primaryColor: verifiedProfile?.settings?.primaryColor
                });
            }
            
            if (activeProfileId) {
                localStorage.setItem('chatWidgetActiveProfile', activeProfileId);
            }
            
            // Mark as needing cloud sync
            markDirty();
        }

        function renderProfiles() {
            const container = document.getElementById('profileList');
            
            // Update personal count in tab
            const personalCount = document.getElementById('personalCount');
            if (personalCount) personalCount.textContent = profiles.length;
            
            if (profiles.length === 0) {
                container.innerHTML = '<p style="color: var(--admin-text-light); font-size: 13px; text-align: center; padding: 12px;">No saved profiles. Create one to quickly switch between customer demos.</p>';
                return;
            }

            container.innerHTML = profiles.map(p => {
                let host = 'No D365 configured';
                try {
                    if (p.settings && p.settings.orgUrl) {
                        host = new URL(p.settings.orgUrl).hostname;
                    }
                } catch (e) {
                    host = 'Invalid org URL';
                }
                
                // Get the embed code from the profile settings (lcwCode is the standard field name)
                const embedCode = p.settings?.lcwCode || '';
                const hasEmbedCode = embedCode.trim().length > 0;
                
                // Get connection details for display
                const appId = p.settings?.widgetId || '';
                const orgId = p.settings?.orgId || '';
                const orgUrl = p.settings?.orgUrl || '';
                const isConfigured = appId && orgId && orgUrl;
                
                // Determine connection status
                let statusClass = '';
                let statusText = 'Not configured';
                if (isConfigured) {
                    statusClass = 'configured';
                    statusText = 'Ready to connect';
                } else if (appId || orgId || orgUrl) {
                    statusClass = 'partial';
                    statusText = 'Partial configuration';
                }

                return `
                <div class="profile-item ${p.id === activeProfileId ? 'active' : ''}" onclick="loadProfile('${p.id}')">
                    <div class="profile-item-header">
                        <div class="profile-info">
                            <div class="profile-name">${escapeHtml(p.name)}</div>
                            <div class="profile-desc">${host}</div>
                        </div>
                        <div class="profile-actions">
                            <button class="profile-btn" onclick="event.stopPropagation(); renameProfile('${p.id}')" title="Rename profile">
                                <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                            </button>
                            <button class="profile-btn" onclick="event.stopPropagation(); updateProfile('${p.id}')" title="Update with current settings">
                                <svg viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                            </button>
                            <button class="profile-btn" onclick="event.stopPropagation(); showCopyToRoomModal('${p.id}')" title="Copy to Room" ${savedRooms.length === 0 ? 'disabled style="opacity: 0.4; cursor: not-allowed;"' : ''}>
                                <img src="https://github.com/microsoft/fluentui-system-icons/raw/main/assets/Breakout%20Room/SVG/ic_fluent_breakout_room_32_regular.svg?raw=true" alt="Copy to Room" style="width: 16px; height: 16px; opacity: 0.7;">
                            </button>
                            <button class="profile-btn delete" onclick="event.stopPropagation(); deleteProfile('${p.id}')" title="Delete profile">
                                <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="profile-embed-section">
                        <!-- Connection Status -->
                        <div class="profile-connection-status ${statusClass}">
                            <span class="profile-status-dot"></span>
                            <span class="profile-status-text">${statusText}</span>
                        </div>
                        
                        <!-- Extracted Values (if configured) -->
                        ${isConfigured ? `
                        <div class="profile-extracted-values">
                            <div class="profile-extracted-item">
                                <span class="profile-extracted-label">App ID:</span>
                                <span class="profile-extracted-value">${escapeHtml(appId)}</span>
                            </div>
                            <div class="profile-extracted-item">
                                <span class="profile-extracted-label">Org ID:</span>
                                <span class="profile-extracted-value">${escapeHtml(orgId)}</span>
                            </div>
                            <div class="profile-extracted-item">
                                <span class="profile-extracted-label">Org URL:</span>
                                <span class="profile-extracted-value">${escapeHtml(orgUrl)}</span>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- LCW Embed Code -->
                        <div class="profile-embed-label">
                            <svg viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                            D365 LCW Embed Code
                        </div>
                        <textarea class="profile-embed-code" 
                            id="profileEmbedCode_${p.id}" 
                            onclick="event.stopPropagation()" 
                            onchange="updateProfileEmbedCode('${p.id}', this.value)"
                            placeholder="Paste your D365 Omnichannel LCW embed code here...">${escapeHtml(embedCode)}</textarea>
                        <div class="profile-embed-actions">
                            <button class="profile-embed-btn secondary" onclick="event.stopPropagation(); copyProfileEmbedCode('${p.id}')" ${!hasEmbedCode ? 'disabled style="opacity: 0.5;"' : ''}>
                                <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                Copy Code
                            </button>
                            <button class="profile-embed-btn primary" onclick="event.stopPropagation(); parseProfileEmbedCode('${p.id}')">
                                <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                                Apply to Settings
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // Helper functions for profile embed code
        function updateProfileEmbedCode(profileId, newCode) {
            const profile = profiles.find(p => p.id === profileId);
            if (profile) {
                profile.settings.lcwCode = newCode;
                saveProfiles();
                // Re-render to update button states
                renderProfiles();
            }
        }
        
        function copyProfileEmbedCode(profileId) {
            const profile = profiles.find(p => p.id === profileId);
            if (profile && profile.settings.lcwCode) {
                navigator.clipboard.writeText(profile.settings.lcwCode).then(() => {
                    showToast('Embed code copied to clipboard!');
                });
            }
        }
        
        function parseProfileEmbedCode(profileId) {
            const profile = profiles.find(p => p.id === profileId);
            if (!profile) return;
            
            const embedCode = profile.settings.lcwCode || '';
            if (!embedCode.trim()) {
                showToast('No embed code to parse. Paste code first.', 'warning');
                return;
            }
            
            // Parse the embed code to extract orgId, orgUrl, widgetId
            const parsed = parseLcwEmbedCode(embedCode);
            
            if (parsed.orgId || parsed.orgUrl || parsed.widgetId) {
                // Update profile settings
                if (parsed.orgId) profile.settings.orgId = parsed.orgId;
                if (parsed.orgUrl) profile.settings.orgUrl = parsed.orgUrl;
                if (parsed.widgetId) profile.settings.widgetId = parsed.widgetId;
                
                saveProfiles();
                
                // If this is the active profile, also update the current form
                if (profileId === activeProfileId) {
                    if (parsed.orgId) document.getElementById('orgId').value = parsed.orgId;
                    if (parsed.orgUrl) document.getElementById('orgUrl').value = parsed.orgUrl;
                    if (parsed.widgetId) document.getElementById('widgetId').value = parsed.widgetId;
                    updateSettingsFromForm();
                }
                
                renderProfiles();
                showToast('D365 settings extracted and applied!');
            } else {
                showToast('Could not parse embed code. Check format.', 'warning');
            }
        }
        
        // Parse LCW embed code to extract connection details (handles both data-* and JSON formats)
        function parseLcwEmbedCode(code) {
            const result = { orgId: '', orgUrl: '', widgetId: '' };
            
            // Try data-* attribute format first (standard D365 embed code)
            const appIdMatch = code.match(/data-app-id\s*=\s*["']([^"']+)["']/i);
            if (appIdMatch) result.widgetId = appIdMatch[1];
            
            const orgIdDataMatch = code.match(/data-org-id\s*=\s*["']([^"']+)["']/i);
            if (orgIdDataMatch) result.orgId = orgIdDataMatch[1];
            
            const orgUrlDataMatch = code.match(/data-org-url\s*=\s*["']([^"']+)["']/i);
            if (orgUrlDataMatch) result.orgUrl = orgUrlDataMatch[1];
            
            // If data-* format didn't work, try JSON config format
            if (!result.orgId && !result.orgUrl && !result.widgetId) {
                const orgIdMatch = code.match(/["']?orgId["']?\s*[:=]\s*["']([^"']+)["']/i);
                if (orgIdMatch) result.orgId = orgIdMatch[1];
                
                const orgUrlMatch = code.match(/["']?orgUrl["']?\s*[:=]\s*["']([^"']+)["']/i);
                if (orgUrlMatch) result.orgUrl = orgUrlMatch[1];
                
                const widgetIdMatch = code.match(/["']?(?:widgetId|appId)["']?\s*[:=]\s*["']([^"']+)["']/i);
                if (widgetIdMatch) result.widgetId = widgetIdMatch[1];
            }
            
            return result;
        }
        
        // Show modal to copy a personal profile to a room
        function showCopyToRoomModal(profileId) {
            const profile = profiles.find(p => p.id === profileId);
            if (!profile) return;
            
            if (savedRooms.length === 0) {
                showToast('Join or create a room first to copy widgets to it');
                return;
            }
            
            // Create modal if it doesn't exist
            let modal = document.getElementById('copyToRoomModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'copyToRoomModal';
                modal.className = 'save-modal-overlay';
                modal.innerHTML = `
                    <div class="save-modal" style="max-width: 420px;">
                        <!-- Header with icon -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0;">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <img src="https://github.com/microsoft/fluentui-system-icons/raw/main/assets/Breakout%20Room/SVG/ic_fluent_breakout_room_32_regular.svg?raw=true" alt="Room" style="width: 28px; height: 28px; filter: brightness(0) invert(1);">
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #1e293b;">Copy to Room</h3>
                                <p style="margin: 4px 0 0 0; font-size: 13px; color: #64748b;">Share this widget with your team</p>
                            </div>
                        </div>
                        
                        <!-- Profile being copied -->
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 14px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #6366f1; flex-shrink: 0;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            <div>
                                <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">Copying Profile</div>
                                <div id="copyToRoomProfileName" style="font-weight: 600; color: #1e293b;"></div>
                            </div>
                        </div>
                        
                        <!-- Room Selection -->
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label" style="font-weight: 500; color: #374151; margin-bottom: 6px; display: block;">
                                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #6366f1; vertical-align: -2px; margin-right: 4px;"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
                                Destination Room
                            </label>
                            <select class="form-input" id="copyToRoomSelect" style="padding: 12px; font-size: 14px; border-radius: 8px; border: 1px solid #d1d5db; background: white;">
                                <!-- Options will be populated -->
                            </select>
                        </div>
                        
                        <!-- Widget Name -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label" style="font-weight: 500; color: #374151; margin-bottom: 6px; display: block;">
                                <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; fill: #6366f1; vertical-align: -2px; margin-right: 4px;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                Widget Name in Room
                            </label>
                            <input type="text" class="form-input" id="copyToRoomWidgetName" placeholder="Leave empty to use profile name" style="padding: 12px; font-size: 14px; border-radius: 8px; border: 1px solid #d1d5db;">
                        </div>
                        
                        <!-- Status -->
                        <div id="copyToRoomStatus" style="display:none; padding: 12px; border-radius: 8px; margin-bottom: 16px;"></div>
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                            <button onclick="closeCopyToRoomModal()" style="padding: 10px 20px; border-radius: 8px; border: 1px solid #d1d5db; background: white; color: #374151; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s;">
                                Cancel
                            </button>
                            <button id="copyToRoomBtn" style="padding: 10px 24px; border-radius: 8px; border: none; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.15s; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);">
                                <img src="https://github.com/microsoft/fluentui-system-icons/raw/main/assets/Breakout%20Room/SVG/ic_fluent_breakout_room_32_regular.svg?raw=true" alt="" style="width: 18px; height: 18px; filter: brightness(0) invert(1);">
                                Copy to Room
                            </button>
                        </div>
                    </div>
                `;
                modal.onclick = function(e) { if (e.target === modal) closeCopyToRoomModal(); };
                document.body.appendChild(modal);
            }
            
            // Store profile ID in modal
            modal.dataset.profileId = profileId;
            
            // Populate modal
            document.getElementById('copyToRoomProfileName').textContent = profile.name;
            document.getElementById('copyToRoomWidgetName').value = profile.name;
            document.getElementById('copyToRoomStatus').style.display = 'none';
            
            // Populate room dropdown with room names
            const select = document.getElementById('copyToRoomSelect');
            select.innerHTML = savedRooms.map(room => {
                const roomName = room.name || `Room ${room.code}`;
                return `<option value="${room.code}">${roomName} (${room.code}) - ${room.widgets?.length || 0} widgets</option>`;
            }).join('');
            
            // Set up button handler
            document.getElementById('copyToRoomBtn').onclick = function() {
                copyProfileToRoom(modal.dataset.profileId);
            };
            
            modal.classList.add('show');
        }
        
        function closeCopyToRoomModal() {
            const modal = document.getElementById('copyToRoomModal');
            if (modal) modal.classList.remove('show');
        }
        
        // Copy a personal profile to a room
        async function copyProfileToRoom(profileId) {
            const profile = profiles.find(p => p.id === profileId);
            if (!profile) return;
            
            const roomCode = document.getElementById('copyToRoomSelect').value;
            const widgetName = document.getElementById('copyToRoomWidgetName').value.trim() || profile.name;
            const statusEl = document.getElementById('copyToRoomStatus');
            
            try {
                statusEl.style.display = 'block';
                statusEl.style.background = '#eff6ff';
                statusEl.style.color = '#1e40af';
                statusEl.textContent = 'Copying to room...';
                
                const response = await fetch(`${COLLAB_API_URL}/room/${roomCode}/widgets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: widgetName,
                        config: profile.settings,
                        creatorName: collabUserName || cloudUser?.login || 'Anonymous'
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to copy to room');
                }
                
                closeCopyToRoomModal();
                
                // Expand the room and refresh
                expandedRooms[roomCode] = true;
                localStorage.setItem('d365_expanded_rooms', JSON.stringify(expandedRooms));
                
                await refreshRoomWidgets(roomCode);
                
                // Switch to team tab
                switchProfileTab('team');
                
                showToast(` "${widgetName}" copied to room ${roomCode}!`);
                
            } catch (error) {
                console.error('Error copying to room:', error);
                statusEl.style.display = 'block';
                statusEl.style.background = '#fef2f2';
                statusEl.style.color = '#dc2626';
                statusEl.textContent = 'Error: ' + error.message;
            }
        }

        function renameProfile(id) {
            const profile = profiles.find(p => p.id === id);
            if (!profile) return;
            
            const newName = prompt('Enter new name for profile:', profile.name);
            if (!newName || newName.trim() === '' || newName.trim() === profile.name) return;
            
            profile.name = newName.trim();
            profile.updatedAt = new Date().toISOString();
            saveProfiles();
            renderProfiles();
            
            // Sync rename to cloud if logged in
            if (cloudToken && profile.cloudId) {
                saveProfileToCloud(profile);
            } else {
                showToast(`Profile renamed to "${newName.trim()}"`);
            }
        }

        function saveAsProfile() {
            const nameInput = document.getElementById('newProfileName');
            const name = nameInput.value.trim();
            if (!name) {
                showToast('Please enter a profile name');
                return;
            }

            updateSettingsFromForm();
            console.log(' saveAsProfile called for:', name);
            console.log(' cloudToken exists:', !!cloudToken);
            console.log(' Saving new profile with backgroundImageUrl:', settings.backgroundImageUrl);
            
            const profile = {
                id: 'profile_' + Date.now(),
                name: name,
                settings: { ...settings },
                createdAt: new Date().toISOString()
            };

            profiles.push(profile);
            activeProfileId = profile.id;
            
            // Also save to chatWidgetSettings so live.html can load it
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
            
            saveProfiles();
            renderProfiles();
            nameInput.value = '';
            
            // Auto-sync to cloud if logged in
            if (cloudToken) {
                saveProfileToCloud(profile);
            } else {
                showToast(`Profile "${name}" saved locally`);
            }
        }

        function loadProfile(id) {
            console.log(' loadProfile() called with id:', id);
            const profile = profiles.find(p => p.id === id);
            if (!profile) {
                console.log(' Profile not found!');
                return;
            }

            console.log(' Loading profile:', profile.name, 'settings:', {
                backgroundImageUrl: profile.settings.backgroundImageUrl,
                gradientStart: profile.settings.gradientStart,
                primaryColor: profile.settings.primaryColor,
                headerTitle: profile.settings.headerTitle
            });
            
            // Temporarily disable auto-save while loading profile
            const wasInitializing = isInitializing;
            isInitializing = true;
            
            // Merge with defaults, ensuring undefined values are replaced with defaults
            settings = { ...defaultSettings, ...profile.settings };
            // Clean up any undefined values (from old profiles created before field existed)
            Object.keys(settings).forEach(key => {
                if (settings[key] === undefined && defaultSettings[key] !== undefined) {
                    settings[key] = defaultSettings[key];
                }
            });
            activeProfileId = id;
            localStorage.setItem('chatWidgetActiveProfile', id);
            
            // Also save to chatWidgetSettings so live.html can load it
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
            
            populateForm();
            updatePreview();
            updateConnectionStatus();
            renderProfiles();
            
            // Re-enable auto-save after a short delay
            setTimeout(() => {
                isInitializing = wasInitializing;
                console.log(' Profile loaded, auto-save re-enabled');
            }, 100);
            
            showToast(`Loaded "${profile.name}"`);
        }

        function updateProfile(id) {
            const profile = profiles.find(p => p.id === id);
            if (!profile) return;

            if (confirm(`Update "${profile.name}" with current settings?`)) {
                updateSettingsFromForm();
                console.log(' Updating profile:', profile.name, 'backgroundImageUrl:', settings.backgroundImageUrl);
                
                profile.settings = { ...settings };
                profile.updatedAt = new Date().toISOString();
                
                // If this is the active profile, also update chatWidgetSettings
                if (activeProfileId === id) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                }
                
                saveProfiles();
                
                // Auto-sync to cloud if logged in
                if (cloudToken) {
                    saveProfileToCloud(profile);
                } else {
                    showToast(`Profile "${profile.name}" updated!`);
                }
            }
        }

        function deleteProfile(id) {
            const profile = profiles.find(p => p.id === id);
            if (!profile) return;

            showConfirmModal({
                type: 'danger',
                title: 'Delete Profile?',
                message: 'This will permanently delete this widget profile. If synced to the cloud, it will also be removed from your GitHub Gists.',
                itemName: profile.name,
                itemIcon: '<svg viewBox="0 0 24 24" style="fill: #6b7280;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm3-8h-2v3h-2v-3H9V7h2V4h2v3h2v2z"/></svg>',
                actionText: 'Delete Profile',
                onConfirm: function() {
                    // If profile has a cloudId, delete from cloud first
                    if (profile.cloudId && cloudToken && !tokenInvalidated) {
                        deleteProfileFromCloud(profile.cloudId, profile.name);
                    }
                    
                    profiles = profiles.filter(p => p.id !== id);
                    if (activeProfileId === id) {
                        activeProfileId = null;
                        localStorage.removeItem('chatWidgetActiveProfile');
                    }
                    
                    // Save profiles without triggering dirty state (deletion is already synced)
                    const wasInitializing = isInitializing;
                    isInitializing = true; // Prevent markDirty from being called
                    saveProfiles();
                    isInitializing = wasInitializing;
                    
                    renderProfiles();
                    showToast('Profile deleted');
                    
                    // Update status to synced (deletion was pushed to cloud)
                    if (cloudToken && !tokenInvalidated) {
                        updateCloudSyncStatus('synced');
                        isDirty = false;
                    }
                }
            });
        }
        
        // Delete a profile's Gist from the cloud
        async function deleteProfileFromCloud(cloudId, profileName) {
            try {
                console.log(' Deleting gist from cloud:', cloudId);
                const res = await fetch('https://api.github.com/gists/' + cloudId, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'token ' + cloudToken }
                });
                
                if (res.status === 204) {
                    console.log(' Gist deleted successfully');
                    showToast(` "${profileName}" deleted from cloud`);
                } else if (res.status === 404) {
                    // Gist already deleted or doesn't exist - that's fine
                    console.log(' Gist already deleted or not found');
                } else if (res.status === 403) {
                    // Can't delete - belongs to different user or no permission
                    console.log(' Cannot delete gist (403) - may belong to different user');
                } else {
                    console.error(' Failed to delete gist:', res.status);
                }
            } catch (e) {
                console.error(' Error deleting gist:', e);
            }
        }

        // ============ SETTINGS MANAGEMENT ============
        // Helper to sanitize image data that's too large
        function sanitizeImageSettings(settingsObj) {
            ['headerLogo', 'agentAvatar', 'customerAvatar', 'botAvatar'].forEach(key => {
                if (!isSafeImageData(settingsObj[key])) {
                    if (settingsObj[key]) {
                        console.warn(` Clearing invalid or oversized ${key}`);
                    }
                    settingsObj[key] = null;
                }
            });
            return settingsObj;
        }

        function loadSettings() {
            console.log(' loadSettings called - activeProfileId:', activeProfileId);
            // If there's an active profile, load that instead of generic settings
            if (activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    console.log(' Loading profile settings:', {
                        name: profile.name,
                        primaryColor: profile.settings?.primaryColor,
                        gradientStart: profile.settings?.gradientStart,
                        useGradient: profile.settings?.useGradient,
                        backgroundImageUrl: profile.settings?.backgroundImageUrl
                    });
                    settings = sanitizeImageSettings({ ...defaultSettings, ...profile.settings });
                    populateForm();
                    return;
                }
            }
            
            // Otherwise, load generic settings (or reset to defaults if no saved settings)
            const saved = localStorage.getItem('chatWidgetSettings');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Only use saved settings that are NOT profile-specific
                // This prevents cross-contamination between profiles
                settings = sanitizeImageSettings({ ...defaultSettings, ...parsed });
                // Update last saved info if available
                if (parsed.lastSaved) {
                    updateLastSavedInfo(parsed.lastSaved);
                }
            } else {
                // No saved settings - start fresh with defaults
                settings = { ...defaultSettings };
            }
            populateForm();
        }

        function populateForm() {
            // D365 Connection - LCW Code
            const lcwTextarea = document.getElementById('lcwCode');
            console.log(' populateForm - lcwCode in settings:', settings.lcwCode ? `${settings.lcwCode.length} chars` : 'empty');
            if (settings.lcwCode) {
                lcwTextarea.value = settings.lcwCode;
                // Parse and display extracted values
                parseLCWCode(settings.lcwCode);
            } else if (settings.orgId && settings.orgUrl && settings.widgetId) {
                // If we have individual values but no lcwCode, reconstruct for display
                showExtractedValues(settings.widgetId, settings.orgId, settings.orgUrl);
            }

            // Widget Mode
            const widgetMode = settings.widgetMode || 'custom';
            document.getElementById('modeStandard').checked = (widgetMode === 'standard');
            document.getElementById('modeCustom').checked = (widgetMode === 'custom');
            toggleWidgetMode(widgetMode);

            // Standard Widget Authentication
            const enableStandardAuth = settings.enableStandardAuth || false;
            const standardAuthCheckbox = document.getElementById('enableStandardAuth');
            if (standardAuthCheckbox) {
                standardAuthCheckbox.checked = enableStandardAuth;
                document.getElementById('standardAuthName').value = settings.standardAuthName || '';
                document.getElementById('standardAuthEmail').value = settings.standardAuthEmail || '';
                toggleStandardAuthFields(enableStandardAuth);
            }

            // Custom Widget Pre-chat Form Toggle
            const enablePrechatForm = settings.enablePrechatForm !== false; // default true
            const prechatFormCheckbox = document.getElementById('enablePrechatForm');
            if (prechatFormCheckbox) {
                prechatFormCheckbox.checked = enablePrechatForm;
                togglePrechatForm(enablePrechatForm);
            }

            // Custom Widget Contact Authentication (when pre-chat is disabled)
            const enableCustomAuth = settings.enableCustomAuth || false;
            const customAuthCheckbox = document.getElementById('enableCustomAuth');
            if (customAuthCheckbox) {
                customAuthCheckbox.checked = enableCustomAuth;
                document.getElementById('customAuthName').value = settings.customAuthName || '';
                document.getElementById('customAuthEmail').value = settings.customAuthEmail || '';
                toggleCustomAuthFields(enableCustomAuth);
            }

            // Text fields
            const bgImageInput = document.getElementById('backgroundImageUrl');
            bgImageInput.value = settings.backgroundImageUrl || '';
            console.log(' Populating form - backgroundImageUrl:', settings.backgroundImageUrl);
            
            document.getElementById('headerTitle').value = settings.headerTitle;
            document.getElementById('headerSubtitle').value = settings.headerSubtitle;
            
            // Font family
            document.getElementById('fontFamily').value = settings.fontFamily || 'system';
            updateFontPreview(settings.fontFamily || 'system');
            
            // Pre-chat form fields
            document.getElementById('welcomeTitle').value = settings.welcomeTitle || defaultSettings.welcomeTitle;
            document.getElementById('welcomeMessage').value = settings.welcomeMessage || defaultSettings.welcomeMessage;
            document.getElementById('nameFieldLabel').value = settings.nameFieldLabel || defaultSettings.nameFieldLabel;
            document.getElementById('nameFieldPlaceholder').value = settings.nameFieldPlaceholder || defaultSettings.nameFieldPlaceholder;
            document.getElementById('emailFieldLabel').value = settings.emailFieldLabel || defaultSettings.emailFieldLabel;
            document.getElementById('emailFieldPlaceholder').value = settings.emailFieldPlaceholder || defaultSettings.emailFieldPlaceholder;
            document.getElementById('questionFieldLabel').value = settings.questionFieldLabel || defaultSettings.questionFieldLabel;
            document.getElementById('questionFieldPlaceholder').value = settings.questionFieldPlaceholder || defaultSettings.questionFieldPlaceholder;
            document.getElementById('startBtnText').value = settings.startBtnText || defaultSettings.startBtnText;

            // Color pickers - MUST be set BEFORE toggleGradient() which calls updateSettingsFromForm()
            const colorFields = [
                'gradientStart', 'gradientEnd', 'primaryColor',
                'userBubbleColor', 'userTextColor', 'agentBubbleColor', 'agentTextColor',
                'systemMsgColor', 'systemTextColor', 'chatBgColor', 'inputBgColor',
                'inputBorderColor', 'sendBtnColor', 'launcherColor', 'badgeColor',
                'headerTitleColor', 'headerSubtitleColor',
                'prechatGradientStart', 'prechatGradientEnd', 'prechatSolidColor', 'prechatTitleColor', 
                'prechatSubtitleColor', 'prechatBadgeBg', 'prechatBadgeText',
                'prechatStatusDot', 'prechatAvatarBorder'
            ];
            
            colorFields.forEach(field => {
                const picker = document.getElementById(field);
                const hex = document.getElementById(field + 'Hex');
                if (picker && settings[field]) {
                    picker.value = settings[field];
                    if (hex) hex.value = settings[field];
                }
            });

            // Gradient toggle - call AFTER colors are populated
            document.getElementById('useGradient').checked = settings.useGradient;
            document.getElementById('useBubbleGradient').checked = settings.useBubbleGradient !== false;
            document.getElementById('usePrechatGradient').checked = settings.usePrechatGradient !== false;
            toggleGradient();
            togglePrechatGradient();

            // Launcher Icon - restore selection
            if (settings.launcherIcon) {
                const iconButtons = document.querySelectorAll('.launcher-icon-option');
                iconButtons.forEach(btn => {
                    if (btn.getAttribute('data-icon') === settings.launcherIcon) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }

            // Images
            [
                { key: 'headerLogo', areaId: 'logoUploadArea', isAvatar: false },
                { key: 'agentAvatar', areaId: 'agentAvatarArea', isAvatar: true },
                { key: 'customerAvatar', areaId: 'customerAvatarArea', isAvatar: true },
                { key: 'botAvatar', areaId: 'botAvatarArea', isAvatar: true }
            ].forEach(({ key, areaId, isAvatar }) => {
                const area = document.getElementById(areaId);
                if (!area) return;

                if (isSafeImageData(settings[key])) {
                    showUploadedImage(areaId, settings[key], isAvatar);
                    // Also update thumbnail selection for avatar galleries
                    if (isAvatar) {
                        const parentArea = area.parentElement;
                        const thumbnails = parentArea.querySelectorAll('.avatar-thumb');
                        thumbnails.forEach(thumb => {
                            if (thumb.src === settings[key] || settings[key].includes(thumb.src.split('/').pop())) {
                                thumb.classList.add('selected');
                            } else {
                                thumb.classList.remove('selected');
                            }
                        });
                    }
                } else if (area.classList.contains('has-image')) {
                    removeImage({ stopPropagation: () => {} }, areaId);
                }
            });
        }

        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
                    
                    // Auto-switch preview tab based on color tab selection
                    const tabName = btn.dataset.tab;
                    let previewTab = null;
                    if (tabName === 'prechat') {
                        previewTab = 'prechat';
                    } else if (tabName === 'launcher') {
                        previewTab = 'launcher';
                    } else if (tabName === 'messages' || tabName === 'ui') {
                        previewTab = 'chat';
                    } else if (tabName === 'primary') {
                        previewTab = 'prechat';
                    }
                    
                    if (previewTab) {
                        // Update preview tab buttons
                        document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
                        const previewTabBtn = document.querySelector(`.preview-tab[onclick*="'${previewTab}'"]`);
                        if (previewTabBtn) previewTabBtn.classList.add('active');
                        
                        // Update preview content
                        document.querySelectorAll('.preview-content').forEach(content => content.classList.remove('active'));
                        const previewContent = document.getElementById(previewTab + 'Preview');
                        if (previewContent) previewContent.classList.add('active');
                    }
                });
            });

            // Widget Mode selector
            document.querySelectorAll('input[name="widgetMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    toggleWidgetMode(e.target.value);
                    updateSettingsFromForm();
                    // Auto-save to active profile
                    if (!isInitializing && activeProfileId) {
                        const profile = profiles.find(p => p.id === activeProfileId);
                        if (profile) {
                            profile.settings = { ...settings };
                            profile.updatedAt = new Date().toISOString();
                            saveProfiles();
                        }
                    }
                    if (!isInitializing) {
                        localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                    }
                });
            });

            // Gradient toggle
            document.getElementById('useGradient').addEventListener('change', toggleGradient);
            
            // Bubble gradient toggle
            document.getElementById('useBubbleGradient').addEventListener('change', () => {
                updateSettingsFromForm();
                updatePreview();
            });

            // Pre-chat hero gradient toggle
            document.getElementById('usePrechatGradient').addEventListener('change', togglePrechatGradient);

            // Color pickers sync - use debounced handler for performance
            document.querySelectorAll('input[type="color"]').forEach(picker => {
                const hexInput = document.getElementById(picker.id + 'Hex');
                picker.addEventListener('input', () => {
                    if (hexInput) hexInput.value = picker.value;
                    debouncedUpdateSettings();
                });
            });

            // Hex inputs sync - use debounced handler for performance
            document.querySelectorAll('.color-hex-input').forEach(input => {
                const pickerId = input.id.replace('Hex', '');
                const picker = document.getElementById(pickerId);
                input.addEventListener('input', () => {
                    let val = input.value;
                    if (!val.startsWith('#')) val = '#' + val;
                    if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                        picker.value = val;
                        debouncedUpdateSettings();
                    }
                });
            });

            // Font family selector
            document.getElementById('fontFamily').addEventListener('change', (e) => {
                updateFontPreview(e.target.value);
                updateSettingsFromForm();
                updatePreview();
                // Auto-save
                if (!isInitializing && activeProfileId) {
                    const profile = profiles.find(p => p.id === activeProfileId);
                    if (profile) {
                        profile.settings = { ...settings };
                        profile.updatedAt = new Date().toISOString();
                        saveProfiles();
                    }
                }
                if (!isInitializing) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                }
            });

            // Text inputs - real-time preview AND auto-save to active profile (debounced)
            ['backgroundImageUrl', 'headerTitle', 'headerSubtitle', 'welcomeTitle', 'welcomeMessage', 
             'nameFieldLabel', 'emailFieldLabel', 'questionFieldLabel', 'questionFieldPlaceholder', 'startBtnText',
             'standardAuthName', 'standardAuthEmail', 'customAuthName', 'customAuthEmail'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', debouncedUpdateSettings);
                }
            });

            // Standard widget authentication toggle
            document.getElementById('enableStandardAuth').addEventListener('change', (e) => {
                toggleStandardAuthFields(e.target.checked);
                updateSettingsFromForm();
                // Auto-save
                if (!isInitializing && activeProfileId) {
                    const profile = profiles.find(p => p.id === activeProfileId);
                    if (profile) {
                        profile.settings = { ...settings };
                        profile.updatedAt = new Date().toISOString();
                        saveProfiles();
                    }
                }
                if (!isInitializing) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                }
            });

            // Custom widget pre-chat form toggle
            document.getElementById('enablePrechatForm').addEventListener('change', (e) => {
                togglePrechatForm(e.target.checked);
                updateSettingsFromForm();
                updatePreview();
                // Auto-save
                if (!isInitializing && activeProfileId) {
                    const profile = profiles.find(p => p.id === activeProfileId);
                    if (profile) {
                        profile.settings = { ...settings };
                        profile.updatedAt = new Date().toISOString();
                        saveProfiles();
                    }
                }
                if (!isInitializing) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                }
            });

            // Custom widget contact authentication toggle
            document.getElementById('enableCustomAuth').addEventListener('change', (e) => {
                toggleCustomAuthFields(e.target.checked);
                updateSettingsFromForm();
                // Auto-save
                if (!isInitializing && activeProfileId) {
                    const profile = profiles.find(p => p.id === activeProfileId);
                    if (profile) {
                        profile.settings = { ...settings };
                        profile.updatedAt = new Date().toISOString();
                        saveProfiles();
                    }
                }
                if (!isInitializing) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                }
            });

            // LCW Code textarea
            document.getElementById('lcwCode').addEventListener('input', (e) => {
                const code = e.target.value;
                settings.lcwCode = code;
                parseLCWCode(code);
                updateConnectionStatus();
                // Update standard preview if in standard mode
                if (settings.widgetMode === 'standard') {
                    updateStandardPreview();
                }
                // Auto-save to active profile if one is selected
                if (!isInitializing && activeProfileId) {
                    const profile = profiles.find(p => p.id === activeProfileId);
                    if (profile) {
                        profile.settings = { ...settings };
                        profile.updatedAt = new Date().toISOString();
                        saveProfiles();
                        console.log(' Auto-saved LCW script to profile:', activeProfileId);
                    }
                }
                // Auto-save to localStorage so live.html picks up the changes
                if (!isInitializing) {
                    localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                    console.log(' Auto-saved LCW settings to localStorage, lcwCode length:', code.length);
                }
            });

            // File uploads removed - using path input instead for Edge compatibility
        }

        // ============ CONNECTION STATUS ============
        function updateConnectionStatus() {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const { orgId, orgUrl, widgetId } = settings;

            if (orgId && orgUrl && widgetId) {
                dot.className = 'status-dot connected';
                text.textContent = 'Configuration complete - ready to connect';
            } else if (orgId || orgUrl || widgetId) {
                dot.className = 'status-dot error';
                const missing = [];
                if (!orgId) missing.push('Org ID');
                if (!orgUrl) missing.push('Org URL');
                if (!widgetId) missing.push('App ID');
                text.textContent = `Missing: ${missing.join(', ')}`;
            } else {
                dot.className = 'status-dot';
                text.textContent = 'Not configured - widget will run in demo mode';
            }
        }

        // ============ LCW CODE PARSING ============
        function parseLCWCode(code) {
            const extractedContainer = document.getElementById('extractedValues');
            const noProfileHint = document.getElementById('noProfileSelectedHint');
            
            if (!code || !code.trim()) {
                extractedContainer.style.display = 'none';
                if (noProfileHint) noProfileHint.style.display = 'block';
                settings.orgId = '';
                settings.orgUrl = '';
                settings.widgetId = '';
                return;
            }

            // Extract data-app-id (widget ID)
            const appIdMatch = code.match(/data-app-id\s*=\s*["']([^"']+)["']/i);
            const appId = appIdMatch ? appIdMatch[1] : '';

            // Extract data-org-id
            const orgIdMatch = code.match(/data-org-id\s*=\s*["']([^"']+)["']/i);
            const orgId = orgIdMatch ? orgIdMatch[1] : '';

            // Extract data-org-url
            const orgUrlMatch = code.match(/data-org-url\s*=\s*["']([^"']+)["']/i);
            const orgUrl = orgUrlMatch ? orgUrlMatch[1] : '';

            // Update settings
            settings.widgetId = appId;
            settings.orgId = orgId;
            settings.orgUrl = orgUrl;

            // Display extracted values
            if (appId || orgId || orgUrl) {
                showExtractedValues(appId, orgId, orgUrl);
            } else {
                extractedContainer.style.display = 'none';
                if (noProfileHint) noProfileHint.style.display = 'block';
            }
        }

        function showExtractedValues(appId, orgId, orgUrl) {
            const extractedContainer = document.getElementById('extractedValues');
            const noProfileHint = document.getElementById('noProfileSelectedHint');
            document.getElementById('extractedAppId').textContent = appId || '-';
            document.getElementById('extractedOrgId').textContent = orgId || '-';
            document.getElementById('extractedOrgUrl').textContent = orgUrl || '-';
            extractedContainer.style.display = 'block';
            // Hide the hint when values are shown
            if (noProfileHint) noProfileHint.style.display = 'none';
        }

        // ============ COLOR PALETTE GALLERY ============
        const colorPalettes = [
            // Professional & Corporate
            { name: 'Ocean Blue', colors: ['#0077B6', '#00B4D8', '#90E0EF'], gradient: ['#0077B6', '#00B4D8'] },
            { name: 'Purple Haze', colors: ['#667eea', '#764ba2', '#f093fb'], gradient: ['#667eea', '#764ba2'] },
            { name: 'Emerald', colors: ['#059669', '#10B981', '#34D399'], gradient: ['#059669', '#10B981'] },
            { name: 'Sunset', colors: ['#F97316', '#FB923C', '#FDBA74'], gradient: ['#F97316', '#FB923C'] },
            { name: 'Royal', colors: ['#4F46E5', '#6366F1', '#818CF8'], gradient: ['#4F46E5', '#6366F1'] },
            { name: 'Rose', colors: ['#E11D48', '#F43F5E', '#FB7185'], gradient: ['#E11D48', '#F43F5E'] },
            // Modern & Trendy
            { name: 'Midnight', colors: ['#1E293B', '#334155', '#475569'], gradient: ['#1E293B', '#475569'] },
            { name: 'Coral Reef', colors: ['#FF6B6B', '#FFA07A', '#FFD93D'], gradient: ['#FF6B6B', '#FFA07A'] },
            { name: 'Forest', colors: ['#2D5A27', '#4C9141', '#7EC871'], gradient: ['#2D5A27', '#4C9141'] },
            { name: 'Berry', colors: ['#9333EA', '#A855F7', '#C084FC'], gradient: ['#9333EA', '#A855F7'] },
            { name: 'Teal Dream', colors: ['#0D9488', '#14B8A6', '#2DD4BF'], gradient: ['#0D9488', '#14B8A6'] },
            { name: 'Warm Gray', colors: ['#57534E', '#78716C', '#A8A29E'], gradient: ['#57534E', '#78716C'] },
            // Vibrant & Playful
            { name: 'Candy', colors: ['#EC4899', '#F472B6', '#F9A8D4'], gradient: ['#EC4899', '#F472B6'] },
            { name: 'Citrus', colors: ['#F59E0B', '#FBBF24', '#FCD34D'], gradient: ['#F59E0B', '#FBBF24'] },
            { name: 'Sky', colors: ['#0EA5E9', '#38BDF8', '#7DD3FC'], gradient: ['#0EA5E9', '#38BDF8'] },
            { name: 'Lavender', colors: ['#8B5CF6', '#A78BFA', '#C4B5FD'], gradient: ['#8B5CF6', '#A78BFA'] },
            // Dark & Bold
            { name: 'Noir', colors: ['#18181B', '#27272A', '#3F3F46'], gradient: ['#18181B', '#3F3F46'] },
            { name: 'Charcoal', colors: ['#374151', '#4B5563', '#6B7280'], gradient: ['#374151', '#4B5563'] },
            { name: 'Deep Sea', colors: ['#164E63', '#0E7490', '#06B6D4'], gradient: ['#164E63', '#0E7490'] },
            { name: 'Wine', colors: ['#7F1D1D', '#991B1B', '#DC2626'], gradient: ['#7F1D1D', '#991B1B'] },
            // Earthy & Natural
            { name: 'Terracotta', colors: ['#C2410C', '#EA580C', '#F97316'], gradient: ['#C2410C', '#EA580C'] },
            { name: 'Sage', colors: ['#4D7C0F', '#65A30D', '#84CC16'], gradient: ['#4D7C0F', '#65A30D'] },
            { name: 'Sand', colors: ['#92400E', '#B45309', '#D97706'], gradient: ['#92400E', '#B45309'] },
            { name: 'Stone', colors: ['#64748B', '#94A3B8', '#CBD5E1'], gradient: ['#64748B', '#94A3B8'] }
        ];
        
        let showAllPalettes = false;
        
        function renderPaletteGallery() {
            const grid = document.getElementById('paletteGrid');
            const palettesToShow = showAllPalettes ? colorPalettes : colorPalettes.slice(0, 6);
            
            grid.innerHTML = palettesToShow.map((palette, index) => `
                <div class="palette-card" onclick="applyPalette(${index})" title="Click to apply ${palette.name}">
                    <div class="palette-colors">
                        ${palette.colors.map(color => `<div style="background: ${color}"></div>`).join('')}
                    </div>
                    <div class="palette-name">${palette.name}</div>
                </div>
            `).join('');
        }
        
        function togglePaletteGallery() {
            showAllPalettes = !showAllPalettes;
            document.getElementById('paletteExpandBtn').textContent = showAllPalettes ? 'Show Less' : 'Show All';
            renderPaletteGallery();
        }
        
        function applyPalette(index) {
            const palette = colorPalettes[index];
            const [gradientStart, gradientEnd] = palette.gradient;
            const primaryColor = palette.colors[0];
            
            // Apply to gradient colors
            document.getElementById('gradientStart').value = gradientStart;
            document.getElementById('gradientStartHex').value = gradientStart;
            document.getElementById('gradientEnd').value = gradientEnd;
            document.getElementById('gradientEndHex').value = gradientEnd;
            document.getElementById('primaryColor').value = primaryColor;
            document.getElementById('primaryColorHex').value = primaryColor;
            
            // Apply to user bubble colors
            document.getElementById('userBubbleColor').value = primaryColor;
            document.getElementById('userBubbleColorHex').value = primaryColor;
            
            // Apply to send button and launcher
            document.getElementById('sendBtnColor').value = primaryColor;
            document.getElementById('sendBtnColorHex').value = primaryColor;
            document.getElementById('launcherColor').value = primaryColor;
            document.getElementById('launcherColorHex').value = primaryColor;
            
            // Apply to pre-chat hero colors
            document.getElementById('prechatGradientStart').value = gradientStart;
            document.getElementById('prechatGradientStartHex').value = gradientStart;
            document.getElementById('prechatGradientEnd').value = gradientEnd;
            document.getElementById('prechatGradientEndHex').value = gradientEnd;
            document.getElementById('prechatSolidColor').value = primaryColor;
            document.getElementById('prechatSolidColorHex').value = primaryColor;
            
            // Apply to header text colors (white/light for contrast with colored header)
            document.getElementById('headerTitleColor').value = '#ffffff';
            document.getElementById('headerTitleColorHex').value = '#ffffff';
            document.getElementById('headerSubtitleColor').value = '#e0e7ff';
            document.getElementById('headerSubtitleColorHex').value = '#e0e7ff';
            
            // Update settings and preview
            updateSettingsFromForm();
            updatePreview();
            updateLauncherPreview();
            
            // Mark selected palette
            document.querySelectorAll('.palette-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index || (index >= 6 && i === index - 6 * Math.floor(index / 6)));
            });
            
            showToast(`Applied "${palette.name}" palette!`);
        }

        function toggleGradient() {
            const useGradient = document.getElementById('useGradient').checked;
            document.getElementById('gradientColors').classList.toggle('show', useGradient);
            document.getElementById('solidColorPicker').style.display = useGradient ? 'none' : 'grid';
            updateSettingsFromForm();
            updatePreview();
            // Auto-save to active profile and localStorage (but not during initialization)
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            if (!isInitializing) {
                localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
            }
        }

        function togglePrechatGradient() {
            const usePrechatGradient = document.getElementById('usePrechatGradient').checked;
            document.getElementById('prechatGradientColors').classList.toggle('show', usePrechatGradient);
            document.getElementById('prechatSolidColorPicker').style.display = usePrechatGradient ? 'none' : 'grid';
            updateSettingsFromForm();
            updatePreview();
            // Auto-save to active profile and localStorage (but not during initialization)
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            if (!isInitializing) {
                localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
            }
        }

        function toggleWidgetMode(mode) {
            console.log('toggleWidgetMode called with:', mode);
            const customSettings = document.getElementById('customWidgetSettings');
            const standardSettings = document.getElementById('standardWidgetSettings');
            const previewPanel = document.querySelector('.preview-panel');
            const customPreviewTabs = document.getElementById('customPreviewTabs');
            const standardPreviewTabs = document.getElementById('standardPreviewTabs');
            
            console.log('customSettings:', customSettings);
            console.log('standardSettings:', standardSettings);
            
            if (mode === 'standard') {
                customSettings.classList.add('hidden');
                standardSettings.classList.remove('hidden');
                // Show standard preview tabs and content
                if (customPreviewTabs) customPreviewTabs.classList.add('hidden');
                if (standardPreviewTabs) standardPreviewTabs.classList.remove('hidden');
                // Switch to standard preview
                switchPreviewTab('standard');
                // Load the LCW preview
                updateStandardPreview();
            } else {
                customSettings.classList.remove('hidden');
                standardSettings.classList.add('hidden');
                // Show custom preview tabs and content
                if (customPreviewTabs) customPreviewTabs.classList.remove('hidden');
                if (standardPreviewTabs) standardPreviewTabs.classList.add('hidden');
                // Switch to prechat preview
                switchPreviewTab('prechat');
            }
            
            console.log('After toggle - customSettings.classList:', customSettings.classList.toString());
            console.log('After toggle - standardSettings.classList:', standardSettings.classList.toString());
            
            settings.widgetMode = mode;
            console.log('Widget mode changed to:', mode);
        }
        
        function updateStandardPreview() {
            const lcwCode = document.getElementById('lcwCode').value.trim();
            const placeholder = document.getElementById('standardPreviewPlaceholder');
            const iframe = document.getElementById('standardPreviewIframe');
            const footer = document.getElementById('standardPreviewFooter');
            
            if (!lcwCode) {
                // Show placeholder if no LCW code
                placeholder.style.display = 'flex';
                iframe.style.display = 'none';
                if (footer) footer.style.display = 'none';
                return;
            }
            
            // Hide placeholder, show iframe and footer
            placeholder.style.display = 'none';
            iframe.style.display = 'block';
            if (footer) footer.style.display = 'block';
            
            // Create HTML document with the LCW code - simple clean background
            const htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{margin:0;padding:0}html,body{height:100%;background:#e2e8f0;}</style></head><body>${lcwCode}</body></html>`;
            
            // Write to iframe
            iframe.srcdoc = htmlContent;
        }
        
        function refreshStandardPreview() {
            updateStandardPreview();
            showToast('Preview refreshed');
        }

        function updateFontPreview(fontFamily) {
            const previewText = document.getElementById('fontPreviewText');
            const widgetPreview = document.querySelector('.widget-preview');
            
            const fontMap = {
                // System
                'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                // Sans-Serif
                'inter': '"Inter", sans-serif',
                'roboto': '"Roboto", sans-serif',
                'opensans': '"Open Sans", sans-serif',
                'lato': '"Lato", sans-serif',
                'poppins': '"Poppins", sans-serif',
                'montserrat': '"Montserrat", sans-serif',
                'nunito': '"Nunito", sans-serif',
                'sourcesans': '"Source Sans Pro", sans-serif',
                'raleway': '"Raleway", sans-serif',
                'ubuntu': '"Ubuntu", sans-serif',
                'rubik': '"Rubik", sans-serif',
                'worksans': '"Work Sans", sans-serif',
                'firasans': '"Fira Sans", sans-serif',
                'dmsans': '"DM Sans", sans-serif',
                'manrope': '"Manrope", sans-serif',
                'plusjakarta': '"Plus Jakarta Sans", sans-serif',
                'outfit': '"Outfit", sans-serif',
                'lexend': '"Lexend", sans-serif',
                // Serif
                'playfair': '"Playfair Display", serif',
                'merriweather': '"Merriweather", serif',
                'lora': '"Lora", serif',
                'crimson': '"Crimson Text", serif',
                'libre': '"Libre Baskerville", serif',
                // Monospace
                'jetbrains': '"JetBrains Mono", monospace',
                'firacode': '"Fira Code", monospace',
                'sourcecodepro': '"Source Code Pro", monospace',
                // Display
                'quicksand': '"Quicksand", sans-serif',
                'comfortaa': '"Comfortaa", cursive',
                'righteous': '"Righteous", cursive'
            };
            
            const fontStack = fontMap[fontFamily] || fontMap['system'];
            
            if (previewText) {
                previewText.style.fontFamily = fontStack;
            }
            if (widgetPreview) {
                widgetPreview.style.fontFamily = fontStack;
            }
        }

        function showUploadedImage(areaId, src, isAvatar) {
            const area = document.getElementById(areaId);
            if (!area) return;
            
            area.classList.add('has-image');
            
            // Show path info below the image (fixed 2-line height for alignment)
            const pathInfo = `<div class="path-info">${src}</div>`;
            
            area.innerHTML = `
                <div class="uploaded-image-preview ${isAvatar ? 'avatar' : ''}">
                    <img src="${src}" alt="Uploaded" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                    <div class="image-error" style="display:none;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#999;">
                        <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:currentColor;"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                        <span style="font-size:10px;margin-top:4px;">Image not found</span>
                    </div>
                    <div class="image-overlay">
                        <button type="button" class="remove-image-btn">Remove</button>
                    </div>
                </div>
                ${pathInfo}
            `;
            
            area.querySelector('.remove-image-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                removeImage(e, areaId);
            });
        }

        function removeImage(event, areaId) {
            event.stopPropagation();
            const area = document.getElementById(areaId);
            area.classList.remove('has-image');
            
            let settingKey, iconSvg, text;
            if (areaId === 'logoUploadArea') {
                settingKey = 'headerLogo';
                iconSvg = '<svg viewBox="0 0 24 24"><path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"/></svg>';
                text = 'Enter image path below';
            } else if (areaId === 'agentAvatarArea') {
                settingKey = 'agentAvatar';
                iconSvg = '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                text = 'Enter image path below';
            } else {
                settingKey = 'customerAvatar';
                iconSvg = '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                text = 'Enter image path below';
            }

            settings[settingKey] = null;
            area.innerHTML = `
                <div class="upload-icon">${iconSvg}</div>
                <div class="upload-text">${text}</div>
                <div class="upload-hint">Place images in the img/ folder</div>
            `;
            updatePreview();
            
            // Save the change
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
        }

        // Select avatar from thumbnail gallery
        function selectAvatar(settingKey, areaId, imagePath, isAvatar) {
            // Store the path
            settings[settingKey] = imagePath;
            console.log('Avatar selected:', settingKey, '=', imagePath);
            
            // Show preview
            showUploadedImage(areaId, imagePath, isAvatar);
            updatePreview();
            
            // Update thumbnail selection visual
            const parentArea = document.getElementById(areaId).parentElement;
            const thumbnails = parentArea.querySelectorAll('.avatar-thumb');
            thumbnails.forEach(thumb => {
                if (thumb.src.includes(imagePath)) {
                    thumb.classList.add('selected');
                } else {
                    thumb.classList.remove('selected');
                }
            });
            
            // Save settings
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
        }

        // Select launcher icon
        function selectLauncherIcon(iconType) {
            // Update settings
            settings.launcherIcon = iconType;
            
            // Update visual selection
            const iconButtons = document.querySelectorAll('.launcher-icon-option');
            iconButtons.forEach(btn => {
                if (btn.getAttribute('data-icon') === iconType) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            // Update launcher preview
            updateLauncherPreview();
            
            // Save settings
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
        }

        // Update launcher preview
        function updateLauncherPreview() {
            const launcherBtn = document.getElementById('previewLauncherBtn');
            const iconSvg = document.getElementById('previewLauncherIcon');
            
            if (!launcherBtn || !iconSvg) return;
            
            // Update color
            launcherBtn.style.background = settings.launcherColor || '#667eea';
            
            // Update icon based on selected type (Fluent 2)
            const iconPaths = {
                chat_multiple: 'M9.56158 3C5.41944 3 2.06158 6.35786 2.06158 10.5C2.06158 11.6329 2.31325 12.7088 2.76423 13.6734C2.5102 14.6714 2.22638 15.7842 2.03999 16.5147C1.80697 17.428 2.6294 18.2588 3.54374 18.039C4.29396 17.8587 5.44699 17.5819 6.47447 17.337C7.41678 17.7631 8.46241 18 9.56158 18C13.7037 18 17.0616 14.6421 17.0616 10.5C17.0616 6.35786 13.7037 3 9.56158 3ZM3.56158 10.5C3.56158 7.18629 6.24787 4.5 9.56158 4.5C12.8753 4.5 15.5616 7.18629 15.5616 10.5C15.5616 13.8137 12.8753 16.5 9.56158 16.5C8.60084 16.5 7.69487 16.2748 6.89161 15.8749L6.6482 15.7537L6.38368 15.8167C5.46095 16.0363 4.39489 16.2919 3.59592 16.4838C3.79467 15.7047 4.05784 14.6724 4.28601 13.7757L4.35619 13.4998L4.22568 13.2468C3.80145 12.4246 3.56158 11.4914 3.56158 10.5ZM14.5616 21.0001C12.5922 21.0001 10.8001 20.241 9.46191 18.9995C9.49511 18.9999 9.52835 19.0001 9.56163 19.0001C10.2796 19.0001 10.9768 18.911 11.6427 18.7434C12.5067 19.2254 13.5021 19.5001 14.5616 19.5001C15.5223 19.5001 16.4283 19.2748 17.2316 18.8749L17.475 18.7537L17.7395 18.8167C18.6611 19.0361 19.7046 19.2625 20.4787 19.4262C20.3037 18.6757 20.065 17.6711 19.8372 16.7757L19.767 16.4999L19.8975 16.2469C20.3217 15.4247 20.5616 14.4915 20.5616 13.5001C20.5616 11.3853 19.4676 9.52617 17.8146 8.45761C17.6363 7.73435 17.3653 7.04756 17.015 6.41052C19.9523 7.42684 22.0616 10.2171 22.0616 13.5001C22.0616 14.6332 21.8098 15.7094 21.3586 16.6741C21.6117 17.6821 21.8679 18.774 22.0304 19.4773C22.2348 20.3623 21.4554 21.1633 20.563 20.9768C19.8358 20.8248 18.6933 20.581 17.6495 20.3367C16.707 20.763 15.6611 21.0001 14.5616 21.0001Z',
                chat_multiple_checkmark: 'M13.0606 8.99827C13.3357 8.68869 13.3079 8.21463 12.9983 7.93944C12.6887 7.66425 12.2146 7.69214 11.9394 8.00173L8.44187 11.9365L7.0029 10.6359C6.69561 10.3582 6.22134 10.3821 5.94359 10.6894C5.66585 10.9967 5.6898 11.471 5.9971 11.7487L7.9971 13.5564C8.14546 13.6905 8.34124 13.7598 8.54094 13.7489C8.74063 13.738 8.92769 13.6477 9.06056 13.4983L13.0606 8.99827ZM2.06158 10.5C2.06158 6.35786 5.41944 3 9.56158 3C13.7037 3 17.0616 6.35786 17.0616 10.5C17.0616 14.6421 13.7037 18 9.56158 18C8.46241 18 7.41678 17.7631 6.47447 17.337C5.44699 17.5819 4.29396 17.8587 3.54374 18.039C2.6294 18.2588 1.80697 17.428 2.03999 16.5147C2.22638 15.7842 2.5102 14.6714 2.76423 13.6734C2.31325 12.7088 2.06158 11.6329 2.06158 10.5ZM9.56158 4.5C6.24787 4.5 3.56158 7.18629 3.56158 10.5C3.56158 11.4914 3.80145 12.4246 4.22568 13.2468L4.35619 13.4998L4.28601 13.7757C4.05784 14.6724 3.79467 15.7047 3.59592 16.4838C4.39489 16.2919 5.46095 16.0363 6.38368 15.8167L6.6482 15.7537L6.89161 15.8749C7.69487 16.2748 8.60084 16.5 9.56158 16.5C12.8753 16.5 15.5616 13.8137 15.5616 10.5C15.5616 7.18629 12.8753 4.5 9.56158 4.5ZM9.46191 18.9995C10.8001 20.241 12.5922 21.0001 14.5616 21.0001C15.6611 21.0001 16.707 20.763 17.6495 20.3367C18.6933 20.581 19.8358 20.8248 20.563 20.9768C21.4554 21.1633 22.2348 20.3623 22.0304 19.4773C21.8679 18.774 21.6117 17.6821 21.3586 16.6741C21.8098 15.7094 22.0616 14.6332 22.0616 13.5001C22.0616 10.2171 19.9523 7.42684 17.015 6.41052C17.3653 7.04756 17.6363 7.73435 17.8146 8.45761C19.4676 9.52617 20.5616 11.3853 20.5616 13.5001C20.5616 14.4915 20.3217 15.4247 19.8975 16.2469L19.767 16.4999L19.8372 16.7757C20.065 17.6711 20.3037 18.6757 20.4787 19.4262C19.7046 19.2625 18.6611 19.0361 17.7395 18.8167L17.475 18.7537L17.2316 18.8749C16.4283 19.2748 15.5223 19.5001 14.5616 19.5001C13.5021 19.5001 12.5067 19.2254 11.6427 18.7434C10.9768 18.911 10.2796 19.0001 9.56163 19.0001C9.52835 19.0001 9.49511 18.9999 9.46191 18.9995Z',
                chat_sparkle: 'M16.0883 6.41228C16.016 6.31886 15.9377 6.2298 15.8539 6.14569C15.5417 5.83255 15.1606 5.59666 14.741 5.45683L13.3632 5.00939C13.257 4.97196 13.165 4.90253 13.1 4.81068C13.0349 4.71883 13 4.60908 13 4.49656C13 4.38404 13.0349 4.27429 13.1 4.18244C13.165 4.09058 13.257 4.02116 13.3632 3.98372L14.741 3.53628C15.1547 3.39352 15.5299 3.15705 15.837 2.84537C16.1357 2.54224 16.3623 2.17595 16.5 1.77372L16.5114 1.73963L16.9592 0.362894C16.9967 0.256782 17.0662 0.164895 17.1581 0.0998993C17.25 0.0349035 17.3598 0 17.4724 0C17.5851 0 17.6949 0.0349035 17.7868 0.0998993C17.8787 0.164895 17.9482 0.256782 17.9857 0.362894L18.4335 1.73963C18.5727 2.15819 18.8077 2.53853 19.1198 2.85041C19.432 3.1623 19.8126 3.39715 20.2315 3.53628L21.6093 3.98372L21.6368 3.99061C21.743 4.02804 21.835 4.09747 21.9 4.18932C21.9651 4.28117 22 4.39092 22 4.50344C22 4.61596 21.9651 4.72571 21.9 4.81756C21.835 4.90942 21.743 4.97884 21.6368 5.01628L20.259 5.46372C19.8402 5.60285 19.4595 5.8377 19.1474 6.14959C18.8353 6.46147 18.6003 6.84181 18.461 7.26037L18.0132 8.63711C18.0092 8.64855 18.0048 8.65983 18 8.67093C17.9605 8.76273 17.8964 8.84212 17.8144 8.9001C17.7224 8.9651 17.6126 9 17.5 9C17.3874 9 17.2776 8.9651 17.1856 8.9001C17.0937 8.8351 17.0242 8.74322 16.9868 8.63711L16.539 7.26037C16.4378 6.95331 16.2851 6.66664 16.0883 6.41228ZM23.7829 10.2132L23.0175 9.9646C22.7848 9.8873 22.5733 9.75683 22.3999 9.58356C22.2265 9.41029 22.0959 9.199 22.0186 8.96646L21.7698 8.20161C21.749 8.14266 21.7104 8.09161 21.6593 8.0555C21.6083 8.01939 21.5473 8 21.4847 8C21.4221 8 21.3611 8.01939 21.31 8.0555C21.259 8.09161 21.2204 8.14266 21.1996 8.20161L20.9508 8.96646C20.875 9.19736 20.7467 9.40761 20.5761 9.58076C20.4055 9.75392 20.1971 9.88529 19.9672 9.9646L19.2018 10.2132C19.1428 10.234 19.0917 10.2725 19.0555 10.3236C19.0194 10.3746 19 10.4356 19 10.4981C19 10.5606 19.0194 10.6216 19.0555 10.6726C19.0917 10.7236 19.1428 10.7622 19.2018 10.783L19.9672 11.0316C20.2003 11.1093 20.412 11.2403 20.5855 11.4143C20.7589 11.5882 20.8893 11.8003 20.9661 12.0335L21.2149 12.7984C21.2357 12.8573 21.2743 12.9084 21.3254 12.9445C21.3764 12.9806 21.4374 13 21.5 13C21.5626 13 21.6236 12.9806 21.6746 12.9445C21.7257 12.9084 21.7643 12.8573 21.7851 12.7984L22.0339 12.0335C22.1113 11.801 22.2418 11.5897 22.4152 11.4164C22.5886 11.2432 22.8001 11.1127 23.0328 11.0354L23.7982 10.7868C23.8572 10.766 23.9083 10.7275 23.9445 10.6764C23.9806 10.6254 24 10.5644 24 10.5019C24 10.4394 23.9806 10.3784 23.9445 10.3274C23.9083 10.2764 23.8572 10.2378 23.7982 10.217L23.7829 10.2132ZM12 2C12.957 2 13.8826 2.13443 14.7589 2.38542C14.6435 2.45713 14.5197 2.51549 14.39 2.55903L13.05 2.99903C12.7677 3.09976 12.5186 3.27531 12.329 3.50625C12.2199 3.5021 12.1102 3.5 12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.1949 20.5 19.68 17.4613 20.3742 13.465C20.4642 13.5981 20.5776 13.7148 20.71 13.809C20.9288 13.9654 21.191 14.0495 21.46 14.0495C21.5752 14.0495 21.6892 14.034 21.7991 14.0041C20.871 18.5665 16.8365 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2Z',
                chat_multiple_heart: 'M6.3412 8.3412C7.1326 7.5498 8.41849 7.55366 9.21333 8.3485L9.49671 8.63188L9.77626 8.35179C10.5691 7.55898 11.8556 7.56284 12.6518 8.3591C13.4468 9.15408 13.4493 10.4364 12.6597 11.2303L9.73275 14.1556C9.6107 14.2777 9.41283 14.2777 9.29079 14.1556L6.3485 11.2133C5.55366 10.4185 5.5498 9.1326 6.3412 8.3412ZM2.06158 10.5C2.06158 6.35786 5.41944 3 9.56158 3C13.7037 3 17.0616 6.35786 17.0616 10.5C17.0616 14.6421 13.7037 18 9.56158 18C8.46241 18 7.41678 17.7631 6.47447 17.337C5.44699 17.5819 4.29396 17.8587 3.54374 18.039C2.6294 18.2588 1.80697 17.428 2.03999 16.5147C2.22638 15.7842 2.5102 14.6714 2.76423 13.6734C2.31325 12.7088 2.06158 11.6329 2.06158 10.5ZM9.56158 4.5C6.24787 4.5 3.56158 7.18629 3.56158 10.5C3.56158 11.4914 3.80145 12.4246 4.22568 13.2468L4.35619 13.4998L4.28601 13.7757C4.05784 14.6724 3.79467 15.7047 3.59592 16.4838C4.39489 16.2919 5.46095 16.0363 6.38368 15.8167L6.6482 15.7537L6.89161 15.8749C7.69487 16.2748 8.60084 16.5 9.56158 16.5C12.8753 16.5 15.5616 13.8137 15.5616 10.5C15.5616 7.18629 12.8753 4.5 9.56158 4.5ZM9.46191 18.9995C10.8001 20.241 12.5922 21.0001 14.5616 21.0001C15.6611 21.0001 16.707 20.763 17.6495 20.3367C18.6933 20.581 19.8358 20.8248 20.563 20.9768C21.4554 21.1633 22.2348 20.3623 22.0304 19.4773C21.8679 18.774 21.6117 17.6821 21.3586 16.6741C21.8098 15.7094 22.0616 14.6332 22.0616 13.5001C22.0616 10.2171 19.9523 7.42684 17.015 6.41052C17.3653 7.04756 17.6363 7.73435 17.8146 8.45761C19.4676 9.52617 20.5616 11.3853 20.5616 13.5001C20.5616 14.4915 20.3217 15.4247 19.8975 16.2469L19.767 16.4999L19.8372 16.7757C20.065 17.6711 20.3037 18.6757 20.4787 19.4262C19.7046 19.2625 18.6611 19.0361 17.7395 18.8167L17.475 18.7537L17.2316 18.8749C16.4283 19.2748 15.5223 19.5001 14.5616 19.5001C13.5021 19.5001 12.5067 19.2254 11.6427 18.7434C10.9768 18.911 10.2796 19.0001 9.56163 19.0001C9.52835 19.0001 9.49511 18.9999 9.46191 18.9995Z',
                chat_help: 'M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.6944 20.5 20.5 16.6944 20.5 12C20.5 7.30558 16.6944 3.5 12 3.5ZM12 15.5C12.5523 15.5 13 15.9477 13 16.5C13 17.0523 12.5523 17.5 12 17.5C11.4477 17.5 11 17.0523 11 16.5C11 15.9477 11.4477 15.5 12 15.5ZM12 6.75C13.5188 6.75 14.75 7.98122 14.75 9.5C14.75 10.5108 14.4525 11.074 13.6989 11.8586L13.5303 12.0303C12.9084 12.6522 12.75 12.9163 12.75 13.5C12.75 13.9142 12.4142 14.25 12 14.25C11.5858 14.25 11.25 13.9142 11.25 13.5C11.25 12.4892 11.5475 11.926 12.3011 11.1414L12.4697 10.9697C13.0916 10.3478 13.25 10.0837 13.25 9.5C13.25 8.80964 12.6904 8.25 12 8.25C11.3528 8.25 10.8205 8.74187 10.7565 9.37219L10.75 9.5C10.75 9.91421 10.4142 10.25 10 10.25C9.58579 10.25 9.25 9.91421 9.25 9.5C9.25 7.98122 10.4812 6.75 12 6.75Z',
                chat_empty: 'M5.25 18C3.45507 18 2 16.5449 2 14.75V6.25C2 4.45507 3.45507 3 5.25 3H18.75C20.5449 3 22 4.45507 22 6.25V14.75C22 16.5449 20.5449 18 18.75 18H13.0125L7.99868 21.7507C7.44585 22.1642 6.6625 22.0512 6.24901 21.4984C6.08736 21.2822 6 21.0196 6 20.7499L5.99921 18H5.25ZM12.5135 16.5H18.75C19.7165 16.5 20.5 15.7165 20.5 14.75V6.25C20.5 5.2835 19.7165 4.5 18.75 4.5H5.25C4.2835 4.5 3.5 5.2835 3.5 6.25V14.75C3.5 15.7165 4.2835 16.5 5.25 16.5H7.49879L7.499 17.2498L7.49986 20.2506L12.5135 16.5Z',
                chat_bubbles_question: 'M8.14303 6.30723C8.57707 6.07535 9.04414 6.00076 9.49888 6.00073C10.0253 6.0007 10.6367 6.17363 11.1305 6.57829C11.6475 7.00192 11.9989 7.65186 11.9989 8.5C11.9989 9.47459 11.3102 10.0037 10.9219 10.302C10.8918 10.3252 10.8634 10.347 10.8373 10.3675C10.4127 10.7012 10.2489 10.8795 10.2489 11.25C10.2489 11.6642 9.91314 12 9.49892 12C9.08471 12 8.74892 11.6642 8.74892 11.25C8.74892 10.116 9.46017 9.54195 9.91052 9.18806C10.4238 8.78469 10.4989 8.69484 10.4989 8.5C10.4989 8.10296 10.3503 7.87825 10.1798 7.73853C9.98616 7.57985 9.72254 7.50072 9.49896 7.50073C9.20371 7.50075 9.00078 7.54962 8.84982 7.63027C8.70637 7.7069 8.55459 7.84146 8.40826 8.11137C8.21083 8.47551 7.7556 8.61066 7.39146 8.41324C7.02732 8.21582 6.89217 7.76058 7.08959 7.39644C7.35326 6.91012 7.70147 6.54311 8.14303 6.30723ZM9.49909 15.0001C10.0514 15.0001 10.4992 14.5524 10.4992 14.0001C10.4992 13.4477 10.0514 13 9.49909 13C8.94677 13 8.49902 13.4477 8.49902 14.0001C8.49902 14.5524 8.94677 15.0001 9.49909 15.0001ZM9.49908 3C5.35694 3 1.99908 6.35786 1.99908 10.5C1.99908 11.6329 2.25075 12.7088 2.70173 13.6734C2.4477 14.6714 2.16388 15.7842 1.97749 16.5147C1.74447 17.428 2.5669 18.2588 3.48124 18.039C4.23146 17.8587 5.38449 17.5819 6.41197 17.337C7.35428 17.7631 8.39991 18 9.49908 18C13.6412 18 16.9991 14.6421 16.9991 10.5C16.9991 6.35786 13.6412 3 9.49908 3ZM3.49908 10.5C3.49908 7.18629 6.18537 4.5 9.49908 4.5C12.8128 4.5 15.4991 7.18629 15.4991 10.5C15.4991 13.8137 12.8128 16.5 9.49908 16.5C8.53834 16.5 7.63237 16.2748 6.82911 15.8749L6.5857 15.7537L6.32118 15.8167C5.39845 16.0363 4.33239 16.2919 3.53342 16.4838C3.73217 15.7047 3.99534 14.6724 4.22351 13.7757L4.29369 13.4998L4.16318 13.2468C3.73895 12.4246 3.49908 11.4914 3.49908 10.5ZM14.4991 21.0001C12.5297 21.0001 10.7376 20.241 9.39941 18.9995C9.43261 18.9999 9.46585 19.0001 9.49913 19.0001C10.2171 19.0001 10.9143 18.911 11.5802 18.7434C12.4442 19.2254 13.4396 19.5001 14.4991 19.5001C15.4598 19.5001 16.3658 19.2748 17.1691 18.8749L17.4125 18.7537L17.677 18.8167C18.5986 19.0361 19.6421 19.2625 20.4162 19.4262C20.2412 18.6757 20.0025 17.6711 19.7747 16.7757L19.7045 16.4999L19.835 16.2469C20.2592 15.4247 20.4991 14.4915 20.4991 13.5001C20.4991 11.3853 19.4051 9.52617 17.7521 8.45761C17.5738 7.73435 17.3028 7.04756 16.9525 6.41052C19.8898 7.42684 21.9991 10.2171 21.9991 13.5001C21.9991 14.6332 21.7473 15.7094 21.2961 16.6741C21.5492 17.6821 21.8054 18.774 21.9679 19.4773C22.1723 20.3623 21.3929 21.1633 20.5005 20.9768C19.7733 20.8248 18.6308 20.581 17.587 20.3367C16.6445 20.763 15.5986 21.0001 14.4991 21.0001Z',
                chat: 'M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.6944 20.5 20.5 16.6944 20.5 12C20.5 7.30558 16.6944 3.5 12 3.5Z',
                bot: 'M17.7534 13.9994C18.9961 13.9994 20.0034 15.0068 20.0034 16.2494V17.1545C20.0034 18.2482 19.526 19.2874 18.6961 19.9998C17.1307 21.3437 14.8904 22.0006 12.0004 22.0006C9.11087 22.0006 6.87205 21.344 5.30918 20.0003C4.48056 19.2879 4.00391 18.2495 4.00391 17.1567V16.2494C4.00391 15.0068 5.01127 13.9994 6.25391 13.9994H17.7534ZM17.7534 15.4994H6.25391C5.83969 15.4994 5.50391 15.8352 5.50391 16.2494V17.1567C5.50391 17.8124 5.7899 18.4354 6.28707 18.8629C7.54516 19.9445 9.44117 20.5006 12.0004 20.5006C14.5603 20.5006 16.4582 19.9442 17.7191 18.8617C18.2169 18.4342 18.5034 17.8107 18.5034 17.1545V16.2494C18.5034 15.8352 18.1676 15.4994 17.7534 15.4994ZM11.8989 2.00685L12.0007 2C12.3804 2 12.6942 2.28215 12.7438 2.64823L12.7507 2.75L12.7499 3.499L16.2504 3.49951C17.493 3.49951 18.5004 4.50687 18.5004 5.74951V10.2541C18.5004 11.4967 17.493 12.5041 16.2504 12.5041H7.75036C6.50772 12.5041 5.50036 11.4967 5.50036 10.2541V5.74951C5.50036 4.50687 6.50772 3.49951 7.75036 3.49951L11.2499 3.499L11.2507 2.75C11.2507 2.3703 11.5328 2.05651 11.8989 2.00685L12.0007 2L11.8989 2.00685ZM16.2504 4.99951H7.75036C7.33615 4.99951 7.00036 5.33529 7.00036 5.74951V10.2541C7.00036 10.6683 7.33615 11.0041 7.75036 11.0041H16.2504C16.6646 11.0041 17.0004 10.6683 17.0004 10.2541V5.74951C17.0004 5.33529 16.6646 4.99951 16.2504 4.99951ZM9.74965 6.49951C10.4396 6.49951 10.9989 7.05883 10.9989 7.74879C10.9989 8.43876 10.4396 8.99808 9.74965 8.99808C9.05969 8.99808 8.50036 8.43876 8.50036 7.74879C8.50036 7.05883 9.05969 6.49951 9.74965 6.49951ZM14.2424 6.49951C14.9324 6.49951 15.4917 7.05883 15.4917 7.74879C15.4917 8.43876 14.9324 8.99808 14.2424 8.99808C13.5524 8.99808 12.9931 8.43876 12.9931 7.74879C12.9931 7.05883 13.5524 6.49951 14.2424 6.49951Z',
                bot_sparkle: 'M18.5004 10.2546C18.5004 10.2994 18.4991 10.3438 18.4965 10.3879C18.4546 10.3508 18.4105 10.3159 18.3645 10.2834C18.1037 10.099 17.7921 10 17.4728 10C17.3115 10 17.1522 10.0253 17.0004 10.074V5.74999C17.0004 5.33578 16.6646 4.99999 16.2504 4.99999H7.75036C7.33615 4.99999 7.00036 5.33578 7.00036 5.74999V10.2546C7.00036 10.6688 7.33615 11.0046 7.75036 11.0046H16.0258L16.0166 11.03L16.0125 11.0417L15.5622 12.426L15.5534 12.4524C15.5474 12.4699 15.5411 12.4873 15.5345 12.5046H7.75036C6.50772 12.5046 5.50036 11.4972 5.50036 10.2546V5.74999C5.50036 4.50735 6.50772 3.49999 7.75036 3.49999L11.2499 3.49949L11.2507 2.75049C11.2507 2.37079 11.5328 2.057 11.8989 2.00733L12.0007 2.00049C12.3804 2.00049 12.6942 2.28264 12.7438 2.64872L12.7507 2.75049L12.7499 3.49949L16.2504 3.49999C17.493 3.49999 18.5004 4.50735 18.5004 5.74999V10.2546ZM13.0428 14.0365L13.1554 13.9999H6.25391C5.01127 13.9999 4.00391 15.0073 4.00391 16.2499V17.1572C4.00391 18.25 4.48056 19.2884 5.30918 20.0008C6.87205 21.3445 9.11087 22.0011 12.0004 22.0011C14.0763 22.0011 15.8171 21.6621 17.2132 20.9731C16.9968 20.9321 16.7904 20.8451 16.6087 20.7166C16.3478 20.5322 16.1506 20.2714 16.0442 19.97L16.04 19.9583L16.0096 19.8646C14.9245 20.2865 13.5901 20.5011 12.0004 20.5011C9.44117 20.5011 7.54516 19.945 6.28707 18.8634C5.7899 18.4359 5.50391 17.8129 5.50391 17.1572V16.2499C5.50391 15.8357 5.83969 15.4999 6.25391 15.4999H12.0004L12.0004 15.4966C12.0004 15.1769 12.0996 14.8653 12.2843 14.6045C12.4689 14.3438 12.7299 14.1468 13.0311 14.0406L13.0428 14.0365ZM10.9989 7.74928C10.9989 7.05932 10.4396 6.49999 9.74965 6.49999C9.05969 6.49999 8.50036 7.05932 8.50036 7.74928C8.50036 8.43925 9.05969 8.99857 9.74965 8.99857C10.4396 8.99857 10.9989 8.43925 10.9989 7.74928ZM14.2424 6.49999C14.9324 6.49999 15.4917 7.05932 15.4917 7.74928C15.4917 8.43925 14.9324 8.99857 14.2424 8.99857C13.5524 8.99857 12.9931 8.43925 12.9931 7.74928C12.9931 7.05932 13.5524 6.49999 14.2424 6.49999ZM16.0886 17.4123C16.0163 17.3189 15.9381 17.2298 15.8542 17.1457C15.5421 16.8326 15.161 16.5967 14.7413 16.4568L13.3635 16.0094C13.2573 15.972 13.1654 15.9025 13.1003 15.8107C13.0353 15.7188 13.0004 15.6091 13.0004 15.4966C13.0004 15.384 13.0353 15.2743 13.1003 15.1824C13.1654 15.0906 13.2573 15.0212 13.3635 14.9837L14.7413 14.5363C15.1551 14.3935 15.5302 14.1571 15.8374 13.8454C16.1361 13.5422 16.3626 13.1759 16.5004 12.7737L16.5118 12.7396L16.9596 11.3629C16.997 11.2568 17.0665 11.1649 17.1584 11.0999C17.2504 11.0349 17.3602 11 17.4728 11C17.5854 11 17.6953 11.0349 17.7872 11.0999C17.8791 11.1649 17.9486 11.2568 17.986 11.3629L18.4338 12.7396C18.5731 13.1582 18.8081 13.5385 19.1202 13.8504C19.4323 14.1623 19.813 14.3971 20.2318 14.5363L21.6096 14.9837L21.6372 14.9906C21.7434 15.028 21.8353 15.0975 21.9004 15.1893C21.9654 15.2812 22.0004 15.3909 22.0004 15.5034C22.0004 15.616 21.9654 15.7257 21.9004 15.8176C21.8353 15.9094 21.7434 15.9788 21.6372 16.0163L20.2594 16.4637C19.8405 16.6029 19.4599 16.8377 19.1478 17.1496C18.8356 17.4615 18.6006 17.8418 18.4614 18.2604L18.0136 19.6371C18.0096 19.6486 18.0051 19.6598 18.0004 19.6709C17.9609 19.7627 17.8967 19.8421 17.8147 19.9001C17.7228 19.9651 17.613 20 17.5004 20C17.3878 20 17.2779 19.9651 17.186 19.9001C17.0941 19.8351 17.0246 19.7432 16.9871 19.6371L16.5394 18.2604C16.4382 17.9533 16.2855 17.6666 16.0886 17.4123ZM23.7833 21.2132L23.0179 20.9646C22.7851 20.8873 22.5737 20.7568 22.4003 20.5836C22.2269 20.4103 22.0963 20.199 22.019 19.9665L21.7702 19.2016C21.7494 19.1427 21.7108 19.0916 21.6597 19.0555C21.6086 19.0194 21.5476 19 21.4851 19C21.4225 19 21.3615 19.0194 21.3104 19.0555C21.2593 19.0916 21.2207 19.1427 21.1999 19.2016L20.9512 19.9665C20.8753 20.1974 20.7471 20.4076 20.5765 20.5808C20.4058 20.7539 20.1974 20.8853 19.9676 20.9646L19.2021 21.2132C19.1431 21.234 19.092 21.2725 19.0559 21.3236C19.0198 21.3746 19.0004 21.4356 19.0004 21.4981C19.0004 21.5606 19.0198 21.6216 19.0559 21.6726C19.092 21.7236 19.1431 21.7622 19.2021 21.783L19.9676 22.0316C20.2007 22.1093 20.4124 22.2403 20.5858 22.4143C20.7593 22.5882 20.8896 22.8003 20.9665 23.0335L21.2152 23.7984C21.2361 23.8573 21.2747 23.9084 21.3257 23.9445C21.3768 23.9806 21.4378 24 21.5004 24C21.5629 24 21.6239 23.9806 21.675 23.9445C21.7261 23.9084 21.7647 23.8573 21.7855 23.7984L22.0343 23.0335C22.1116 22.801 22.2422 22.5897 22.4156 22.4164C22.589 22.2432 22.8005 22.1127 23.0332 22.0354L23.7986 21.7868C23.8576 21.766 23.9087 21.7275 23.9448 21.6764C23.981 21.6254 24.0004 21.5644 24.0004 21.5019C24.0004 21.4394 23.981 21.3784 23.9448 21.3274C23.9087 21.2764 23.8576 21.2378 23.7986 21.217L23.7833 21.2132Z'
            };
            
            const selectedIcon = settings.launcherIcon || 'chat_multiple';
            iconSvg.innerHTML = `<path d="${iconPaths[selectedIcon]}"/>`;
        }

        // Apply image from path input (Edge-friendly alternative to file upload)
        function applyImagePath(settingKey, inputId, areaId, isAvatar) {
            const input = document.getElementById(inputId);
            let path = input.value.trim();
            
            if (!path) {
                alert('Please enter an image path or URL.\n\nExamples:\n Local: img/logo.png\n URL: https://example.com/image.png');
                return;
            }
            
            // Remove surrounding quotes if present
            if ((path.startsWith('"') && path.endsWith('"')) || (path.startsWith("'") && path.endsWith("'"))) {
                path = path.slice(1, -1).trim();
            }
            
            // Check if it's a valid URL (HTTP/HTTPS)
            const isUrl = path.startsWith('https://') || path.startsWith('http://');
            
            // Validate: URLs or local paths must end with valid image extension
            if (!isUrl && !path.match(/\.(png|jpg|jpeg|gif|webp|svg)$/i)) {
                alert('Please enter a valid image path ending with .png, .jpg, .gif, .webp, or .svg');
                return;
            }
            
            // For URLs, do a basic validation (should contain image extension somewhere or be a dynamic URL)
            if (isUrl && !path.match(/\.(png|jpg|jpeg|gif|webp|svg)(\?.*)?$/i) && !path.includes('/image') && !path.includes('/avatar')) {
                // Allow common image service patterns even without extension
                console.log('URL may not be an image, but allowing it:', path);
            }
            
            // Store the path
            settings[settingKey] = path;
            
            // Show preview
            showUploadedImage(areaId, path, isAvatar);
            updatePreview();
            
            // Clear the input
            input.value = '';
            
            // Save settings
            if (!isInitializing && activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settings };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                }
            }
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
        }

        function toggleStandardAuthFields(enabled) {
            const fieldsContainer = document.getElementById('standardAuthFields');
            if (fieldsContainer) {
                if (enabled) {
                    fieldsContainer.classList.remove('hidden');
                } else {
                    fieldsContainer.classList.add('hidden');
                }
            }
        }

        function togglePrechatForm(enabled) {
            const formFields = document.getElementById('prechatFormFields');
            const authSection = document.getElementById('customAuthSection');
            if (formFields) {
                if (enabled) {
                    formFields.classList.remove('hidden');
                } else {
                    formFields.classList.add('hidden');
                }
            }
            if (authSection) {
                if (enabled) {
                    authSection.classList.add('hidden');
                } else {
                    authSection.classList.remove('hidden');
                }
            }
        }

        function toggleCustomAuthFields(enabled) {
            const fieldsContainer = document.getElementById('customAuthFields');
            if (fieldsContainer) {
                if (enabled) {
                    fieldsContainer.classList.remove('hidden');
                } else {
                    fieldsContainer.classList.add('hidden');
                }
            }
        }

        function updateSettingsFromForm() {
            // D365 Connection - lcwCode is updated via its own event listener
            // orgId, orgUrl, widgetId are already set by parseLCWCode()
            settings.lcwCode = document.getElementById('lcwCode').value;
            // Note: orgId, orgUrl, widgetId are already in settings from parseLCWCode

            // Widget Mode
            settings.widgetMode = document.querySelector('input[name="widgetMode"]:checked')?.value || 'custom';

            // Standard Widget Authentication
            const standardAuthCheckbox = document.getElementById('enableStandardAuth');
            if (standardAuthCheckbox) {
                settings.enableStandardAuth = standardAuthCheckbox.checked;
                settings.standardAuthName = document.getElementById('standardAuthName').value;
                settings.standardAuthEmail = document.getElementById('standardAuthEmail').value;
            }

            // Custom Widget Pre-chat Form
            const prechatFormCheckbox = document.getElementById('enablePrechatForm');
            if (prechatFormCheckbox) {
                settings.enablePrechatForm = prechatFormCheckbox.checked;
            }

            // Custom Widget Contact Authentication
            const customAuthCheckbox = document.getElementById('enableCustomAuth');
            if (customAuthCheckbox) {
                settings.enableCustomAuth = customAuthCheckbox.checked;
                settings.customAuthName = document.getElementById('customAuthName').value;
                settings.customAuthEmail = document.getElementById('customAuthEmail').value;
            }

            // Demo Settings
            const bgImageValue = document.getElementById('backgroundImageUrl').value;
            settings.backgroundImageUrl = bgImageValue;

            // Header & Branding
            settings.headerTitle = document.getElementById('headerTitle').value;
            settings.headerSubtitle = document.getElementById('headerSubtitle').value;
            settings.headerTitleColor = document.getElementById('headerTitleColor').value;
            settings.headerSubtitleColor = document.getElementById('headerSubtitleColor').value;
            // Note: headerLogo is already in settings from handleImageUpload

            // Fonts
            settings.fontFamily = document.getElementById('fontFamily').value;

            // Colors
            settings.useGradient = document.getElementById('useGradient').checked;
            settings.useBubbleGradient = document.getElementById('useBubbleGradient').checked;
            settings.gradientStart = document.getElementById('gradientStart').value;
            settings.gradientEnd = document.getElementById('gradientEnd').value;
            settings.primaryColor = document.getElementById('primaryColor').value;
            settings.userBubbleColor = document.getElementById('userBubbleColor').value;
            settings.userTextColor = document.getElementById('userTextColor').value;
            settings.agentBubbleColor = document.getElementById('agentBubbleColor').value;
            settings.agentTextColor = document.getElementById('agentTextColor').value;
            settings.systemMsgColor = document.getElementById('systemMsgColor').value;
            settings.systemTextColor = document.getElementById('systemTextColor').value;
            settings.chatBgColor = document.getElementById('chatBgColor').value;
            settings.inputBgColor = document.getElementById('inputBgColor').value;
            settings.inputBorderColor = document.getElementById('inputBorderColor').value;
            settings.sendBtnColor = document.getElementById('sendBtnColor').value;
            settings.launcherColor = document.getElementById('launcherColor').value;
            settings.badgeColor = document.getElementById('badgeColor').value;

            // Pre-chat Hero Colors
            settings.usePrechatGradient = document.getElementById('usePrechatGradient').checked;
            settings.prechatGradientStart = document.getElementById('prechatGradientStart').value;
            settings.prechatGradientEnd = document.getElementById('prechatGradientEnd').value;
            settings.prechatSolidColor = document.getElementById('prechatSolidColor').value;
            settings.prechatTitleColor = document.getElementById('prechatTitleColor').value;
            settings.prechatSubtitleColor = document.getElementById('prechatSubtitleColor').value;
            settings.prechatBadgeBg = document.getElementById('prechatBadgeBg').value;
            settings.prechatBadgeText = document.getElementById('prechatBadgeText').value;
            settings.prechatStatusDot = document.getElementById('prechatStatusDot').value;
            settings.prechatAvatarBorder = document.getElementById('prechatAvatarBorder').value;

            // Pre-chat Form
            settings.welcomeTitle = document.getElementById('welcomeTitle').value;
            settings.welcomeMessage = document.getElementById('welcomeMessage').value;
            settings.nameFieldLabel = document.getElementById('nameFieldLabel').value;
            settings.nameFieldPlaceholder = document.getElementById('nameFieldPlaceholder').value;
            settings.emailFieldLabel = document.getElementById('emailFieldLabel').value;
            settings.emailFieldPlaceholder = document.getElementById('emailFieldPlaceholder').value;
            settings.questionFieldLabel = document.getElementById('questionFieldLabel').value;
            settings.questionFieldPlaceholder = document.getElementById('questionFieldPlaceholder').value;
            settings.startBtnText = document.getElementById('startBtnText').value;
        }

        function updatePreview() {
            try {
                const gradient = settings.useGradient 
                    ? `linear-gradient(135deg, ${settings.gradientStart} 0%, ${settings.gradientEnd} 100%)`
                    : settings.primaryColor;

                // Apply font to preview
                updateFontPreview(settings.fontFamily || 'system');

                // Preview containers - use simple gradient backgrounds, no demo images
                const prechatContainer = document.querySelector('#prechatPreview .preview-widget-container');
                const chatContainer = document.querySelector('#chatPreview .preview-widget-container');
                
                if (prechatContainer) {
                    prechatContainer.style.backgroundImage = 'none';
                    prechatContainer.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%)';
                }
                
                if (chatContainer) {
                    chatContainer.style.backgroundImage = 'none';
                    chatContainer.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%)';
                }

                // Header
                const previewHeader = document.getElementById('previewHeader');
                if (previewHeader) previewHeader.style.background = gradient;
                
                const previewTitle = document.getElementById('previewTitle');
                if (previewTitle) {
                    previewTitle.textContent = settings.headerTitle;
                    previewTitle.style.color = settings.headerTitleColor || '#ffffff';
                }
                
                const previewStatus = document.getElementById('previewStatus');
                if (previewStatus) {
                    previewStatus.textContent = settings.headerSubtitle;
                    previewStatus.style.color = settings.headerSubtitleColor || '#e0e7ff';
                }

                const headerAvatar = document.getElementById('previewHeaderAvatar');
                if (headerAvatar) {
                    if (isSafeImageData(settings.headerLogo)) {
                        headerAvatar.classList.add('has-image');
                        headerAvatar.innerHTML = '<img src="' + settings.headerLogo + '" alt="Logo">';
                    } else {
                        headerAvatar.classList.remove('has-image');
                        headerAvatar.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:24px;height:24px;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H5v-2h9v2zm5-4H5v-2h14v2zm0-4H5V7h14v2z"/></svg>';
                    }
                }

                // Messages area
                const previewMessages = document.getElementById('previewMessages');
                if (previewMessages) previewMessages.style.background = settings.chatBgColor;

                // Bot bubble (first message)
                const botBubble = document.getElementById('previewBotBubble');
                if (botBubble) {
                    botBubble.style.background = settings.agentBubbleColor;
                    botBubble.style.color = settings.agentTextColor;
                }

                const botAvatar = document.getElementById('previewBotAvatar');
                if (botAvatar) {
                    if (isSafeImageData(settings.botAvatar)) {
                        botAvatar.innerHTML = `<img src="${settings.botAvatar}" alt="Bot" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                        botAvatar.style.background = 'transparent';
                    } else {
                        botAvatar.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:18px;height:18px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';
                        botAvatar.style.background = 'linear-gradient(135deg, #00b4d8 0%, #0077b6 100%)';
                    }
                }

                // Agent bubble (second agent message)
                const agentBubble = document.getElementById('previewAgentBubble');
                if (agentBubble) {
                    agentBubble.style.background = settings.agentBubbleColor;
                    agentBubble.style.color = settings.agentTextColor;
                }

                const agentAvatar = document.getElementById('previewAgentAvatar');
                if (agentAvatar) {
                    if (isSafeImageData(settings.agentAvatar)) {
                        agentAvatar.innerHTML = `<img src="${settings.agentAvatar}" alt="Agent" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                        agentAvatar.style.background = 'transparent';
                    } else {
                        agentAvatar.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:18px;height:18px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                        agentAvatar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    }
                }

                // User bubble
                const userBubble = document.getElementById('previewUserBubble');
                if (userBubble) {
                    userBubble.style.background = settings.useBubbleGradient ? gradient : settings.userBubbleColor;
                    userBubble.style.color = settings.userTextColor;
                }

                const userAvatar = document.getElementById('previewUserAvatar');
                if (userAvatar) {
                    if (isSafeImageData(settings.customerAvatar)) {
                        userAvatar.innerHTML = `<img src="${settings.customerAvatar}" alt="User" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                        userAvatar.style.background = 'transparent';
                    } else {
                        userAvatar.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:18px;height:18px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                        userAvatar.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                    }
                }

                // Input area & send button
                const previewInputArea = document.getElementById('previewInputArea');
                if (previewInputArea) previewInputArea.style.background = settings.inputBgColor;
                // Preview send button keeps transparent background (like actual widget)

                // Pre-chat Form Preview
                const previewPrechatHeader = document.getElementById('previewPrechatHeader');
                if (previewPrechatHeader) previewPrechatHeader.style.background = gradient;
                
                const previewPrechatTitle = document.getElementById('previewPrechatTitle');
                if (previewPrechatTitle) {
                    previewPrechatTitle.textContent = settings.headerTitle;
                    previewPrechatTitle.style.color = settings.headerTitleColor || '#ffffff';
                }
                
                const previewPrechatStatus = document.getElementById('previewPrechatStatus');
                if (previewPrechatStatus) {
                    previewPrechatStatus.textContent = settings.headerSubtitle;
                    previewPrechatStatus.style.color = settings.headerSubtitleColor || '#e0e7ff';
                }
                
                const prechatHeaderAvatar = document.getElementById('previewPrechatHeaderAvatar');
                if (prechatHeaderAvatar) {
                    if (isSafeImageData(settings.headerLogo)) {
                        prechatHeaderAvatar.classList.add('has-image');
                        prechatHeaderAvatar.innerHTML = '<img src="' + settings.headerLogo + '" alt="Logo">';
                    } else {
                        prechatHeaderAvatar.classList.remove('has-image');
                        prechatHeaderAvatar.innerHTML = '<svg viewBox="0 0 24 24" style="fill:white;width:24px;height:24px;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H5v-2h9v2zm5-4H5v-2h14v2zm0-4H5V7h14v2z"/></svg>';
                    }
                }

                // Update form labels
                const previewNameLabel = document.getElementById('previewNameLabel');
                if (previewNameLabel) previewNameLabel.textContent = document.getElementById('nameFieldLabel').value || 'Your Name';
                
                const previewEmailLabel = document.getElementById('previewEmailLabel');
                if (previewEmailLabel) previewEmailLabel.textContent = document.getElementById('emailFieldLabel').value || 'Email Address';
                
                const previewQuestionLabel = document.getElementById('previewQuestionLabel');
                if (previewQuestionLabel) previewQuestionLabel.textContent = document.getElementById('questionFieldLabel').value || 'How can we help?';
                
                const previewQuestionPlaceholder = document.getElementById('previewQuestionPlaceholder');
                if (previewQuestionPlaceholder) previewQuestionPlaceholder.placeholder = document.getElementById('questionFieldPlaceholder').value || 'Describe your question...';
                
                const previewStartBtn = document.getElementById('previewStartBtn');
                if (previewStartBtn) {
                    previewStartBtn.textContent = document.getElementById('startBtnText').value || 'Start Chat';
                    previewStartBtn.style.background = gradient;
                }
                
                // Pre-chat Hero Colors
                const prechatHeroBackground = settings.usePrechatGradient !== false
                    ? `linear-gradient(135deg, ${settings.prechatGradientStart || '#667eea'} 0%, ${settings.prechatGradientEnd || '#764ba2'} 100%)`
                    : (settings.prechatSolidColor || '#667eea');
                
                const prechatHero = document.getElementById('previewPrechatHero');
                if (prechatHero) {
                    prechatHero.style.background = prechatHeroBackground;
                }
                
                const prechatHeroTitle = document.getElementById('previewPrechatHeroTitle');
                if (prechatHeroTitle) {
                    prechatHeroTitle.style.color = settings.prechatTitleColor || '#ffffff';
                    prechatHeroTitle.textContent = settings.welcomeTitle || 'Start a conversation';
                }
                
                const prechatHeroSubtitle = document.getElementById('previewPrechatHeroSubtitle');
                if (prechatHeroSubtitle) {
                    prechatHeroSubtitle.style.color = settings.prechatSubtitleColor || '#e0e7ff';
                    prechatHeroSubtitle.innerHTML = settings.welcomeMessage || "We're here to help!<br>Fill out the form below to chat with our team.";
                }
                
                const prechatStatusBadge = document.getElementById('previewPrechatStatusBadge');
                if (prechatStatusBadge) {
                    prechatStatusBadge.style.background = settings.prechatBadgeBg || '#ffffff';
                    prechatStatusBadge.style.color = settings.prechatBadgeText || '#059669';
                    prechatStatusBadge.style.backdropFilter = 'none';
                }
                
                const prechatStatusDot = document.getElementById('previewPrechatStatusDot');
                if (prechatStatusDot) {
                    prechatStatusDot.style.background = settings.prechatStatusDot || '#10b981';
                    prechatStatusDot.style.boxShadow = `0 0 0 2px ${settings.prechatStatusDot || '#10b981'}33`;
                }
                
                const prechatAvatars = document.querySelectorAll('.prechat-avatar-preview');
                prechatAvatars.forEach(avatar => {
                    avatar.style.borderColor = settings.prechatAvatarBorder || '#ffffff';
                });
                
                // Update launcher preview
                updateLauncherPreview();
            } catch (err) {
                console.error('Error in updatePreview:', err);
            }
        }

        function saveSettings() {
            updateSettingsFromForm();
            
            // Create a clean copy without blob URLs (they can't be saved)
            const settingsToSave = { ...settings };
            ['headerLogo', 'agentAvatar', 'customerAvatar', 'botAvatar'].forEach(key => {
                if (!isSafeImageData(settingsToSave[key])) {
                    settingsToSave[key] = null; // Only persist sanitized image data URLs
                }
                delete settingsToSave[key + '_isBlob'];
            });
            
            // Add timestamp
            settingsToSave.lastSaved = new Date().toISOString();
            
            console.log(' SAVING SETTINGS TO localStorage:', {
                orgId: settingsToSave.orgId,
                widgetId: settingsToSave.widgetId,
                orgUrl: settingsToSave.orgUrl,
                lcwCode: settingsToSave.lcwCode ? `${settingsToSave.lcwCode.length} chars` : 'empty',
                backgroundImageUrl: settingsToSave.backgroundImageUrl,
                botAvatar: settingsToSave.botAvatar ? settingsToSave.botAvatar.substring(0, 100) + '...' : null,
                launcherIcon: settingsToSave.launcherIcon,
                headerTitle: settingsToSave.headerTitle,
                totalSize: JSON.stringify(settingsToSave).length + ' bytes'
            });
            
            localStorage.setItem('chatWidgetSettings', JSON.stringify(settingsToSave));
            
            // If there's an active profile, update it and sync to cloud
            if (activeProfileId) {
                const profile = profiles.find(p => p.id === activeProfileId);
                if (profile) {
                    profile.settings = { ...settingsToSave };
                    profile.updatedAt = new Date().toISOString();
                    saveProfiles();
                    
                    if (cloudToken) {
                        saveProfileToCloud(profile);
                    } else {
                        showToast('Settings saved!');
                    }
                    updateLastSavedInfo(settingsToSave.lastSaved);
                    return;
                }
            }
            
            // Verify the save worked
            const verification = localStorage.getItem('chatWidgetSettings');
            if (verification) {
                const parsed = JSON.parse(verification);
                console.log(' VERIFIED in localStorage after save:', {
                    orgId: parsed.orgId,
                    widgetId: parsed.widgetId,
                    lcwCode: parsed.lcwCode ? `${parsed.lcwCode.length} chars` : 'empty',
                    backgroundImageUrl: parsed.backgroundImageUrl,
                    botAvatar: parsed.botAvatar ? 'SET' : 'NULL'
                });
            } else {
                console.error(' VERIFICATION FAILED - localStorage is empty!');
            }
            
            showToast('Settings saved successfully!');
            updateLastSavedInfo(settingsToSave.lastSaved);
        }

        function updateLastSavedInfo(timestamp) {
            const lastSavedEl = document.getElementById('lastSavedInfo');
            if (lastSavedEl && timestamp) {
                const date = new Date(timestamp);
                const formatted = date.toLocaleString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true 
                });
                lastSavedEl.textContent = `Last Saved: ${formatted}`;
            }
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default?')) {
                // Reset settings object to defaults
                settings = { ...defaultSettings };
                
                // Clear localStorage
                localStorage.removeItem('chatWidgetSettings');
                activeProfileId = null;
                localStorage.removeItem('chatWidgetActiveProfile');
                
                // Show toast and auto-refresh the page to ensure clean state
                showToast('Resetting to defaults...');
                
                // Small delay to show toast, then refresh page for clean reset
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        }

        // ============ IMPORT/EXPORT ============
        function exportSettings() {
            updateSettingsFromForm();
            const exportData = {
                version: '1.0',
                exportedAt: new Date().toISOString(),
                settings: settings,
                profiles: profiles
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-widget-config-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Settings exported!');
        }

        function importSettings(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.settings) {
                        settings = { ...defaultSettings, ...data.settings };
                        localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                    }
                    
                    if (data.profiles && Array.isArray(data.profiles)) {
                        // Merge profiles, avoiding duplicates by name
                        const existingNames = profiles.map(p => p.name);
                        data.profiles.forEach(p => {
                            if (!existingNames.includes(p.name)) {
                                p.id = 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                profiles.push(p);
                            }
                        });
                        saveProfiles();
                    }

                    populateForm();
                    updatePreview();
                    updateConnectionStatus();
                    renderProfiles();
                    showToast('Settings imported successfully!');
                } catch (err) {
                    alert('Invalid configuration file');
                    console.error('Import error:', err);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // ===== SIMPLE SHARING (No GitHub Required!) =====
        
        function copyConfigToClipboard() {
            updateSettingsFromForm();
            const exportData = {
                version: '1.0',
                settings: settings,
                profiles: profiles
            };
            const configJson = JSON.stringify(exportData, null, 2);
            navigator.clipboard.writeText(configJson).then(() => {
                showToast(' Config copied! Paste it in an email, Teams, or Slack');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = configJson;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast(' Config copied!');
            });
        }

        function generateShareLink() {
            updateSettingsFromForm();
            const shareData = {
                v: '1',
                s: {
                    orgId: settings.orgId,
                    orgUrl: settings.orgUrl,
                    widgetColor: settings.widgetColor,
                    widgetPosition: settings.widgetPosition,
                    widgetSize: settings.widgetSize,
                    enableVoiceVideo: settings.enableVoiceVideo,
                    autoOpen: settings.autoOpen,
                    draggable: settings.draggable,
                    agentName: settings.agentName || '',
                    botIcon: settings.botIcon || '',
                    welcomeMessage: settings.welcomeMessage || ''
                }
            };
            
            // Compress: base64 encode the config
            const encoded = btoa(encodeURIComponent(JSON.stringify(shareData)));
            const shareUrl = `${window.location.origin}${window.location.pathname}?config=${encoded}`;
            
            // Check URL length (browsers typically support ~2000 chars)
            if (shareUrl.length > 2000) {
                showToast(' Config too large for URL. Use "Copy Config" instead.', 'warning');
                return null;
            }
            
            return shareUrl;
        }

        function copyShareLink() {
            const shareUrl = generateShareLink();
            if (!shareUrl) return;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast(' Share link copied! Anyone with this link can import your config');
            }).catch(err => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = shareUrl;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast(' Share link copied!');
            });
        }

        function showQRCode() {
            const shareUrl = generateShareLink();
            if (!shareUrl) return;
            
            // Use QR code API (no library needed)
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shareUrl)}`;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'save-modal-overlay';
            modal.id = 'qrModal';
            modal.innerHTML = `
                <div class="save-modal" style="max-width: 320px; text-align: center;">
                    <h3> Scan to Import Config</h3>
                    <p style="color: #666; font-size: 13px; margin-bottom: 16px;">Scan this QR code on another device to import your widget settings</p>
                    <img src="${qrUrl}" alt="QR Code" style="width: 200px; height: 200px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <div style="margin-top: 16px;">
                        <button class="save-modal-cancel" onclick="document.getElementById('qrModal').remove()">Close</button>
                    </div>
                </div>
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        // Load config from URL on page load
        function loadConfigFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('config');
            
            if (configParam) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(atob(configParam)));
                    if (decoded.s) {
                        // Apply settings
                        Object.assign(settings, decoded.s);
                        localStorage.setItem('chatWidgetSettings', JSON.stringify(settings));
                        populateForm();
                        updatePreview();
                        updateConnectionStatus();
                        
                        // Clean URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        showToast(' Config imported from share link!');
                    }
                } catch (err) {
                    console.error('Failed to load config from URL:', err);
                }
            }
        }

        function copyEmbedCode() {
            updateSettingsFromForm();
            
            const embedCode = `<!-- D365 Modern Chat Widget -->
<script>
  window.chatWidgetConfig = ${JSON.stringify({
    orgId: settings.orgId,
    orgUrl: settings.orgUrl,
    widgetId: settings.widgetId,
    theme: {
      headerTitle: settings.headerTitle,
      headerSubtitle: settings.headerSubtitle,
      headerTitleColor: settings.headerTitleColor,
      headerSubtitleColor: settings.headerSubtitleColor,
      useGradient: settings.useGradient,
      gradientStart: settings.gradientStart,
      gradientEnd: settings.gradientEnd,
      primaryColor: settings.primaryColor
    }
  }, null, 2)};
<\/script>
<script src="https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/dist/chat-sdk-bundle.js"><\/script>`;

            // Show the code block
            const codeBlock = document.getElementById('embedCodeBlock');
            const codeEl = document.getElementById('embedCode');
            codeEl.textContent = embedCode;
            codeBlock.style.display = 'block';

            // Copy to clipboard
            navigator.clipboard.writeText(embedCode).then(() => {
                const btn = event.target.closest('.btn');
                btn.classList.add('copied');
                setTimeout(() => btn.classList.remove('copied'), 2000);
            });
        }

        // ============ EMBED CODE GENERATION ============
        
        // Helper function to convert local paths to GitHub raw URLs for embed code
        function toGitHubRawUrl(localPath) {
            if (!localPath) return '';
            
            const baseUrl = 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/';
            
            // If it's already a GitHub raw URL or other external URL, return as-is
            if (localPath.startsWith('https://raw.githubusercontent.com/') || 
                localPath.startsWith('https://cdn.') || 
                localPath.startsWith('data:')) {
                return localPath;
            }
            
            // Handle file:/// URLs (convert to relative path first)
            if (localPath.startsWith('file:///')) {
                // Extract the img/ portion from file:/// paths
                const imgMatch = localPath.match(/img\/(bot|headshots)\/[^\/]+\.(png|jpg|jpeg|gif|svg|webp)/i);
                if (imgMatch) {
                    return baseUrl + imgMatch[0];
                }
            }
            
            // Handle http:// or https:// external URLs - return as-is
            if (localPath.startsWith('http://') || localPath.startsWith('https://')) {
                return localPath;
            }
            
            // Handle relative paths like "img/bot/bot1.png" or "./img/headshots/..."
            // Remove leading ./ or / if present
            const cleanPath = localPath.replace(/^\.?\//, '');
            
            // Only convert if it looks like an image path from our project
            if (cleanPath.startsWith('img/')) {
                return baseUrl + cleanPath;
            }
            
            // For any other path, return as-is (might be user's own URL)
            return localPath;
        }
        
        function generateEmbedCode() {
            updateSettingsFromForm();
            
            const embedMode = document.getElementById('embedCodeMode').value;
            const includeSettings = document.getElementById('embedIncludeSettings').checked;
            const minified = document.getElementById('embedMinified').checked;
            
            // Validate required D365 settings
            if (!settings.orgId || !settings.orgUrl || !settings.widgetId) {
                showToast('Please configure D365 Connection settings first (Org ID, Org URL, Widget ID)');
                document.getElementById('embedCodeOutput').value = ' Please configure D365 Connection settings first.\n\nGo to the "D365 Connection" tab and enter your Org ID, Org URL, and Widget ID.';
                hideCharCount();
                return;
            }
            
            if (embedMode === 'compact') {
                generateCompactEmbedCode(minified);
            } else {
                generateFullEmbedCode(minified);
            }
        }
        
        function hideCharCount() {
            document.getElementById('embedCharCount').style.display = 'none';
        }
        
        function showCharCount(charCount) {
            const maxChars = 65536;
            const percent = Math.min(100, (charCount / maxChars) * 100);
            const countEl = document.getElementById('embedCharCount');
            const textEl = document.getElementById('charCountText');
            const barEl = document.getElementById('charCountBar');
            
            countEl.style.display = 'block';
            
            if (charCount <= maxChars) {
                countEl.style.background = '#f0fdf4';
                countEl.style.borderColor = '#22c55e';
                textEl.innerHTML = `<span style="color: #15803d; font-weight: 600;"> ${charCount.toLocaleString()} characters</span>  Safe for Power Pages (limit: ${maxChars.toLocaleString()})`;
                barEl.style.background = '#22c55e';
            } else {
                countEl.style.background = '#fef2f2';
                countEl.style.borderColor = '#ef4444';
                textEl.innerHTML = `<span style="color: #dc2626; font-weight: 600;"> ${charCount.toLocaleString()} characters</span>  Exceeds Power Pages limit by ${(charCount - maxChars).toLocaleString()}!`;
                barEl.style.background = '#ef4444';
            }
            barEl.style.width = Math.min(100, percent) + '%';
        }
        
        function generateCompactEmbedCode(minified) {
            // Build config object for compact mode (only non-default values to minimize size)
            const config = buildCompactConfig();
            
            // Generate minified config JSON
            // Generate minified config JSON - escape for safe embedding
            let configJson = JSON.stringify(config);
            // Escape any closing script tags to prevent breaking HTML
            configJson = configJson.replace(/<\/script>/gi, '<\\/script>');
            // Escape any problematic characters for inline JS
            configJson = configJson.replace(/\u2028/g, '\\u2028').replace(/\u2029/g, '\\u2029');
            
            // Tiny loader that fetches from GitHub Pages
            const embedCode = `<!-- D365 Chat Widget - Compact Loader (Power Pages Compatible) -->
<!-- Generated: ${new Date().toLocaleDateString()} | Size: ~1.5KB -->
<script>
window.D365WidgetConfig=${configJson};
(function(){var s=document.createElement('script');s.src='https://moliveirapinto.github.io/d365-modern-chat-widget/dist/widget-core.js';document.head.appendChild(s);})();
<\/script>`;
            
            document.getElementById('embedCodeOutput').value = embedCode;
            showCharCount(embedCode.length);
            document.getElementById('downloadHtmlBtn').style.display = 'inline-flex'; // Show download button
            showToast(' Compact embed code generated! Only ' + embedCode.length + ' characters!');
        }
        
        function buildCompactConfig() {
            // Only include essential config + non-default customizations to minimize size
            // NOTE: We do NOT include lcwScript in compact mode - the widget-core.js handles SDK loading
            const config = {
                orgId: settings.orgId,
                orgUrl: settings.orgUrl,
                widgetId: settings.widgetId
            };
            
            // Only add non-default values to minimize JSON size
            // DO NOT include lcwCode/lcwScript - it's too large and contains script tags that break embedding
            if (settings.headerTitle && settings.headerTitle !== 'Support Chat') config.headerTitle = settings.headerTitle;
            if (settings.headerSubtitle && settings.headerSubtitle !== "We're here to help") config.headerSubtitle = settings.headerSubtitle;
            if (settings.headerTitleColor && settings.headerTitleColor !== '#ffffff') config.headerTitleColor = settings.headerTitleColor;
            if (settings.headerSubtitleColor && settings.headerSubtitleColor !== '#e0e7ff') config.headerSubtitleColor = settings.headerSubtitleColor;
            if (settings.headerLogo) config.headerLogo = toGitHubRawUrl(settings.headerLogo);
            if (settings.fontFamily && settings.fontFamily !== 'system') config.fontFamily = settings.fontFamily;
            if (settings.useGradient === false) config.useGradient = false;
            if (settings.gradientStart && settings.gradientStart !== '#667eea') config.gradientStart = settings.gradientStart;
            if (settings.gradientEnd && settings.gradientEnd !== '#764ba2') config.gradientEnd = settings.gradientEnd;
            if (settings.primaryColor && settings.primaryColor !== '#667eea') config.primaryColor = settings.primaryColor;
            if (settings.userBubbleColor && settings.userBubbleColor !== '#667eea') config.userBubbleColor = settings.userBubbleColor;
            if (settings.userTextColor && settings.userTextColor !== '#ffffff') config.userTextColor = settings.userTextColor;
            if (settings.agentBubbleColor && settings.agentBubbleColor !== '#ffffff') config.agentBubbleColor = settings.agentBubbleColor;
            if (settings.agentTextColor && settings.agentTextColor !== '#2d3748') config.agentTextColor = settings.agentTextColor;
            if (settings.chatBgColor && settings.chatBgColor !== '#f8fafc') config.chatBgColor = settings.chatBgColor;
            if (settings.launcherColor && settings.launcherColor !== '#667eea') config.launcherColor = settings.launcherColor;
            if (settings.launcherIcon && settings.launcherIcon !== 'chat_multiple') config.launcherIcon = settings.launcherIcon;
            if (settings.badgeColor && settings.badgeColor !== '#ff4757') config.badgeColor = settings.badgeColor;
            if (settings.sendBtnColor && settings.sendBtnColor !== '#667eea') config.sendBtnColor = settings.sendBtnColor;
            // Pre-chat Hero Colors
            if (settings.usePrechatGradient === false) config.usePrechatGradient = false;
            if (settings.prechatSolidColor && settings.prechatSolidColor !== '#667eea') config.prechatSolidColor = settings.prechatSolidColor;
            if (settings.prechatGradientStart && settings.prechatGradientStart !== '#667eea') config.prechatGradientStart = settings.prechatGradientStart;
            if (settings.prechatGradientEnd && settings.prechatGradientEnd !== '#764ba2') config.prechatGradientEnd = settings.prechatGradientEnd;
            if (settings.prechatTitleColor && settings.prechatTitleColor !== '#ffffff') config.prechatTitleColor = settings.prechatTitleColor;
            if (settings.prechatSubtitleColor && settings.prechatSubtitleColor !== '#e0e7ff') config.prechatSubtitleColor = settings.prechatSubtitleColor;
            if (settings.prechatBadgeBg && settings.prechatBadgeBg !== '#ffffff') config.prechatBadgeBg = settings.prechatBadgeBg;
            if (settings.prechatBadgeText && settings.prechatBadgeText !== '#059669') config.prechatBadgeText = settings.prechatBadgeText;
            if (settings.prechatStatusDot && settings.prechatStatusDot !== '#10b981') config.prechatStatusDot = settings.prechatStatusDot;
            if (settings.prechatAvatarBorder && settings.prechatAvatarBorder !== '#ffffff') config.prechatAvatarBorder = settings.prechatAvatarBorder;
            if (settings.agentAvatar) config.agentAvatar = toGitHubRawUrl(settings.agentAvatar);
            if (settings.customerAvatar) config.customerAvatar = toGitHubRawUrl(settings.customerAvatar);
            if (settings.botAvatar) config.botAvatar = toGitHubRawUrl(settings.botAvatar);
            if (settings.enablePrechatForm === false) config.enablePrechatForm = false;
            if (settings.welcomeTitle && settings.welcomeTitle !== 'Welcome!') config.welcomeTitle = settings.welcomeTitle;
            if (settings.welcomeMessage && settings.welcomeMessage !== 'Please fill in your details to start chatting with us.') config.welcomeMessage = settings.welcomeMessage;
            if (settings.nameFieldLabel && settings.nameFieldLabel !== 'Name *') config.nameFieldLabel = settings.nameFieldLabel;
            if (settings.nameFieldPlaceholder && settings.nameFieldPlaceholder !== 'Enter your name') config.nameFieldPlaceholder = settings.nameFieldPlaceholder;
            if (settings.emailFieldLabel && settings.emailFieldLabel !== 'Email *') config.emailFieldLabel = settings.emailFieldLabel;
            if (settings.emailFieldPlaceholder && settings.emailFieldPlaceholder !== 'Enter your email') config.emailFieldPlaceholder = settings.emailFieldPlaceholder;
            if (settings.questionFieldPlaceholder && settings.questionFieldPlaceholder !== 'Describe your question...') config.questionFieldPlaceholder = settings.questionFieldPlaceholder;
            if (settings.startBtnText && settings.startBtnText !== 'Start Chat') config.startBtnText = settings.startBtnText;
            if (settings.enableCustomAuth) {
                config.enableCustomAuth = true;
                if (settings.customAuthName) config.customAuthName = settings.customAuthName;
                if (settings.customAuthEmail) config.customAuthEmail = settings.customAuthEmail;
            }
            
            return config;
        }
        
        function generateFullEmbedCode(minified, skipCharCount) {
            // Build the configuration object with all customizations
            // Use GitHub raw URLs for images so they work when embedded anywhere
            const config = {
                orgId: settings.orgId,
                orgUrl: settings.orgUrl,
                widgetId: settings.widgetId,
                lcwScript: settings.lcwCode || '', // Include the actual LCW script from admin
                widgetMode: 'custom',
                headerTitle: settings.headerTitle || 'Support Chat',
                headerSubtitle: settings.headerSubtitle || "We're here to help",
                headerTitleColor: settings.headerTitleColor || '#ffffff',
                headerSubtitleColor: settings.headerSubtitleColor || '#e0e7ff',
                headerLogo: toGitHubRawUrl(settings.headerLogo) || '',
                fontFamily: settings.fontFamily || 'system',
                useGradient: settings.useGradient !== false,
                useBubbleGradient: settings.useBubbleGradient !== false,
                gradientStart: settings.gradientStart || '#667eea',
                gradientEnd: settings.gradientEnd || '#764ba2',
                primaryColor: settings.primaryColor || '#667eea',
                userBubbleColor: settings.userBubbleColor || '#667eea',
                userTextColor: settings.userTextColor || '#ffffff',
                agentBubbleColor: settings.agentBubbleColor || '#ffffff',
                agentTextColor: settings.agentTextColor || '#2d3748',
                systemMsgColor: settings.systemMsgColor || '#e2e8f0',
                systemTextColor: settings.systemTextColor || '#64748b',
                chatBgColor: settings.chatBgColor || '#f8fafc',
                inputBgColor: settings.inputBgColor || '#ffffff',
                inputBorderColor: settings.inputBorderColor || '#e2e8f0',
                sendBtnColor: settings.sendBtnColor || '#667eea',
                launcherColor: settings.launcherColor || '#667eea',
                launcherIcon: settings.launcherIcon || 'chat_multiple',
                badgeColor: settings.badgeColor || '#ff4757',
                usePrechatGradient: settings.usePrechatGradient !== false,
                prechatSolidColor: settings.prechatSolidColor || '#667eea',
                prechatGradientStart: settings.prechatGradientStart || '#667eea',
                prechatGradientEnd: settings.prechatGradientEnd || '#764ba2',
                prechatTitleColor: settings.prechatTitleColor || '#ffffff',
                prechatSubtitleColor: settings.prechatSubtitleColor || '#e0e7ff',
                prechatBadgeBg: settings.prechatBadgeBg || '#ffffff',
                prechatBadgeText: settings.prechatBadgeText || '#059669',
                prechatStatusDot: settings.prechatStatusDot || '#10b981',
                prechatAvatarBorder: settings.prechatAvatarBorder || '#ffffff',
                agentAvatar: toGitHubRawUrl(settings.agentAvatar) || '',
                customerAvatar: toGitHubRawUrl(settings.customerAvatar) || '',
                botAvatar: toGitHubRawUrl(settings.botAvatar) || '',
                enablePrechatForm: settings.enablePrechatForm !== false,
                welcomeTitle: settings.welcomeTitle || 'Welcome!',
                welcomeMessage: settings.welcomeMessage || 'Please fill in your details to start chatting with us.',
                nameFieldLabel: settings.nameFieldLabel || 'Name *',
                nameFieldPlaceholder: settings.nameFieldPlaceholder || 'Enter your name',
                emailFieldLabel: settings.emailFieldLabel || 'Email *',
                emailFieldPlaceholder: settings.emailFieldPlaceholder || 'Enter your email',
                questionFieldLabel: settings.questionFieldLabel || 'How can we help? (optional)',
                questionFieldPlaceholder: settings.questionFieldPlaceholder || 'Describe your question...',
                startBtnText: settings.startBtnText || 'Start Chat',
                enableCustomAuth: settings.enableCustomAuth || false,
                customAuthName: settings.customAuthName || '',
                customAuthEmail: settings.customAuthEmail || ''
            };
            
            // Generate JSON and escape closing script tags to prevent breaking HTML parsing
            let configJson = minified ? JSON.stringify(config) : JSON.stringify(config, null, 2);
            configJson = configJson.replace(/<\x2fscript>/gi, '<\\/script>');
            
            // Icon SVG paths mapping for dynamic launcher icons
            const iconSvgPaths = {
                chat_multiple: 'M9.56158 3C5.41944 3 2.06158 6.35786 2.06158 10.5C2.06158 11.6329 2.31325 12.7088 2.76423 13.6734C2.5102 14.6714 2.22638 15.7842 2.03999 16.5147C1.80697 17.428 2.6294 18.2588 3.54374 18.039C4.29396 17.8587 5.44699 17.5819 6.47447 17.337C7.41678 17.7631 8.46241 18 9.56158 18C13.7037 18 17.0616 14.6421 17.0616 10.5C17.0616 6.35786 13.7037 3 9.56158 3ZM3.56158 10.5C3.56158 7.18629 6.24787 4.5 9.56158 4.5C12.8753 4.5 15.5616 7.18629 15.5616 10.5C15.5616 13.8137 12.8753 16.5 9.56158 16.5C8.60084 16.5 7.69487 16.2748 6.89161 15.8749L6.6482 15.7537L6.38368 15.8167C5.46095 16.0363 4.39489 16.2919 3.59592 16.4838C3.79467 15.7047 4.05784 14.6724 4.28601 13.7757L4.35619 13.4998L4.22568 13.2468C3.80145 12.4246 3.56158 11.4914 3.56158 10.5ZM14.5616 21.0001C12.5922 21.0001 10.8001 20.241 9.46191 18.9995C9.49511 18.9999 9.52835 19.0001 9.56163 19.0001C10.2796 19.0001 10.9768 18.911 11.6427 18.7434C12.5067 19.2254 13.5021 19.5001 14.5616 19.5001C15.5223 19.5001 16.4283 19.2748 17.2316 18.8749L17.475 18.7537L17.7395 18.8167C18.6611 19.0361 19.7046 19.2625 20.4787 19.4262C20.3037 18.6757 20.065 17.6711 19.8372 16.7757L19.767 16.4999L19.8975 16.2469C20.3217 15.4247 20.5616 14.4915 20.5616 13.5001C20.5616 11.3853 19.4676 9.52617 17.8146 8.45761C17.6363 7.73435 17.3653 7.04756 17.015 6.41052C19.9523 7.42684 22.0616 10.2171 22.0616 13.5001C22.0616 14.6332 21.8098 15.7094 21.3586 16.6741C21.6117 17.6821 21.8679 18.774 22.0304 19.4773C22.2348 20.3623 21.4554 21.1633 20.563 20.9768C19.8358 20.8248 18.6933 20.581 17.6495 20.3367C16.707 20.763 15.6611 21.0001 14.5616 21.0001Z',
                chat_multiple_checkmark: 'M13.0606 8.99827C13.3357 8.68869 13.3079 8.21463 12.9983 7.93944C12.6887 7.66425 12.2146 7.69214 11.9394 8.00173L8.44187 11.9365L7.0029 10.6359C6.69561 10.3582 6.22134 10.3821 5.94359 10.6894C5.66585 10.9967 5.6898 11.471 5.9971 11.7487L7.9971 13.5564C8.14546 13.6905 8.34124 13.7598 8.54094 13.7489C8.74063 13.738 8.92769 13.6477 9.06056 13.4983L13.0606 8.99827ZM2.06158 10.5C2.06158 6.35786 5.41944 3 9.56158 3C13.7037 3 17.0616 6.35786 17.0616 10.5C17.0616 14.6421 13.7037 18 9.56158 18C8.46241 18 7.41678 17.7631 6.47447 17.337C5.44699 17.5819 4.29396 17.8587 3.54374 18.039C2.6294 18.2588 1.80697 17.428 2.03999 16.5147C2.22638 15.7842 2.5102 14.6714 2.76423 13.6734C2.31325 12.7088 2.06158 11.6329 2.06158 10.5ZM9.56158 4.5C6.24787 4.5 3.56158 7.18629 3.56158 10.5C3.56158 11.4914 3.80145 12.4246 4.22568 13.2468L4.35619 13.4998L4.28601 13.7757C4.05784 14.6724 3.79467 15.7047 3.59592 16.4838C4.39489 16.2919 5.46095 16.0363 6.38368 15.8167L6.6482 15.7537L6.89161 15.8749C7.69487 16.2748 8.60084 16.5 9.56158 16.5C12.8753 16.5 15.5616 13.8137 15.5616 10.5C15.5616 7.18629 12.8753 4.5 9.56158 4.5ZM9.46191 18.9995C10.8001 20.241 12.5922 21.0001 14.5616 21.0001C15.6611 21.0001 16.707 20.763 17.6495 20.3367C18.6933 20.581 19.8358 20.8248 20.563 20.9768C21.4554 21.1633 22.2348 20.3623 22.0304 19.4773C21.8679 18.774 21.6117 17.6821 21.3586 16.6741C21.8098 15.7094 22.0616 14.6332 22.0616 13.5001C22.0616 10.2171 19.9523 7.42684 17.015 6.41052C17.3653 7.04756 17.6363 7.73435 17.8146 8.45761C19.4676 9.52617 20.5616 11.3853 20.5616 13.5001C20.5616 14.4915 20.3217 15.4247 19.8975 16.2469L19.767 16.4999L19.8372 16.7757C20.065 17.6711 20.3037 18.6757 20.4787 19.4262C19.7046 19.2625 18.6611 19.0361 17.7395 18.8167L17.475 18.7537L17.2316 18.8749C16.4283 19.2748 15.5223 19.5001 14.5616 19.5001C13.5021 19.5001 12.5067 19.2254 11.6427 18.7434C10.9768 18.911 10.2796 19.0001 9.56163 19.0001C9.52835 19.0001 9.49511 18.9999 9.46191 18.9995Z',
                chat_sparkle: 'M16.0883 6.41228C16.016 6.31886 15.9377 6.2298 15.8539 6.14569C15.5417 5.83255 15.1606 5.59666 14.741 5.45683L13.3632 5.00939C13.257 4.97196 13.165 4.90253 13.1 4.81068C13.0349 4.71883 13 4.60908 13 4.49656C13 4.38404 13.0349 4.27429 13.1 4.18244C13.165 4.09058 13.257 4.02116 13.3632 3.98372L14.741 3.53628C15.1547 3.39352 15.5299 3.15705 15.837 2.84537C16.1357 2.54224 16.3623 2.17595 16.5 1.77372L16.5114 1.73963L16.9592 0.362894C16.9967 0.256782 17.0662 0.164895 17.1581 0.0998993C17.25 0.0349035 17.3598 0 17.4724 0C17.5851 0 17.6949 0.0349035 17.7868 0.0998993C17.8787 0.164895 17.9482 0.256782 17.9857 0.362894L18.4335 1.73963C18.5727 2.15819 18.8077 2.53853 19.1198 2.85041C19.432 3.1623 19.8126 3.39715 20.2315 3.53628L21.6093 3.98372L21.6368 3.99061C21.743 4.02804 21.835 4.09747 21.9 4.18932C21.9651 4.28117 22 4.39092 22 4.50344C22 4.61596 21.9651 4.72571 21.9 4.81756C21.835 4.90942 21.743 4.97884 21.6368 5.01628L20.259 5.46372C19.8402 5.60285 19.4595 5.8377 19.1474 6.14959C18.8353 6.46147 18.6003 6.84181 18.461 7.26037L18.0132 8.63711C18.0092 8.64855 18.0048 8.65983 18 8.67093C17.9605 8.76273 17.8964 8.84212 17.8144 8.9001C17.7224 8.9651 17.6126 9 17.5 9C17.3874 9 17.2776 8.9651 17.1856 8.9001C17.0937 8.8351 17.0242 8.74322 16.9868 8.63711L16.539 7.26037C16.4378 6.95331 16.2851 6.66664 16.0883 6.41228ZM23.7829 10.2132L23.0175 9.9646C22.7848 9.8873 22.5733 9.75683 22.3999 9.58356C22.2265 9.41029 22.0959 9.199 22.0186 8.96646L21.7698 8.20161C21.749 8.14266 21.7104 8.09161 21.6593 8.0555C21.6083 8.01939 21.5473 8 21.4847 8C21.4221 8 21.3611 8.01939 21.31 8.0555C21.259 8.09161 21.2204 8.14266 21.1996 8.20161L20.9508 8.96646C20.875 9.19736 20.7467 9.40761 20.5761 9.58076C20.4055 9.75392 20.1971 9.88529 19.9672 9.9646L19.2018 10.2132C19.1428 10.234 19.0917 10.2725 19.0555 10.3236C19.0194 10.3746 19 10.4356 19 10.4981C19 10.5606 19.0194 10.6216 19.0555 10.6726C19.0917 10.7236 19.1428 10.7622 19.2018 10.783L19.9672 11.0316C20.2003 11.1093 20.412 11.2403 20.5855 11.4143C20.7589 11.5882 20.8893 11.8003 20.9661 12.0335L21.2149 12.7984C21.2357 12.8573 21.2743 12.9084 21.3254 12.9445C21.3764 12.9806 21.4374 13 21.5 13C21.5626 13 21.6236 12.9806 21.6746 12.9445C21.7257 12.9084 21.7643 12.8573 21.7851 12.7984L22.0339 12.0335C22.1113 11.801 22.2418 11.5897 22.4152 11.4164C22.5886 11.2432 22.8001 11.1127 23.0328 11.0354L23.7982 10.7868C23.8572 10.766 23.9083 10.7275 23.9445 10.6764C23.9806 10.6254 24 10.5644 24 10.5019C24 10.4394 23.9806 10.3784 23.9445 10.3274C23.9083 10.2764 23.8572 10.2378 23.7982 10.217L23.7829 10.2132ZM12 2C12.957 2 13.8826 2.13443 14.7589 2.38542C14.6435 2.45713 14.5197 2.51549 14.39 2.55903L13.05 2.99903C12.7677 3.09976 12.5186 3.27531 12.329 3.50625C12.2199 3.5021 12.1102 3.5 12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.1949 20.5 19.68 17.4613 20.3742 13.465C20.4642 13.5981 20.5776 13.7148 20.71 13.809C20.9288 13.9654 21.191 14.0495 21.46 14.0495C21.5752 14.0495 21.6892 14.034 21.7991 14.0041C20.871 18.5665 16.8365 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2Z',
                chat_multiple_heart: 'M6.3412 8.3412C7.1326 7.5498 8.41849 7.55366 9.21333 8.3485L9.49671 8.63188L9.77626 8.35179C10.5691 7.55898 11.8556 7.56284 12.6518 8.3591C13.4468 9.15408 13.4493 10.4364 12.6597 11.2303L9.73275 14.1556C9.6107 14.2777 9.41283 14.2777 9.29079 14.1556L6.3485 11.2133C5.55366 10.4185 5.5498 9.1326 6.3412 8.3412ZM2.06158 10.5C2.06158 6.35786 5.41944 3 9.56158 3C13.7037 3 17.0616 6.35786 17.0616 10.5C17.0616 14.6421 13.7037 18 9.56158 18C8.46241 18 7.41678 17.7631 6.47447 17.337C5.44699 17.5819 4.29396 17.8587 3.54374 18.039C2.6294 18.2588 1.80697 17.428 2.03999 16.5147C2.22638 15.7842 2.5102 14.6714 2.76423 13.6734C2.31325 12.7088 2.06158 11.6329 2.06158 10.5ZM9.56158 4.5C6.24787 4.5 3.56158 7.18629 3.56158 10.5C3.56158 11.4914 3.80145 12.4246 4.22568 13.2468L4.35619 13.4998L4.28601 13.7757C4.05784 14.6724 3.79467 15.7047 3.59592 16.4838C4.39489 16.2919 5.46095 16.0363 6.38368 15.8167L6.6482 15.7537L6.89161 15.8749C7.69487 16.2748 8.60084 16.5 9.56158 16.5C12.8753 16.5 15.5616 13.8137 15.5616 10.5C15.5616 7.18629 12.8753 4.5 9.56158 4.5ZM9.46191 18.9995C10.8001 20.241 12.5922 21.0001 14.5616 21.0001C15.6611 21.0001 16.707 20.763 17.6495 20.3367C18.6933 20.581 19.8358 20.8248 20.563 20.9768C21.4554 21.1633 22.2348 20.3623 22.0304 19.4773C21.8679 18.774 21.6117 17.6821 21.3586 16.6741C21.8098 15.7094 22.0616 14.6332 22.0616 13.5001C22.0616 10.2171 19.9523 7.42684 17.015 6.41052C17.3653 7.04756 17.6363 7.73435 17.8146 8.45761C19.4676 9.52617 20.5616 11.3853 20.5616 13.5001C20.5616 14.4915 20.3217 15.4247 19.8975 16.2469L19.767 16.4999L19.8372 16.7757C20.065 17.6711 20.3037 18.6757 20.4787 19.4262C19.7046 19.2625 18.6611 19.0361 17.7395 18.8167L17.475 18.7537L17.2316 18.8749C16.4283 19.2748 15.5223 19.5001 14.5616 19.5001C13.5021 19.5001 12.5067 19.2254 11.6427 18.7434C10.9768 18.911 10.2796 19.0001 9.56163 19.0001C9.52835 19.0001 9.49511 18.9999 9.46191 18.9995Z',
                chat_help: 'M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.6944 20.5 20.5 16.6944 20.5 12C20.5 7.30558 16.6944 3.5 12 3.5ZM12 15.5C12.5523 15.5 13 15.9477 13 16.5C13 17.0523 12.5523 17.5 12 17.5C11.4477 17.5 11 17.0523 11 16.5C11 15.9477 11.4477 15.5 12 15.5ZM12 6.75C13.5188 6.75 14.75 7.98122 14.75 9.5C14.75 10.5108 14.4525 11.074 13.6989 11.8586L13.5303 12.0303C12.9084 12.6522 12.75 12.9163 12.75 13.5C12.75 13.9142 12.4142 14.25 12 14.25C11.5858 14.25 11.25 13.9142 11.25 13.5C11.25 12.4892 11.5475 11.926 12.3011 11.1414L12.4697 10.9697C13.0916 10.3478 13.25 10.0837 13.25 9.5C13.25 8.80964 12.6904 8.25 12 8.25C11.3528 8.25 10.8205 8.74187 10.7565 9.37219L10.75 9.5C10.75 9.91421 10.4142 10.25 10 10.25C9.58579 10.25 9.25 9.91421 9.25 9.5C9.25 7.98122 10.4812 6.75 12 6.75Z',
                chat_empty: 'M5.25 18C3.45507 18 2 16.5449 2 14.75V6.25C2 4.45507 3.45507 3 5.25 3H18.75C20.5449 3 22 4.45507 22 6.25V14.75C22 16.5449 20.5449 18 18.75 18H13.0125L7.99868 21.7507C7.44585 22.1642 6.6625 22.0512 6.24901 21.4984C6.08736 21.2822 6 21.0196 6 20.7499L5.99921 18H5.25ZM12.5135 16.5H18.75C19.7165 16.5 20.5 15.7165 20.5 14.75V6.25C20.5 5.2835 19.7165 4.5 18.75 4.5H5.25C4.2835 4.5 3.5 5.2835 3.5 6.25V14.75C3.5 15.7165 4.2835 16.5 5.25 16.5H7.49879L7.499 17.2498L7.49986 20.2506L12.5135 16.5Z',
                chat_bubbles_question: 'M8.14303 6.30723C8.57707 6.07535 9.04414 6.00076 9.49888 6.00073C10.0253 6.0007 10.6367 6.17363 11.1305 6.57829C11.6475 7.00192 11.9989 7.65186 11.9989 8.5C11.9989 9.47459 11.3102 10.0037 10.9219 10.302C10.8918 10.3252 10.8634 10.347 10.8373 10.3675C10.4127 10.7012 10.2489 10.8795 10.2489 11.25C10.2489 11.6642 9.91314 12 9.49892 12C9.08471 12 8.74892 11.6642 8.74892 11.25C8.74892 10.116 9.46017 9.54195 9.91052 9.18806C10.4238 8.78469 10.4989 8.69484 10.4989 8.5C10.4989 8.10296 10.3503 7.87825 10.1798 7.73853C9.98616 7.57985 9.72254 7.50072 9.49896 7.50073C9.20371 7.50075 9.00078 7.54962 8.84982 7.63027C8.70637 7.7069 8.55459 7.84146 8.40826 8.11137C8.21083 8.47551 7.7556 8.61066 7.39146 8.41324C7.02732 8.21582 6.89217 7.76058 7.08959 7.39644C7.35326 6.91012 7.70147 6.54311 8.14303 6.30723ZM9.49909 15.0001C10.0514 15.0001 10.4992 14.5524 10.4992 14.0001C10.4992 13.4477 10.0514 13 9.49909 13C8.94677 13 8.49902 13.4477 8.49902 14.0001C8.49902 14.5524 8.94677 15.0001 9.49909 15.0001ZM9.49908 3C5.35694 3 1.99908 6.35786 1.99908 10.5C1.99908 11.6329 2.25075 12.7088 2.70173 13.6734C2.4477 14.6714 2.16388 15.7842 1.97749 16.5147C1.74447 17.428 2.5669 18.2588 3.48124 18.039C4.23146 17.8587 5.38449 17.5819 6.41197 17.337C7.35428 17.7631 8.39991 18 9.49908 18C13.6412 18 16.9991 14.6421 16.9991 10.5C16.9991 6.35786 13.6412 3 9.49908 3ZM3.49908 10.5C3.49908 7.18629 6.18537 4.5 9.49908 4.5C12.8128 4.5 15.4991 7.18629 15.4991 10.5C15.4991 13.8137 12.8128 16.5 9.49908 16.5C8.53834 16.5 7.63237 16.2748 6.82911 15.8749L6.5857 15.7537L6.32118 15.8167C5.39845 16.0363 4.33239 16.2919 3.53342 16.4838C3.73217 15.7047 3.99534 14.6724 4.22351 13.7757L4.29369 13.4998L4.16318 13.2468C3.73895 12.4246 3.49908 11.4914 3.49908 10.5ZM14.4991 21.0001C12.5297 21.0001 10.7376 20.241 9.39941 18.9995C9.43261 18.9999 9.46585 19.0001 9.49913 19.0001C10.2171 19.0001 10.9143 18.911 11.5802 18.7434C12.4442 19.2254 13.4396 19.5001 14.4991 19.5001C15.4598 19.5001 16.3658 19.2748 17.1691 18.8749L17.4125 18.7537L17.677 18.8167C18.5986 19.0361 19.6421 19.2625 20.4162 19.4262C20.2412 18.6757 20.0025 17.6711 19.7747 16.7757L19.7045 16.4999L19.835 16.2469C20.2592 15.4247 20.4991 14.4915 20.4991 13.5001C20.4991 11.3853 19.4051 9.52617 17.7521 8.45761C17.5738 7.73435 17.3028 7.04756 16.9525 6.41052C19.8898 7.42684 21.9991 10.2171 21.9991 13.5001C21.9991 14.6332 21.7473 15.7094 21.2961 16.6741C21.5492 17.6821 21.8054 18.774 21.9679 19.4773C22.1723 20.3623 21.3929 21.1633 20.5005 20.9768C19.7733 20.8248 18.6308 20.581 17.587 20.3367C16.6445 20.763 15.5986 21.0001 14.4991 21.0001Z',
                chat: 'M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C10.3817 22 8.81782 21.6146 7.41286 20.888L3.58704 21.9553C2.92212 22.141 2.23258 21.7525 2.04691 21.0876C1.98546 20.8676 1.98549 20.6349 2.04695 20.4151L3.11461 16.5922C2.38637 15.186 2 13.6203 2 12C2 6.47715 6.47715 2 12 2ZM12 3.5C7.30558 3.5 3.5 7.30558 3.5 12C3.5 13.4696 3.87277 14.8834 4.57303 16.1375L4.72368 16.4072L3.61096 20.3914L7.59755 19.2792L7.86709 19.4295C9.12006 20.1281 10.5322 20.5 12 20.5C16.6944 20.5 20.5 16.6944 20.5 12C20.5 7.30558 16.6944 3.5 12 3.5Z',
                bot: 'M17.7534 13.9994C18.9961 13.9994 20.0034 15.0068 20.0034 16.2494V17.1545C20.0034 18.2482 19.526 19.2874 18.6961 19.9998C17.1307 21.3437 14.8904 22.0006 12.0004 22.0006C9.11087 22.0006 6.87205 21.344 5.30918 20.0003C4.48056 19.2879 4.00391 18.2495 4.00391 17.1567V16.2494C4.00391 15.0068 5.01127 13.9994 6.25391 13.9994H17.7534ZM17.7534 15.4994H6.25391C5.83969 15.4994 5.50391 15.8352 5.50391 16.2494V17.1567C5.50391 17.8124 5.7899 18.4354 6.28707 18.8629C7.54516 19.9445 9.44117 20.5006 12.0004 20.5006C14.5603 20.5006 16.4582 19.9442 17.7191 18.8617C18.2169 18.4342 18.5034 17.8107 18.5034 17.1545V16.2494C18.5034 15.8352 18.1676 15.4994 17.7534 15.4994ZM11.8989 2.00685L12.0007 2C12.3804 2 12.6942 2.28215 12.7438 2.64823L12.7507 2.75L12.7499 3.499L16.2504 3.49951C17.493 3.49951 18.5004 4.50687 18.5004 5.74951V10.2541C18.5004 11.4967 17.493 12.5041 16.2504 12.5041H7.75036C6.50772 12.5041 5.50036 11.4967 5.50036 10.2541V5.74951C5.50036 4.50687 6.50772 3.49951 7.75036 3.49951L11.2499 3.499L11.2507 2.75C11.2507 2.3703 11.5328 2.05651 11.8989 2.00685L12.0007 2L11.8989 2.00685ZM16.2504 4.99951H7.75036C7.33615 4.99951 7.00036 5.33529 7.00036 5.74951V10.2541C7.00036 10.6683 7.33615 11.0041 7.75036 11.0041H16.2504C16.6646 11.0041 17.0004 10.6683 17.0004 10.2541V5.74951C17.0004 5.33529 16.6646 4.99951 16.2504 4.99951ZM9.74965 6.49951C10.4396 6.49951 10.9989 7.05883 10.9989 7.74879C10.9989 8.43876 10.4396 8.99808 9.74965 8.99808C9.05969 8.99808 8.50036 8.43876 8.50036 7.74879C8.50036 7.05883 9.05969 6.49951 9.74965 6.49951ZM14.2424 6.49951C14.9324 6.49951 15.4917 7.05883 15.4917 7.74879C15.4917 8.43876 14.9324 8.99808 14.2424 8.99808C13.5524 8.99808 12.9931 8.43876 12.9931 7.74879C12.9931 7.05883 13.5524 6.49951 14.2424 6.49951Z',
                bot_sparkle: 'M18.5004 10.2546C18.5004 10.2994 18.4991 10.3438 18.4965 10.3879C18.4546 10.3508 18.4105 10.3159 18.3645 10.2834C18.1037 10.099 17.7921 10 17.4728 10C17.3115 10 17.1522 10.0253 17.0004 10.074V5.74999C17.0004 5.33578 16.6646 4.99999 16.2504 4.99999H7.75036C7.33615 4.99999 7.00036 5.33578 7.00036 5.74999V10.2546C7.00036 10.6688 7.33615 11.0046 7.75036 11.0046H16.0258L16.0166 11.03L16.0125 11.0417L15.5622 12.426L15.5534 12.4524C15.5474 12.4699 15.5411 12.4873 15.5345 12.5046H7.75036C6.50772 12.5046 5.50036 11.4972 5.50036 10.2546V5.74999C5.50036 4.50735 6.50772 3.49999 7.75036 3.49999L11.2499 3.49949L11.2507 2.75049C11.2507 2.37079 11.5328 2.057 11.8989 2.00733L12.0007 2.00049C12.3804 2.00049 12.6942 2.28264 12.7438 2.64872L12.7507 2.75049L12.7499 3.49949L16.2504 3.49999C17.493 3.49999 18.5004 4.50735 18.5004 5.74999V10.2546ZM13.0428 14.0365L13.1554 13.9999H6.25391C5.01127 13.9999 4.00391 15.0073 4.00391 16.2499V17.1572C4.00391 18.25 4.48056 19.2884 5.30918 20.0008C6.87205 21.3445 9.11087 22.0011 12.0004 22.0011C14.0763 22.0011 15.8171 21.6621 17.2132 20.9731C16.9968 20.9321 16.7904 20.8451 16.6087 20.7166C16.3478 20.5322 16.1506 20.2714 16.0442 19.97L16.04 19.9583L16.0096 19.8646C14.9245 20.2865 13.5901 20.5011 12.0004 20.5011C9.44117 20.5011 7.54516 19.945 6.28707 18.8634C5.7899 18.4359 5.50391 17.8129 5.50391 17.1572V16.2499C5.50391 15.8357 5.83969 15.4999 6.25391 15.4999H12.0004L12.0004 15.4966C12.0004 15.1769 12.0996 14.8653 12.2843 14.6045C12.4689 14.3438 12.7299 14.1468 13.0311 14.0406L13.0428 14.0365ZM10.9989 7.74928C10.9989 7.05932 10.4396 6.49999 9.74965 6.49999C9.05969 6.49999 8.50036 7.05932 8.50036 7.74928C8.50036 8.43925 9.05969 8.99857 9.74965 8.99857C10.4396 8.99857 10.9989 8.43925 10.9989 7.74928ZM14.2424 6.49999C14.9324 6.49999 15.4917 7.05932 15.4917 7.74928C15.4917 8.43925 14.9324 8.99857 14.2424 8.99857C13.5524 8.99857 12.9931 8.43925 12.9931 7.74928C12.9931 7.05932 13.5524 6.49999 14.2424 6.49999ZM16.0886 17.4123C16.0163 17.3189 15.9381 17.2298 15.8542 17.1457C15.5421 16.8326 15.161 16.5967 14.7413 16.4568L13.3635 16.0094C13.2573 15.972 13.1654 15.9025 13.1003 15.8107C13.0353 15.7188 13.0004 15.6091 13.0004 15.4966C13.0004 15.384 13.0353 15.2743 13.1003 15.1824C13.1654 15.0906 13.2573 15.0212 13.3635 14.9837L14.7413 14.5363C15.1551 14.3935 15.5302 14.1571 15.8374 13.8454C16.1361 13.5422 16.3626 13.1759 16.5004 12.7737L16.5118 12.7396L16.9596 11.3629C16.997 11.2568 17.0665 11.1649 17.1584 11.0999C17.2504 11.0349 17.3602 11 17.4728 11C17.5854 11 17.6953 11.0349 17.7872 11.0999C17.8791 11.1649 17.9486 11.2568 17.986 11.3629L18.4338 12.7396C18.5731 13.1582 18.8081 13.5385 19.1202 13.8504C19.4323 14.1623 19.813 14.3971 20.2318 14.5363L21.6096 14.9837L21.6372 14.9906C21.7434 15.028 21.8353 15.0975 21.9004 15.1893C21.9654 15.2812 22.0004 15.3909 22.0004 15.5034C22.0004 15.616 21.9654 15.7257 21.9004 15.8176C21.8353 15.9094 21.7434 15.9788 21.6372 16.0163L20.2594 16.4637C19.8405 16.6029 19.4599 16.8377 19.1478 17.1496C18.8356 17.4615 18.6006 17.8418 18.4614 18.2604L18.0136 19.6371C18.0096 19.6486 18.0051 19.6598 18.0004 19.6709C17.9609 19.7627 17.8967 19.8421 17.8147 19.9001C17.7228 19.9651 17.613 20 17.5004 20C17.3878 20 17.2779 19.9651 17.186 19.9001C17.0941 19.8351 17.0246 19.7432 16.9871 19.6371L16.5394 18.2604C16.4382 17.9533 16.2855 17.6666 16.0886 17.4123ZM23.7833 21.2132L23.0179 20.9646C22.7851 20.8873 22.5737 20.7568 22.4003 20.5836C22.2269 20.4103 22.0963 20.199 22.019 19.9665L21.7702 19.2016C21.7494 19.1427 21.7108 19.0916 21.6597 19.0555C21.6086 19.0194 21.5476 19 21.4851 19C21.4225 19 21.3615 19.0194 21.3104 19.0555C21.2593 19.0916 21.2207 19.1427 21.1999 19.2016L20.9512 19.9665C20.8753 20.1974 20.7471 20.4076 20.5765 20.5808C20.4058 20.7539 20.1974 20.8853 19.9676 20.9646L19.2021 21.2132C19.1431 21.234 19.092 21.2725 19.0559 21.3236C19.0198 21.3746 19.0004 21.4356 19.0004 21.4981C19.0004 21.5606 19.0198 21.6216 19.0559 21.6726C19.092 21.7236 19.1431 21.7622 19.2021 21.783L19.9676 22.0316C20.2007 22.1093 20.4124 22.2403 20.5858 22.4143C20.7593 22.5882 20.8896 22.8003 20.9665 23.0335L21.2152 23.7984C21.2361 23.8573 21.2747 23.9084 21.3257 23.9445C21.3768 23.9806 21.4378 24 21.5004 24C21.5629 24 21.6239 23.9806 21.675 23.9445C21.7261 23.9084 21.7647 23.8573 21.7855 23.7984L22.0343 23.0335C22.1116 22.801 22.2422 22.5897 22.4156 22.4164C22.589 22.2432 22.8005 22.1127 23.0332 22.0354L23.7986 21.7868C23.8576 21.766 23.9087 21.7275 23.9448 21.6764C23.981 21.6254 24.0004 21.5644 24.0004 21.5019C24.0004 21.4394 23.981 21.3784 23.9448 21.3274C23.9087 21.2764 23.8576 21.2378 23.7986 21.217L23.7833 21.2132Z'
            };
            
            // Get the SVG path for the selected launcher icon
            const selectedIconPath = iconSvgPaths[config.launcherIcon] || iconSvgPaths.chat_multiple;
            
            // Font family CSS mapping
            const fontFamilyCss = {
                'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                'inter': '"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                'roboto': '"Roboto", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                'poppins': '"Poppins", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                'open-sans': '"Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                'lato': '"Lato", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                'nunito': '"Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
            };
            const selectedFontFamily = fontFamilyCss[config.fontFamily] || fontFamilyCss.system;
            
            // Google Font link if needed
            const googleFontLinks = {
                'inter': 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap',
                'roboto': 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap',
                'poppins': 'https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap',
                'open-sans': 'https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap',
                'lato': 'https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap',
                'nunito': 'https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap'
            };
            const googleFontLink = googleFontLinks[config.fontFamily] || '';
            
            // Generate a fully self-contained embed code with ALL features from live.html
            const embedCode = `<!-- D365 Modern Chat Widget - Full Featured Self-Contained Embed -->
<!-- Generated: ${new Date().toLocaleDateString()} -->
<!-- Simply copy this entire block and paste it into your HTML page -->
<!-- Features: Emoji picker, File attachments, Voice recording, Sound toggle, Minimize, Close -->
${googleFontLink ? `\n<!-- Google Font -->\n<link href="${googleFontLink}" rel="stylesheet">` : ''}

<script>
(function() {
  'use strict';
  
  // Widget Configuration
  var config = ${configJson};
  
  // Launcher icon SVG path for selected icon: ${config.launcherIcon}
  var launcherIconPath = '${selectedIconPath}';
  
  // Font family
  var fontFamily = '${selectedFontFamily}';
  
  // Emojis for picker
  var emojis = [
    '', '', '', '', '', '', '', '',
    '', '', '', '', '', '', '', '',
    '', '', '', '', '', '', '', '',
    '', '', '', '', '', '', '', '',
    '', '', '', '', '', '', '', '',
    '', '', '', '', '', '', '', '',
    '', '', '', '', '', '', '', '',
    '', '', '', '', '', '', '', ''
  ];
  
  // Main initialization function - called when DOM is ready
  function initD365Widget() {
    // Inject CSS Styles - Full featured version matching live.html
    var style = document.createElement('style');
    style.textContent = \`
    /* Hide the native D365 Omnichannel widget - we use it as backend only */
    #Microsoft_Omnichannel_LCWidget_Chat_Iframe_Window,
    #oc-lcw-chat-button,
    [id^="Microsoft_Omnichannel"],
    .oc-lcw-widget,
    .oc-lcw-chat-button,
    .oc-lcw-chat-button-container,
    .oc-lcw-chat-widget,
    .lcw-chat-button,
    .lcw-components,
    [class^="lcw-"],
    [class*=" lcw-"],
    iframe[id*="Omnichannel"],
    iframe[id*="lcw"],
    iframe[title*="Omnichannel"],
    iframe[title*="Live Chat"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
      width: 0 !important;
      height: 0 !important;
      position: absolute !important;
      left: -9999px !important;
    }
    @keyframes d365pulse {
      0% { box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 0 rgba(102,126,234,0.4); }
      50% { box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 12px rgba(102,126,234,0); }
      100% { box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 0 rgba(102,126,234,0); }
    }
    .d365-chat-launcher {
      position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px;
      border-radius: 50%; border: none; cursor: pointer; z-index: 999999;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      background: \${config.useGradient ? 'linear-gradient(135deg, ' + config.gradientStart + ' 0%, ' + config.gradientEnd + ' 100%)' : config.launcherColor};
      animation: d365pulse 2.5s ease-in-out infinite;
    }
    .d365-chat-launcher:hover { transform: scale(1.1); box-shadow: 0 6px 30px rgba(0,0,0,0.4); animation: none; }
    .d365-chat-launcher.open { animation: none; }
    .d365-chat-launcher svg { width: 28px; height: 28px; fill: white; }
    .d365-chat-launcher .chat-icon { display: block; }
    .d365-chat-launcher .close-icon { display: none; }
    .d365-chat-launcher.open .chat-icon { display: none; }
    .d365-chat-launcher.open .close-icon { display: block; }
    .d365-chat-badge {
      position: absolute; top: -4px; right: -4px; background: \${config.badgeColor};
      color: white; font-size: 11px; font-weight: 700; min-width: 20px; height: 20px;
      border-radius: 10px; display: flex; align-items: center; justify-content: center;
      opacity: 0; transform: scale(0); transition: all 0.2s ease;
    }
    .d365-chat-badge.show { opacity: 1; transform: scale(1); }
    .d365-chat-container {
      position: fixed; bottom: 100px; right: 24px; width: 400px; height: 700px;
      max-height: calc(100vh - 120px); background: white; border-radius: 16px;
      box-shadow: 0 10px 50px rgba(0,0,0,0.2); display: flex; flex-direction: column;
      overflow: hidden; opacity: 0; transform: translateY(20px) scale(0.95);
      transition: all 0.3s ease; pointer-events: none; z-index: 999998;
      font-family: \${fontFamily};
    }
    .d365-chat-container.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
    .d365-chat-header {
      padding: 16px 20px; display: flex; align-items: center; gap: 12px;
      background: \${config.useGradient ? 'linear-gradient(135deg, ' + config.gradientStart + ' 0%, ' + config.gradientEnd + ' 100%)' : config.primaryColor};
    }
    .d365-header-avatar {
      width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.2);
      display: flex; align-items: center; justify-content: center; overflow: hidden;
      border: 2px solid rgba(255,255,255,0.5);
    }
    .d365-header-avatar svg { width: 26px; height: 26px; fill: white; }
    .d365-header-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .d365-header-info { flex: 1; }
    .d365-header-title { color: white; font-weight: 600; font-size: 16px; }
    .d365-header-status { color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 2px; }
    .d365-header-actions { display: flex; gap: 8px; }
    .d365-header-btn {
      background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px;
      border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: background 0.2s; position: relative;
    }
    .d365-header-btn:hover { background: rgba(255,255,255,0.3); }
    .d365-header-btn svg { width: 18px; height: 18px; fill: white; }
    .d365-header-btn.sound-off svg { opacity: 0.5; }
    .d365-header-btn.sound-off::after {
      content: ''; position: absolute; width: 2px; height: 20px;
      background: white; transform: rotate(45deg); border-radius: 1px;
    }
    .d365-chat-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .d365-prechat-form {
      display: flex; flex-direction: column; flex: 1; overflow-y: auto;
    }
    .d365-prechat-form.hidden { display: none; }
    
    /* Pre-chat Hero Section */
    .d365-prechat-hero {
      background: \${config.usePrechatGradient !== false ? 'linear-gradient(135deg, ' + (config.prechatGradientStart || '#667eea') + ' 0%, ' + (config.prechatGradientEnd || '#764ba2') + ' 100%)' : (config.prechatSolidColor || '#667eea')};
      padding: 32px 24px 28px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .d365-prechat-hero::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 200%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: d365shimmer 3s infinite;
    }
    @keyframes d365shimmer { 0% { left: -100%; } 100% { left: 100%; } }
    .d365-prechat-hero-content { position: relative; z-index: 1; }
    .d365-prechat-avatar-group { position: relative; display: flex; justify-content: center; margin-bottom: 16px; }
    .d365-prechat-avatar {
      width: 48px; height: 48px; border-radius: 50%; border: 3px solid \${config.prechatAvatarBorder || 'rgba(255,255,255,0.9)'};
      background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;
      margin: 0 -8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden;
    }
    .d365-prechat-avatar:first-child { z-index: 3; }
    .d365-prechat-avatar:nth-child(2) { z-index: 2; }
    .d365-prechat-avatar:nth-child(3) { z-index: 1; }
    .d365-prechat-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .d365-prechat-avatar svg { width: 24px; height: 24px; fill: white; }
    .d365-prechat-status {
      position: absolute; top: 0; right: 0; display: flex; align-items: center; gap: 5px;
      background: \${config.prechatBadgeBg || 'rgba(255,255,255,0.2)'}; padding: 6px 12px 6px 8px;
      border-radius: 20px; font-size: 12px; color: \${config.prechatBadgeText || 'white'}; font-weight: 500; white-space: nowrap;
    }
    .d365-prechat-status-dot {
      width: 8px; height: 8px; background: \${config.prechatStatusDot || '#10b981'}; border-radius: 50%;
      animation: d365pulseDot 1.5s ease-in-out infinite; box-shadow: 0 0 0 2px \${config.prechatStatusDot || '#10b981'}4d;
    }
    @keyframes d365pulseDot { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
    .d365-prechat-hero-title { font-size: 22px; font-weight: 700; color: \${config.prechatTitleColor || 'white'}; margin-bottom: 8px; letter-spacing: -0.3px; }
    .d365-prechat-hero-subtitle { font-size: 14px; color: \${config.prechatSubtitleColor || 'rgba(255,255,255,0.9)'}; line-height: 1.5; }
    
    /* Pre-chat Form Body */
    .d365-prechat-form-body { padding: 24px; display: flex; flex-direction: column; gap: 16px; flex: 1; }
    .d365-form-title { font-size: 18px; font-weight: 600; color: #1f2937; }
    .d365-form-subtitle { font-size: 13px; color: #6b7280; margin-bottom: 8px; }
    .d365-form-group { display: flex; flex-direction: column; gap: 6px; width: 100%; }
    .d365-form-group label { font-size: 13px; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 4px; }
    .d365-form-group label .required { color: #ef4444; }
    .d365-form-group input, .d365-form-group textarea {
      width: 100%; box-sizing: border-box; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 12px;
      font-size: 14px; transition: all 0.2s ease; font-family: inherit; background: #f9fafb;
    }
    .d365-form-group input:hover, .d365-form-group textarea:hover { border-color: #d1d5db; background: white; }
    .d365-form-group input:focus, .d365-form-group textarea:focus {
      outline: none; border-color: \${config.primaryColor}; box-shadow: 0 0 0 4px \${config.primaryColor}1a; background: white;
    }
    .d365-form-group input::placeholder, .d365-form-group textarea::placeholder { color: #9ca3af; }
    .d365-form-group textarea { resize: none; min-height: 80px; }
    .d365-input-with-icon { position: relative; width: 100%; }
    .d365-input-with-icon input { padding-left: 44px; width: 100%; }
    .d365-input-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: #9ca3af; pointer-events: none; }
    .d365-start-btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      color: white; border: none; padding: 14px 24px; border-radius: 12px; font-size: 15px;
      font-weight: 600; cursor: pointer; margin-top: 8px; box-shadow: 0 4px 14px rgba(0,0,0,0.15);
      background: \${config.useGradient ? 'linear-gradient(135deg, ' + config.gradientStart + ' 0%, ' + config.gradientEnd + ' 100%)' : config.primaryColor};
      transition: all 0.2s ease;
    }
    .d365-start-btn svg { width: 18px; height: 18px; fill: white; }
    .d365-start-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
    .d365-start-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .d365-connecting-view, .d365-chat-ended {
      display: none; flex-direction: column; align-items: center; justify-content: center;
      flex: 1; gap: 16px; padding: 24px; text-align: center;
    }
    .d365-connecting-view.active, .d365-chat-ended.active { display: flex; }
    .d365-spinner {
      width: 48px; height: 48px; border: 3px solid #e2e8f0; border-top-color: \${config.primaryColor};
      border-radius: 50%; animation: d365spin 1s linear infinite;
    }
    @keyframes d365spin { to { transform: rotate(360deg); } }
    .d365-chat-messages {
      display: none; flex-direction: column; flex: 1; overflow-y: auto;
      padding: 16px; gap: 12px; background: \${config.chatBgColor}; scroll-behavior: smooth;
    }
    .d365-chat-messages.active { display: flex; }
    .d365-message-wrapper { display: flex; gap: 10px; max-width: 85%; animation: d365fadeIn 0.3s ease; align-items: flex-start; }
    .d365-message-wrapper.user { flex-direction: row-reverse; align-self: flex-end; }
    .d365-message-wrapper.agent { align-self: flex-start; }
    @keyframes d365fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .d365-message-avatar {
      width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-weight: 600; font-size: 13px; flex-shrink: 0; overflow: hidden;
      margin-top: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      border: 2px solid transparent; transition: transform 0.2s ease;
    }
    .d365-message-avatar:hover { transform: scale(1.05); }
    .d365-message-avatar.agent { background: linear-gradient(135deg, \${config.gradientStart} 0%, \${config.gradientEnd} 100%); color: white; border-color: rgba(102,126,234,0.3); }
    .d365-message-avatar.bot { background: linear-gradient(135deg, #00b4d8 0%, #0077b6 100%); color: white; border-color: rgba(0,180,216,0.3); }
    .d365-message-avatar.user { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-color: rgba(17,153,142,0.3); }
    .d365-message-avatar:has(img) { background: transparent !important; }
    .d365-message-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .d365-message-content { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
    .d365-message-sender { font-size: 12px; font-weight: 600; color: #64748b; padding: 0 4px; }
    .d365-message-wrapper.user .d365-message-sender { text-align: right; }
    .d365-message {
      padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.6;
      word-wrap: break-word; white-space: normal;
    }
    .d365-message.agent { background: \${config.agentBubbleColor}; color: \${config.agentTextColor}; border-bottom-left-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .d365-message.user { background: \${config.useBubbleGradient ? 'linear-gradient(135deg, ' + config.gradientStart + ' 0%, ' + config.gradientEnd + ' 100%)' : config.userBubbleColor}; color: \${config.userTextColor}; border-bottom-right-radius: 4px; }
    .d365-message.system { align-self: center; background: \${config.systemMsgColor}; color: \${config.systemTextColor}; font-size: 12px; padding: 6px 12px; border-radius: 12px; max-width: none; }
    
    /* Enhanced Markdown Rendering */
    .d365-message.agent h1, .d365-message.agent h2, .d365-message.agent h3, .d365-message.agent h4 {
      margin: 16px 0 8px 0; font-weight: 600; line-height: 1.3; color: #1e293b;
    }
    .d365-message.agent h1:first-child, .d365-message.agent h2:first-child, .d365-message.agent h3:first-child { margin-top: 0; }
    .d365-message.agent h1 { font-size: 18px; }
    .d365-message.agent h2 { font-size: 16px; }
    .d365-message.agent h3 { font-size: 15px; }
    .d365-message.agent p { margin: 8px 0; }
    .d365-message.agent p:first-child { margin-top: 0; }
    .d365-message.agent p:last-child { margin-bottom: 0; }
    .d365-message.agent strong { font-weight: 600; color: #1e293b; }
    .d365-message.agent em { font-style: italic; }
    .d365-message.agent code { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px; color: #7c3aed; }
    .d365-message.agent pre { background: #1e293b; color: #e2e8f0; padding: 12px 16px; border-radius: 8px; overflow-x: auto; margin: 12px 0; }
    .d365-message.agent pre code { background: none; padding: 0; color: inherit; }
    .d365-message.agent ul, .d365-message.agent ol { margin: 8px 0; padding-left: 20px; }
    .d365-message.agent li { margin: 4px 0; line-height: 1.5; }
    .d365-message.agent li::marker { color: \${config.primaryColor}; }
    .d365-message.agent hr { border: none; border-top: 1px solid #e2e8f0; margin: 16px 0; }
    .d365-message.agent a { color: #6366f1; text-decoration: none; border-bottom: 1px dotted #a5b4fc; transition: all 0.2s; }
    .d365-message.agent a:hover { color: #4f46e5; border-bottom-color: #6366f1; }
    .d365-message.agent .cite-link { display: inline-flex; align-items: center; justify-content: center; min-width: 16px; height: 16px; padding: 0 4px; font-size: 10px; font-weight: 600; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 4px; text-decoration: none; border: none; vertical-align: super; margin: 0 1px; transition: all 0.2s; cursor: pointer; }
    .d365-message.agent .cite-link:hover { transform: scale(1.1); box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4); }
    .message-sources { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0; }
    .sources-toggle { display: flex; align-items: center; gap: 8px; background: none; border: none; cursor: pointer; font-size: 12px; font-weight: 600; color: #64748b; padding: 6px 10px; border-radius: 6px; transition: all 0.2s; }
    .sources-toggle:hover { background: #f1f5f9; color: #475569; }
    .sources-toggle svg { width: 14px; height: 14px; fill: currentColor; transition: transform 0.2s; }
    .sources-toggle.expanded svg { transform: rotate(180deg); }
    .sources-count { background: #e0e7ff; color: #4f46e5; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; }
    .sources-list { display: none; margin-top: 8px; padding: 0; list-style: none; }
    .sources-list.show { display: block; }
    .source-item { display: flex; gap: 10px; padding: 10px 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 6px; transition: all 0.2s; border: 1px solid transparent; }
    .source-item:hover { background: #f1f5f9; border-color: #e2e8f0; }
    .source-item:last-child { margin-bottom: 0; }
    .source-number { flex-shrink: 0; width: 20px; height: 20px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; }
    .source-content { flex: 1; min-width: 0; }
    .source-title { font-size: 13px; font-weight: 500; color: #1e293b; margin-bottom: 2px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .source-url { font-size: 11px; color: #6366f1; text-decoration: none; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .source-url:hover { text-decoration: underline; }
    .source-domain { font-size: 11px; color: #94a3b8; display: flex; align-items: center; gap: 4px; }
    .source-domain svg { width: 12px; height: 12px; fill: currentColor; }
    
    .d365-message-time { font-size: 10px; color: #94a3b8; padding: 0 4px; }
    .d365-message-wrapper.user .d365-message-time { text-align: right; }
    .d365-message-image { max-width: 200px; max-height: 200px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; object-fit: contain; }
    .d365-message-image:hover { transform: scale(1.02); }
    
    /* Adaptive Card Styles */
    .d365-adaptive-card { background: #ffffff !important; padding: 0 !important; overflow: hidden; border-radius: 12px; }
    .d365-adaptive-card .ac-adaptiveCard { background: transparent !important; }
    .d365-adaptive-card .ac-container { padding: 12px; }
    .d365-adaptive-card .ac-textBlock { margin-bottom: 8px; }
    .d365-adaptive-card .ac-actionSet { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
    .d365-adaptive-card .ac-pushButton {
      padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500;
      cursor: pointer; transition: all 0.2s; border: none; min-width: 80px;
    }
    .d365-adaptive-card .ac-pushButton.style-positive { background: \${config.primaryColor}; color: white; }
    .d365-adaptive-card .ac-pushButton.style-positive:hover { opacity: 0.9; }
    .d365-adaptive-card .ac-pushButton.style-destructive { background: #ef4444; color: white; }
    .d365-adaptive-card .ac-pushButton.style-destructive:hover { background: #dc2626; }
    .d365-adaptive-card .ac-pushButton.style-default, .d365-adaptive-card .ac-pushButton:not([class*="style-"]) {
      background: #f1f5f9; color: #374151; border: 1px solid #e2e8f0;
    }
    .d365-adaptive-card .ac-pushButton.style-default:hover { background: #e2e8f0; }
    .d365-adaptive-card .ac-input { 
      width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;
      font-size: 14px; margin-bottom: 8px;
    }
    .d365-adaptive-card .ac-input:focus { outline: none; border-color: \${config.primaryColor}; }
    
    /* Suggested Actions Styles */
    .d365-suggested-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .d365-suggested-btn {
      padding: 8px 16px; background: #f1f5f9; border: 1px solid #e2e8f0;
      border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.2s;
      color: \${config.primaryColor}; font-weight: 500;
    }
    .d365-suggested-btn:hover { background: \${config.primaryColor}; color: white; border-color: \${config.primaryColor}; }
    .d365-suggested-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .d365-typing-indicator { display: none; padding: 8px 0; align-items: center; gap: 8px; }
    .d365-typing-indicator.active { display: flex; }
    .d365-typing-dots { display: flex; gap: 4px; padding: 12px 16px; background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-left: 46px; }
    .d365-typing-dots span { width: 8px; height: 8px; background: #a0aec0; border-radius: 50%; animation: d365bounce 1.4s infinite ease-in-out; }
    .d365-typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .d365-typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes d365bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    .d365-chat-input-area {
      display: none; background: \${config.inputBgColor};
      border-top: 1px solid \${config.inputBorderColor}; position: relative;
    }
    .d365-chat-input-area.active { display: block; }
    .d365-chat-input-wrapper {
      padding: 12px 16px;
    }
    .d365-message-input {
      width: 100%; padding: 10px 14px; background: #f1f5f9; border: none;
      border-radius: 12px; font-size: 14px; font-family: inherit; outline: none;
      resize: none; min-height: 44px; max-height: 120px;
    }
    .d365-message-input:focus { background: #e2e8f0; }
    .d365-message-input::placeholder { color: #64748b; }
    .d365-input-bottom-row {
      display: flex; justify-content: space-between; align-items: center; margin-top: 8px;
    }
    .d365-input-actions {
      display: flex; gap: 8px;
    }
    .d365-action-btn {
      width: 36px; height: 36px; border-radius: 50%; background: #f1f5f9;
      border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease;
    }
    .d365-action-btn:hover { background: #e2e8f0; }
    .d365-action-btn svg { width: 20px; height: 20px; fill: #64748b; }
    
    /* Visually hidden file input (Edge-safe approach) */
    .d365-visually-hidden-input {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
    }
    /* File label styled as action button */
    .d365-file-label { display: flex !important; }
    .d365-file-label:focus-within { outline: 2px solid #667eea; outline-offset: 2px; }
    
    /* Drag and drop overlay */
    .d365-drop-zone-overlay {
      display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(102, 126, 234, 0.95); border-radius: 0 0 16px 16px;
      z-index: 100; align-items: center; justify-content: center; pointer-events: none;
    }
    .d365-drop-zone-overlay.active { display: flex; }
    .d365-drop-zone-content { text-align: center; color: white; }
    .d365-drop-zone-content svg { margin-bottom: 8px; opacity: 0.9; }
    .d365-drop-zone-content p { font-size: 16px; font-weight: 500; margin: 0; }
    .d365-send-btn {
      width: 36px; height: 36px; border-radius: 50%; background: \${config.sendBtnColor};
      border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease; flex-shrink: 0;
    }
    .d365-send-btn:hover { opacity: 0.9; transform: scale(1.05); }
    .d365-send-btn:active { transform: scale(0.95); }
    .d365-send-btn svg { width: 18px; height: 18px; fill: white; }
    .d365-emoji-picker {
      position: absolute; bottom: 100%; left: 12px; width: 300px; max-height: 250px;
      background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 12px; display: none; z-index: 100; overflow: hidden;
    }
    .d365-emoji-picker.show { display: block; }
    .d365-emoji-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; max-height: 200px; overflow-y: auto; padding-right: 4px; }
    .d365-emoji-item {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; border-radius: 6px; font-size: 20px; transition: background 0.2s; border: none; background: transparent;
    }
    .d365-emoji-item:hover { background: #f1f5f9; transform: scale(1.1); }
    .d365-voice-recording {
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: #ef4444; color: white; padding: 10px 20px; border-radius: 24px;
      display: none; align-items: center; gap: 10px; font-size: 14px; font-weight: 500;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
    }
    .d365-voice-recording.show { display: flex; animation: d365slideUp 0.3s ease; }
    @keyframes d365slideUp { from { opacity: 0; transform: translateX(-50%) translateY(10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .d365-voice-dot { width: 10px; height: 10px; background: white; border-radius: 50%; animation: d365pulseDot 1s infinite; }
    @keyframes d365pulseDot { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }
    .d365-voice-waveform { display: flex; gap: 2px; align-items: center; }
    .d365-voice-waveform span { width: 3px; background: white; border-radius: 2px; animation: d365wave 0.6s infinite ease-in-out; }
    .d365-voice-waveform span:nth-child(1) { height: 8px; animation-delay: 0s; }
    .d365-voice-waveform span:nth-child(2) { height: 16px; animation-delay: 0.1s; }
    .d365-voice-waveform span:nth-child(3) { height: 12px; animation-delay: 0.2s; }
    .d365-voice-waveform span:nth-child(4) { height: 20px; animation-delay: 0.3s; }
    .d365-voice-waveform span:nth-child(5) { height: 12px; animation-delay: 0.4s; }
    @keyframes d365wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.5); } }
    .d365-stop-voice-btn {
      background: rgba(255,255,255,0.2); border: none; padding: 6px 12px;
      border-radius: 6px; color: white; cursor: pointer; font-size: 12px; font-weight: 500;
    }
    .d365-stop-voice-btn:hover { background: rgba(255,255,255,0.3); }
    .d365-confirm-modal {
      position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: none;
      align-items: center; justify-content: center; z-index: 200;
    }
    .d365-confirm-modal.show { display: flex; }
    .d365-confirm-content { background: white; padding: 24px; border-radius: 16px; text-align: center; max-width: 280px; margin: 20px; }
    .d365-confirm-title { font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 8px; }
    .d365-confirm-text { font-size: 14px; color: #64748b; margin-bottom: 20px; }
    .d365-confirm-buttons { display: flex; gap: 12px; justify-content: center; }
    .d365-confirm-btn { padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
    .d365-confirm-btn.cancel { background: #e2e8f0; color: #4a5568; }
    .d365-confirm-btn.cancel:hover { background: #cbd5e1; }
    .d365-confirm-btn.end { background: #ef4444; color: white; }
    .d365-confirm-btn.end:hover { background: #dc2626; }
    
    /* Image Preview Modal */
    .d365-image-preview-modal {
      position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: none;
      flex-direction: column; z-index: 250;
    }
    .d365-image-preview-modal.show { display: flex; }
    .d365-image-preview-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; background: rgba(0,0,0,0.3);
    }
    .d365-image-preview-title { color: white; font-size: 14px; font-weight: 500; }
    .d365-image-preview-close {
      background: rgba(255,255,255,0.2); border: none; border-radius: 50%;
      width: 36px; height: 36px; cursor: pointer; display: flex;
      align-items: center; justify-content: center; transition: background 0.2s;
    }
    .d365-image-preview-close:hover { background: rgba(255,255,255,0.3); }
    .d365-image-preview-close svg { width: 20px; height: 20px; fill: white; }
    .d365-image-preview-body {
      flex: 1; display: flex; align-items: center; justify-content: center;
      padding: 20px; overflow: hidden;
    }
    .d365-image-preview-img {
      max-width: 100%; max-height: 100%; object-fit: contain;
      border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .d365-image-preview-footer { padding: 16px 20px; background: white; border-radius: 16px 16px 0 0; }
    .d365-image-preview-caption {
      width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0;
      border-radius: 8px; font-size: 14px; resize: none; margin-bottom: 12px;
      font-family: inherit; box-sizing: border-box;
    }
    .d365-image-preview-caption:focus { outline: none; border-color: #667eea; }
    .d365-image-preview-actions { display: flex; gap: 12px; justify-content: flex-end; }
    .d365-image-preview-btn {
      padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 500;
      cursor: pointer; transition: all 0.2s; border: none;
    }
    .d365-image-preview-btn.cancel { background: #e2e8f0; color: #4a5568; }
    .d365-image-preview-btn.cancel:hover { background: #cbd5e1; }
    .d365-image-preview-btn.send { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .d365-image-preview-btn.send:hover { opacity: 0.9; transform: translateY(-1px); }
    
    .d365-new-chat-btn {
      color: white; border: none; padding: 12px 24px; border-radius: 8px;
      font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 8px;
      background: \${config.useGradient ? 'linear-gradient(135deg, ' + config.gradientStart + ' 0%, ' + config.gradientEnd + ' 100%)' : config.primaryColor};
    }
  \`;
  document.head.appendChild(style);
  
  // Inject HTML - Full featured version with all buttons
  var widgetHTML = \`
    <button class="d365-chat-launcher" id="d365ChatLauncher">
      <span class="d365-chat-badge" id="d365ChatBadge">0</span>
      <svg class="chat-icon" viewBox="0 0 24 24"><path d="\${launcherIconPath}"/></svg>
      <svg class="close-icon" viewBox="0 0 24 24"><path d="m4.21 4.387.083-.094a1 1 0 0 1 1.32-.083l.094.083L12 10.585l6.293-6.292a1 1 0 1 1 1.414 1.414L13.415 12l6.292 6.293a1 1 0 0 1 .083 1.32l-.083.094a1 1 0 0 1-1.32.083l-.094-.083L12 13.415l-6.293 6.292a1 1 0 0 1-1.414-1.414L10.585 12 4.293 5.707a1 1 0 0 1-.083-1.32l.083-.094-.083.094Z"/></svg>
    </button>
    <div class="d365-chat-container" id="d365ChatContainer">
      <div class="d365-chat-header">
        <div class="d365-header-avatar">\${config.headerLogo ? '<img src="' + config.headerLogo + '" alt="Logo">' : '<svg viewBox="0 0 24 24"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>'}</div>
        <div class="d365-header-info">
          <div class="d365-header-title">\${config.headerTitle}</div>
          <div class="d365-header-status">\${config.headerSubtitle}</div>
        </div>
        <div class="d365-header-actions">
          <button class="d365-header-btn" id="d365ToggleSound" title="Sound notifications on">
            <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
          </button>
          <button class="d365-header-btn" id="d365DownloadChat" title="Download transcript" style="display:none;">
            <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
          </button>
          <button class="d365-header-btn" id="d365MinimizeChat" title="Minimize">
            <svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg>
          </button>
          <button class="d365-header-btn" id="d365CloseChat" title="Close">
            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </button>
        </div>
      </div>
      <div class="d365-chat-body">
        <form class="d365-prechat-form" id="d365PrechatForm" onsubmit="return false;">
          <div class="d365-prechat-hero">
            <div class="d365-prechat-hero-content">
              <div class="d365-prechat-status">
                <div class="d365-prechat-status-dot"></div>
                <span>Online</span>
              </div>
              <div class="d365-prechat-avatar-group">
                <div class="d365-prechat-avatar">
                  <img src="\${config.agentAvatar || 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female1.png'}" alt="Support team member">
                </div>
                <div class="d365-prechat-avatar">
                  <img src="\${config.botAvatar || 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_male1.png'}" alt="Support team member">
                </div>
                <div class="d365-prechat-avatar">
                  <img src="\${config.customerAvatar || 'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/img/headshots/headshot_female2.png'}" alt="Support team member">
                </div>
              </div>
              <div class="d365-prechat-hero-title">\${config.welcomeTitle}</div>
              <div class="d365-prechat-hero-subtitle">\${config.welcomeMessage}</div>
            </div>
          </div>
          <div class="d365-prechat-form-body">
            <div class="d365-form-group">
              <label>\${config.nameFieldLabel} <span class="required">*</span></label>
              <div class="d365-input-with-icon">
                <input type="text" id="d365UserName" placeholder="\${config.nameFieldPlaceholder || 'Enter your name'}" required>
                <svg class="d365-input-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
              </div>
            </div>
            <div class="d365-form-group">
              <label>\${config.emailFieldLabel} <span class="required">*</span></label>
              <div class="d365-input-with-icon">
                <input type="email" id="d365UserEmail" placeholder="\${config.emailFieldPlaceholder || 'Enter your email'}" required>
                <svg class="d365-input-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
              </div>
            </div>
            <div class="d365-form-group">
              <label>\${config.questionFieldLabel} <span style="font-weight: 400; color: #9ca3af;">(optional)</span></label>
              <textarea id="d365UserQuestion" placeholder="\${config.questionFieldPlaceholder}"></textarea>
            </div>
            <button type="button" class="d365-start-btn" id="d365StartBtn">
              <span>\${config.startBtnText}</span>
              <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
          </div>
        </form>
        <div class="d365-connecting-view" id="d365ConnectingView">
          <div class="d365-spinner"></div>
          <div style="color: #4a5568; font-size: 14px;">Connecting you with an agent...</div>
        </div>
        <div class="d365-chat-messages" id="d365ChatMessages">
          <div class="d365-typing-indicator" id="d365TypingIndicator">
            <div class="d365-typing-dots"><span></span><span></span><span></span></div>
          </div>
        </div>
        <div class="d365-chat-input-area" id="d365ChatInputArea">
          <div class="d365-emoji-picker" id="d365EmojiPicker">
            <div class="d365-emoji-grid" id="d365EmojiGrid"></div>
          </div>
          <!-- Drag and Drop Overlay (Edge-safe workaround) -->
          <div class="d365-drop-zone-overlay" id="d365DropZoneOverlay">
            <div class="d365-drop-zone-content">
              <svg viewBox="0 0 24 24" width="48" height="48"><path fill="currentColor" d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
              <p>Drop your file here</p>
            </div>
          </div>
          <div class="d365-voice-recording" id="d365VoiceRecording">
            <div class="d365-voice-dot"></div>
            <div class="d365-voice-waveform"><span></span><span></span><span></span><span></span><span></span></div>
            <span>Recording...</span>
            <button class="d365-stop-voice-btn" id="d365StopVoiceBtn">Stop</button>
          </div>
          <div class="d365-chat-input-wrapper">
            <textarea class="d365-message-input" id="d365MessageInput" placeholder="Type your message..." rows="3"></textarea>
            <div class="d365-input-bottom-row">
              <div class="d365-input-actions">
                <!-- Label-based file input (Edge-safe - no programmatic click) -->
                <input type="file" id="d365FileInput" class="d365-visually-hidden-input" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                <label for="d365FileInput" class="d365-action-btn d365-file-label" id="d365AttachLabel" title="Attach file (or drag & drop)">
                  <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                </label>
                <button type="button" class="d365-action-btn" id="d365EmojiBtn" title="Emoji">
                  <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
                </button>
                <button type="button" class="d365-action-btn" id="d365VoiceBtn" title="Voice input">
                  <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
                </button>
              </div>
              <button type="button" class="d365-send-btn" id="d365SendBtn" title="Send">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
              </button>
            </div>
          </div>
        </div>
        <div class="d365-chat-ended" id="d365ChatEnded">
          <div style="font-size: 48px;"></div>
          <div style="font-size: 18px; font-weight: 600; color: #2d3748;">Chat Ended</div>
          <div style="font-size: 14px; color: #718096;">Thank you for chatting with us!</div>
          <button class="d365-new-chat-btn" id="d365NewChatBtn">Start New Chat</button>
        </div>
      </div>
      <div class="d365-confirm-modal" id="d365ConfirmModal">
        <div class="d365-confirm-content">
          <div class="d365-confirm-title">End Chat?</div>
          <div class="d365-confirm-text">Are you sure you want to end this conversation?</div>
          <div class="d365-confirm-buttons">
            <button class="d365-confirm-btn cancel" id="d365ConfirmNo">Cancel</button>
            <button class="d365-confirm-btn end" id="d365ConfirmYes">End Chat</button>
          </div>
        </div>
      </div>
      
      <!-- Image Preview Modal -->
      <div class="d365-image-preview-modal" id="d365ImagePreviewModal">
        <div class="d365-image-preview-header">
          <span class="d365-image-preview-title" id="d365ImagePreviewTitle">Preview</span>
          <button class="d365-image-preview-close" id="d365ImagePreviewClose" title="Cancel">
            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </button>
        </div>
        <div class="d365-image-preview-body">
          <img class="d365-image-preview-img" id="d365ImagePreviewImg" src="" alt="Preview">
        </div>
        <div class="d365-image-preview-footer">
          <textarea class="d365-image-preview-caption" id="d365ImagePreviewCaption" placeholder="Add a caption (optional)..." rows="2"></textarea>
          <div class="d365-image-preview-actions">
            <button class="d365-image-preview-btn cancel" id="d365ImagePreviewCancel">Cancel</button>
            <button class="d365-image-preview-btn send" id="d365ImagePreviewSend">Send</button>
          </div>
        </div>
      </div>
    </div>
  \`;
  
  var container = document.createElement('div');
  container.innerHTML = widgetHTML;
  document.body.appendChild(container);
  
  // Load the Microsoft Omnichannel Chat SDK for custom UI integration
  // Using GitHub-hosted bundle to avoid CDN blocking by Power Pages CSP
  console.log('Loading Omnichannel Chat SDK...');
  
  // Load Adaptive Cards library first
  var adaptiveCardsScript = document.createElement('script');
  adaptiveCardsScript.src = 'https://unpkg.com/adaptivecards@3.0.2/dist/adaptivecards.min.js';
  adaptiveCardsScript.onload = function() {
    console.log(' Adaptive Cards library loaded');
  };
  adaptiveCardsScript.onerror = function() {
    console.warn(' Adaptive Cards library failed to load - cards will not render');
  };
  document.head.appendChild(adaptiveCardsScript);
  
  var sdkSources = [
    'https://raw.githubusercontent.com/moliveirapinto/d365-modern-chat-widget/main/dist/chat-sdk-bundle.js',
    'https://moliveirapinto.github.io/d365-modern-chat-widget/dist/chat-sdk-bundle.js',
    'https://cdn.jsdelivr.net/gh/moliveirapinto/d365-modern-chat-widget@main/dist/chat-sdk-bundle.js'
  ];
  var currentSdkIndex = 0;
  
  function loadNextSdk() {
    if (currentSdkIndex >= sdkSources.length) {
      console.error('All SDK sources failed to load. Chat will not connect to D365.');
      console.log('Power Pages may be blocking external scripts. Check CSP settings.');
      initWidgetFallback();
      return;
    }
    
    var sdkScript = document.createElement('script');
    sdkScript.src = sdkSources[currentSdkIndex];
    console.log('Trying SDK source:', sdkSources[currentSdkIndex]);
    
    sdkScript.onload = function() {
      console.log(' Omnichannel Chat SDK loaded successfully from:', sdkSources[currentSdkIndex]);
      initWidget();
    };
    
    sdkScript.onerror = function() {
      console.warn('SDK failed to load from:', sdkSources[currentSdkIndex]);
      currentSdkIndex++;
      loadNextSdk();
    };
    
    document.head.appendChild(sdkScript);
  }
  
  loadNextSdk();
  
  function initWidget() {
    var chatSDK = null, chatStarted = false, userName = '', userEmail = '';
    var chatMessages = [];
    var soundEnabled = true;
    var processedMessageIds = {}; // Track processed message IDs to avoid duplicates
    
    // Message queue for batching and sorting messages
    var messageQueue = [];
    var messageQueueTimer = null;
    var MESSAGE_BATCH_DELAY = 150; // ms to wait for batching messages
    var messageArrivalCounter = 0; // Track arrival order for stable sorting
    var DEBUG_MSG_SORTING = true; // Set to false to disable debug logs
    
    // Get timestamp from a message for sorting
    // Priority: messageId (has millisecond precision) > sequenceId > timestamp (only second precision)
    function getMessageTimestamp(msg, logResult) {
        var ts = null;
        var source = '';
        
        // FIRST: Check messageId - this is a millisecond timestamp and most reliable
        // The D365 SDK uses messageId as the actual creation timestamp with ms precision
        var msgId = msg.messageId || msg.id || msg.clientmessageid || msg.messageid;
        if (msgId && !isNaN(Number(msgId)) && Number(msgId) > 1000000000000) {
            // Looks like a millisecond timestamp (13+ digits starting with 1)
            ts = Number(msgId);
            source = 'messageId';
        }
        // SECOND: Check for sequence number
        else if (msg.sequenceId !== undefined && !isNaN(Number(msg.sequenceId))) {
            ts = Number(msg.sequenceId);
            source = 'sequenceId';
        } else if (msg.sequence !== undefined && !isNaN(Number(msg.sequence))) {
            ts = Number(msg.sequence);
            source = 'sequence';
        } else if (msg.order !== undefined && !isNaN(Number(msg.order))) {
            ts = Number(msg.order);
            source = 'order';
        }
        // THIRD: Try explicit timestamp fields (these often only have second precision)
        else if (msg.timestamp) {
            ts = new Date(msg.timestamp).getTime();
            source = 'timestamp';
        } else if (msg.createdOn) {
            ts = new Date(msg.createdOn).getTime();
            source = 'createdOn';
        } else if (msg.sentOn) {
            ts = new Date(msg.sentOn).getTime();
            source = 'sentOn';
        } else if (msg.originalArrivalTime) {
            ts = new Date(msg.originalArrivalTime).getTime();
            source = 'originalArrivalTime';
        } else {
            ts = Date.now();
            source = 'fallback-now';
        }
        
        // Log what we found for debugging (only when explicitly requested)
        if (logResult && DEBUG_MSG_SORTING) {
            var content = (msg.content || msg.text || '').substring(0, 25);
            console.log(' Timestamp for "' + content + '...": ' + ts + ' (from ' + source + ')');
        }
        
        return ts;
    }
    
    // Queue a message for batched processing
    function queueMessage(message) {
        // Get message ID for deduplication
        var messageId = message.messageId || message.id || message.clientmessageid || message.messageid;
        
        // Skip if already processed
        if (messageId && processedMessageIds[messageId]) {
            console.log('Skipping already processed message:', messageId);
            return;
        }
        
        // Mark as processed
        if (messageId) {
            processedMessageIds[messageId] = true;
        }
        
        // Assign arrival order for stable sorting
        message._arrivalOrder = messageArrivalCounter++;
        messageQueue.push(message);
        
        // Clear existing timer
        if (messageQueueTimer) {
            clearTimeout(messageQueueTimer);
        }
        
        // Set timer to process batch
        messageQueueTimer = setTimeout(processMessageQueue, MESSAGE_BATCH_DELAY);
    }
    
    // Process queued messages in sorted order
    function processMessageQueue() {
        if (messageQueue.length === 0) return;
        
        // Sort messages by timestamp (oldest first), with messageId and arrival order as tiebreakers
        var sortedMessages = messageQueue.slice().sort(function(a, b) {
            var tsA = getMessageTimestamp(a);
            var tsB = getMessageTimestamp(b);
            
            // Primary sort by timestamp
            if (tsA !== tsB) {
                return tsA - tsB;
            }
            
            // Secondary sort by messageId if timestamps are equal
            var idA = Number(a.messageId || a.id || 0);
            var idB = Number(b.messageId || b.id || 0);
            if (idA !== idB) {
                return idA - idB;
            }
            
            // Tertiary sort by arrival order (preserves SDK order for identical timestamps/IDs)
            return (a._arrivalOrder || 0) - (b._arrivalOrder || 0);
        });
        
        // Debug: Log the sort order with timestamp sources
        if (DEBUG_MSG_SORTING) {
            console.log(' Processing message queue:', sortedMessages.length, 'messages');
            console.log(' Message order after sorting:');
            sortedMessages.forEach(function(m) {
                getMessageTimestamp(m, true); // Log with source info
                console.log('   ID: ' + (m.messageId || m.id) + ', arrival: ' + m._arrivalOrder + ', content: "' + (m.content || m.text || '').substring(0, 40) + '..."');
            });
        }
        
        // Clear queue before processing
        messageQueue = [];
        messageQueueTimer = null;
        
        // Process each message in sorted order
        sortedMessages.forEach(function(msg) {
            processMessageImmediate(msg);
        });
    }
    
    // DOM Elements
    var launcher = document.getElementById('d365ChatLauncher');
    var chatContainer = document.getElementById('d365ChatContainer');
    var badge = document.getElementById('d365ChatBadge');
    var prechatForm = document.getElementById('d365PrechatForm');
    var connectingView = document.getElementById('d365ConnectingView');
    var messagesContainer = document.getElementById('d365ChatMessages');
    var inputArea = document.getElementById('d365ChatInputArea');
    var typingIndicator = document.getElementById('d365TypingIndicator');
    var messageInput = document.getElementById('d365MessageInput');
    var sendBtn = document.getElementById('d365SendBtn');
    var startBtn = document.getElementById('d365StartBtn');
    var minimizeBtn = document.getElementById('d365MinimizeChat');
    var closeBtn = document.getElementById('d365CloseChat');
    var chatEnded = document.getElementById('d365ChatEnded');
    var newChatBtn = document.getElementById('d365NewChatBtn');
    var confirmModal = document.getElementById('d365ConfirmModal');
    var confirmYes = document.getElementById('d365ConfirmYes');
    var confirmNo = document.getElementById('d365ConfirmNo');
    var toggleSoundBtn = document.getElementById('d365ToggleSound');
    var downloadChatBtn = document.getElementById('d365DownloadChat');
    var unreadCount = 0;
    
    function showView(view) {
      prechatForm.classList.add('hidden');
      connectingView.classList.remove('active');
      messagesContainer.classList.remove('active');
      inputArea.classList.remove('active');
      chatEnded.classList.remove('active');
      downloadChatBtn.style.display = 'none';
      if (view === 'prechat') prechatForm.classList.remove('hidden');
      else if (view === 'connecting') connectingView.classList.add('active');
      else if (view === 'chat') { 
        messagesContainer.classList.add('active'); 
        inputArea.classList.add('active'); 
        downloadChatBtn.style.display = 'flex';
      }
      else if (view === 'ended') { 
        chatEnded.classList.add('active'); 
        chatStarted = false; 
        downloadChatBtn.style.display = 'flex';
      }
    }
    
    function getInitials(name) {
      if (!name) return '?';
      var parts = name.trim().split(' ');
      if (parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
      return name.substring(0, 2).toUpperCase();
    }
    
    function formatTime(date) {
      return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    function isBotSender(senderName) {
      if (!senderName) return false;
      var name = senderName.toLowerCase();
      return name.includes('bot') || name.includes('copilot') || name.includes('virtual') || 
             name.includes('assistant') || name.includes('ai');
    }
    
    // Enhanced Markdown & Reference Parser
    function formatBotMessage(text) {
      if (!text) return '';
      
      var references = [];
      var refRegex = /\[(\d+)\]:\s*(https?:\/\/[^\s]+)\s*"([^"]+)"/g;
      var match;
      var mainContent = text;
      
      while ((match = refRegex.exec(text)) !== null) {
        references.push({ num: match[1], url: match[2], title: match[3] });
      }
      
      if (references.length > 0) {
        mainContent = text.replace(/\n?\[(\d+)\]:\s*https?:\/\/[^\s]+\s*"[^"]+"/g, '');
      }
      
      var html = mainContent
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/\`\`\`(\w*)\n?([\s\S]*?)\`\`\`/g, '<pre><code>$2</code></pre>')
        .replace(/\`([^\`]+)\`/g, '<code>$1</code>')
        .replace(/^####\s+(.+)$/gm, '<h4>$1</h4>')
        .replace(/^###\s+(.+)$/gm, '<h3>$1</h3>')
        .replace(/^##\s+(.+)$/gm, '<h2>$1</h2>')
        .replace(/^#\s+(.+)$/gm, '<h1>$1</h1>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        .replace(/^---+$/gm, '<hr>')
        .replace(/^[-*]\s+(.+)$/gm, '<li>$1</li>')
        .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
      
      // Convert citations
      references.forEach(function(ref) {
        html = html.replace(new RegExp('\\[' + ref.num + '\\]', 'g'), 
          '<a href="' + ref.url + '" target="_blank" class="cite-link" title="' + ref.title + '">' + ref.num + '</a>');
      });
      
      html = html
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
        .replace(/\n\n+/g, '</p><p>')
        .replace(/\n/g, '<br>');
      
      html = html.replace(/(<li>[\s\S]*?<\/li>)(\s*<li>)/g, '$1$2');
      html = html.replace(/(<li>[\s\S]*?<\/li>)(?!\s*<li>)/g, '<ul>$1</ul>');
      html = html.replace(/<\/ul>\s*<ul>/g, '');
      
      if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('<pre')) {
        html = '<p>' + html + '</p>';
      }
      html = html.replace(/<p>\s*<\/p>/g, '').replace(/<p>\s*<br>\s*<\/p>/g, '');
      
      if (references.length > 0) {
        var sourcesHtml = '<div class="message-sources"><button class="sources-toggle" onclick="this.classList.toggle(\'expanded\'); this.nextElementSibling.classList.toggle(\'show\');"><svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg><span>Sources</span><span class="sources-count">' + references.length + '</span></button><ul class="sources-list">';
        references.forEach(function(ref) {
          var domain = '';
          try { domain = new URL(ref.url).hostname.replace('www.', ''); } catch(e) {}
          sourcesHtml += '<li class="source-item"><span class="source-number">' + ref.num + '</span><div class="source-content"><div class="source-title">' + ref.title + '</div><div class="source-domain"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>' + domain + '</div><a href="' + ref.url + '" target="_blank" class="source-url">' + ref.url + '</a></div></li>';
        });
        sourcesHtml += '</ul></div>';
        html += sourcesHtml;
      }
      
      return html;
    }
    
    function addMessage(text, isUser, senderName) {
      var now = new Date();
      chatMessages.push({ content: text, isUser: isUser, senderName: senderName, timestamp: now });
      
      var wrapper = document.createElement('div');
      wrapper.className = 'd365-message-wrapper ' + (isUser ? 'user' : 'agent');
      
      var avatar = document.createElement('div');
      var isBot = !isUser && isBotSender(senderName);
      avatar.className = 'd365-message-avatar ' + (isUser ? 'user' : (isBot ? 'bot' : 'agent'));
      
      if (isUser && config.customerAvatar) {
        avatar.innerHTML = '<img src="' + config.customerAvatar + '" alt="You">';
      } else if (!isUser && isBot && config.botAvatar) {
        avatar.innerHTML = '<img src="' + config.botAvatar + '" alt="Bot">';
      } else if (!isUser && !isBot && config.agentAvatar) {
        avatar.innerHTML = '<img src="' + config.agentAvatar + '" alt="Agent">';
      } else {
        avatar.textContent = getInitials(isUser ? userName : (senderName || 'Agent'));
      }
      
      // Format bot messages with enhanced markdown rendering
      var formattedText = isUser ? text : formatBotMessage(text);
      
      var content = document.createElement('div');
      content.className = 'd365-message-content';
      content.innerHTML = '<div class="d365-message-sender">' + (isUser ? userName : (senderName || 'Agent')) + '</div>' +
        '<div class="d365-message ' + (isUser ? 'user' : 'agent') + '">' + formattedText + '</div>' +
        '<div class="d365-message-time">' + formatTime(now) + '</div>';
      
      wrapper.appendChild(avatar);
      wrapper.appendChild(content);
      typingIndicator.parentNode.insertBefore(wrapper, typingIndicator);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      if (!isUser && !chatContainer.classList.contains('open')) {
        unreadCount++; badge.textContent = unreadCount; badge.classList.add('show');
        if (soundEnabled) playNotificationSound();
      }
    }
    
    function playNotificationSound() {
      try {
        var audioContext = new (window.AudioContext || window.webkitAudioContext)();
        var oscillator = audioContext.createOscillator();
        var gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) { console.log('Sound not supported'); }
    }
    
    // Sound toggle
    toggleSoundBtn.addEventListener('click', function() {
      soundEnabled = !soundEnabled;
      toggleSoundBtn.classList.toggle('sound-off', !soundEnabled);
      toggleSoundBtn.title = soundEnabled ? 'Sound notifications on' : 'Sound notifications off';
    });
    
    // Download transcript
    downloadChatBtn.addEventListener('click', function() {
      if (chatMessages.length === 0) { alert('No messages to download'); return; }
      var transcript = 'Chat Transcript\\n';
      transcript += 'Date: ' + new Date().toLocaleDateString() + '\\n';
      transcript += 'User: ' + userName + '\\n';
      transcript += '='.repeat(50) + '\\n\\n';
      chatMessages.forEach(function(msg) {
        var time = formatTime(msg.timestamp);
        var sender = msg.isUser ? userName : (msg.senderName || 'Agent');
        transcript += '[' + time + '] ' + sender + ':\\n' + msg.content + '\\n\\n';
      });
      transcript += '='.repeat(50) + '\\nEnd of transcript';
      var blob = new Blob([transcript], { type: 'text/plain' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'chat-transcript-' + new Date().toISOString().slice(0,10) + '.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
    
    // Launcher click
    launcher.addEventListener('click', function() {
      chatContainer.classList.toggle('open');
      launcher.classList.toggle('open');
      if (chatContainer.classList.contains('open')) {
        unreadCount = 0; badge.textContent = '0'; badge.classList.remove('show');
        if (!config.enablePrechatForm && !chatStarted) {
          var defaultName = config.enableCustomAuth ? config.customAuthName : 'Anonymous';
          var defaultEmail = config.enableCustomAuth ? config.customAuthEmail : 'anonymous@example.com';
          initializeChat(defaultName, defaultEmail, '');
        }
      }
    });
    
    // Minimize button
    minimizeBtn.addEventListener('click', function() {
      chatContainer.classList.remove('open');
      launcher.classList.remove('open');
    });
    
    // Close button with confirmation
    closeBtn.addEventListener('click', function() {
      if (chatStarted) {
        confirmModal.classList.add('show');
      } else {
        chatContainer.classList.remove('open');
        launcher.classList.remove('open');
      }
    });
    
    // Confirm dialog
    confirmNo.addEventListener('click', function() {
      confirmModal.classList.remove('show');
    });
    
    confirmYes.addEventListener('click', async function() {
      confirmModal.classList.remove('show');
      if (chatSDK) {
        try { await chatSDK.endChat(); } catch (e) { console.log('End chat error:', e); }
      }
      showView('ended');
    });
    
    // Start chat button
    startBtn.addEventListener('click', function() {
      userName = document.getElementById('d365UserName').value.trim();
      userEmail = document.getElementById('d365UserEmail').value.trim();
      var question = document.getElementById('d365UserQuestion').value.trim();
      if (!userName || !userEmail) { alert('Please fill in all required fields'); return; }
      startBtn.disabled = true; startBtn.textContent = 'Starting...';
      initializeChat(userName, userEmail, question);
    });
    
    // Send message
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    
    // File attachment with image preview
    var attachBtn = document.getElementById('d365AttachBtn');
    var fileInput = document.getElementById('d365FileInput');
    var pendingImageFile = null;
    // Create a resized preview using canvas (works reliably across all browsers including Edge)
    function createImagePreview(file, callback) {
      var img = new Image();
      var reader = new FileReader();
      
      reader.onload = function(e) {
        img.onload = function() {
          // Create canvas for resized preview (max 400px for preview)
          var canvas = document.createElement('canvas');
          var ctx = canvas.getContext('2d');
          var maxSize = 400;
          var width = img.width;
          var height = img.height;
          
          // Calculate new dimensions maintaining aspect ratio
          if (width > height) {
            if (width > maxSize) {
              height = Math.round(height * maxSize / width);
              width = maxSize;
            }
          } else {
            if (height > maxSize) {
              width = Math.round(width * maxSize / height);
              height = maxSize;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          
          // Get preview as data URL (small enough to not cause issues)
          var previewUrl = canvas.toDataURL('image/jpeg', 0.7);
          callback(null, previewUrl);
        };
        img.onerror = function() {
          callback(new Error('Failed to load image'));
        };
        img.src = e.target.result;
      };
      reader.onerror = function() {
        callback(new Error('Failed to read file'));
      };
      reader.readAsDataURL(file);
    }
    
    function showImagePreview(file, previewUrl) {
      pendingImageFile = file;
      var modal = document.getElementById('d365ImagePreviewModal');
      var img = document.getElementById('d365ImagePreviewImg');
      var title = document.getElementById('d365ImagePreviewTitle');
      var caption = document.getElementById('d365ImagePreviewCaption');
      
      title.textContent = file.name;
      caption.value = '';
      img.src = previewUrl;
      modal.classList.add('show');
      caption.focus();
    }
    
    function hideImagePreview() {
      var modal = document.getElementById('d365ImagePreviewModal');
      var img = document.getElementById('d365ImagePreviewImg');
      modal.classList.remove('show');
      img.src = '';
      pendingImageFile = null;
      fileInput.value = '';
    }
    
    async function sendImageWithCaption() {
      if (!pendingImageFile || !chatSDK || !chatStarted) {
        hideImagePreview();
        return;
      }
      var caption = document.getElementById('d365ImagePreviewCaption').value.trim();
      var file = pendingImageFile;
      var fileName = file.name;
      
      // Clear state
      var modal = document.getElementById('d365ImagePreviewModal');
      modal.classList.remove('show');
      pendingImageFile = null;
      fileInput.value = '';
      
      try {
        // Send caption first if provided
        if (caption) {
          addMessage(caption, true);
          await chatSDK.sendMessage({ content: caption });
        }
        // Then send the image - create a fresh blob URL for display
        if (file.type.startsWith('image/')) {
          var displayUrl = URL.createObjectURL(file);
          addImageMessage({ name: fileName, url: displayUrl }, true);
        }
        // Upload the actual file (SDK handles the file object directly)
        await chatSDK.uploadFileAttachment(file);
      } catch (err) {
        console.error('File upload error:', err);
        if (err.message === 'FeatureDisabled') {
          alert('File attachments are disabled. Please enable file attachments in your D365 Omnichannel widget configuration.');
        } else {
          alert('Failed to upload file: ' + (err.message || 'Unknown error'));
        }
      }
    }
    
    // Helper function to add image messages in index.html preview
    function addImageMessage(fileInfo, isUser) {
      var wrapper = document.createElement('div');
      wrapper.className = 'd365-message ' + (isUser ? 'user' : 'agent');
      wrapper.innerHTML = '<div class="d365-message-content"><img src="' + fileInfo.url + '" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="window.open(\'' + fileInfo.url + '\', \'_blank\')" alt="' + fileInfo.name + '"><div style="font-size: 11px; color: #64748b; margin-top: 4px;">' + fileInfo.name + '</div></div>';
      d365MessagesContainer.appendChild(wrapper);
      d365MessagesContainer.scrollTop = d365MessagesContainer.scrollHeight;
    }
    
    // ============================================
    // FILE ATTACHMENT HANDLING (Edge-safe approach)
    // Uses drag-and-drop + label-based input instead of programmatic click()
    // ============================================
    var dropZoneOverlay = document.getElementById('d365DropZoneOverlay');
    var inputArea = document.getElementById('d365ChatInputArea');
    var dragCounter = 0;
    
    // Unified file handler function (deferred to avoid browser crashes)
    function handleFileDeferred(file) {
      if (!file) return;
      if (file.size > 25000000) { alert('File too large. Maximum size is 25MB.'); return; }
      
      console.log('[FILE] Processing:', file.name, file.type);
      
      // Check if it's an image - create resized preview
      if (file.type.startsWith('image/')) {
        createImagePreview(file, function(err, previewUrl) {
          if (err) {
            console.error('Preview error:', err);
            alert('Failed to preview image. Please try a different image.');
            return;
          }
          showImagePreview(file, previewUrl);
        });
      } else {
        // Non-image files: upload directly
        var reader = new FileReader();
        reader.onload = function(evt) {
          var fileName = file.name;
          var fileType = file.type || 'application/octet-stream';
          var base64 = evt.target.result;
          if (chatSDK && chatStarted) {
            chatSDK.uploadFileAttachment({ name: fileName, type: fileType, data: base64 }).then(function() {
              console.log('File uploaded:', fileName);
              addMessage(' ' + fileName, true);
            }).catch(function(err) {
              console.error('File upload error:', err);
              if (err.message === 'FeatureDisabled') {
                alert('File attachments are disabled. Please enable file attachments in your D365 Omnichannel widget configuration.');
              } else {
                alert('Failed to upload file: ' + (err.message || 'Unknown error'));
              }
            });
          }
        };
        reader.readAsDataURL(file);
      }
    }
    
    // DRAG AND DROP FILE UPLOAD (Edge-safe method)
    if (inputArea && dropZoneOverlay) {
      // Prevent default drag behaviors on the whole document
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
        document.body.addEventListener(eventName, function(e) {
          e.preventDefault();
          e.stopPropagation();
        }, false);
      });
      
      // Drag enter - show overlay
      inputArea.addEventListener('dragenter', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragCounter++;
        if (chatStarted && e.dataTransfer.types.indexOf('Files') !== -1) {
          dropZoneOverlay.classList.add('active');
          console.log('[DRAG] Enter - showing overlay');
        }
      });
      
      // Drag over - keep showing overlay
      inputArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (chatStarted) {
          dropZoneOverlay.classList.add('active');
        }
      });
      
      // Drag leave - hide overlay when fully leaving
      inputArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragCounter--;
        if (dragCounter === 0) {
          dropZoneOverlay.classList.remove('active');
          console.log('[DRAG] Leave - hiding overlay');
        }
      });
      
      // Drop - handle the file
      inputArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        dragCounter = 0;
        dropZoneOverlay.classList.remove('active');
        console.log('[DROP] File dropped');
        
        if (!chatStarted) {
          console.log('[DROP] Chat not started, ignoring');
          return;
        }
        
        var files = e.dataTransfer.files;
        if (files && files.length > 0) {
          var file = files[0];
          console.log('[DROP] Processing file:', file.name, file.type, file.size);
          setTimeout(function() { handleFileDeferred(file); }, 50);
        }
      });
    }
    
    // LABEL-BASED FILE INPUT (for click selection - Edge-safe)
    if (fileInput) {
      fileInput.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        console.log('[FILE INPUT] File selected via label click:', file.name);
        
        // Small delay to let the file dialog close
        setTimeout(function() {
          handleFileDeferred(file);
        }, 50);
        
        // Reset input for next selection
        fileInput.value = '';
      });
      
      // Image preview modal event handlers
      document.getElementById('d365ImagePreviewClose').addEventListener('click', hideImagePreview);
      document.getElementById('d365ImagePreviewCancel').addEventListener('click', hideImagePreview);
      document.getElementById('d365ImagePreviewSend').addEventListener('click', sendImageWithCaption);
      document.getElementById('d365ImagePreviewCaption').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendImageWithCaption();
        }
      });
    }
    
    // Emoji picker
    var emojiBtn = document.getElementById('d365EmojiBtn');
    var emojiPicker = document.getElementById('d365EmojiPicker');
    var emojiGrid = document.getElementById('d365EmojiGrid');
    if (emojiBtn && emojiPicker && emojiGrid) {
      var emojis = ['','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''];
      emojis.forEach(function(emoji) {
        var btn = document.createElement('button');
        btn.className = 'd365-emoji-item';
        btn.textContent = emoji;
        btn.type = 'button';
        btn.addEventListener('click', function() {
          messageInput.value += emoji;
          messageInput.focus();
          emojiPicker.classList.remove('show');
        });
        emojiGrid.appendChild(btn);
      });
      emojiBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        emojiPicker.classList.toggle('show');
      });
      document.addEventListener('click', function(e) {
        if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
          emojiPicker.classList.remove('show');
        }
      });
    }
    
    // Voice recording
    var voiceBtn = document.getElementById('d365VoiceBtn');
    var voiceRecording = document.getElementById('d365VoiceRecording');
    var stopVoiceBtn = document.getElementById('d365StopVoiceBtn');
    if (voiceBtn && voiceRecording && stopVoiceBtn && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      var recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.continuous = false;
      recognition.interimResults = false;
      var isRecording = false;
      recognition.onstart = function() {
        isRecording = true;
        voiceBtn.classList.add('recording');
        voiceRecording.classList.add('show');
      };
      recognition.onresult = function(event) {
        var transcript = event.results[0][0].transcript;
        messageInput.value += (messageInput.value ? ' ' : '') + transcript;
        messageInput.focus();
      };
      recognition.onend = function() {
        isRecording = false;
        voiceBtn.classList.remove('recording');
        voiceRecording.classList.remove('show');
      };
      recognition.onerror = function(event) {
        console.log('Speech recognition error:', event.error);
        isRecording = false;
        voiceBtn.classList.remove('recording');
        voiceRecording.classList.remove('show');
      };
      voiceBtn.addEventListener('click', function() {
        if (isRecording) { recognition.stop(); } else { recognition.start(); }
      });
      stopVoiceBtn.addEventListener('click', function() { recognition.stop(); });
    } else if (voiceBtn) {
      voiceBtn.style.display = 'none';
    }
    
    // New chat button
    newChatBtn.addEventListener('click', function() {
      chatStarted = false; chatSDK = null; chatMessages = [];
      startBtn.disabled = false; startBtn.textContent = config.startBtnText;
      document.getElementById('d365UserName').value = '';
      document.getElementById('d365UserEmail').value = '';
      document.getElementById('d365UserQuestion').value = '';
      while (messagesContainer.firstChild !== typingIndicator) {
        messagesContainer.removeChild(messagesContainer.firstChild);
      }
      showView('prechat');
    });
    
    async function initializeChat(name, email, question) {
      try {
        userName = name; userEmail = email;
        showView('connecting');
        console.log('Starting chat initialization...');
        
        // Get the Omnichannel Chat SDK
        var SDKClass = null;
        
        // Check various ways the SDK might be exposed (our custom bundle exposes it as window.OmnichannelChatSDK)
        if (typeof OmnichannelChatSDK !== 'undefined') {
          // Our custom bundle or direct global
          if (typeof OmnichannelChatSDK === 'function') {
            SDKClass = OmnichannelChatSDK;
            console.log('Found SDK as direct constructor (OmnichannelChatSDK)');
          } else if (OmnichannelChatSDK.default && typeof OmnichannelChatSDK.default === 'function') {
            SDKClass = OmnichannelChatSDK.default;
            console.log('Found SDK via OmnichannelChatSDK.default');
          } else if (OmnichannelChatSDK.OmnichannelChatSDK) {
            SDKClass = OmnichannelChatSDK.OmnichannelChatSDK;
            console.log('Found SDK via OmnichannelChatSDK.OmnichannelChatSDK');
          } else {
            // Search for constructor in module
            for (var key in OmnichannelChatSDK) {
              if (typeof OmnichannelChatSDK[key] === 'function' && OmnichannelChatSDK[key].prototype) {
                SDKClass = OmnichannelChatSDK[key];
                console.log('Found SDK constructor at OmnichannelChatSDK.' + key);
                break;
              }
            }
          }
        } else if (typeof Microsoft !== 'undefined' && Microsoft.OmnichannelChatSDK) {
          SDKClass = Microsoft.OmnichannelChatSDK.OmnichannelChatSDK || Microsoft.OmnichannelChatSDK;
          console.log('Found SDK via Microsoft.OmnichannelChatSDK');
        }
        
        if (!SDKClass) {
          console.error('SDK not found. Available window keys with Omni/Microsoft:', 
            Object.keys(window).filter(function(k) { 
              return k.toLowerCase().includes('omni') || k.toLowerCase().includes('microsoft'); 
            })
          );
          console.log('OmnichannelChatSDK value:', typeof OmnichannelChatSDK !== 'undefined' ? OmnichannelChatSDK : 'undefined');
          throw new Error('Omnichannel Chat SDK not loaded. Please check your D365 configuration.');
        }
        
        console.log('Creating SDK instance with config:', {
          orgId: config.orgId,
          orgUrl: config.orgUrl,
          widgetId: config.widgetId
        });
        
        chatSDK = new SDKClass({
          orgId: config.orgId,
          orgUrl: config.orgUrl,
          widgetId: config.widgetId
        });
        
        console.log('Initializing SDK...');
        await chatSDK.initialize();
        console.log('SDK initialized successfully');
        
        // Set up event handlers
        chatSDK.onNewMessage(function(msg) {
          console.log('New message received:', msg);
          if (msg && msg.content) {
            addMessage(msg.content, false, msg.senderDisplayName || 'Agent');
          }
        });
        
        chatSDK.onTypingEvent(function() {
          typingIndicator.classList.add('active');
          setTimeout(function() { typingIndicator.classList.remove('active'); }, 3000);
        });
        
        chatSDK.onAgentEndSession(function() {
          console.log('Agent ended session');
          showView('ended');
        });
        
        console.log('Starting chat with context...');
        await chatSDK.startChat({
          customContext: {
            'emailaddress1': { value: email, isDisplayable: true },
            'Name': { value: name, isDisplayable: true }
          }
        });
        
        console.log('Chat started successfully!');
        chatStarted = true;
        showView('chat');
        
        // Send initial question if provided
        if (question) {
          addMessage(question, true, name);
          await chatSDK.sendMessage({ content: question });
        }
        
        // Start polling for messages
        setInterval(pollMessages, 3000);
        
      } catch (error) {
        console.error('Chat initialization error:', error);
        console.error('Error stack:', error.stack);
        alert('Failed to start chat: ' + (error.message || 'Unknown error') + '\\n\\nPlease check the browser console for more details.');
        showView('prechat');
        startBtn.disabled = false;
        startBtn.textContent = config.startBtnText;
      }
    }
    
    async function sendMessage() {
      var text = messageInput.value.trim();
      if (!text) {
        console.log('No message to send');
        return;
      }
      if (!chatSDK) {
        console.error('Cannot send message: chatSDK is not initialized');
        alert('Chat is not connected. Please restart the conversation.');
        return;
      }
      if (!chatStarted) {
        console.error('Cannot send message: chat has not started');
        alert('Chat has not started yet. Please wait for connection.');
        return;
      }
      
      messageInput.value = '';
      addMessage(text, true, userName);
      
      try {
        console.log('Sending message:', text);
        await chatSDK.sendMessage({ content: text });
        console.log('Message sent successfully');
      } catch (e) {
        console.error('Error sending message:', e);
        addMessage('Failed to send message. Please try again.', false, 'System');
      }
    }
    
    // Adaptive Card detection
    function isAdaptiveCardContent(content) {
      if (!content || typeof content !== 'string') return false;
      try {
        var parsed = JSON.parse(content);
        if (parsed.type === 'AdaptiveCard') return true;
        if (parsed.attachments && Array.isArray(parsed.attachments)) {
          return parsed.attachments.some(function(att) {
            return att.contentType === 'application/vnd.microsoft.card.adaptive' ||
                   (att.content && att.content.type === 'AdaptiveCard');
          });
        }
        return false;
      } catch (e) {
        return false;
      }
    }
    
    // Suggested Actions detection (PVA-style)
    function isSuggestedActionsContent(content) {
      if (!content || typeof content !== 'string') return false;
      try {
        var parsed = JSON.parse(content);
        if (parsed.text && parsed.suggestedActions && parsed.suggestedActions.actions) {
          return parsed.suggestedActions.actions.length > 0;
        }
        return false;
      } catch (e) {
        return false;
      }
    }
    
    // Render Adaptive Card
    function addAdaptiveCardMessage(content, senderName) {
      var now = new Date();
      var wrapper = document.createElement('div');
      wrapper.className = 'd365-message-wrapper agent';
      
      var avatar = document.createElement('div');
      avatar.className = 'd365-message-avatar ' + (isBotSender(senderName) ? 'bot' : 'agent');
      if (isBotSender(senderName) && config.botAvatar) {
        avatar.innerHTML = '<img src="' + config.botAvatar + '" alt="Bot">';
      } else if (config.agentAvatar) {
        avatar.innerHTML = '<img src="' + config.agentAvatar + '" alt="Agent">';
      } else {
        avatar.textContent = getInitials(senderName || 'Agent');
      }
      
      var contentDiv = document.createElement('div');
      contentDiv.className = 'd365-message-content';
      
      var senderDiv = document.createElement('div');
      senderDiv.className = 'd365-message-sender';
      senderDiv.textContent = senderName || 'Agent';
      
      var cardContainer = document.createElement('div');
      cardContainer.className = 'd365-message agent d365-adaptive-card';
      
      try {
        var parsed = JSON.parse(content);
        var cardPayload = null;
        
        if (parsed.type === 'AdaptiveCard') {
          cardPayload = parsed;
        } else if (parsed.attachments && Array.isArray(parsed.attachments)) {
          var cardAtt = parsed.attachments.find(function(att) {
            return att.contentType === 'application/vnd.microsoft.card.adaptive' && att.content;
          });
          if (cardAtt) cardPayload = cardAtt.content;
        }
        
        if (cardPayload && typeof AdaptiveCards !== 'undefined') {
          var adaptiveCard = new AdaptiveCards.AdaptiveCard();
          adaptiveCard.hostConfig = new AdaptiveCards.HostConfig({
            fontFamily: "inherit",
            spacing: { small: 8, default: 12, medium: 16, large: 20, extraLarge: 24, padding: 16 },
            separator: { lineThickness: 1, lineColor: "#e2e8f0" },
            fontSizes: { small: 12, default: 14, medium: 16, large: 18, extraLarge: 20 },
            containerStyles: {
              default: { backgroundColor: "#ffffff", foregroundColors: { default: { default: "#2d3748", subtle: "#64748b" } } }
            }
          });
          
          adaptiveCard.parse(cardPayload);
          
          adaptiveCard.onExecuteAction = function(action) {
            console.log('Adaptive Card action executed:', action);
            if (action.constructor.name === 'SubmitAction' || (action.data !== undefined)) {
              var data = action.data;
              console.log('Submit action data:', data);
              if (data && chatSDK && chatStarted) {
                cardContainer.style.opacity = '0.6';
                cardContainer.style.pointerEvents = 'none';
                var actionId = (data && data.actionSubmitId) || action.title || 'Submit';
                var sendContent = JSON.stringify({value: data});
                chatSDK.sendMessage({ 
                  content: sendContent,
                  metadata: { 'microsoft.azure.communication.chat.bot.contenttype': 'azurebotservice.adaptivecard' }
                }).then(function() {
                  addMessage(actionId, true, userName);
                }).catch(function(err) {
                  console.error('Error sending card response:', err);
                  cardContainer.style.opacity = '1';
                  cardContainer.style.pointerEvents = 'auto';
                });
              }
            } else if (action.url) {
              window.open(action.url, '_blank');
            }
          };
          
          var renderedCard = adaptiveCard.render();
          if (renderedCard) {
            cardContainer.appendChild(renderedCard);
          } else {
            cardContainer.innerHTML = '<p style="color:#e74c3c;">Could not render card</p>';
          }
        } else {
          cardContainer.innerHTML = '<p style="color:#e74c3c;">Adaptive Cards library not loaded</p>';
        }
      } catch (e) {
        console.error('Error rendering Adaptive Card:', e);
        cardContainer.innerHTML = '<p style="color:#e74c3c;">Error displaying card</p>';
      }
      
      var timeDiv = document.createElement('div');
      timeDiv.className = 'd365-message-time';
      timeDiv.textContent = formatTime(now);
      
      contentDiv.appendChild(senderDiv);
      contentDiv.appendChild(cardContainer);
      contentDiv.appendChild(timeDiv);
      wrapper.appendChild(avatar);
      wrapper.appendChild(contentDiv);
      typingIndicator.parentNode.insertBefore(wrapper, typingIndicator);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      chatMessages.push({ content: '[Adaptive Card]', isUser: false, senderName: senderName, timestamp: now });
      
      if (!chatContainer.classList.contains('open')) {
        unreadCount++; badge.textContent = unreadCount; badge.classList.add('show');
        if (soundEnabled) playNotificationSound();
      }
    }
    
    // Render Suggested Actions message
    function addSuggestedActionsMessage(content, senderName) {
      var now = new Date();
      var wrapper = document.createElement('div');
      wrapper.className = 'd365-message-wrapper agent';
      
      var avatar = document.createElement('div');
      avatar.className = 'd365-message-avatar ' + (isBotSender(senderName) ? 'bot' : 'agent');
      if (isBotSender(senderName) && config.botAvatar) {
        avatar.innerHTML = '<img src="' + config.botAvatar + '" alt="Bot">';
      } else if (config.agentAvatar) {
        avatar.innerHTML = '<img src="' + config.agentAvatar + '" alt="Agent">';
      } else {
        avatar.textContent = getInitials(senderName || 'Agent');
      }
      
      var contentDiv = document.createElement('div');
      contentDiv.className = 'd365-message-content';
      
      var senderDiv = document.createElement('div');
      senderDiv.className = 'd365-message-sender';
      senderDiv.textContent = senderName || 'Agent';
      
      try {
        var parsed = JSON.parse(content);
        var messageText = parsed.text || '';
        var actions = (parsed.suggestedActions && parsed.suggestedActions.actions) || [];
        
        var messageBubble = document.createElement('div');
        messageBubble.className = 'd365-message agent';
        messageBubble.textContent = messageText;
        
        if (actions.length > 0) {
          var actionsContainer = document.createElement('div');
          actionsContainer.className = 'd365-suggested-actions';
          
          actions.forEach(function(action) {
            var button = document.createElement('button');
            button.className = 'd365-suggested-btn';
            button.textContent = action.title || action.text || 'Select';
            button.onclick = function() {
              var value = action.value || action.text || action.title;
              actionsContainer.querySelectorAll('.d365-suggested-btn').forEach(function(btn) { btn.disabled = true; });
              if (action.type === 'openUrl' && action.value) {
                window.open(action.value, '_blank');
              } else if (chatSDK && chatStarted) {
                chatSDK.sendMessage({ content: value }).then(function() {
                  addMessage(value, true, userName);
                }).catch(function(err) {
                  console.error('Error sending action:', err);
                  actionsContainer.querySelectorAll('.d365-suggested-btn').forEach(function(btn) { btn.disabled = false; });
                });
              }
            };
            actionsContainer.appendChild(button);
          });
          messageBubble.appendChild(actionsContainer);
        }
        
        var timeDiv = document.createElement('div');
        timeDiv.className = 'd365-message-time';
        timeDiv.textContent = formatTime(now);
        
        contentDiv.appendChild(senderDiv);
        contentDiv.appendChild(messageBubble);
        contentDiv.appendChild(timeDiv);
      } catch (e) {
        console.error('Error rendering suggested actions:', e);
        contentDiv.innerHTML = '<div class="d365-message-sender">' + (senderName || 'Agent') + '</div>' +
          '<div class="d365-message agent">' + content + '</div>' +
          '<div class="d365-message-time">' + formatTime(now) + '</div>';
      }
      
      wrapper.appendChild(avatar);
      wrapper.appendChild(contentDiv);
      typingIndicator.parentNode.insertBefore(wrapper, typingIndicator);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      chatMessages.push({ content: messageText || content, isUser: false, senderName: senderName, timestamp: now });
      
      if (!chatContainer.classList.contains('open')) {
        unreadCount++; badge.textContent = unreadCount; badge.classList.add('show');
        if (soundEnabled) playNotificationSound();
      }
    }
    
    // Queue messages for batched, sorted processing
    function processMessage(message) {
      if (!message) return;
      queueMessage(message);
    }
    
    // Process a message immediately (called from queue processor)
    function processMessageImmediate(message) {
      if (!message) return;
      
      // Get message content - try various possible content fields
      var content = message.content || message.text || message.body;
      
      if (!content) {
        console.log('Message has no content:', message);
        return;
      }
      
      // Determine message role
      var role = message.role || message.senderRole || message.deliveryMode;
      
      // Extract sender info
      var senderId = message.senderId || message.sender;
      var senderName = 'Agent';
      if (typeof senderId === 'object' && senderId !== null) {
        senderName = senderId.displayName || senderId.name || 'Agent';
      } else if (typeof senderId === 'string') {
        senderName = senderId;
      }
      if (message.senderDisplayName) {
        senderName = message.senderDisplayName;
      }
      
      console.log('Processing message - role:', role, 'senderName:', senderName, 'content:', content);
      
      var isFromUser = role === 'user' || role === 'User' || role === 1;
      var isSystem = role === 'system' || role === 'System';
      
      // Skip user messages (those are added when sent)
      if (isFromUser) {
        console.log('Skipping user message');
        return;
      }
      
      // Check for Adaptive Cards
      if (isAdaptiveCardContent(content)) {
        console.log('\ud83d\udccb Detected Adaptive Card');
        addAdaptiveCardMessage(content, senderName);
        return;
      }
      
      // Check for Suggested Actions
      if (isSuggestedActionsContent(content)) {
        console.log('\ud83d\udcac Detected Suggested Actions');
        addSuggestedActionsMessage(content, senderName);
        return;
      }
      
      // Add regular text messages
      addMessage(content, false, senderName);
    }
    
    async function pollMessages() {
      if (!chatSDK || !chatStarted) return;
      try {
        var messages = await chatSDK.getMessages();
        console.log('Polled messages:', messages);
        if (messages && messages.length) {
          // Sort messages by timestamp/ID before processing to ensure correct order
          // SDK may return messages in reverse chronological order (newest first)
          var sortedMessages = messages.slice().sort(function(a, b) {
            return getMessageTimestamp(a) - getMessageTimestamp(b);
          });
          
          if (DEBUG_MSG_SORTING) {
            console.log(' Sorted poll results:', sortedMessages.map(function(m) {
              return {
                id: m.messageId || m.id,
                ts: getMessageTimestamp(m),
                content: (m.content || m.text || '').substring(0, 30)
              };
            }));
          }
          
          sortedMessages.forEach(function(msg) {
            processMessage(msg);
          });
        }
      } catch (e) { console.log('Poll error:', e); }
    }
    
    if (!config.enablePrechatForm) {
      prechatForm.classList.add('hidden');
    }
  }
  
  function initWidgetFallback() {
    console.log('Using fallback widget mode - SDK not available');
    console.log('If using Power Pages, you may need to add CDN domains to Content Security Policy');
    
    var launcher = document.getElementById('d365ChatLauncher');
    var chatContainer = document.getElementById('d365ChatContainer');
    var prechatForm = document.getElementById('d365PrechatForm');
    
    // Update form to show contact info instead
    var formTitle = prechatForm.querySelector('.d365-form-title');
    var formSubtitle = prechatForm.querySelector('.d365-form-subtitle');
    if (formTitle) formTitle.textContent = 'Contact Us';
    if (formSubtitle) formSubtitle.textContent = 'Live chat is temporarily unavailable. Please fill in your details and we will contact you.';
    
    launcher.addEventListener('click', function() {
      chatContainer.classList.toggle('open');
      launcher.classList.toggle('open');
    });
    document.getElementById('d365MinimizeChat').addEventListener('click', function() {
      chatContainer.classList.remove('open');
      launcher.classList.remove('open');
    });
    document.getElementById('d365StartBtn').addEventListener('click', function() {
      var name = document.getElementById('d365UserName').value.trim();
      var email = document.getElementById('d365UserEmail').value.trim();
      var question = document.getElementById('d365UserQuestion').value.trim();
      
      if (!name || !email) {
        alert('Please fill in your name and email.');
        return;
      }
      
      // Show a message that we'll contact them
      alert('Thank you! We received your message and will contact you at ' + email + ' soon.\\n\\nNote: Live chat SDK could not be loaded. If you are the site admin using Power Pages, please configure Content Security Policy to allow the Omnichannel SDK CDN.');
      
      // Log the contact attempt for debugging
      console.log('Contact form submitted:', { name: name, email: email, question: question });
      
      // Reset form
      document.getElementById('d365UserName').value = '';
      document.getElementById('d365UserEmail').value = '';
      document.getElementById('d365UserQuestion').value = '';
    });
  }
  } // End of initD365Widget function
  
  // Wait for DOM to be ready before initializing
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initD365Widget);
  } else {
    // DOM is already ready
    initD365Widget();
  }
})();
<\/script>`;
            
            document.getElementById('embedCodeOutput').value = embedCode;
            if (!skipCharCount) {
                showCharCount(embedCode.length);
                showToast('Full embed code generated! ' + embedCode.length.toLocaleString() + ' characters.');
            }
            document.getElementById('downloadHtmlBtn').style.display = 'inline-flex'; // Show download button
            
            // Return the generated code for use by other functions (like downloadEmbedCode)
            return embedCode;
        }
        
        function copyGeneratedEmbedCode() {
            const embedCodeEl = document.getElementById('embedCodeOutput');
            const embedCode = embedCodeEl.value;
            
            if (!embedCode || embedCode.includes('Click')) {
                showToast('Please generate the embed code first');
                return;
            }
            
            navigator.clipboard.writeText(embedCode).then(() => {
                const successEl = document.getElementById('copySuccess');
                successEl.classList.add('show');
                setTimeout(() => successEl.classList.remove('show'), 2000);
                showToast('Embed code copied to clipboard!');
            }).catch(err => {
                // Fallback for older browsers
                embedCodeEl.select();
                document.execCommand('copy');
                showToast('Embed code copied to clipboard!');
            });
        }
        
        function downloadEmbedCode() {
            // Get the code from textarea
            let embedCode = document.getElementById('embedCodeOutput').value;
            
            // Check if there's valid embed code (not empty, not placeholder, not TamperMonkey)
            if (!embedCode || embedCode.includes('Click') || embedCode.includes('')) {
                showToast('Please generate embed code first by clicking "Generate Embed Code"');
                return;
            }
            
            // If TamperMonkey code is in textarea, generate fresh Full Embed code instead
            if (embedCode.startsWith('// ==UserScript==')) {
                updateSettingsFromForm();
                if (!settings.orgId || !settings.orgUrl || !settings.widgetId) {
                    showToast('Please configure D365 Connection settings first');
                    return;
                }
                // Generate full embed code silently (skip char count warning)
                embedCode = generateFullEmbedCode(true, true);
            }
            
            // Create HTML file with the embed code
            const htmlContent = '<!DOCTYPE html>\n' +
                '<html lang="en">\n' +
                '<head>\n' +
                '    <meta charset="UTF-8">\n' +
                '    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
                '    <title>Chat Widget Demo</title>\n' +
                '    <style>\n' +
                '        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 40px; background: #f5f5f5; min-height: 100vh; }\n' +
                '        .demo-content { max-width: 800px; margin: 0 auto; }\n' +
                '        h1 { color: #333; }\n' +
                '        p { color: #666; line-height: 1.6; }\n' +
                '    </style>\n' +
                '</head>\n' +
                '<body>\n' +
                '    <div class="demo-content">\n' +
                '        <h1>Chat Widget Demo</h1>\n' +
                '        <p>This is a demo page with the embedded chat widget. The widget should appear in the bottom-right corner of the page.</p>\n' +
                '        <p>Click the chat launcher button to open the widget.</p>\n' +
                '    </div>\n' +
                '    ' + embedCode + '\n' +
                '</body>\n' +
                '</html>';
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat-widget-embed.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('HTML demo page downloaded!');
        }

        function generateTamperMonkeyCode() {
            updateSettingsFromForm();
            
            // Validate required D365 settings
            if (!settings.orgId || !settings.orgUrl || !settings.widgetId) {
                showToast('Please configure D365 Connection settings first (Org ID, Org URL, Widget ID)');
                document.getElementById('embedCodeOutput').value = ' Please configure D365 Connection settings first.\n\nGo to the "D365 Connection" tab and enter your Org ID, Org URL, and Widget ID.';
                hideCharCount();
                return;
            }
            
            // Build config for TamperMonkey
            const config = buildCompactConfig();
            let configJson = JSON.stringify(config, null, 2);
            
            // Get target URL from user or use default
            const targetUrl = prompt('Enter the website URL where you want the widget to appear:\n\nExamples:\n- https://example.com/*\n- https://*.mycompany.com/*\n- *://*/*', 'https://*/*');
            
            if (!targetUrl) {
                showToast('TamperMonkey code generation cancelled');
                return;
            }
            
            const tamperMonkeyCode = generateTamperMonkeyScript(config, configJson, targetUrl);
            
            document.getElementById('embedCodeOutput').value = tamperMonkeyCode;
            showCharCount(tamperMonkeyCode.length);
            document.getElementById('downloadHtmlBtn').style.display = 'none'; // Hide download button for TamperMonkey
            showToast(' TamperMonkey script generated! Copy and paste into TamperMonkey.');
        }
        
        function generateTamperMonkeyScript(config, configJson, targetUrl) {
            const scriptName = settings.headerTitle || 'D365 Chat Widget';
            
            // Convert JSON config to clean JavaScript object format (no quoted keys)
            const configLines = [];
            for (const [key, value] of Object.entries(config)) {
                if (typeof value === 'string') {
                    configLines.push(`    ${key}: "${value.replace(/"/g, '\\"')}"`);
                } else if (typeof value === 'boolean') {
                    configLines.push(`    ${key}: ${value}`);
                } else {
                    configLines.push(`    ${key}: ${JSON.stringify(value)}`);
                }
            }
            const configObjectStr = `{\n${configLines.join(',\n')}\n  }`;
            
            return `// ==UserScript==
// @name         ${scriptName}  D365 Chat Widget Injector
// @namespace    https://moliveirapinto.github.io/d365-modern-chat-widget/
// @version      1.0
// @description  Injects the D365 Modern Chat Widget into target pages.
// @author       D365 Chat Widget Generator
// @match        ${targetUrl}
// @run-at       document-start
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  // --- Guard against duplicate injection ---
  const INJECTION_FLAG = '__d365_widget_injected__';
  if (window[INJECTION_FLAG]) return;
  window[INJECTION_FLAG] = true;

  // --- Widget Configuration ---
  window.D365WidgetConfig = ${configObjectStr};

  // --- Loader injection ---
  function injectLoader() {
    // If script is already present, skip
    if (document.querySelector('script[src*="moliveirapinto.github.io/d365-modern-chat-widget/dist/widget-core.js"]')) {
      return;
    }

    const s = document.createElement('script');
    s.src = 'https://moliveirapinto.github.io/d365-modern-chat-widget/dist/widget-core.js';
    s.async = true;
    s.crossOrigin = 'anonymous';

    // Prefer head, fallback to documentElement (helps if CSP blocks head modifications)
    const target = document.head || document.getElementsByTagName('head')[0] || document.documentElement;
    try {
      target.appendChild(s);
    } catch (e) {
      // Last resort fallback
      document.documentElement.appendChild(s);
    }
  }

  // Inject as early as possible; if DOM not ready, retry shortly
  if (document.head) {
    injectLoader();
  } else {
    // Early pages sometimes don't have <head> yet at document-start
    const tryEarly = setInterval(() => {
      if (document.head || document.getElementsByTagName('head')[0]) {
        clearInterval(tryEarly);
        injectLoader();
      }
    }, 25);

    // Hard fallback at DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
      clearInterval(tryEarly);
      injectLoader();
    });
  }
})();`;
        }

        // ============ USER MANAGEMENT ============
        function loadCurrentUser() {
            // User info is shown in the user bar when logged in
            // No additional action needed here
        }

        // ============ UTILITY ============
        // Note: escapeHtml is defined in the GitHub Cloud Sync section above

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Share dropdown menu toggle
        function toggleShareMenu() {
            const menu = document.getElementById('shareMenu');
            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                // Close on outside click
                setTimeout(() => {
                    document.addEventListener('click', closeShareMenuOnOutsideClick);
                }, 0);
            } else {
                menu.style.display = 'none';
                document.removeEventListener('click', closeShareMenuOnOutsideClick);
            }
        }
        
        function closeShareMenuOnOutsideClick(e) {
            const dropdown = document.querySelector('.share-dropdown');
            if (!dropdown.contains(e.target)) {
                document.getElementById('shareMenu').style.display = 'none';
                document.removeEventListener('click', closeShareMenuOnOutsideClick);
            }
        }
    </script>
    
    <!-- Feedback Button -->
    <button class="feedback-button" onclick="openFeedbackModal()" title="Send Feedback">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zM7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
        </svg>
        <span>Feedback</span>
    </button>
    
    <!-- Feedback Modal -->
    <div id="feedbackModal" class="feedback-modal-overlay" onclick="if(event.target === this) closeFeedbackModal()">
        <div class="feedback-modal-content">
            <div class="feedback-modal-header">
                <h3>Send Feedback</h3>
                <button class="feedback-modal-close" onclick="closeFeedbackModal()">&times;</button>
            </div>
            <iframe id="feedbackIframe" src="" frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
    
    <style>
        .feedback-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
            z-index: 9999;
        }
        .feedback-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }
        .feedback-button svg {
            flex-shrink: 0;
        }
        .feedback-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .feedback-modal-overlay.show {
            display: flex;
        }
        .feedback-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 640px;
            height: 85vh;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: feedbackModalIn 0.3s ease;
        }
        @keyframes feedbackModalIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .feedback-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .feedback-modal-header h3 {
            margin: 0;
            font-size: 18px;
            color: #1f2937;
        }
        .feedback-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
        }
        .feedback-modal-close:hover {
            color: #1f2937;
        }
        .feedback-modal-content iframe {
            flex: 1;
            width: 100%;
            border-radius: 0 0 16px 16px;
        }
    </style>
    
    <script>
        function openFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            const iframe = document.getElementById('feedbackIframe');
            iframe.src = 'https://forms.office.com/r/ye88A0WkPp';
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        function closeFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            const iframe = document.getElementById('feedbackIframe');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            // Clear iframe to stop any ongoing processes
            setTimeout(() => { iframe.src = ''; }, 300);
        }
        
        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('feedbackModal').classList.contains('show')) {
                closeFeedbackModal();
            }
        });
    </script>
</body>
</html>
